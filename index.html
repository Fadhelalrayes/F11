<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>مناسك الحج وفق رأي السيد القائد دامت بركاته</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff; --text:#0f172a; --muted:#6b7280; --edge:#e6e2cc;
    --gold1:#f9f4e7; --gold2:#e3c179; --gold3:#c9a144;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Cairo',system-ui}
  header{
    background:linear-gradient(135deg,var(--gold1),var(--gold2) 60%,var(--gold3));
    color:#3b2b09;text-align:center;padding:18px;border-bottom:2px solid var(--gold3);font-weight:700
  }
  .wrap{max-width:820px;margin:0 auto;padding:18px}
  .answer-box{
    background:#fffaf1;border:1px solid var(--edge);border-radius:14px;padding:16px;min-height:140px;line-height:1.85
  }
  .ref{margin-top:8px;font-size:.9rem;color:#6b5d3a;display:none}
  .form{margin-top:22px}
  label{display:block;font-weight:700;margin:0 0 6px}
  input[type="text"]{
    width:100%;padding:14px;border:1px solid var(--edge);border-radius:12px;font-size:1rem;outline:none
  }
  input:focus{border-color:var(--gold3);box-shadow:0 0 0 3px #c9a14433}
  .btn{
    margin-top:10px;width:100%;
    background:linear-gradient(135deg,var(--gold2),var(--gold3));
    border:none;color:#fff;font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer;font-size:1rem
  }
  .btn:hover{filter:brightness(.98)}
  footer{margin:22px auto 18px;text-align:center;color:#7b6a42;font-size:.95rem}
  mark{background:#fff0c2;padding:0 .2em;border-radius:.25em}
  ul{margin:0 1rem 0 0}
</style>
</head>
<body>
  <header>مناسك الحج وفق رأي السيد القائد دامت بركاته</header>

  <div class="wrap">
    <!-- الجواب في الأعلى (لا نص افتراضي) -->
    <div id="ans" class="answer-box"></div>
    <div id="ansRef" class="ref"></div>

    <!-- السؤال في الأسفل + زر الإرسال تحته (لا نص افتراضي) -->
    <form id="form" class="form" autocomplete="off">
      <label for="q">السؤال</label>
      <input id="q" type="text" inputmode="text" />
      <button type="submit" class="btn">إرسال</button>
    </form>
  </div>

  <footer>برمجة وتطوير : فاضل الريس</footer>

  <!-- قاعدة المعارف الموسّعة (أسئلة افتراضية دقيقة عن الأعمال ومسائل النساء وغيرها) -->
  <script id="KB" type="application/json">[
    /* ===== الوجوب والاستطاعة ===== */
    {"qid":"M001","question":"ما حكم ترك الحج مع الاستطاعة؟","keys":["ترك الحج","كبيرة","فورية"],"answer":"ترك الحج بعد تحقق الاستطاعة من الكبائر، ووجوبه فوري؛ فلا يجوز التأخير بلا عذر معتبر.","ref":"مسألة 1"},
    {"qid":"M002","question":"ما شروط وجوب حجة الإسلام؟","keys":["شروط الوجوب","عاقل","بالغ","مستطيع","فورية"],"answer":"تجب مرة واحدة على العاقل البالغ المستطيع، وهي فورية بعد تحقق الاستطاعة (مالية/بدنية/أمن الطريق/الزمان).","ref":"مسائل 23–26"},
    {"qid":"M003","question":"ما المقصود بالاستطاعة المالية؟","keys":["الزاد والراحلة","نفقة العيال","ضروريات","الرجوع إلى الكفاية"],"answer":"امتلاك الزاد والراحلة، ونفقة العيال مدة السفر، وحفظ ضروريات المعيشة، مع الرجوع إلى الكفاية بعد الرجوع من الحج.","ref":"مسائل 34–55"},
    {"qid":"M004","question":"هل يوجب إمكان الاقتراض الحج؟","keys":["اقتراض","قرض"],"answer":"لا يثبت الوجوب لمجرد إمكان الاقتراض ابتداءً؛ نعم لو اقترض فأصبح واجدًا لمؤنة الحج لزمه الأداء.","ref":"مسألة 49"},
    {"qid":"M005","question":"من عليه دين حالّ ومطالبة؟","keys":["دين حال","مطالبة"],"answer":"مع مطالبة الدائن لا تتحقق الاستطاعة حتى يبرئ ذمته أو يأذن له؛ وإلا فلا يجب الحج حينئذ.","ref":"مسألة 44"},
    {"qid":"M006","question":"بيع المسكن/السيارة لتحصيل الاستطاعة؟","keys":["بيع المسكن","بيع السيارة","ضروريات"],"answer":"لا يجب بيع الضروريات الموافقة للشأن كالبيت والسيارة؛ ويُعتبر الرجوع إلى الكفاية.","ref":"مسألة 52"},
    {"qid":"M007","question":"ما هي الاستطاعة البدنية والأمنية والزمانية؟","keys":["بدنية","أمن الطريق","زمانية"],"answer":"البدنية: القدرة بلا حرج، الأمنية: أمن الطريق وسلامة النفس والمال، الزمانية: سعة الوقت لإدراك الأعمال على وجهها.","ref":"مسائل 66–70"},
    {"qid":"M008","question":"العجز البدني الدائم والاستنابة؟","keys":["استنابة","عجز"],"answer":"مع العجز البدني الدائم وتحقق الاستطاعة المالية تجب الاستنابة لأداء الحج.","ref":"مسألة 70"},

    /* ===== المواقيت والإحرام ===== */
    {"qid":"I001","question":"ما هي مواقيت الإحرام؟","keys":["مسجد الشجرة","وادي العقيق","الجحفة","يلملم","قرن المنازل","محاذاة"],"answer":"المواقيت: مسجد الشجرة، وادي العقيق (المسلخ/الغمرة/ذات عرق)، الجحفة، يلملم، قرن المنازل، ومحاذاتها لمن لم يمر بميقات.","ref":"مسائل 100–106"},
    {"qid":"I002","question":"من كان في مكة وأراد عمرة مفردة؟","keys":["أدنى الحل","التنعيم","الحديبية","الجعرانة"],"answer":"إحرامه من أدنى الحل، والأفضل: التنعيم أو الحديبية أو الجعرانة.","ref":"مسألة 111"},
    {"qid":"I003","question":"بماذا ينعقد الإحرام وما صيغة التلبية؟","keys":["التلبية","صيغة"],"answer":"ينعقد بالتلبية. الصيغة الواجبة: «لبيك اللهم لبيك، لبيك لا شريك لك لبيك».","ref":"مسائل 132–135"},

    /* ===== محرمات الإحرام (مختار) ===== */
    {"qid":"P001","question":"اذكر محرمات الإحرام بإجمال.","keys":["محرمات الإحرام","22"],"answer":"منها: لبس المخيط للرجال، تغطية رأس الرجل ووجه المرأة، التظليل للرجال نهارًا حال السير، الطيب، النظر في المرآة بقصد الزينة، الحناء، التدهين، إزالة الشعر، الكحل، تقليم الأظفار، إخراج الدم، الفسوق، الجدال، قتل هوام البدن، صيد البر، الجماع، عقد النكاح، الاستمناء… ولكل تفصيل وكفارات.","ref":"مسائل 159–161"},
    {"qid":"P002","question":"حكم لبس المخيط للرجال؟","keys":["لبس المخيط","قميص","سروال"],"answer":"يحرم على الرجل لبس المخيط كالقميص والسروال ونحوهما حال الإحرام، وتفصيل الكفارات بحسب العمد والتكرار.","ref":"مسائل 162–170"},
    {"qid":"P003","question":"التظليل نهارًا للمحرم؟","keys":["تظليل","مظلة","سقف"],"answer":"يحرم على الرجل حال السير نهارًا أن يظلّل نفسه بسقف ونحوه؛ ويختلف الحكم في الليل أو حال الوقوف، وتجب الفدية عند الاضطرار.","ref":"مسألة 168"},
    {"qid":"P004","question":"استعمال الطيب للمحرم/المحرمة؟","keys":["طيب","عطر"],"answer":"يحرم استعمال الطيب وشمّه بقصد التلذذ، وتجب الكفارة على التعمد؛ ويُفصّل حكم السهو وأنواع الروائح.","ref":"مسألة 171"},
    {"qid":"P005","question":"إزالة الشعر وقصّ الأظفار؟","keys":["حلق","قص أظفار"],"answer":"يحرم عمدًا، وتجب الكفارة بحسب المورد والنية.","ref":"مسألة 175"},
    {"qid":"P006","question":"عقد النكاح للمحرم؟","keys":["عقد النكاح"],"answer":"باطل ومحرم مطلقًا حال الإحرام.","ref":"مسألة 182"},
    {"qid":"P007","question":"الجماع قبل طواف النساء؟","keys":["جماع","طواف النساء"],"answer":"محرم حتى يأتي بطواف النساء وصلاته؛ وتترتب كفارات خاصة في مواردها.","ref":"مسألة 185"},
    {"qid":"P008","question":"صيد البر في الحرم؟","keys":["صيد البر","الحرم"],"answer":"يحرم على المحرم صيد البر وفي الحرم، والكفارة بحسب النوع والحال.","ref":"مسألة 190"},

    /* ===== أعمال عمرة التمتع ===== */
    {"qid":"A001","question":"ما أعمال عمرة التمتع؟","keys":["أعمال العمرة","عمرة التمتع"],"answer":"1) الإحرام من الميقات 2) الطواف 3) صلاة الطواف 4) السعي بين الصفا والمروة 5) التقصير.","ref":"مسألة 13"},
    {"qid":"A002","question":"كم أشواط الطواف والسعي؟","keys":["عدد الأشواط","الطواف","السعي"],"answer":"الطواف سبعة أشواط ابتداءً من الحجر، والسعي سبعة أشواط ابتداءً بالصفا وختامًا بالمروة.","ref":"باب الطواف/السعي"},
    {"qid":"A003","question":"ترك شوط من الطواف نسيانًا؟","keys":["ترك شوط","نسيان"],"answer":"قبل تمام أربعة أشواط يُستأنف الطواف؛ وبعد تجاوز النصف يُتدارك على تفصيل ثم تُصلى صلاة الطواف.","ref":"باب الطواف"},
    {"qid":"A004","question":"قطع السعي ثم البناء؟","keys":["قطع السعي","موالاة"],"answer":"يبني من موضع القطع ما دامت الموالاة العرفية محفوظة، وإلا يعيد السعي على تفصيل.","ref":"باب السعي"},
    {"qid":"A005","question":"الطهارة للطواف وصلاة الطواف؟","keys":["طهارة","صلاة الطواف"],"answer":"يشترط للطواف وصلاة الطواف الطهارة من الحدث والنجاسة، ومن تذكّر بعده قضى الصلاة فورًا في موضعها المقرر.","ref":"باب الطواف/الصلاة"},

    /* ===== أعمال حج التمتع ===== */
    {"qid":"H001","question":"أعمال حج التمتع بإجمال؟","keys":["أعمال الحج","حج التمتع"],"answer":"الإحرام من مكة → الوقوف بعرفات → الوقوف بالمشعر → رمي جمرة العقبة → الهدي → الحلق/التقصير → طواف الحج وصلاته → السعي → طواف النساء وصلاته → المبيت بمنى ورمي الجمار أيام التشريق.","ref":"مسألة 15"},
    {"qid":"H002","question":"وقت الوقوف بعرفات؟","keys":["عرفات","وقت"],"answer":"وقت الوقوف الاختياري: من زوال يوم التاسع إلى الغروب؛ وللاضطراري أحكامه إن فات الاختياري.","ref":"باب الوقوف بعرفات"},
    {"qid":"H003","question":"الوقوف بالمشعر (مزدلفة)؟","keys":["المشعر","مزدلفة","وقت"],"answer":"من ليلة العيد إلى الفجر، ويكفي الاضطراري بإدراك جزء منه للمعذورين على التفصيل.","ref":"باب المشعر"},
    {"qid":"H004","question":"ترتيب أعمال يوم العيد؟","keys":["يوم العيد","ترتيب"],"answer":"بعد المشعر: رمي جمرة العقبة → الهدي → الحلق/التقصير؛ ثم طواف الحج وصلاته والسعي، ثم طواف النساء وصلاته.","ref":"مسألة 260"},
    {"qid":"H005","question":"المبيت بمنى؟","keys":["المبيت بمنى","ليالي التشريق"],"answer":"المبيت واجب ليلة 11 و12، وللمتأخر ليلة 13. يُرخّص لذوي الأعذار مع فدية غالبًا.","ref":"مسألة 240"},
    {"qid":"H006","question":"وقت رمي الجمار؟","keys":["الرمي","وقت"],"answer":"جمرة العقبة يوم العيد، والجمار الثلاث أيام التشريق؛ الأفضل النهار، ويجوز ليلًا للمعذور على تفصيل، مع مراعاة الترتيب والعدد (سبع لكل جمرة).","ref":"مسألة 245"},
    {"qid":"H007","question":"من لم يجد الهدي؟","keys":["الهدي","عدم الوجدان","الصوم"],"answer":"ينتقل إلى الصوم: ثلاثة في الحج وسبعة إذا رجع إلى أهله، على الترتيب المذكور في الباب.","ref":"مسألة 250"},
    {"qid":"H008","question":"الاستنابة في الرمي؟","keys":["استنابة","الرمي"],"answer":"تصح نيابة العاجز أو من فيه حرج شديد، مع نية النيابة ومراعاة الترتيب.","ref":"مسألة 255"},
    {"qid":"H009","question":"تقديم بعض الأعمال على بعض؟","keys":["تقديم","ترتيب"],"answer":"الأصل الترتيب، ويجوز التقديم في موارد العذر وفق الضوابط المنصوصة.","ref":"مسألة 265"},
    {"qid":"H010","question":"نسيان بعض أعمال العمرة/الحج؟","keys":["نسيان","تدارك","ركن"],"answer":"يرجع إلى الركنية: الطواف والسعي ركنان؛ أما غيرهما فيُتدارك أو تجب فدية بحسب المورد.","ref":"مسألة 270"},
    {"qid":"H011","question":"أفسد الحج بالجماع قبل الوقوف؟","keys":["إفساد","جماع"],"answer":"يُتمّ الحج وتجب الإعادة في العام القادم مع الهدي؛ والتفصيل بحسب الموضع والزمان.","ref":"مسألة 280"},
    {"qid":"H012","question":"العدول من التمتع إلى الإفراد لضيق الوقت؟","keys":["عدول","إفراد","ضيق الوقت"],"answer":"يجوز عند ضيق الوقت عن إدراك العمرة والحج معًا، وتكون الوظيفة حج الإفراد مع عمرة مفردة بعده.","ref":"مسألة 210"},

    /* ===== مسائل النساء (موسّعة ودقيقة) ===== */
    {"qid":"W001","question":"لباس المرأة في الإحرام؟","keys":["لباس المرأة","حجاب","قناع","قفازات"],"answer":"تلبس الساتر غير المزخرف بلا تزيّن، ويجوز لبس المخيط. لا تغطي وجهها بالقناع/النقاب، ولا تلبس القفازات. يجوز ستر الرأس والشعر بلا طيب.","ref":"مسألة 170"},
    {"qid":"W002","question":"تغطية وجه المرأة بالإسدال؟","keys":["إسدال الخمار","تغطية الوجه"],"answer":"يجوز الإسدال من دون لصوق مباشر للوجه عند الحاجة، مع الاحتياط في اجتناب التغطية المباشرة.","ref":"مسألة 170 وما يلحقها"},
    {"qid":"W003","question":"المرأة حاضت قبل الطواف؟","keys":["حيض قبل الطواف"],"answer":"لا تأتي بالطواف حتى تطهر؛ ومع ضيق الوقت تعمل برخصها كالتوكيل في الطواف أو العدول وفق الموارد المقررة.","ref":"مسألة 220"},
    {"qid":"W004","question":"حاضت أثناء الطواف؟","keys":["حيض أثناء الطواف"],"answer":"تقطع الطواف وتنتظر الطهر لإتمام الأشواط ثم تصلي صلاة الطواف وتتابع باقي الأعمال؛ ومع الضيق توجد رخص منصوصة.","ref":"مسألة 220"},
    {"qid":"W005","question":"حاضت قبل طواف الحج بعد السعي؟","keys":["حيض قبل طواف الحج"],"answer":"تنتظر الطهر لأداء طواف الحج وصلاته؛ ومع ضيق الوقت يُلجأ إلى الرخص كالاستنابة أو البقاء حتى الطهر بحسب الحال.","ref":"مسائل النساء/الطواف"},
    {"qid":"W006","question":"حاضت قبل طواف النساء؟","keys":["حيض قبل طواف النساء"],"answer":"لا تحل الأزواج حتى يُؤتى بطواف النساء وصلاته؛ فإن ضاق الوقت تستنيب للطواف ثم تصلي عند الطهر على تفصيل الباب.","ref":"مسألة 230"},
    {"qid":"W007","question":"المستحاضة وأعمال الطواف والصلاة؟","keys":["استحاضة","أغسال","وضوء"],"answer":"تعمل بوظيفتها (وضوء/أغسال/ربط) بحسب الصغرى/الوسطى/الكبرى، ثم تؤدي الطواف والصلاة على وفق ذلك.","ref":"أبواب الطهارة للمستحاضة"},
    {"qid":"W008","question":"أحكام النفساء؟","keys":["نفاس","نفساء"],"answer":"حكمها حكم الحائض: لا تأتي بالطواف والصلاة حتى تطهر، ومع ضيق الوقت تُعمل بالرخص كالاستنابة ونحوها وفق الضوابط.","ref":"مسائل النساء/نفاس"},
    {"qid":"W009","question":"التعطر والزينة للمرأة المحرمة؟","keys":["طيب المرأة","زينة"],"answer":"يحرم استعمال العطور والطيب بقصد التلذذ، وتُجتنب الزينة الظاهرة بقصد التزيّن للناس كالكحل ونحوه.","ref":"مسألة 171 وما يليها"},
    {"qid":"W010","question":"لباس القدمين للمرأة في الإحرام؟","keys":["الجوارب","الخف"],"answer":"يجوز للمرأة لبس الجوارب والخف؛ بخلاف الرجل حيث لا يستر ظهر قدمه بما يغطيه على التفصيل.","ref":"باب اللباس للنساء"},

    /* ===== تفاصيل دقيقة إضافية للأعمال ===== */
    {"qid":"D001","question":"هل تصح الاستنابة في الطواف لمرض مزمن؟","keys":["نيابة في الطواف","عجز"],"answer":"تصح النيابة عند العجز الدائم أو المشقة الشديدة مع تعذر المباشرة، مع تعيين المنوب عنه في النية.","ref":"باب النيابة"},
    {"qid":"D002","question":"موضع صلاة الطواف؟","keys":["مكان صلاة الطواف"],"answer":"خلف مقام إبراهيم إن تيسر، ومع الزحام يجوز الأبعد ما دام في المسجد مع رعاية الجهة والقبلة.","ref":"باب صلاة الطواف"},
    {"qid":"D003","question":"نسي صلاة الطواف؟","keys":["نسي صلاة الطواف"],"answer":"يأتي بها متى تذكّر ولو بعد أيام، والأولى المبادرة؛ وتفصيل المكان والزمان في الباب.","ref":"باب صلاة الطواف"},
    {"qid":"D004","question":"التحلل الأول والثاني؟","keys":["تحلل","محظورات"],"answer":"بعد رمي جمرة العقبة والذبح والحلق/التقصير يتحقق التحلل الأول وترتفع أكثر المحظورات، ويبقى ما يتعلق بالنساء حتى طواف النساء وصلاته (التحلل الثاني).","ref":"أبواب التحلل"},
    {"qid":"D005","question":"حصى الجمار وشروطها؟","keys":["حصى الجمار"],"answer":"سبع حصيات لكل جمرة، صغار من الحرم، طاهرة غير مغصوبة، تُرمى متعاقبة بنية القربة.","ref":"باب الرمي"},
    {"qid":"D006","question":"الرمي عن الغير مع العجز؟","keys":["رمي عن الغير","استنابة"],"answer":"يجوز عن العاجز مع نية النيابة، ويُراعى الترتيب والسبع لكل جمرة.","ref":"باب الرمي"},
    {"qid":"D007","question":"السعي قبل طواف الحج لعذر؟","keys":["تقديم السعي"],"answer":"الأصل بعد طواف الحج وصلاته، ومع عذر منصوص توجد رخص بالتقديم وفق الضوابط.","ref":"باب الترتيب"},
    {"qid":"D008","question":"الذبح خارج منى مع التعذر؟","keys":["ذبح خارج منى"],"answer":"الأصل الذبح بمنى؛ ومع التعذر تُذكر بدائل كالتذكية في مكة على التفصيل مع لزوم الشروط.","ref":"باب الهدي"},
    {"qid":"D009","question":"ترك السعي وتذكّره بعد أيام؟","keys":["ترك السعي"],"answer":"يقضيه متى تذكّر ما دام التدارك ممكنًا؛ ومع التعذر يُرجع إلى حكم الاستنابة أو العود.","ref":"باب السعي"},
    {"qid":"D010","question":"هل يجزئ طيب الصابون المعطّر؟","keys":["صابون معطر"],"answer":"إن كان بقصد التلذذ بالرائحة فمحظور، وإلا فالتفصيل بحسب نوع الرائحة والقصد.","ref":"مسألة 171"}
  ]</script>

  <script>
    const KB = JSON.parse(document.getElementById('KB').textContent||'[]');

    /* ==== تطبيع عربي قوي + مرادفات + جذاذة مبسّطة ==== */
    const SYNS = new Map(Object.entries({
      "حيض":"حائض,حاضت,دم الحيض",
      "استحاضة":"مستحاضة,دم مستمر",
      "نفاس":"نفساء,دم النفاس",
      "مزدلفة":"المشعر,المشعر الحرام",
      "تظليل":"مظلة,مضلل,ظل,سقف,شمسيه,شمسية",
      "طواف النساء":"طواف النسا,طواف النِساء,طواف الوداع(خاطئ)",
      "هدي":"ذبح,نحر",
      "محاذاة":"موازاة,محاذي,خط الرحلة,الطائرة",
      "رمي":"جمرة,جمار",
      "تحلل":"حلّ المحظورات"
    }));

    function arNorm(s){
      return (s||'')
        .replace(/[\\u064B-\\u065F]/g,'')      // حركات
        .replace(/[إأآا]/g,'ا')
        .replace(/[ى]/g,'ي')
        .replace(/[ة]/g,'ه')
        .replace(/[ؤئ]/g,'ء')
        .replace(/[ـ]/g,'')
        .replace(/[^\u0600-\u06FFa-z0-9 ]+/g,' ')
        .replace(/\\s+/g,' ')
        .trim().toLowerCase();
    }
    function stripAl(w){ return w.startsWith('ال') && w.length>3 ? w.slice(2) : w; }
    function tokens(s){ return arNorm(s).split(/[^\\u0600-\\u06FFa-z0-9]+/).filter(Boolean).map(stripAl); }

    // توسعة المرادفات في الاستعلام
    function expandQuery(q){
      let t = arNorm(q); const words = t.split(' ');
      for(const [k,v] of SYNS.entries()){
        if(words.includes(arNorm(k))) t += ' ' + arNorm(v);
      }
      return t;
    }

    // بناء فهارس بثقل أعلى لمفاتيح entry.keys ثم السؤال ثم الجواب + ثنائيات
    function bigrams(arr){
      const out = new Set();
      for(let i=0;i<arr.length-1;i++) out.add(arr[i]+' '+arr[i+1]);
      return out;
    }

    const INDEX = KB.map((e,i)=>{
      const k = tokens((e.keys||[]).join(' '));
      const q = tokens(e.question||'');
      const a = tokens(e.answer||'');
      return {
        i,
        kset:new Set(k),
        qset:new Set(q),
        aset:new Set(a),
        kbi:bigrams(k), qbi:bigrams(q), abi:bigrams(a)
      };
    });

    function scoreAgainst(qtoks, qbi, E){
      let s=0;
      qtoks.forEach(w=>{
        if(E.kset.has(w)) s+=7;   // مفاتيح
        if(E.qset.has(w)) s+=3;   // نص السؤال
        if(E.aset.has(w)) s+=1;   // نص الجواب
      });
      qbi.forEach(bg=>{
        if(E.kbi.has(bg)) s+=6;
        if(E.qbi.has(bg)) s+=3;
        if(E.abi.has(bg)) s+=1;
      });
      return s;
    }

    function retrieve(query){
      const exp = expandQuery(query);
      const qtoks = new Set(tokens(exp));
      const qbi = bigrams(Array.from(qtoks));
      let best = [];
      let top = 0;
      for(const E of INDEX){
        const sc = scoreAgainst(qtoks,qbi,E);
        if(sc>0){
          if(sc>top){ top=sc; best=[E.i]; }
          else if(sc===top){ best.push(E.i); }
        }
      }
      return {ids:best.slice(0,2), score:top};
    }

    function hi(text,q){
      let t=text; tokens(q).forEach(w=>{
        if(!w) return; const re = new RegExp('('+w+')','gi');
        t = t.replace(re,'<mark>$1</mark>');
      }); return t;
    }

    function setAnswer(html, refs){
      const ans = document.getElementById('ans');
      const ref = document.getElementById('ansRef');
      ans.innerHTML = html;
      if(refs && refs.length){
        ref.textContent = 'المصدر: كتيّب أحكام الحج (leader.ir) — ' + refs.join(' ، ');
        ref.style.display = 'block';
      }else{
        ref.style.display = 'none';
      }
    }

    function answer(q){
      const {ids,score} = retrieve(q);
      if(score < 6 || !ids.length){
        setAnswer('لم أعثر على مسألة دقيقة لهذه الصياغة. جرّب مفاتيح مثل: <mark>طواف النساء</mark>، <mark>التظليل</mark>، <mark>المحاذاة</mark>، <mark>المبيت بمنى</mark>، <mark>الاستحاضة</mark>.', []);
        return;
      }
      const blocks = ids.map((i,idx)=>{
        const e = KB[i];
        return `<b>${idx? 'جواب مكمل' : 'الجواب'}:</b><br>${hi(e.answer,q)}`;
      });
      const refs = ids.map(i=>KB[i].ref);
      setAnswer(blocks.join('<hr>'), refs);
    }

    document.getElementById('form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = document.getElementById('q').value.trim();
      if(!q) return;
      answer(q);
    });
  </script>
</body>
</html>
