/**
 * 🚀 FadhelTalk - ملف واحد فيه كل شيء
 * - يقدم صفحة HTML + CSS + JS للزوار
 * - يحفظ مفتاح API بأمان (داخل الكود هنا أو في متغير بيئة)
 * - يعمل كخادم خلفي (Node.js + Express)
 */

import express from "express";
import fetch from "node-fetch";
import dotenv from "dotenv";

dotenv.config();
const app = express();
app.use(express.json());

// ===============
// ⚠️ ضع مفتاح API هنا أو في ملف .env
// ===============
const API_KEY = process.env.API_KEY || "ضع_مفتاحك_هنا";

// 🟢 الواجهة الأمامية (HTML كامل)
const htmlPage = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FadhelTalk - محادثة ذكية</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, sans-serif; }
    body { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;}
    .container { width:100%; max-width:500px; background:rgba(255,255,255,0.95); border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,0.15); overflow:hidden; }
    .header { background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:#fff; padding:25px; text-align:center;}
    .logo { display:flex; justify-content:center; margin-bottom:15px;}
    .logo-icon { font-size:32px; background:#fff; color:#7c3aed; width:60px; height:60px; border-radius:50%; display:flex; justify-content:center; align-items:center;}
    h1 { font-size:28px; font-weight:700; margin-bottom:5px;}
    .subtitle { font-size:14px; opacity:.9;}
    .status { display:inline-flex; align-items:center; gap:8px; font-size:13px; margin-top:15px; background:rgba(255,255,255,0.2); padding:5px 12px; border-radius:20px;}
    .status-dot { width:8px; height:8px; background:#10b981; border-radius:50%;}
    .chat-container { height:400px; overflow-y:auto; padding:25px; background:#f8fafc; display:flex; flex-direction:column; gap:20px;}
    .message { max-width:80%; padding:16px 20px; border-radius:20px; line-height:1.5; box-shadow:0 4px 12px rgba(0,0,0,0.05);}
    .user-message { align-self:flex-end; background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%); color:#fff; border-bottom-right-radius:5px;}
    .ai-message { align-self:flex-start; background:#fff; color:#374151; border:1px solid #e5e7eb; border-bottom-left-radius:5px;}
    .message-time { font-size:11px; opacity:.7; margin-top:5px;}
    .input-container { display:flex; padding:20px; background:#f8fafc; border-top:1px solid #e5e7eb; gap:12px;}
    input { flex:1; padding:16px 20px; border:none; border-radius:24px; outline:none; background:#fff;}
    button { background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%); color:#fff; border:none; border-radius:24px; padding:16px 24px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:8px;}
    .footer { text-align:center; padding:15px; background:#f1f5f9; color:#64748b; font-size:12px; border-top:1px solid #e2e8f0;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo"><div class="logo-icon"><i class="fas fa-comments"></i></div></div>
      <h1>FadhelTalk</h1>
      <p class="subtitle">تطبيق المحادثة الذكية</p>
      <div class="status"><span id="status-text">جاهز</span><div class="status-dot"></div></div>
    </div>

    <div class="chat-container" id="chat-container">
      <div class="message ai-message">
        <div class="message-content">مرحبًا! أنا مساعدك في FadhelTalk. كيف يمكنني مساعدتك اليوم؟</div>
        <div class="message-time" id="current-time"></div>
      </div>
    </div>

    <div class="input-container">
      <input type="text" id="user-input" placeholder="اكتب رسالتك هنا...">
      <button id="send-btn"><i class="fas fa-paper-plane"></i><span>إرسال</span></button>
    </div>

    <div class="footer">برمجة وتطوير: فاضل الريس | جميع الحقوق محفوظة</div>
  </div>

  <script>
    const chat=document.getElementById('chat-container'),input=document.getElementById('user-input'),btn=document.getElementById('send-btn'),timeEl=document.getElementById('current-time');
    let waiting=false;
    function now(){const n=new Date();const t=\`\${n.getHours()}:\${n.getMinutes().toString().padStart(2,'0')}\`;if(timeEl)timeEl.textContent=t;return t;}
    now();
    function addMsg(txt,user){const d=document.createElement('div');d.classList.add('message',user?'user-message':'ai-message');const c=document.createElement('div');c.textContent=txt;const t=document.createElement('div');t.classList.add('message-time');t.textContent=now();d.appendChild(c);d.appendChild(t);chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
    function typing(){const d=document.createElement('div');d.classList.add('ai-message');d.id='typing';d.textContent='...جاري المعالجة';chat.appendChild(d);chat.scrollTop=chat.scrollHeight;return d;}
    async function ai(msg){try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});const j=await r.json();return j.reply||'لا يوجد رد.';}catch(e){return '⚠️ خطأ في الاتصال.';}}
    async function send(){if(waiting)return;const m=input.value.trim();if(!m)return;addMsg(m,true);input.value='';waiting=true;btn.disabled=true;const typ=typing();try{const ans=await ai(m);typ.remove();addMsg(ans,false);}catch{typ.remove();addMsg('خطأ غير متوقع',false);}finally{waiting=false;btn.disabled=false;input.focus();}}
    btn.addEventListener('click',send);input.addEventListener('keypress',e=>{if(e.key==='Enter'&&!waiting)send();});
  </script>
</body>
</html>
`;

// 🟢 تقديم الصفحة الرئيسية
app.get("/", (req, res) => {
  res.send(htmlPage);
});

// 🟢 API وسيط بين الزائر و DeepSeek
app.post("/api/chat", async (req, res) => {
  try {
    const userMsg = req.body.message;
    const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${API_KEY}\`,
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
          { role: "system", content: "أنت مساعد ذكي يتحدث العربية." },
          { role: "user", content: userMsg },
        ],
        max_tokens: 500,
      }),
    });

    const data = await response.json();
    const reply = data?.choices?.[0]?.message?.content || "لا يوجد رد.";
    res.json({ reply });
  } catch (err) {
    console.error("❌ خطأ:", err.message);
    res.status(500).json({ reply: "⚠️ خطأ في الخدمة، حاول لاحقاً." });
  }
});

// 🟢 تشغيل السيرفر
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(\`🚀 FadhelTalk يعمل على http://localhost:\${PORT}\`));
