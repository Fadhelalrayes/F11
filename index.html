<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FadhelTalk - محادثة ذكية</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- سياسة أمان محتوى بسيطة -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src https://cdnjs.cloudflare.com;">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background:#0f172a; color:#e2e8f0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .container { width: min(980px, 92vw); }
    .header { display:flex; align-items:center; gap:14px; margin-bottom:18px; }
    .logo-icon { width:44px; height:44px; border-radius:12px; background:#1e293b; display:grid; place-items:center; }
    .logo-icon i { font-size:20px; }
    h1 { font-size:28px; font-weight:700; }
    .subtitle { color:#94a3b8; margin-top:2px; }
    .card { background:#0b1220; border:1px solid #1f2937; border-radius:16px; padding:18px; }
    .muted { color:#94a3b8; font-size:14px; }
    .app { margin-top:14px; background:#0b1220; border:1px dashed #243041; border-radius:14px; padding:20px; }
    .pill { display:inline-block; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #243041; color:#a3bffa; background:#0b1220; }
    a { color:#93c5fd; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container">

    <div class="header">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-comments"></i></div>
      </div>
      <div>
        <h1>FadhelTalk</h1>
        <p class="subtitle">تطبيق المحادثة الذكية</p>
      </div>
    </div>

    <!-- ملاحظة: قسم الحالة تمت إزالته نهائياً حسب الطلب -->

    <div class="card">
      <span class="pill">جاهز للاستخدام لجميع الزوار</span>
      <p class="muted" style="margin-top:10px;">
        يعمل التطبيق دون الحاجة لإدخال رقم. إن وُجد رقم في الرابط (مثلاً <code>?phone=</code>) فسيُشفَّر محلياً
        ويُخزَّن مُشفّرًا فقط.
      </p>

      <div class="app" id="app-root">
        <!-- ضع واجهة الدردشة الفعلية هنا -->
        <p class="muted">واجهة الدردشة ستظهر هنا…</p>
      </div>
    </div>
  </div>

  <script>
    // ===== تشفير محلي للرقم (AES-GCM عبر Web Crypto) =====
    // - يتم إنشاء مفتاح مخصص للجلسة وتخزينه في sessionStorage (لا يُحفظ بشكل دائم).
    // - يتم حفظ الرقم مُشفّرًا فقط في localStorage تحت المفتاح 'ft_msisdn_enc'.
    // - إذا كان الرقم محفوظًا قديماً كنص واضح تحت 'msisdn' فسنقوم بترحيله لتخزين مُشفّر ثم حذفه.

    const KEY_STORAGE = 'ft_aes_raw_key_v1';
    const ENC_MSISDN = 'ft_msisdn_enc';

    async function getOrCreateKey() {
      // جرّب تحميل مفتاح خام محفوظ للجلسة
      let rawB64 = sessionStorage.getItem(KEY_STORAGE);
      if (!rawB64) {
        const key = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt','decrypt']);
        const raw = await crypto.subtle.exportKey('raw', key);
        rawB64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
        sessionStorage.setItem(KEY_STORAGE, rawB64);
        return key;
      }
      // استيراد المفتاح من Base64
      const raw = Uint8Array.from(atob(rawB64), c => c.charCodeAt(0));
      return crypto.subtle.importKey('raw', raw, { name:'AES-GCM' }, false, ['encrypt','decrypt']);
    }

    function concatUint8(a, b) {
      const out = new Uint8Array(a.length + b.length);
      out.set(a, 0); out.set(b, a.length);
      return out;
    }

    async function encryptText(key, text) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder().encode(text);
      const ct = new Uint8Array(await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc));
      // نخزن IV + CT بصيغة Base64
      const payload = concatUint8(iv, ct);
      return btoa(String.fromCharCode(...payload));
    }

    async function decryptText(key, b64) {
      const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const iv = bytes.slice(0, 12);
      const ct = bytes.slice(12);
      const dec = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);
      return new TextDecoder().decode(dec);
    }

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function migratePlainIfAny(key) {
      // ترحيل محتوى قديم محتمل (لو كنت سابقاً تخزن الرقم كنص واضح)
      const legacyPlain = localStorage.getItem('msisdn');
      if (legacyPlain && legacyPlain.trim()) {
        try {
          const enc = await encryptText(key, legacyPlain.trim());
          localStorage.setItem(ENC_MSISDN, enc);
        } catch(e) {
          console.error('Encryption failed during migration:', e);
        } finally {
          localStorage.removeItem('msisdn'); // حذف النص الواضح نهائياً
        }
      }
    }

    async function storePhoneIfInURL(key) {
      const phone = getQueryParam('phone');
      if (phone && phone.trim()) {
        try {
          const enc = await encryptText(key, phone.trim());
          localStorage.setItem(ENC_MSISDN, enc);
        } catch(e) {
          console.error('Encryption failed for URL phone:', e);
        }
      }
    }

    // مثال اختياري: دالة لجلب الرقم (مُفكّك) إن احتجته داخل التطبيق.
    async function getDecryptedPhone() {
      const encB64 = localStorage.getItem(ENC_MSISDN);
      if (!encB64) return null;
      try {
        const key = await getOrCreateKey();
        return await decryptText(key, encB64);
      } catch {
        return null; // لو فشل فك التشفير لأي سبب، لا نعيد شيئاً
      }
    }

    (async () => {
      const key = await getOrCreateKey();
      await migratePlainIfAny(key);
      await storePhoneIfInURL(key);

      // التطبيق يعمل لكل الزوار بغضّ النظر عن وجود رقم.
      // إن احتجت الرقم لاحقاً في منطقك الداخلي، استدعِ getDecryptedPhone().
      // مثال (اختباري، يمكن حذفه):
      // const p = await getDecryptedPhone();
      // console.log('Decrypted phone (if any):', p);
    })();
  </script>
</body>
</html>
