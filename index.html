<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>الخِيرة بالقرآن | استخارة من الصفحة اليمنى</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<noscript><style>section.view{display:block!important}</style></noscript>
<style>
:root{
  --gold1:#fff4cc; --gold2:#f6d478; --gold3:#e9b84f; --gold4:#cf9a38;
  --ink:#111; --radius:22px;
  --sh-md:0 10px 22px rgba(0,0,0,.14); --sh-xl:0 20px 44px rgba(0,0,0,.22);
  --fs-h1:clamp(26px,4.2vw,44px);
  --fs-h2:clamp(20px,2.8vw,32px);
  --fs-btn:clamp(15px,1.7vw,18px);
  --fs-body:clamp(14px,1.3vw,18px);
  --fs-ayah:clamp(20px,2.2vw,30px);
  --space:clamp(12px,2vw,22px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);font-size:var(--fs-body);
  background:
    radial-gradient(1200px 420px at 50% -120px, rgba(0,0,0,.28), transparent 60%),
    linear-gradient(180deg,#1a1a1a 0%, #0e0e0e 20%, #000 22%),
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="260" height="260" viewBox="0 0 260 260"><path d="M130 10l120 120-120 120L10 130z" fill="%23f2ead1" fill-opacity=".25"/></svg>') repeat;
  background-blend-mode:soft-light,normal,soft-light;
  font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}
.container{width:min(1200px,96%);margin-inline:auto;padding:clamp(16px,2.5vw,28px) 0 36px}

/* زخرفة */
.medallion{
  width:clamp(70px,9vw,110px);height:clamp(70px,9vw,110px);
  margin:0 auto calc(var(--space)*-1.3);
  position:relative;z-index:2;border-radius:50%;
  background:
    radial-gradient(circle at 38% 28%, rgba(255,255,255,.5), transparent 40%),
    conic-gradient(from 210deg, var(--gold1), var(--gold2), var(--gold3), var(--gold4), var(--gold2));
  box-shadow:var(--sh-xl), inset 0 0 0 4px rgba(255,255,255,.35), inset 0 0 0 1px rgba(185,130,31,.45)
}
.medallion:after{
  content:"";position:absolute;inset:12px;border-radius:50%;
  background:radial-gradient(circle at 60% 30%, rgba(255,255,255,.55), transparent 45%),linear-gradient(180deg,var(--gold2),var(--gold4));
  box-shadow:inset 0 0 0 1px rgba(185,130,31,.55)
}

/* Hero */
.hero{
  position:relative;padding:calc(var(--space)*1.8) var(--space) calc(var(--space)*1.2);
  border-radius:var(--radius);
  background:radial-gradient(120% 180% at 50% -70%, rgba(255,255,255,.18), transparent 70%),
             linear-gradient(180deg,#141414 0%, #0c0c0c 55%, #070707 100%);
  color:#fff;box-shadow:var(--sh-xl);overflow:hidden;text-align:center
}
.title{font-family:"Noto Kufi Arabic";font-weight:800;font-size:var(--fs-h1);margin:0 0 6px}
.divider{
  width:min(240px,40%);height:16px;margin:12px auto 0;border-radius:999px;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent),
             linear-gradient(90deg, var(--gold1), var(--gold2), var(--gold3), var(--gold4));
  box-shadow:0 8px 20px rgba(185,130,31,.35)
}

/* أزرار */
.row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
a.btn,button.btn{display:inline-block;text-decoration:none;position:relative;border:0;cursor:pointer;
  padding:12px clamp(18px,2.6vw,28px);border-radius:18px;min-width:clamp(150px,22vw,220px);
  font-family:"Noto Kufi Arabic";font-weight:800;font-size:var(--fs-btn);color:#3a2706;letter-spacing:.2px;
  background:linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,0) 45%),
             linear-gradient(180deg,var(--gold1),var(--gold2) 30%,var(--gold3) 62%,var(--gold4));
  box-shadow:0 12px 26px rgba(185,130,31,.30), inset 0 1px 0 rgba(255,255,255,.85);
  transition:transform .15s ease, box-shadow .25s ease, filter .25s ease}
a.btn:before,button.btn:before{content:"";position:absolute;inset:0;border-radius:inherit;box-shadow:inset 0 0 0 1px rgba(185,130,31,.55), inset 0 -8px 14px rgba(0,0,0,.08);pointer-events:none}
a.btn:hover,button.btn:hover{transform:translateY(-2px);filter:saturate(1.06);box-shadow:0 18px 36px rgba(185,130,31,.36), inset 0 1px 0 rgba(255,255,255,.92)}
.btn.black{color:#fff;background:
  linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 45%),
  linear-gradient(180deg,#272727,#161616 55%,#0b0b0b)}

/* بطاقات */
.card{background:#fff;border-radius:22px;box-shadow:var(--sh-xl);padding:var(--space);margin:18px 0}
.section-title{font-family:"Noto Kufi Arabic";font-size:var(--fs-h2);margin:6px 0 12px;text-align:center}
.block-btn{width:100%;padding:18px;border-radius:18px;margin:12px 0;border:0;cursor:pointer;
  font-family:"Noto Kufi Arabic";font-size:clamp(20px,2.6vw,28px);font-weight:800;color:#3a2706;
  background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,0) 40%),
             linear-gradient(180deg, var(--gold1), var(--gold2) 30%, var(--gold3) 60%, var(--gold4));
  box-shadow:0 12px 26px rgba(185,130,31,.28), inset 0 1px 0 rgba(255,255,255,.78)}
.label{font-weight:700;margin-bottom:6px}
input,select{width:100%;padding:14px;border:1px solid #ead79f;border-radius:14px;background:#fff;font-size:clamp(14px,1.4vw,18px);box-shadow:inset 0 1px 3px rgba(0,0,0,.03)}
.hidden{display:none}

/* الحديث على الرئيسية */
.hadith-box{
  margin:16px auto 0;max-width:1100px;padding:clamp(14px,2vw,20px);
  border-radius:18px;text-align:right;
  background: radial-gradient(160% 120% at 18% -30%, rgba(255,255,255,.55), transparent 55%),
             linear-gradient(180deg, var(--gold1), var(--gold2) 56%, var(--gold3));
  border:1px solid rgba(185,130,31,.35);box-shadow:var(--sh-md);color:#2b1f08
}
.hadith-box .q{font-family:"Noto Kufi Arabic",sans-serif;font-size:clamp(16px,1.6vw,19px);line-height:2.1;text-align:justify;text-justify:inter-word}
.hadith-box .src{margin-top:8px;font-size:clamp(12px,1.2vw,13px);text-align:center;opacity:.9}

/* الدعاء */
.dua-text{font-family:"Noto Kufi Arabic",sans-serif;font-size:clamp(14px,1.4vw,17px);line-height:2.15;text-align:justify;text-justify:inter-word;margin-bottom:8px}

/* نتيجة */
.result{background:#fffdf3;border:1px solid #f1e2b0;border-radius:18px;padding:var(--space)}
.item{display:none} /* ← إخفاء الحكم/الملاحظات نهائيًا */
.ayah{font-family:"Tajawal";font-weight:700;font-size:var(--fs-ayah);line-height:2;color:#1b1406;margin-top:10px}
.badge{display:inline-block;background:linear-gradient(180deg,#fff7d4,#fbe9b1);border:1px solid #edd899;border-radius:999px;padding:6px 12px;margin:4px 6px 0 0;white-space:nowrap}
.blackbar{background:#0b0b0b;color:#fff;border-radius:12px;padding:10px 12px;margin:-6px 0 10px;overflow:auto}
.verse-card{background:#fff;border-radius:16px;border:1px solid #eee;box-shadow:var(--sh-md);padding:12px;margin:10px 0;cursor:pointer}
.verse-card:hover{box-shadow:0 18px 32px rgba(0,0,0,.12)}
@media (min-width:900px){ #search .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px} }
.footer{margin-top:26px;text-align:center}
.credit{display:inline-block;background:linear-gradient(180deg,#1a1a1a,#000);color:#fff;padding:10px 18px;border-radius:999px;border:1px solid rgba(255,255,255,.08);box-shadow:0 12px 26px rgba(0,0,0,.35)}

/* عرض الأقسام */
section.view{display:none}
section.view.active{display:block}

/* مودال */
.app-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
.app-modal.hidden{display:none}
.app-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
.app-card{position:relative;width:min(92vw,520px);padding:20px 18px 16px;border-radius:22px;background:linear-gradient(180deg,#1f1f27,#15151c);color:#fff;box-shadow:var(--sh-xl);border:1px solid #2b2b36;text-align:center}
.app-ttl{margin:6px 0 8px;font-size:1.25rem;font-weight:800;font-family:"Noto Kufi Arabic"}
.app-msg{margin:0 6px 16px;line-height:1.9;color:#c9c9d3}
.app-btn{display:block;width:100%;padding:12px 18px;font-size:1.05rem;font-weight:800;border:0;border-radius:16px;cursor:pointer;color:#1b1b22;background:linear-gradient(180deg,var(--gold1),var(--gold2) 60%,var(--gold3));box-shadow:0 6px 16px rgba(205,163,73,.35)}
.app-ico{width:64px;height:64px;margin:4px auto 8px;border-radius:50%;display:grid;place-items:center;font-size:34px;color:#1b1b22;background:linear-gradient(180deg,var(--gold1),var(--gold2));box-shadow:0 6px 16px rgba(205,163,73,.35)}
</style>

<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","name":"الخِيرة بالقرآن","url":"https://example.com/","potentialAction":{"@type":"SearchAction","target":"https://example.com/#search","query-input":"required name=query"}}
</script>
</head>
<body>
<div class="container">

  <div class="medallion" aria-hidden="true"></div>

  <!-- الرئيسية -->
  <section id="home" class="hero view active" aria-labelledby="title">
    <h1 id="title" class="title">الخِيرة بالقرآن</h1>
    <div class="divider" aria-hidden="true"></div>
    <nav class="row" style="margin-top:12px" aria-label="التنقّل">
      <a class="btn" href="#khira">خيرة جديدة</a>
      <a class="btn black" href="#search">بحث</a>
    </nav>
    <div class="hadith-box" id="hadithBox">
      <div class="q" id="hadithText"></div>
      <div class="src" id="hadithSrc"></div>
    </div>
  </section>

  <!-- الخيرة -->
  <section id="khira" class="card view" aria-labelledby="khiraTitle">
    <h2 id="khiraTitle" class="section-title">مراحل الخِيرة</h2>
    <ol style="margin:0 0 10px 0;line-height:2">
      <li>الأفضل الطهارة بالوضوء أو الغُسل، مع النيّة لله تعالى.</li>
      <li>قراءة الدعاء المأثور:</li>
    </ol>
    <div class="hadith-box" style="margin-top:10px">
      <div class="dua-text">
        اللّهم إنّي أستخيرُكَ بعِلمِكَ، وأستقدِرُكَ بقُدرَتِكَ، وأسألُكَ من فضلكَ العظيم، فإنّكَ تقدِرُ ولا أقدِر، وتعلَمُ ولا أعلَم، وأنتَ علّامُ الغُيوب...
      </div>
      <div class="src">دعاء الاستخارة</div>
    </div>
    <ol start="3" style="margin:10px 0 0;line-height:2">
      <li>الصلاة على محمد وآل محمد.</li>
      <li>اضغط <b>استخارة</b> لتظهر النتيجة (اليمين فقط).</li>
    </ol>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="doBtn" type="button">استخارة</button>
      <a class="btn black" href="#home">رجوع</a>
    </div>

    <div id="res-box" class="result hidden" style="margin-top:12px">
      <div id="res-tags"></div>
      <!-- أخفينا الحكم/الملاحظات نهائيًا -->
      <div class="item"><b>الخيرة:</b> <span id="vVerdict">—</span> · <b>الملاحظات:</b> <span id="vNotes">—</span></div>
      <div class="item"><b>الصفحة:</b> <span id="vPage">—</span> · <span id="vSA">—</span></div>
      <div class="blackbar">السطر الأول من الصفحة</div>
      <div id="res-text" class="ayah">—</div>
    </div>
  </section>

  <!-- البحث -->
  <section id="search" class="card view" aria-labelledby="searchTitle">
    <h2 id="searchTitle" class="section-title">صفحة البحث</h2>

    <div class="grid">
      <div>
        <button class="block-btn" type="button" data-open="pBox">رقم الصفحة</button>
        <div id="pBox" class="card hidden">
          <div class="label">اليمين فقط (١–٦٠٣ أعداد فردية):</div>
          <!-- يقبل عربي/إنجليزي/فارسي -->
          <input id="pageInput" type="text" inputmode="numeric" placeholder="مثال: ٣١١">
          <div class="row" style="margin-top:10px">
            <button class="btn" id="lookupBtn" type="button">بحث</button>
            <button class="btn black" type="button" data-close="pBox">إغلاق</button>
          </div>
        </div>

        <button class="block-btn" type="button" data-open="kBox">كلمات (عربي فقط)</button>
        <div id="kBox" class="card hidden">
          <div class="label">اكتب بالعربية فقط؛ البحث يعمل تلقائيًا.</div>
          <input id="kwInput" type="text" placeholder="مثال: رحمة، نصر، هلاك">
          <!-- زر البحث أُلغي عمليًا، سنخفيه للحفاظ على الشكل -->
          <div class="row" style="margin-top:10px;display:none">
            <button class="btn" id="kwBtn" type="button">بحث</button>
          </div>
        </div>
      </div>

      <div>
        <button class="block-btn" type="button" data-open="sBox">السورة والآية</button>
        <div id="sBox" class="card hidden">
          <div class="label">اختر سورة لعرض الآيات على صفحات فردية:</div>
          <div class="row">
            <select id="suraSelect" aria-label="اختيار سورة"></select>
            <button class="btn" id="suraBtn" type="button">عرض الآيات</button>
            <button class="btn black" type="button" data-close="sBox">إغلاق</button>
          </div>
          <div id="versesList" class="result hidden" style="margin-top:10px">
            <div class="blackbar">آيات هذه السورة على صفحات فردية</div>
            <div id="versesWrap"></div>
            <div class="badge">اضغط على بطاقة الآية لعرض آية الصفحة</div>
          </div>
        </div>
      </div>
    </div>

    <div id="searchResult" class="result hidden" style="margin-top:12px">
      <div id="searchTags"></div>
      <!-- إخفاء الخيرة/الملاحظات أيضًا -->
      <div class="item">
        <b>الصفحة:</b> <span id="sPage">—</span> · <span id="sSA">—</span>
      </div>
      <div class="blackbar">السطر الأول من الصفحة</div>
      <div id="searchText" class="ayah">—</div>
    </div>

    <div class="row" style="margin-top:6px">
      <a class="btn black" href="#home">رجوع</a>
    </div>
  </section>

  <div class="footer">
    <span class="credit">برمجة وتطوير: فاضل الريس</span>
  </div>
</div>

<!-- مودال -->
<div id="appModal" class="app-modal hidden" dir="rtl" role="dialog" aria-modal="true">
  <div class="app-backdrop" data-close></div>
  <div class="app-card">
    <div class="app-ico">!</div>
    <h3 class="app-ttl" id="mTitle">تنبيه</h3>
    <div class="app-msg" id="mMsg">—</div>
    <button class="app-btn" id="mOk" data-close>حسنًا</button>
  </div>
</div>

<script>
/* ===== تنقّل ===== */
function resetKhira(){
  const bx=document.getElementById('res-box');
  if(bx) bx.classList.add('hidden');
  ['vVerdict','vNotes','vPage','vSA','res-text','res-tags'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(id==='res-tags') el.innerHTML=''; else el.textContent='—';
  });
}
function resetSearch(){
  ['pBox','kBox','sBox'].forEach(id=>{const el=document.getElementById(id); if(el) el.classList.add('hidden');});
  const sRes=document.getElementById('searchResult'); if(sRes) sRes.classList.add('hidden');
  const vList=document.getElementById('versesList'); if(vList) vList.classList.add('hidden');
  const vWrap=document.getElementById('versesWrap'); if(vWrap) vWrap.innerHTML='';
  const pg=document.getElementById('pageInput'); if(pg) pg.value='';
  const kw=document.getElementById('kwInput'); if(kw) kw.value='';
  const ss=document.getElementById('suraSelect'); if(ss) ss.value='';
  ['sPage','sSA','sVerdict','sNotes','searchText','searchTags'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(id==='searchTags') el.innerHTML=''; else el.textContent='—';
  });
}
function activate(id){
  document.querySelectorAll('section.view').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id||'home'); if(el) el.classList.add('active');
  if(id==='khira') resetKhira();
  if(id==='search') resetSearch();
}
function showFromHash(){ const id=(location.hash||'#home').slice(1); activate(id); }
window.addEventListener('hashchange',showFromHash);

/* ===== أدوات ===== */
const $=id=>document.getElementById(id);

/* أرقام: 0-9 + ٠-٩ + ۰-۹ → غربية */
function toWesternDigits(s=""){
  return String(s)
    .replace(/[٠-٩]/g, d=>"٠١٢٣٤٥٦٧٨٩".indexOf(d))   // عربي
    .replace(/[۰-۹]/g, d=>"۰۱۲۳۴۵۶۷۸۹".indexOf(d));  // فارسي/أردي
}
const toArabicDigits = (x) => String(x ?? "—").replace(/[0-9]/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);

/* تطبيع عربي للكلمات (أدق + يعالج سبإ/سبء) */
function arNormalizeBase(str=""){
  return String(str)
    .replace(/[\u064B-\u0652\u0670\u0640]/g,'')   // حركات + ألف خنجرية + تطويل
    .replace(/[إأآٱ]/g,'ا')                       // ألف مهموزة → ا
    .replace(/ى/g,'ي')                            // ى → ي
    .replace(/ة/g,'ه')                            // ة → ه
    .replace(/[ؤئ]/g,'ء')                         // همزات على واو/ياء → ء
    .trim();
}
function arNormalizeNoHamza(str=""){
  return arNormalizeBase(str).replace(/ء/g,'');    // إزالة الهمزة تمامًا (حالة بديلة)
}

/* مودال */
(function(){
  const modal=$('appModal'), ttl=$('mTitle'), msg=$('mMsg');
  function uiAlert({title='تنبيه', message='—', okText='حسنًا'}={}){
    ttl.textContent=title; msg.innerHTML=message;
    modal.classList.remove('hidden'); $('mOk').textContent=okText;
  }
  function close(){ modal.classList.add('hidden'); }
  modal.querySelectorAll('[data-close]').forEach(el=>el.addEventListener('click',close));
  document.addEventListener('keydown',e=>{ if(e.key==='Escape'&&!modal.classList.contains('hidden')) close(); });
  window.uiAlert=uiAlert;
})();

/* أسماء السور */
const SURAH=["","الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة","يونس","هود","يوسف","الرعد","إبراهيم","الحجر","النحل","الإسراء","الكهف","مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل","القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبإ","فاطر","يس","الصافات","ص","الزمر","غافر","فصلت","الشورى","الزخرف","الدخان","الجاثية","الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر","الرحمن","الواقعة","الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون","التغابن","الطلاق","التحريم","الملك","القلم","الحاقة","المعارج","نوح","الجن","المزمل","المدثر","القيامة","الإنسان","المرسلات","النبإ","النازعات","عبس","التكوير","الانفطار","المطففين","الانشقاق","البروج","الطارق","الأعلى","الغاشية","الفجر","البلد","الشمس","الليل","الضحى","الشرح","التين","العلق","القدر","البينة","الزلزلة","العاديات","القارعة","التكاثر","العصر","الهمزة","الفيل","قريش","الماعون","الكوثر","الكافرون","النصر","المسد","الإخلاص","الفلق","الناس"];
window.SURAH=SURAH;

/* جدول مختصر (للبحث بالكلمات فقط). عرض النتيجة لا يعتمد عليه الآن */
window.PAGE_RESULT={51:"غير جيدة والنتيجة فيها ندم وخسارة",55:"ممتازة – فيها بركة وتوفيق",71:"وسط وفيها رحمة",73:"ممتازة – نعمة قريبة",313:"ممتازة جدًا"};

/* جلب أول آية في الصفحة */
async function firstAyahByPage(page){
  const pg=Number(page);
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/page/${pg}/quran-uthmani`,{cache:'no-store'});
    if(r.ok){
      const j=await r.json(); const ay=j?.data?.ayahs?.[0];
      if(ay) return { text: ay.text||null, sura: Number(ay.surah?.number)||null, ayah: Number(ay.numberInSurah)||null };
    }
  }catch(_){}
  try{
    const r2=await fetch(`https://api.quran.com/api/v4/verses/by_page/${pg}?language=ar&fields=text_uthmani,verse_key,chapter_id,page_number`,{cache:'no-store'});
    if(r2.ok){
      const j2=await r2.json(); const v=j2?.verses?.[0];
      if(v){
        const parts=String(v.verse_key||"").split(":");
        const s=Number(v.chapter_id||parts[0])||null;
        const a=Number(parts[1])||null;
        return { text:v.text_uthmani||v.text||null, sura:s, ayah:a };
      }
    }
  }catch(_){}
  return {text:null,sura:null,ayah:null};
}

/* عرض النتيجة (آية فقط) */
function renderAyah(target, page, ay){
  const suraName=window.SURAH?.[Number(ay?.sura)] || (ay?.sura ? `سورة رقم ${toArabicDigits(ay.sura)}` : "—");
  const ayahNo=ay?.ayah ?? "—";
  const text=ay?.text || "(تعذّر جلب نص الآية الآن)";

  const tagsHtml = `
    <span class="badge">صفحة: ${toArabicDigits(page)}</span>
    <span class="badge">${suraName}</span>
    <span class="badge">آية ${toArabicDigits(ayahNo)}</span>
    <span class="badge">يمين · السطر الأول</span>
  `;

  if(target==="kh"){
    $('vPage').textContent=toArabicDigits(page);
    $('vSA').textContent=`${suraName} - الآية ${toArabicDigits(ayahNo)}`;
    $('res-text').textContent=text;
    $('res-tags').innerHTML=tagsHtml;
    document.getElementById('res-box').classList.remove('hidden');
    document.getElementById('res-box').scrollIntoView({behavior:"smooth",block:"center"});
  }else{
    $('sPage').textContent=toArabicDigits(page);
    $('sSA').textContent=`${suraName} - الآية ${toArabicDigits(ayahNo)}`;
    $('searchText').textContent=text;
    $('searchTags').innerHTML=tagsHtml;
    document.getElementById('searchResult').classList.remove('hidden');
    document.getElementById('searchResult').scrollIntoView({behavior:"smooth",block:"center"});
  }
}

/* تحقق الصفحة: أي صفحة فردية 1–603 مسموح الآن */
function normalizePageInput(v){ return Number(toWesternDigits(String(v).trim())); }
function validateOdd603(n){ return Number.isInteger(n) && n>=1 && n<=603 && n%2===1; }

/* أزرار وإدخال */
document.addEventListener('DOMContentLoaded',()=>{
  showFromHash(); if(!document.querySelector('section.view.active')) activate('home');

  const HADITHS=[
    {t:"قال الإمام الصادق (ع): من شقاء عبدي أن يعمل الأعمال ولا يستخير بي.", s:"ميزان الحكمة"},
    {t:"قال الإمام الصادق (ع): من دخل في أمر بغير استخارة ثم ابتلي لم يؤجر.", s:"ميزان الحكمة"},
    {t:"قال الإمام علي (ع): ما حار من استخار، ولا ندم من استشار.", s:"ميزان الحكمة"},
    {t:"قال رسول الله (ص): من سعادة ابن آدم استخارته الله ورضاه بما قضى الله.", s:"ميزان الحكمة"}
  ];
  const h=HADITHS[Math.floor(Math.random()*HADITHS.length)];
  $('hadithText').textContent=h.t; $('hadithSrc').textContent=h.s;

  const on=(id,ev,fn)=>{const e=$(id); if(e) e.addEventListener(ev,fn);};
  on('doBtn','click',async()=>{
    const page = (Math.floor(Math.random()*302)*2)+1; // أي صفحة فردية بين 1 و603
    const ay=await firstAyahByPage(page);
    renderAyah("kh", page, ay);
  });
  on('lookupBtn','click',lookupByPage);
  on('suraBtn','click',loadSuraOddPageVerses);

  // Enter للبحث بالرقم
  $('pageInput').addEventListener('keydown',e=>{ if(e.key==='Enter') lookupByPage(); });

  // البحث بالكلمة تلقائيًا (بدون زر) — بالعربي فقط
  const kw = $('kwInput');
  let t=null;
  kw.addEventListener('input',()=>{
    clearTimeout(t);
    t=setTimeout(searchByKeyword, 350); // debounce
  });
});

/* بحث برقم الصفحة: يقبل عربي/إنجليزي/فارسي، ويسمح بأي صفحة فردية صحيحة */
async function lookupByPage(){
  const raw=$('pageInput')?.value??"";
  const n=normalizePageInput(raw);
  if(!validateOdd603(n)){
    uiAlert({title:'صفحة البحث',message:'أدخل رقمًا <b>فرديًا</b> بين <span dir="rtl">١ و٦٠٣</span> (اليمين فقط).'});
    return;
  }
  const ay=await firstAyahByPage(n);
  renderAyah("sr", n, ay);
}

/* بحث بالكلمات — عربي فقط + تطبيعين (مع ومن دون همزة) + بدون زر + بدون إظهار الملاحظة في النتائج */
function searchByKeyword(){
  const raw=($('kwInput')?.value||"").trim();
  const list=document.getElementById('versesList');
  const wrap=document.getElementById('versesWrap');
  if(!raw){ wrap.innerHTML=''; list.classList.add('hidden'); return; }
  if(/[A-Za-z]/.test(raw)){ /* تجاهل الإنجليزي بلا تنبيه */ return; }

  const q1 = arNormalizeBase(raw);
  const q2 = arNormalizeNoHamza(raw);

  const out=[];
  for(const [k,v] of Object.entries(window.PAGE_RESULT||{})){
    const nv = String(v);
    const n1 = arNormalizeBase(nv);
    const n2 = arNormalizeNoHamza(nv);
    if(n1.includes(q1) || n2.includes(q2)) out.push(Number(k));
  }

  wrap.innerHTML='';
  if(!out.length){ wrap.innerHTML="<div class='badge'>لا توجد نتائج مطابقة.</div>"; list.classList.remove('hidden'); return; }

  out.sort((a,b)=>a-b).forEach(p=>{
    const d=document.createElement("div"); d.className="verse-card";
    d.innerHTML=`<div style="font-weight:800">صفحة ${toArabicDigits(p)}</div>`;
    d.onclick=async()=>{ const ay=await firstAyahByPage(p); renderAyah("sr", p, ay); };
    wrap.appendChild(d);
  });
  list.classList.remove('hidden');
}

/* آيات السورة على صفحات فردية — بدون شرط PAGE_RESULT */
async function loadSuraOddPageVerses(){
  const s=Number($('suraSelect')?.value||0); if(!s){uiAlert({title:'السورة والآية',message:'اختر سورة.'});return;}
  let verses=[];
  try{
    const r=await fetch(`https://api.quran.com/api/v4/verses/by_chapter/${s}?language=ar&fields=text_uthmani,verse_key,page_number&per_page=300`,{cache:'no-store'});
    if(r.ok){const j=await r.json();verses=j.verses||[];}
  }catch(_){}
  const filtered=verses.filter(v=>Number(v?.page_number)%2===1);
  const w=$('versesWrap'); const list=$('versesList'); w.innerHTML="";
  if(!filtered.length){w.innerHTML="<div class='badge'>لا توجد آيات على صفحات فردية لهذه السورة.</div>"; list.classList.remove("hidden"); return;}
  filtered.forEach(v=>{
    const page=Number(v.page_number), ay=Number(String(v.verse_key||"").split(":")[1]||v.verse_number||""); 
    const text=v.text_uthmani||v.text||"";
    const card=document.createElement("div"); card.className="verse-card";
    card.innerHTML=`<div style="font-weight:800">الآية ${toArabicDigits(ay)}</div>
                    <div class="badge">سورة ${window.SURAH?.[s]||toArabicDigits(s)} · صفحة ${toArabicDigits(page)}</div>
                    <div style="font-family:'Noto Kufi Arabic',sans-serif;font-size:clamp(16px,1.6vw,20px);line-height:2;margin-top:6px">${text}</div>`;
    card.onclick=async()=>{ const a=await firstAyahByPage(page); renderAyah("sr", page, a); };
    w.appendChild(card);
  });
  list.classList.remove("hidden");
}
</script>
</body>
</html>
