<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ â€” ØªÙ‚Ø¯ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ (UN/WB)</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f6f8; --ink:#111827; --muted:#6b7280;
    --card:#ffffff; --line:#e5e7eb;
    --gold:#b58900; --gold-soft:#f5d574;
    --ocean:#0b4d8a; --emerald:#059669; --crimson:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:"Cairo",sans-serif; background:var(--bg); color:var(--ink)}
  header{text-align:center; padding:24px 12px}
  .brand{font-family:"Amiri",serif; font-size:clamp(26px,4.5vw,42px); color:var(--gold)}
  .tag{margin-top:6px; font-size:14px; color:var(--muted)}
  .shell{max-width:980px; margin:0 auto; padding:0 16px}
  .hero{background:var(--card); border:1px solid var(--line); border-radius:20px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05)}
  .row{display:grid; gap:16px}
  @media(min-width:920px){ .row{grid-template-columns:1.2fr .8fr} }
  .field{display:flex; flex-direction:column; gap:8px; margin-bottom:12px}
  .center{text-align:center}
  .date-grid{display:flex; justify-content:center; gap:8px; flex-wrap:wrap}
  .date-grid input[type="number"]{
    width:110px; padding:10px; border:1px solid var(--line); border-radius:10px; text-align:center; font-family:monospace;
  }
  .seg{display:flex; gap:6px; justify-content:center; flex-wrap:wrap}
  .seg button{flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--line); background:#f9fafb; cursor:pointer; max-width:160px}
  .seg button.on{background:var(--gold); color:#fff; border-color:var(--gold)}
  .btn{padding:12px 20px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--gold),var(--gold-soft)); color:#111; font-weight:700; display:block; margin:0 auto}
  .badge{display:inline-block; padding:10px 14px; border-radius:10px; margin-top:12px}
  .ok{background:#eff6ff; color:var(--ocean)}
  .no{background:#fee2e2; color:var(--crimson)}

  .kpi{display:grid; gap:10px; grid-template-columns:repeat(2,1fr); margin-top:10px}
  .k{background:#f9fafb; border:1px solid var(--line); border-radius:10px; padding:10px; text-align:center}
  .k .v{font-weight:700; font-size:18px}

  .eqwrap{display:none; margin-top:8px}
  .eqbox{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; text-align:center}
  .eqbox .v{font-weight:700; font-size:16px; margin-bottom:4px; color:#111}
  .eqbox .l{font-size:12px; color:#6b7280}

  .deck{display:grid; gap:12px; grid-template-columns:1fr; margin-top:16px}
  @media(min-width:860px){ .deck{grid-template-columns:repeat(3,1fr)} }
  .card{background:#fdfdfd; border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .card h3{margin:0 0 6px; font-family:"Amiri",serif; color:var(--gold)}
  .card p{margin:0; font-size:14px; color:#374151; line-height:1.6}
  .card ul{margin:8px 0 0; padding-inline-start:20px; color:#374151}

  .counter{
    margin:14px auto 0; max-width:720px;
    background:linear-gradient(90deg, #fff7e6, #fff);
    border:1px solid #f3e8c8; border-radius:16px; padding:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.05);
  }
  .counter.alt{
    background:linear-gradient(90deg, #eef6ff, #fff);
    border-color:#cfe6ff;
  }
  .counter h4{margin:0 0 8px; font-family:"Amiri",serif; color:#8b6a00; text-align:center}
  .counter.alt h4{color:#0b4d8a}
  .cflex{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .cbox{min-width:110px; padding:10px 12px; border:1px solid var(--line); background:#fff; border-radius:12px; text-align:center}
  .cbox .num{font-weight:800; font-size:22px}
  .cbox .lbl{font-size:12px; color:#6b7280}

  .sharebar{display:flex; justify-content:center; gap:8px; margin:16px 0; flex-wrap:wrap}
  .iconbtn{width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; border:1px solid var(--line); background:#fff; cursor:pointer}
  .iconbtn svg{width:18px; height:18px; fill:#374151}
  footer{text-align:center; margin:12px 0 24px; font-size:12px; color:#6b7280}
  .ghost-link{color:inherit; text-decoration:none; cursor:default}
  .ghost-link:visited{color:inherit}

  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    background:#ffffff; color:#111827; border:1px solid var(--line); box-shadow:0 8px 24px rgba(0,0,0,.12);
    border-radius:14px; padding:12px 14px; min-width:260px; max-width:92vw; z-index:9999; opacity:0; transition:.25s ease;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .toast .title{font-weight:700; color:var(--gold); margin-bottom:4px; font-family:"Amiri",serif}
  .toast.error{border-color:#fecaca; box-shadow:0 8px 24px rgba(220,38,38,.15)}
</style>
</head>
<body>
<header>
  <div class="brand">Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ</div>
  <div class="tag">Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙˆØ§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø© ÙˆØ§Ù„Ù†ÙˆØ¹ ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø£Ù…Ù…ÙŠØ©/Ø­ÙƒÙˆÙ…ÙŠØ©.</div>
</header>

<main class="shell">
  <section class="hero">
    <div class="row">
      <div>
        <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
        <div class="field center">
          <label><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</strong></label>
          <div class="date-grid" dir="ltr">
            <input id="d" type="number" inputmode="numeric" placeholder="Ø§Ù„ÙŠÙˆÙ…"  min="1"  max="31"  autocomplete="off"/>
            <input id="m" type="number" inputmode="numeric" placeholder="Ø§Ù„Ø´Ù‡Ø±" min="1"  max="12"  autocomplete="off"/>
            <input id="y" type="number" inputmode="numeric" placeholder="Ø§Ù„Ø³Ù†Ø©" min="1900" max="2100" autocomplete="off"/>
          </div>
        </div>

        <!-- Ø§Ù„Ø¯ÙˆÙ„Ø© -->
        <div class="field center">
          <label><strong>Ø§Ù„Ø¯ÙˆÙ„Ø©</strong></label>
          <div class="seg" id="countrySeg"></div>
        </div>

        <!-- Ø§Ù„Ù†ÙˆØ¹ -->
        <div class="field center">
          <label><strong>Ø§Ù„Ù†ÙˆØ¹</strong></label>
          <div class="seg" id="sexSeg">
            <button type="button" class="on" data-sex="male">Ø±Ø¬Ù„</button>
            <button type="button" data-sex="female">Ø§Ù…Ø±Ø£Ø©</button>
          </div>
        </div>

        <!-- Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© -->
        <div class="field center">
          <label><strong>Ø¹ÙˆØ§Ù…Ù„ Ù…Ø¤Ø«Ø±Ø©</strong></label>
          <div class="seg" id="smokeSeg">
            <button type="button" class="on" data-smoke="no">ØºÙŠØ± Ù…Ø¯Ø®Ù‘Ù†</button>
            <button type="button" data-smoke="yes">Ù…Ø¯Ø®Ù‘Ù†</button>
          </div>
          <div style="margin-top:8px" class="seg" id="chronicSeg">
            <button type="button" class="on" data-chronic="no">Ù„Ø§ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©</button>
            <button type="button" data-chronic="yes">Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©</button>
          </div>
        </div>

        <button class="btn" id="calc">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ</button>
      </div>

      <div>
        <!-- Ø®Ù„Ø§ØµØ© -->
        <div id="verdict" class="badge ok" style="display:none"></div>

        <!-- Ù…Ø¶Ù‰ Ù…Ù† Ø¹Ù…Ø±Ùƒ -->
        <div id="counterDone" class="counter" style="display:none">
          <h4>Ù…Ø¶Ù‰ Ù…Ù† Ø¹Ù…Ø±Ùƒ</h4>
          <div class="cflex">
            <div class="cbox"><div class="num" id="cntY">0</div><div class="lbl">Ø³Ù†Ø©</div></div>
            <div class="cbox"><div class="num" id="cntM">0</div><div class="lbl">Ø´Ù‡Ø±</div></div>
            <div class="cbox"><div class="num" id="cntD">0</div><div class="lbl">ÙŠÙˆÙ…</div></div>
          </div>
        </div>

        <!-- Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ -->
        <div id="counterRemain" class="counter alt" style="display:none">
          <h4>Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ</h4>
          <div class="cflex">
            <div class="cbox"><div class="num" id="remY">0</div><div class="lbl">Ø³Ù†Ø©</div></div>
            <div class="cbox"><div class="num" id="remM">0</div><div class="lbl">Ø´Ù‡Ø±</div></div>
            <div class="cbox"><div class="num" id="remD">0</div><div class="lbl">ÙŠÙˆÙ…</div></div>
          </div>
        </div>

        <!-- Ù…Ø¤Ø´Ø±Ø§Øª -->
        <div id="kpis" class="kpi" style="display:none">
          <div class="k"><div class="v" id="ageSolar">â€”</div><div>Ø¹ÙÙ…Ø±Ùƒ Ø§Ù„Ø¢Ù† (Ø³Ù†ÙˆØ§Øª Ù…ÙŠÙ„Ø§Ø¯ÙŠØ©)</div></div>
          <div class="k"><div class="v" id="lifeExp">â€”</div><div>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø³Ù†ÙˆØ§Øª)</div></div>
        </div>

        <!-- ØªØ§Ø±ÙŠØ® Ø¨Ù„ÙˆØº Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ -->
        <div id="eqwrap" class="eqwrap">
          <div class="eqbox">
            <div class="v" id="eqVal">â€”</div>
            <div class="l" id="eqLbl">ØªØ§Ø±ÙŠØ® Ø¨Ù„ÙˆØº Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (ØªÙ‚Ø±ÙŠØ¨ Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ù†ØµØ§Ø¦Ø­ -->
    <div id="advice" class="deck" style="display:none"></div>
  </section>

  <!-- Ù…Ø´Ø§Ø±ÙƒØ© -->
  <div class="sharebar" id="sharebar">
    <a class="iconbtn" id="shareWA" title="ÙˆØ§ØªØ³Ø§Ø¨" target="_blank" aria-label="WhatsApp">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 0a12 12 0 00-10 18.3L1 23l4.9-1A12 12 0 1012 0zm6.5 17.2c-.3.8-1.7 1.6-2.4 1.6-.6 0-1.4.1-3.8-1-3.2-1.4-5.3-4.6-5.5-4.8-.1-.2-1.3-1.7-1.3-3.2 0-1.6.8-2.4 1.1-2.7.3-.3.7-.4 1-.4h.8c.2 0 .6 0 .9.7.3.8 1.1 2.7 1.2 2.9.1.2.2.5 0 .8-.2.3-.3.5-.6.8-.3.3-.6.6-.2 1.2.4.6 1.7 2.8 4 3.8 2.9 1.2 3 .8 3.5.8.5 0 1.8-.8 2.1-1.5.2-.7 1-1.6 1.3-1.8.2-.1.3-.2.5-.1l1 .5c.3.1.5.3.5.5-.1.4-.7 2-1 2.7z"/></svg>
    </a>
    <a class="iconbtn" id="shareTG" title="ØªÙŠÙ„ÙŠØºØ±Ø§Ù…" target="_blank" aria-label="Telegram">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 18.2l-.3 4.1c.4 0 .6-.2.8-.4l2-1.8 4.1 3c.7.4 1.3.2 1.5-.7L22 6.2c.2-1.1-.4-1.5-1.1-1.2L2.3 11.1c-1.1.4-1 1.3 0 1.6l4.1 1.2 9.4-5.9c.4-.3.9-.1.5.2L9 18.2z"/></svg>
    </a>
    <a class="iconbtn" id="shareX" title="X" target="_blank" aria-label="X">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 2h4.7l5 6.8L18.7 2H22l-7.8 9.1L22 22h-4.8l-5.4-7.2L6 22H2.1l8.3-9.8L3 2z"/></svg>
    </a>
    <a class="iconbtn" id="shareFB" title="ÙÙŠØ³Ø¨ÙˆÙƒ" target="_blank" aria-label="Facebook">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 10-11.6 9.9v-7H7.7V12h2.7V9.8c0-2.7 1.6-4.2 4-4.2 1.2 0 2.5.2 2.5.2v2.7h-1.4c-1.4 0-1.9.9-1.9 1.8V12h3.2l-.5 2.9h-2.7v7A10 10 0 0022 12z"/></svg>
    </a>
    <button class="iconbtn" id="copyLink" title="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·" aria-label="Copy Link">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H8C6.3 1 5 2.3 5 4v12c0 1.7 1.3 3 3 3h8c1.7 0 3-1.3 3-3V4c0-1.7-1.3-3-3-3zm1 15c0 .6-.4 1-1 1H8c-.6 0-1-.4-1-1V4c0-.6.4-1 1-1h8c.6 0 1 .4 1 1v12zM7 20c0 .6.4 1 1 1h8v2H8c-1.7 0-3-1.3-3-3v-2h2v2z"/></svg>
    </button>
  </div>

  <!-- Ù…ØµØ§Ø¯Ø± -->
  <footer>
    <div style="margin-top:8px; line-height:1.7">
      <strong>Ø§Ù„Ù…ØµØ§Ø¯Ø±:</strong>
      Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…ÙØ´ØªÙ‚Ø© Ù…Ù† ØªÙ‚Ø¯ÙŠØ±Ø§Øª <a href="https://population.un.org/wpp/" target="_blank" rel="noopener">WPP-2024 (UN)</a> ÙˆÙˆØ§Ø¬Ù‡Ø© <a href="https://data.worldbank.org/indicator/SP.DYN.LE00.IN" target="_blank" rel="noopener">Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¯ÙˆÙ„ÙŠ</a>ØŒ ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø¯ÙˆÙ„ÙŠØ© Ù…Ø¬Ù…Ù‘Ø¹Ø© Ù…Ø«Ù„ <a href="https://www.worldometers.info/demographics/life-expectancy/" target="_blank" rel="noopener">Worldometers</a>.<br/>
      ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ¯Ø®ÙŠÙ†: Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªÙˆØ³Ø· ÙŠÙ‚Ù„Ù‘Øµ Ø§Ù„Ø¹Ù…Ø± Ø¨Ù†Ø­Ùˆ <strong>10 Ø³Ù†ÙˆØ§Øª</strong> (CDC/NEJM/WHO). Ø±Ø§Ø¬Ø¹: CDC (\"Life expectancy for smokers is at least 10 years shorter\"), WHO (ÙÙˆØ§Ø¦Ø¯ Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹).<br/>
      Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©: ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù…Ø­Ø§ÙØ¸ Ø¹Ø§Ù… (Ù‚Ø¯ ÙŠØ®ØªÙ„Ù Ø¨Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù…Ø±Ø¶ ÙˆØ´Ø¯ØªÙ‡).
    </div>
  </footer>
</main>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" style="display:none">
  <div class="title">ØªÙ†Ø¨ÙŠÙ‡</div>
  <div class="msg">â€”</div>
</div>

<script>
/* ===== Ø«ÙˆØ§Ø¨Øª ÙˆØ­ÙÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
const SOLAR_YEAR = 365.2425;
/* ÙØ¬ÙˆØ© Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø³Ù†ÙˆØ§Øª): ØªÙØ¶Ø§Ù Ù„Ù„Ù†Ø³Ø§Ø¡ ÙˆØªÙØ·Ø±Ø­ Ù…Ù† Ø§Ù„Ø±Ø¬Ø§Ù„ Ø¥Ù† ØºØ§Ø¨Øª Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø© */
const DEFAULT_SEX_GAP = 3.0;

/* Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© + Ø¥ÙŠØ±Ø§Ù† (Ù‚ÙŠÙ…Ø© ÙƒÙ„Ø§ Ø§Ù„Ø¬Ù†Ø³ÙŠÙ† ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù…Ù† UN/WB 2023â€“2024).
   Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„Ø¯Ù‚Ø© Ù„ÙƒÙ„ Ø¯ÙˆÙ„Ø©/Ø¬Ù†Ø³ Ø­Ø¯Ù‘Ø« Ø§Ù„ÙƒØ§Ø¦Ù† Ø¨Ù‚ÙŠÙ… Ø°ÙƒÙˆØ±/Ø¥Ù†Ø§Ø«. */
const LE_DATA = {
  "Algeria": { both: 77.2 },
  "Bahrain": { both: 81.3 },
  "Comoros": { both: 65.3 },
  "Djibouti": { both: 64.7 },
  "Egypt": { both: 71.0 },
  "Iraq": { both: 72.3 },
  "Jordan": { both: 75.7 },
  "Kuwait": { both: 83.0 },
  "Lebanon": { both: 77.8 },
  "Libya": { both: 73.5 },
  "Mauritania": { both: 65.0 },
  "Morocco": { both: 74.0 },
  "Oman": { both: 78.3 },
  "Palestine": { both: 74.2 },
  "Qatar": { both: 81.9 },
  "Saudi Arabia": { both: 78.8 },
  "Somalia": { both: 57.7 },
  "Sudan": { both: 66.0 },
  "Syria": { both: 73.0 },
  "Tunisia": { both: 77.0 },
  "United Arab Emirates": { both: 79.2 },
  "Yemen": { both: 66.1 },
  "Iran": { both: 77.1 }
};

/* ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
const COUNTRY_LABELS = [
  "Algeria","Bahrain","Comoros","Djibouti","Egypt","Iraq","Jordan","Kuwait","Lebanon","Libya",
  "Mauritania","Morocco","Oman","Palestine","Qatar","Saudi Arabia","Somalia","Sudan","Syria",
  "Tunisia","United Arab Emirates","Yemen","Iran"
];

/* Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ£Ø«ÙŠØ±:
   - Ø§Ù„Ù…Ø¯Ø®Ù‘Ù†: -10 Ø³Ù†ÙˆØ§Øª (CDC/NEJM/WHO Ø¥Ø¬Ù…Ø§Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠ)
   - Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©: -3 Ø³Ù†ÙˆØ§Øª (ØªÙ‚Ø¯ÙŠØ± Ù…Ø­Ø§ÙØ¸ Ø¹Ø§Ù… ÙŠØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ø´Ø¯Ø©) */
const PENALTY_SMOKER = 10.0;
const PENALTY_CHRONIC = 3.0;

/* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
const dEl = document.getElementById('d');
const mEl = document.getElementById('m');
const yEl = document.getElementById('y');

const countrySeg = document.getElementById('countrySeg');
const sexSeg = document.getElementById('sexSeg');
const smokeSeg = document.getElementById('smokeSeg');
const chronicSeg = document.getElementById('chronicSeg');

const calcBtn = document.getElementById('calc');
const verdict = document.getElementById('verdict');

const kpis = document.getElementById('kpis');
const ageSolarEl = document.getElementById('ageSolar');
const lifeExpEl = document.getElementById('lifeExp');

const counterDone = document.getElementById('counterDone');
const cntY = document.getElementById('cntY');
const cntM = document.getElementById('cntM');
const cntD = document.getElementById('cntD');

const counterRemain = document.getElementById('counterRemain');
const remY = document.getElementById('remY');
const remM = document.getElementById('remM');
const remD = document.getElementById('remD');

const eqWrap = document.getElementById('eqwrap');
const eqVal = document.getElementById('eqVal');

const adviceDeck = document.getElementById('advice');

const toast = document.getElementById('toast'); const toastMsg = toast.querySelector('.msg');

/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
let selectedCountry = "Bahrain";
let selectedSex = "male";
let isSmoker = "no";
let hasChronic = "no";

/* Ø­Ù‚ÙˆÙ„ Ø±Ù‚Ù…ÙŠØ©: Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· */
[dEl,mEl,yEl].forEach(inp=>{
  inp.addEventListener('input',()=>{ inp.value = inp.value.replace(/\D+/g,''); });
});

/* Ø¨Ù†Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙˆÙ„ */
function buildCountryButtons(){
  countrySeg.innerHTML = '';
  COUNTRY_LABELS.forEach((name, i)=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.textContent = name;
    b.dataset.c = name;
    if(name === selectedCountry) b.classList.add('on');
    b.addEventListener('click', ()=>{
      countrySeg.querySelectorAll('button').forEach(x=>x.classList.remove('on'));
      b.classList.add('on');
      selectedCountry = name;
    });
    countrySeg.appendChild(b);
  });
}
buildCountryButtons();

/* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„ØªØ¯Ø®ÙŠÙ†/Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ */
sexSeg.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click',()=>{
    sexSeg.querySelectorAll('button').forEach(x=>x.classList.remove('on'));
    b.classList.add('on'); selectedSex = b.dataset.sex;
  });
});
smokeSeg.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click',()=>{
    smokeSeg.querySelectorAll('button').forEach(x=>x.classList.remove('on'));
    b.classList.add('on'); isSmoker = b.dataset.smoke;
  });
});
chronicSeg.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click',()=>{
    chronicSeg.querySelectorAll('button').forEach(x=>x.classList.remove('on'));
    b.classList.add('on'); hasChronic = b.dataset.chronic;
  });
});

/* Toast */
let toastTimer=null;
function showToast(message, opts={type:'info', title:'ØªÙ†Ø¨ÙŠÙ‡', timeout:2800}){
  toast.style.display='block';
  toast.classList.remove('error');
  if(opts.type==='error') toast.classList.add('error');
  toast.querySelector('.title').textContent = opts.title || 'ØªÙ†Ø¨ÙŠÙ‡';
  toastMsg.textContent = message;
  requestAnimationFrame(()=>toast.classList.add('show'));
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ toast.classList.remove('show'); }, opts.timeout||2800);
}

/* ØªÙˆØ§Ø±ÙŠØ® */
function daysInMonthUTC(y,m){ return new Date(Date.UTC(y, m, 0)).getUTCDate(); } // m: 1..12
function fmtDate(d){ return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`; }
function diffYMD(fromUTC, toUTCDate){
  let y = toUTCDate.getUTCFullYear() - fromUTC.getUTCFullYear();
  let m = toUTCDate.getUTCMonth() + 1 - (fromUTC.getUTCMonth() + 1);
  let d = toUTCDate.getUTCDate() - fromUTC.getUTCDate();
  if(d < 0){ const prevMonth = new Date(Date.UTC(toUTCDate.getUTCFullYear(), toUTCDate.getUTCMonth(), 0)); d += prevMonth.getUTCDate(); m -= 1; }
  if(m < 0){ m += 12; y -= 1; }
  if(y < 0){ y=0; m=0; d=0; }
  return {y,m,d};
}
function validateFullDate(d,m,y){
  if(!(y>=1900 && y<=2100)) { showToast('Ø£Ø¯Ø®Ù„ Ø³Ù†Ø© ØµØ­ÙŠØ­Ø© Ø¨ÙŠÙ† 1900 Ùˆ 2100.', {type:'error', title:'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ù†Ø©'}); return false; }
  if(!(m>=1 && m<=12))      { showToast('Ø£Ø¯Ø®Ù„ Ø´Ù‡Ø±Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø¨ÙŠÙ† 1 Ùˆ 12.',      {type:'error', title:'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ù‡Ø±'}); return false; }
  if(!(d>=1 && d<=31))      { showToast('Ø£Ø¯Ø®Ù„ ÙŠÙˆÙ…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø¨ÙŠÙ† 1 Ùˆ 31.',       {type:'error', title:'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…'});  return false; }
  const dim = daysInMonthUTC(y, m);
  if(d > dim){ showToast(`Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙŠØ­ØªÙˆÙŠ ${dim} ÙŠÙˆÙ…Ù‹Ø§ ÙÙ‚Ø·. ØµØ­Ù‘Ø­ Ø§Ù„ÙŠÙˆÙ….`, {type:'error', title:'Ø§Ù„ÙŠÙˆÙ… ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø´Ù‡Ø±'}); return false; }
  const dob=new Date(Date.UTC(y, m-1, d));
  const today=new Date();
  if(dob > today){ showToast('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.', {type:'error', title:'ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®'}); return false; }
  return true;
}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¹Ø´Ø±ÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
function calcAgeYears(dobUTC, todayUTC){
  const daySpan=(todayUTC - dobUTC)/(1000*60*60*24);
  return daySpan/SOLAR_YEAR;
}

/* ØªØ§Ø±ÙŠØ® Ø¨Ù„ÙˆØº (Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹) */
function addYearsExact(baseUTC, years){
  const days = Math.round(years * SOLAR_YEAR);
  return new Date(baseUTC.getTime() + days*24*60*60*1000);
}

/* Ù†ØµØ§Ø¦Ø­ Ø§Ù„ÙØ­Øµ */
function buildAdvice(){
  adviceDeck.innerHTML='';
  const mk = (t,html)=>{ const e=document.createElement('div'); e.className='card'; e.innerHTML=`<h3>${t}</h3>${html}`; return e; };

  const gen = mk('ÙØ­ÙˆØµØ§Øª Ø¹Ø§Ù…Ø© Ø¯ÙˆØ±ÙŠØ©', `
    <ul>
      <li>Ø¶ØºØ· Ø§Ù„Ø¯Ù…ØŒ Ø³ÙƒØ± ØµØ§Ø¦Ù…/ØªØ±Ø§ÙƒÙ…ÙŠØŒ Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¯Ù…ØŒ Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…ØŒ Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ±.</li>
      <li>ÙØ­Øµ Ø£Ø³Ù†Ø§Ù† ÙˆÙ†Ø¸Ø± ÙˆØ³Ù…Ø§Ø¹ Ø³Ù†ÙˆÙŠÙ‘Ù‹Ø§ØŒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª.</li>
      <li>Ù†Ø´Ø§Ø· Ø¨Ø¯Ù†ÙŠ Ù…Ù†ØªØ¸Ù… (150 Ø¯Ù‚ÙŠÙ‚Ø©/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„) ÙˆÙ†ÙˆÙ… ÙƒØ§ÙÙ.</li>
    </ul>
  `);
  const men = mk('ÙØ­ÙˆØµØ§Øª Ù…Ù‚ØªØ±Ø­Ø© Ù„Ù„Ø±Ø¬Ø§Ù„', `
    <ul>
      <li>Ø³Ø±Ø·Ø§Ù† Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ†: Ø¨Ø¯Ø¡Ù‹Ø§ Ù…Ù† Ø³Ù† 45â€“50 (Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ©).</li>
      <li>Ø§Ù„Ø¨Ø±ÙˆØ³ØªØ§ØªØ§: PSA/ÙØ­Øµ Ø³Ø±ÙŠØ±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø± ÙˆØ¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·ÙˆØ±Ø©.</li>
      <li>Ø§Ù„Ù‚Ù„Ø¨: ØªØ®Ø·ÙŠØ·/Ø¥ÙŠÙƒÙˆ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£Ø¹Ø±Ø§Ø¶ Ø£Ùˆ Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ©.</li>
    </ul>
  `);
  const women = mk('ÙØ­ÙˆØµØ§Øª Ù…Ù‚ØªØ±Ø­Ø© Ù„Ù„Ù†Ø³Ø§Ø¡', `
    <ul>
      <li>Ø³Ø±Ø·Ø§Ù† Ø§Ù„Ø«Ø¯ÙŠ: ØªØµÙˆÙŠØ± Ø¯ÙˆØ±ÙŠ Ø¨Ø¯Ø¡Ù‹Ø§ Ù…Ù† 40â€“50 Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª.</li>
      <li>Ø¹Ù†Ù‚ Ø§Ù„Ø±Ø­Ù…: Pap/HPV Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©.</li>
      <li>Ù‡Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø¸Ø§Ù…: Ø¨Ø¹Ø¯ Ø³Ù† 50â€“65 Ø£Ùˆ Ø¹Ù†Ø¯ Ø¹ÙˆØ§Ù…Ù„ Ø®Ø·ÙˆØ±Ø©.</li>
    </ul>
  `);
  const life = mk('Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©', `
    <ul>
      <li>Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹ Ø¹Ù† Ø§Ù„ØªØ¯Ø®ÙŠÙ†: ÙŠØ²ÙŠØ¯ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ÙˆÙŠÙ‚Ù„Ù„ Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨/Ø§Ù„Ø³Ø±Ø·Ø§Ù†.</li>
      <li>ØºØ°Ø§Ø¡ Ù…ØªÙˆØ§Ø²Ù† (Ø®Ø¶Ø§Ø±ØŒ ÙØ§ÙƒÙ‡Ø©ØŒ Ø­Ø¨ÙˆØ¨ ÙƒØ§Ù…Ù„Ø©ØŒ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ø­/Ø§Ù„Ø³ÙƒØ±/Ø§Ù„Ø¯Ù‡ÙˆÙ† Ø§Ù„Ù…Ø´Ø¨Ø¹Ø©).</li>
      <li>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØªØ±ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø¬ÙŠØ¯Ø©ØŒ ÙƒØ´Ù Ù…Ø¨ÙƒØ± Ø¹Ù†Ø¯ Ø£ÙŠ Ø¹ÙØ±ÙØ¶ Ù…Ù‚Ù„Ù‚.</li>
    </ul>
  `);
  adviceDeck.append(gen, men, women, life);
  adviceDeck.style.display='grid';
}

/* Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
document.getElementById('calc').addEventListener('click', ()=>{
  const d=parseInt(dEl.value,10), m=parseInt(mEl.value,10), y=parseInt(yEl.value,10);
  if(!validateFullDate(d,m,y)) return;

  const dobUTC=new Date(Date.UTC(y, m-1, d));
  const today=new Date();
  const todayUTC=new Date(Date.UTC(today.getFullYear(),today.getMonth(),today.getDate()));

  // 1) Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
  const ageYears = calcAgeYears(dobUTC, todayUTC);

  // 2) Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¯ÙˆÙ„Ø©
  const base = LE_DATA[selectedCountry];
  if(!base){ showToast('Ø§Ù„Ø¯ÙˆÙ„Ø© ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.', {type:'error', title:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø©'}); return; }
  let leBoth = Number(base.both);
  if(!leBoth || leBoth<=0){ showToast('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„Ø©.', {type:'error', title:'Ù‚ÙŠÙ…Ø© Ù…ÙÙ‚ÙˆØ¯Ø©'}); return; }

  // 3) Ø¶Ø¨Ø· Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³
  let leSex = leBoth;
  if(base.male && base.female){
    leSex = (selectedSex==='male')? base.male : base.female;
  }else{
    leSex = (selectedSex==='male')? (leBoth - DEFAULT_SEX_GAP) : (leBoth + DEFAULT_SEX_GAP);
  }

  // 4) Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ¯Ø®ÙŠÙ†/Ø§Ù„Ø£Ù…Ø±Ø§Ø¶
  let leAdj = leSex;
  if(isSmoker==='yes') leAdj -= PENALTY_SMOKER;
  if(hasChronic==='yes') leAdj -= PENALTY_CHRONIC;
  if(leAdj < 1) leAdj = 1; // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ø¢Ù…Ù†

  // 5) Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  const targetUTC = addYearsExact(dobUTC, leAdj);
  const remainingMs = targetUTC - todayUTC;

  // Ø®Ù„Ø§ØµØ©
  verdict.style.display='inline-block';
  verdict.className='badge ok';
  if(remainingMs <= 0){
    verdict.textContent = 'â„¹ï¸ Ø¨Ù„ØºØª Ø£Ùˆ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ÙˆÙÙ‚ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø©.';
  }else{
    verdict.textContent = 'ğŸ” ØªÙ‚Ø¯ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ ÙˆÙÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù„Ø¯Ùƒ ÙˆØ¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø·Ø±.';
  }

  // KPIs
  kpis.style.display='grid';
  ageSolarEl.textContent = `${ageYears.toFixed(1)} Ø³Ù†Ø©`;
  lifeExpEl.textContent  = `${leAdj.toFixed(1)} Ø³Ù†Ø©`;

  // Ù…Ø¶Ù‰ Ù…Ù† Ø¹Ù…Ø±Ùƒ
  const elapsedDiff = diffYMD(dobUTC, todayUTC);
  cntY.textContent = elapsedDiff.y; cntM.textContent = elapsedDiff.m; cntD.textContent = elapsedDiff.d;
  counterDone.style.display='block';

  // Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ
  if(remainingMs > 0){
    const remainDiff = diffYMD(todayUTC, targetUTC);
    remY.textContent = remainDiff.y; remM.textContent = remainDiff.m; remD.textContent = remainDiff.d;
    counterRemain.style.display='block';
  }else{
    counterRemain.style.display='none';
  }

  // ØªØ§Ø±ÙŠØ® Ø¨Ù„ÙˆØº Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
  eqWrap.style.display='block';
  eqVal.textContent = fmtDate(targetUTC);

  // Ù†ØµØ§Ø¦Ø­
  buildAdvice();
});

/* Ù…Ø´Ø§Ø±ÙƒØ© */
document.getElementById('shareWA').addEventListener('click', (e)=>{ e.preventDefault(); window.open(`https://wa.me/?text=${encodeURIComponent(location.href)}`,'_blank','noopener'); });
document.getElementById('shareTG').addEventListener('click', (e)=>{ e.preventDefault(); window.open(`https://t.me/share/url?url=${encodeURIComponent(location.href)}`,'_blank','noopener'); });
document.getElementById('shareX').addEventListener('click',  (e)=>{ e.preventDefault(); window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(location.href)}`,'_blank','noopener'); });
document.getElementById('shareFB').addEventListener('click', (e)=>{ e.preventDefault(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}`,'_blank','noopener'); });

/* Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· */
document.getElementById('copyLink').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(location.href); showToast('ØªÙ…Ù‘ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­.'); }
  catch(_){ showToast('ØªØ¹Ø°Ù‘Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.',{type:'error',title:'Ù…Ø­Ø§ÙˆÙ„Ø© Ù†Ø³Ø®'}); }
});
</script>
</body>
</html>
