/**
 * ğŸš€ FadhelTalk - Ù…Ù„Ù ÙˆØ§Ø­Ø¯ ÙÙŠÙ‡ ÙƒÙ„ Ø´ÙŠØ¡
 * - ÙŠÙ‚Ø¯Ù… ØµÙØ­Ø© HTML + CSS + JS Ù„Ù„Ø²ÙˆØ§Ø±
 * - ÙŠØ­ÙØ¸ Ù…ÙØªØ§Ø­ API Ø¨Ø£Ù…Ø§Ù† (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø£Ùˆ ÙÙŠ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø©)
 * - ÙŠØ¹Ù…Ù„ ÙƒØ®Ø§Ø¯Ù… Ø®Ù„ÙÙŠ (Node.js + Express)
 */

import express from "express";
import fetch from "node-fetch";
import dotenv from "dotenv";

dotenv.config();
const app = express();
app.use(express.json());

// ===============
// âš ï¸ Ø¶Ø¹ Ù…ÙØªØ§Ø­ API Ù‡Ù†Ø§ Ø£Ùˆ ÙÙŠ Ù…Ù„Ù .env
// ===============
const API_KEY = process.env.API_KEY || "Ø¶Ø¹_Ù…ÙØªØ§Ø­Ùƒ_Ù‡Ù†Ø§";

// ğŸŸ¢ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (HTML ÙƒØ§Ù…Ù„)
const htmlPage = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FadhelTalk - Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ©</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, sans-serif; }
    body { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;}
    .container { width:100%; max-width:500px; background:rgba(255,255,255,0.95); border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,0.15); overflow:hidden; }
    .header { background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:#fff; padding:25px; text-align:center;}
    .logo { display:flex; justify-content:center; margin-bottom:15px;}
    .logo-icon { font-size:32px; background:#fff; color:#7c3aed; width:60px; height:60px; border-radius:50%; display:flex; justify-content:center; align-items:center;}
    h1 { font-size:28px; font-weight:700; margin-bottom:5px;}
    .subtitle { font-size:14px; opacity:.9;}
    .status { display:inline-flex; align-items:center; gap:8px; font-size:13px; margin-top:15px; background:rgba(255,255,255,0.2); padding:5px 12px; border-radius:20px;}
    .status-dot { width:8px; height:8px; background:#10b981; border-radius:50%;}
    .chat-container { height:400px; overflow-y:auto; padding:25px; background:#f8fafc; display:flex; flex-direction:column; gap:20px;}
    .message { max-width:80%; padding:16px 20px; border-radius:20px; line-height:1.5; box-shadow:0 4px 12px rgba(0,0,0,0.05);}
    .user-message { align-self:flex-end; background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%); color:#fff; border-bottom-right-radius:5px;}
    .ai-message { align-self:flex-start; background:#fff; color:#374151; border:1px solid #e5e7eb; border-bottom-left-radius:5px;}
    .message-time { font-size:11px; opacity:.7; margin-top:5px;}
    .input-container { display:flex; padding:20px; background:#f8fafc; border-top:1px solid #e5e7eb; gap:12px;}
    input { flex:1; padding:16px 20px; border:none; border-radius:24px; outline:none; background:#fff;}
    button { background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%); color:#fff; border:none; border-radius:24px; padding:16px 24px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:8px;}
    .footer { text-align:center; padding:15px; background:#f1f5f9; color:#64748b; font-size:12px; border-top:1px solid #e2e8f0;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo"><div class="logo-icon"><i class="fas fa-comments"></i></div></div>
      <h1>FadhelTalk</h1>
      <p class="subtitle">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ©</p>
      <div class="status"><span id="status-text">Ø¬Ø§Ù‡Ø²</span><div class="status-dot"></div></div>
    </div>

    <div class="chat-container" id="chat-container">
      <div class="message ai-message">
        <div class="message-content">Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ FadhelTalk. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
        <div class="message-time" id="current-time"></div>
      </div>
    </div>

    <div class="input-container">
      <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
      <button id="send-btn"><i class="fas fa-paper-plane"></i><span>Ø¥Ø±Ø³Ø§Ù„</span></button>
    </div>

    <div class="footer">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³ | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</div>
  </div>

  <script>
    const chat=document.getElementById('chat-container'),input=document.getElementById('user-input'),btn=document.getElementById('send-btn'),timeEl=document.getElementById('current-time');
    let waiting=false;
    function now(){const n=new Date();const t=\`\${n.getHours()}:\${n.getMinutes().toString().padStart(2,'0')}\`;if(timeEl)timeEl.textContent=t;return t;}
    now();
    function addMsg(txt,user){const d=document.createElement('div');d.classList.add('message',user?'user-message':'ai-message');const c=document.createElement('div');c.textContent=txt;const t=document.createElement('div');t.classList.add('message-time');t.textContent=now();d.appendChild(c);d.appendChild(t);chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
    function typing(){const d=document.createElement('div');d.classList.add('ai-message');d.id='typing';d.textContent='...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';chat.appendChild(d);chat.scrollTop=chat.scrollHeight;return d;}
    async function ai(msg){try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});const j=await r.json();return j.reply||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯.';}catch(e){return 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.';}}
    async function send(){if(waiting)return;const m=input.value.trim();if(!m)return;addMsg(m,true);input.value='';waiting=true;btn.disabled=true;const typ=typing();try{const ans=await ai(m);typ.remove();addMsg(ans,false);}catch{typ.remove();addMsg('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',false);}finally{waiting=false;btn.disabled=false;input.focus();}}
    btn.addEventListener('click',send);input.addEventListener('keypress',e=>{if(e.key==='Enter'&&!waiting)send();});
  </script>
</body>
</html>
`;

// ğŸŸ¢ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
app.get("/", (req, res) => {
  res.send(htmlPage);
});

// ğŸŸ¢ API ÙˆØ³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„Ø²Ø§Ø¦Ø± Ùˆ DeepSeek
app.post("/api/chat", async (req, res) => {
  try {
    const userMsg = req.body.message;
    const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${API_KEY}\`,
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
          { role: "system", content: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©." },
          { role: "user", content: userMsg },
        ],
        max_tokens: 500,
      }),
    });

    const data = await response.json();
    const reply = data?.choices?.[0]?.message?.content || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯.";
    res.json({ reply });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£:", err.message);
    res.status(500).json({ reply: "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹." });
  }
});

// ğŸŸ¢ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(\`ğŸš€ FadhelTalk ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ http://localhost:\${PORT}\`));
