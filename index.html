<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>مواقيت الصلاة وفق المذهب الجعفري</title>

<!-- خطوط أجمل -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Noto+Naskh+Arabic:wght@500;700&family=Reem+Kufi:wght@600&display=swap" rel="stylesheet">

<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --bg:#f6f8fb; --border:#e5e7eb; --accent:#0ea5a6;
    --accent-2:#0bb5b7; --shadow:0 10px 30px rgba(2,6,23,.08); --hadith-color:#0d2a58;
    --chip:#ffffff; --card:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#f7fafc 0%,#f3f7fb 100%);
    font-family:"Cairo", system-ui, -apple-system, "Segoe UI", sans-serif;
    color:var(--ink); padding:16px;
  }
  .container{width:min(1000px,100%); margin:auto; display:flex; flex-direction:column; gap:16px}

  .topClock{display:flex; justify-content:flex-end; gap:10px; font-size:.95rem; font-weight:700; color:#0b4a49}
  .hero{
    background:radial-gradient(1200px 300px at 50% -80px,#e7fbfb,transparent), #fff;
    border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:20px; text-align:center
  }
  .heroTitle{margin:0; font-family:"Reem Kufi",sans-serif; font-size:1.5rem; color:var(--ink); letter-spacing:.2px}

  .locationBox{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    box-shadow:var(--shadow); padding:12px 14px; display:flex; justify-content:space-between; align-items:center
  }
  .place{font-weight:800; font-size:1.05rem}
  .changeBtn{
    background:linear-gradient(180deg,#eefbfd,#e9f5ff);
    border:1px solid var(--border); padding:8px 14px; border-radius:999px;
    font-weight:800; cursor:pointer; transition:transform .1s ease, box-shadow .2s ease
  }
  .changeBtn:hover{box-shadow:0 6px 18px rgba(2,6,23,.08)}
  .changeBtn:active{transform:translateY(1px)}

  .nextBox{background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:16px; display:grid; gap:10px}
  .nextTitle{font-weight:800; color:#0b3b3a; text-align:center; letter-spacing:.3px}
  .nextRow{display:flex; justify-content:space-between; align-items:center; font-weight:800}
  .nextName{font-size:1.06rem}
  .nextAt{font-variant-numeric:tabular-nums}
  .countdown{display:flex; justify-content:center; gap:10px; font-weight:900; font-size:1.6rem; letter-spacing:.5px; direction:ltr}
  .cd-seg{min-width:2.2ch; text-align:center; padding:.25rem .6rem; border:1px solid var(--border); border-radius:10px; background:#f8fafc}
  .cd-colon{opacity:.6}
  .note{font-size:.86rem; color:var(--muted); text-align:center}

  .infoRow{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media(max-width:720px){.infoRow{grid-template-columns:1fr}}

  .chip{background:var(--chip); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px; display:flex; align-items:center; gap:12px}
  .ico{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:#eaf3ff; font-size:1.2rem}
  .stack{display:flex; flex-direction:column}
  .label{font-size:.85rem; color:var(--muted); font-weight:700}
  .value{font-weight:800; font-size:1.02rem; font-variant-numeric:tabular-nums}

  .card{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px}
  .card h3{margin:0 0 10px; font-size:1rem; font-weight:800; text-align:center;}
  table{width:100%; border-collapse:collapse}
  th,td{padding:12px; border-bottom:1px solid #f0f0f0; font-size:1rem}
  th{background:#fafafa; font-weight:800}
  td.name{text-align:right; font-weight:700}
  td.time{text-align:left; font-weight:800}
  tr.next td{background:linear-gradient(90deg,#0ea5a61a,transparent)}

  .events{display:none; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:14px}
  .events h3{margin:0 0 8px; font-size:1rem; font-weight:800; text-align:center;}
  .evtGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:720px){.evtGrid{grid-template-columns:1fr}}
  .evtCol{border:1px dashed #e3e8f0; border-radius:10px; padding:10px}
  .evtCol h4{margin:0 0 6px; font-size:.9rem; color:var(--ink)}
  .evtItem{padding:6px 0; border-bottom:1px solid #f0f0f0}
  .evtItem:last-child{border-bottom:none}
  .evtText{font-weight:700}

  .hadith{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; text-align:center}
  .htext{margin:0; font-size:1.08rem; color:var(--hadith-color); line-height:1.95; font-family:"Noto Naskh Arabic","Cairo",serif}
  .hsrc{display:inline-block; margin-top:12px; padding:6px 14px; border-radius:10px; background:#f5f7fa; border:1px solid var(--border); font-weight:800; color:#3b4656}
  footer{text-align:center; margin-top:8px}
  .credit{color:var(--hadith-color); font-weight:800}

  /* نافذة الإعدادات */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.28); z-index:60}
  .modal.open{display:grid}
  .box{width:min(560px,96%); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .rowCtrl{display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap}
  .rowCtrl label{width:160px; color:var(--muted); font-weight:700}
  input[type="text"], input[type="number"], select{
    flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); font-weight:700; background:#fff
  }
  .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  .btn{border:1px solid var(--border); border-radius:12px; padding:.7rem 1rem; font-weight:800; cursor:pointer; background:linear-gradient(180deg,#ffffff,#f7fbff); box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .btn.primary{background:linear-gradient(180deg,#d9fbfb,#cfefff); border-color:#cbe3ff}
  .btn.warn{background:linear-gradient(180deg,#fff2f2,#ffe1e1)}
  .switch{display:flex; align-items:center; gap:10px}
  .switch input{transform:scale(1.2)}
  .hint{font-size:.85rem; color:var(--muted); margin-top:2px}
  .small{font-size:.9rem; color:#0b4a49; font-weight:700}
  .pill{display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#eef7ff; border:1px solid #e3eefc; font-weight:800; font-size:.82rem}
  .results{width:100%; max-height:220px; overflow:auto; border:1px solid #eef2f6; border-radius:12px; display:none}
  .resItem{padding:.65rem .8rem; border-bottom:1px dashed #eef2f6; cursor:pointer}
  .resItem:hover{background:#f7fbff}
</style>
</head>
<body>
  <div class="container">
    <div class="topClock">
      <span id="topClock">--:-- --</span>
      <span class="pill" id="tzPill"></span>
    </div>

    <section class="hero">
      <h1 class="heroTitle">مواقيت الصلاة وفق المذهب الجعفري</h1>
    </section>

    <div class="locationBox">
      <div class="place" id="place">جاري تحديد الموقع…</div>
      <button class="changeBtn" id="openPicker" type="button">الإعدادات</button>
    </div>

    <!-- الحدث القادم + عداد -->
    <section class="nextBox" id="nextBox">
      <div class="nextTitle">الحدث القادم</div>
      <div class="nextRow">
        <span class="nextName" id="nextName">--</span>
        <span class="nextAt" id="nextAt">--:-- --</span>
      </div>
      <div class="countdown" aria-live="polite">
        <span class="cd-seg" id="cdH">00</span><span class="cd-colon">:</span>
        <span class="cd-seg" id="cdM">00</span><span class="cd-colon">:</span>
        <span class="cd-seg" id="cdS">00</span>
      </div>
      <div class="note" id="nextNote"></div>
    </section>

    <section class="infoRow">
      <div class="chip">
        <div class="ico">🗓</div>
        <div class="stack"><div class="label">التاريخ الهجري</div><div class="value" id="hijri">--</div></div>
      </div>
      <div class="chip">
        <div class="ico">📅</div>
        <div class="stack"><div class="label">التاريخ الميلادي</div><div class="value" id="greg">--</div></div>
      </div>
    </section>

    <section class="card">
      <h3>الجدول اليومي</h3>
      <table>
        <thead><tr><th>الحدث</th><th>الوقت</th></tr></thead>
        <tbody id="times"><tr><td colspan="2">جاري التحميل…</td></tr></tbody>
      </table>
    </section>

    <!-- يظهر فقط عند وجود مناسبات -->
    <section class="events" id="eventsBox">
      <h3>مناسبات اليوم</h3>
      <div class="evtGrid">
        <div class="evtCol" id="colToday"><h4>اليوم</h4><div id="eventsToday"></div></div>
        <div class="evtCol" id="colNight"><h4>الليلة</h4><div id="eventsTonight"></div></div>
      </div>
    </section>

    <section class="hadith">
      <p class="htext" id="hadithText"></p>
      <div class="hsrc" id="hadithSource"></div>
    </section>

    <footer><span class="credit">برمجة وتطوير فاضل الريس</span></footer>
  </div>

  <!-- نافذة الإعدادات -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="rowCtrl switch">
        <input type="checkbox" id="autoDetectChk">
        <label for="autoDetectChk">تحديد الموقع تلقائيًا</label>
        <span class="hint">عند التفعيل سيتم استخدام إحداثيات جهازك مباشرة.</span>
      </div>

      <div class="rowCtrl">
        <label>ابحث عن المكان</label>
        <input id="placeSearch" type="text" placeholder="مثال: الدوحة، قطر | Berlin, Germany">
      </div>
      <div id="searchResults" class="results"></div>

      <div class="rowCtrl">
        <label>إدخال إحداثيات</label>
        <input id="latInp" type="number" step="any" placeholder="Latitude">
        <input id="lonInp" type="number" step="any" placeholder="Longitude">
        <button class="btn" id="useCoords" type="button">تعيين</button>
      </div>

      <div class="rowCtrl">
        <label>طريقة الحساب</label>
        <select id="methodSel"></select>
        <span class="hint">يُحمَّل تلقائيًا من Aladhan. الافتراضي: الجعفري.</span>
      </div>

      <div class="rowCtrl">
        <label>تعويض الهجري</label>
        <select id="hijriOffsetSel">
          <option value="-2">-2 يوم</option>
          <option value="-1">-1 يوم</option>
          <option value="0" selected>بدون تعويض</option>
          <option value="1">+1 يوم</option>
          <option value="2">+2 يوم</option>
        </select>
      </div>

      <div class="actions">
        <button class="btn" id="useMyLocation" type="button">استخدم موقعي الآن</button>
        <button class="btn primary" id="savePlace" type="button">حفظ</button>
        <button class="btn" id="cancelPlace" type="button">إلغاء</button>
        <button class="btn warn" id="resetAll" type="button">إعادة ضبط</button>
      </div>
      <div class="small">* لا يُستخدم أي جدول دول/مدن ثابت — كل شيء عالمي بالإحداثيات والمعايير الرسمية.</div>
    </div>
  </div>

<script>
/* ========================= إعدادات حالة ========================= */
let HIJRI_OFFSET_DAYS = Number(localStorage.getItem("jaq_hijri_offset_days")||"0");
let AUTO_DETECT = JSON.parse(localStorage.getItem("jaq_auto_detect")||"true");
let coords = JSON.parse(localStorage.getItem("jaq_coords")||"null"); // {lat, lon}
let resolvedName = JSON.parse(localStorage.getItem("jaq_resolved_name")||"null"); // {cityAr,countryAr,display}
let METHOD_ID = Number(localStorage.getItem("jaq_method_id")||"0"); // 0: Shia Ithna-Ashari (Jafari)
let TIMEZONE = localStorage.getItem("jaq_timezone") || Intl.DateTimeFormat().resolvedOptions().timeZone;

const NAMES = {Imsak:"الإمساك",Fajr:"أذان الفجر",Sunrise:"الشروق",Dhuhr:"أذان الظهر",Asr:"أذان العصر",Sunset:"الغروب",Maghrib:"أذان المغرب",Isha:"أذان العشاء",Midnight:"منتصف الليل"};

/* أحاديث */
const HADITHS=[
  {t:"قال الإمام الباقر (عليه السلام): إذا استقبل المصلي القبلة استقبل الرحمن بوجهه لا إله غيره.",s:"المصدر: ميزان الحكمة"},
  {t:"قال الإمام علي (عليه السلام): إذا قام الرجل إلى الصلاة أقبل إبليس ينظر إليه حسداً لما يرى من رحمة الله التي تغشاه.",s:"المصدر: ميزان الحكمة"},
  {t:"قال الإمام الرضا (عليه السلام): الصلاة لها أربعة آلاف باب.",s:"المصدر: ميزان الحكمة"},
  {t:"قال الإمام علي (عليه السلام): يا كميل! ليس الشأن أن تصلي وتصوم وتتصدق، إنما الشأن أن تكون الصلاة فعلت بقلب نقي، وعمل عند الله مرضي، وخشوع سوي.",s:"المصدر: ميزان الحكمة"},
  {t:"عن سعد بن أبي وقاص: سألت النبي صلى الله عليه وآله عن قوله: الذين هم عن صلاتهم ساهون. قال: هم الذين يؤخرون الصلاة عن وقتها.",s:"المصدر: السنن الكبرى"},
  {t:"قال رسول الله صلى الله عليه وآله: من ترك صلاته متعمداً فقد هدم دينه، ومن ترك أوقاتها يدخل الويل، والويل وادٍ في جهنم كما قال تعالى: فويل للمصلين الذين هم عن صلاتهم ساهون.",s:"المصدر: جامع الأخبار"},
  {t:"قال عبد الله بن مسعود: سألت رسول الله صلى الله عليه وآله: أيّ الأعمال أحب إلى الله جل جلاله؟ قال: الصلاة لوقتها.",s:"المصدر: الخصال"}
];
function setHadith(){
  const h=HADITHS[Math.floor(Math.random()*HADITHS.length)];
  hadithText.textContent=h.t; hadithSource.textContent=h.s;
}

/* أدوات وقت/تنسيق */
function to12h(raw){
  if(!raw) return "--:-- --";
  const pure=String(raw).replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(pure)) return raw;
  let [H,M]=pure.split(":").map(Number); H=(H===24)?0:H;
  const h=H%12||12; return `${h}:${String(M).padStart(2,"0")} ${H<12?"AM":"PM"}`;
}
function ymdInTZ(date, tz){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  return {Y:p.find(x=>x.type==='year').value, M:p.find(x=>x.type==='month').value, D:p.find(x=>x.type==='day').value};
}
function updateClock(){
  topClock.textContent=new Intl.DateTimeFormat('en-GB',{timeZone:TIMEZONE,hour:'2-digit',minute:'2-digit',hour12:true}).format(new Date());
  tzPill.textContent = TIMEZONE;
}

/* الهجري (مع تعويض) */
const HIJRI_MONTHS_AR=["","محرم","صفر","ربيع الأول","ربيع الآخر","جمادى الأولى","جمادى الآخرة","رجب","شعبان","رمضان","شوال","ذو القعدة","ذو الحجة"];
function hasIntlIslamic(){ try{ new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric'}).format(new Date()); return true; }catch{ return false; } }
function g2jd(y,m,d){ const a=Math.floor((14-m)/12); y=y+4800-a; m=m+12*a-3; return d + Math.floor((153*m+2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045; }
function jd2islamic(jd){
  const l = jd - 1948440 + 10632;
  const n = Math.floor((l - 1) / 10631);
  let l2 = l - 10631*n + 354;
  const j = (Math.floor((10985 - l2)/5316)) * (Math.floor((50*l2)/17719)) + (Math.floor(l2/5670)) * (Math.floor((43*l2)/15238));
  l2 = l2 - (Math.floor((30 - j)/15)) * (Math.floor((17719*j)/50)) - (Math.floor(j/16)) * (Math.floor((15238*j)/43)) + 29;
  const m = Math.floor((24*l2)/709);
  const d = l2 - Math.floor((709*m)/24);
  const y = 30*n + j - 30;
  return {y,m,d};
}
async function fetchHijriFromAladhan(refDate){
  const {Y,M,D}=ymdInTZ(refDate, TIMEZONE);
  const url=`https://api.aladhan.com/v1/gToH?date=${encodeURIComponent(`${D}-${M}-${Y}`)}&adjustment=${encodeURIComponent(HIJRI_OFFSET_DAYS||0)}`;
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("Hijri API HTTP "+r.status);
  const j=await r.json();
  const hj=j?.data?.hijri; if(!hj) throw new Error("Hijri API malformed");
  return hj;
}
function formatHijriFromObj(h, civilWeekday){
  const day = Number(h.day||h.date?.split('-')[0]);
  const monthName = h?.month?.ar || HIJRI_MONTHS_AR[h?.month?.number||0] || '';
  const year = h.year || (h.date? h.date.split('-')[2] : '');
  return `${civilWeekday}، ${day} ${monthName} ${year} هـ`;
}
function localHijriFallback(refDate, civilWeekday){
  try{
    if(hasIntlIslamic()){
      const parts=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:TIMEZONE,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(refDate);
      const y=+parts.find(p=>p.type==='year').value;
      const m=+parts.find(p=>p.type==='month').value;
      const d=+parts.find(p=>p.type==='day').value;
      return `${civilWeekday}، ${d} ${HIJRI_MONTHS_AR[m]} ${y} هـ`;
    }else{
      const p=ymdInTZ(refDate,TIMEZONE);
      const jd=g2jd(+p.Y,+p.M,+p.D), h=jd2islamic(jd);
      return `${civilWeekday}، ${h.d} ${HIJRI_MONTHS_AR[h.m]} ${h.y} هـ`;
    }
  }catch{ return "التاريخ الهجري (غير متاح)"; }
}

/* مواقيت + القادم */
let lastTimings=null;
function nextKey(t){
  const order=["Imsak","Fajr","Sunrise","Dhuhr","Asr","Sunset","Maghrib","Isha","Midnight"];
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const {Y,M,D}=ymdInTZ(nowTZ, TIMEZONE);
  const cand=order.map(k=>{
    const raw=(t[k]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
    if(!/^\d{1,2}:\d{2}$/.test(raw)) return {k,diff:Infinity};
    let [HH,MM]=raw.split(':').map(Number); HH=(HH===24)?0:HH;
    return {k,diff:new Date(+Y,+M-1,+D,HH||0,MM||0,0)-nowTZ};
  });
  let n=cand.filter(x=>x.diff>=0).sort((a,b)=>a.diff-b.diff)[0];
  if(!n) n=cand.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff))[0];
  return n?.k||null;
}
function tr(name,val,next=false){return `<tr class="${next?'next':''}"><td class="name">${name}</td><td class="time">${to12h(val||'')}</td></tr>`;}
function ensureImsak(t){
  if(!t.Imsak && t.Fajr){
    const pure=String(t.Fajr).replace(/\s*\(.*?\)\s*/g,"").trim();
    let [H,M]=pure.split(":").map(Number);
    const d=new Date(); d.setHours((H||0), (M||0)-10, 0, 0);
    t.Imsak = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }
  return t;
}
async function fetchTimingsByCoords(lat, lon){
  const url=`https://api.aladhan.com/v1/timings?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&method=${encodeURIComponent(METHOD_ID)}`;
  const r=await fetch(url); if(!r.ok) throw new Error("تعذّر جلب المواقيت (إحداثيات)");
  const j=await r.json();
  return j.data.timings;
}

/* تاريخ الحدث اليوم */
function dateForKeyToday(timings, key){
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const {Y,M,D}=ymdInTZ(nowTZ, TIMEZONE);
  const raw=(timings[key]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(raw)) return null;
  let [H,Min]=raw.split(':').map(Number); H=(H===24)?0:H;
  return new Date(+Y,+M-1,+D,H||0,Min||0,0);
}

async function renderTimes(t){
  const timings=ensureImsak({...t});
  lastTimings=timings;

  const rows=[
    {n:"الإمساك",k:"Imsak"},
    {n:"أذان الفجر",k:"Fajr"},
    {n:"الشروق",k:"Sunrise"},
    {n:"أذان الظهر",k:"Dhuhr"},
    {n:"أذان العصر",k:"Asr"},
    {n:"الغروب",k:"Sunset"},
    {n:"أذان المغرب",k:"Maghrib"},
    {n:"أذان العشاء",k:"Isha"},
    {n:"منتصف الليل",k:"Midnight"}
  ];
  const k=nextKey(timings);
  times.innerHTML=rows.map(r=>tr(r.n,timings[r.k],r.k===k)).join("");

  updateNextBox();

  const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  greg.textContent = new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(nowTZ);
  const civilWeekday = new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long'}).format(nowTZ);

  try{
    const hijriObj = await fetchHijriFromAladhan(nowTZ);
    hijri.textContent = formatHijriFromObj(hijriObj, civilWeekday);
    await renderEventsWithHijri(hijriObj, nowTZ);
  }catch(e){
    hijri.textContent = localHijriFallback(nowTZ, civilWeekday);
    renderEventsFallback(nowTZ);
  }
}

/* مناسبات (كما سابقًا) */
let EVENTS={
  "1-1":[{t:"رأس السنة الهجرية"}],
  "1-2":[{t:"دخول الإمام الحسين ع كربلاء"}],
  "1-7":[{t:"بدء منع الماء عن خيام الحسين ع"}],
  "1-9":[{t:"تاسوعاء – يوم أبي الفضل العباس ع"}],
  "1-10":[{t:"عاشوراء – شهادة الإمام الحسين ع"}],
  "1-12":[{t:"دفن الأجساد الطاهرة بكربلاء"}],
  "1-25":[{t:"شهادة الإمام زين العابدين ع"}],
  "2-7":[{t:"شهادة الإمام الحسن المجتبى ع (اختلاف الروايات)"}],
  "2-20":[{t:"الأربعين – زيارة الإمام الحسين ع"}],
  "2-28":[{t:"وفاة النبي الأكرم ﷺ (على المشهور)"}],
  "3-8":[{t:"شهادة الإمام الحسن العسكري ع"}],
  "3-9":[{t:"فرحة الزهراء (يوم البراءة)"}],
  "3-17":[{t:"المولد النبوي الشريف (عند الإمامية)"}],
  "4-8":[{t:"ولادة الإمام الحسن العسكري ع (اختلاف الروايات)"}],
  "4-10":[{t:"ولادة الإمام الحسن العسكري ع (اختلاف الروايات)"}],
  "5-5":[{t:"مولد السيدة زينب بنت علي ع"}],
  "5-13":[{t:"شهادة السيدة فاطمة الزهراء ع (إحدى الروايات)"}],
  "6-3":[{t:"شهادة السيدة فاطمة الزهراء ع (قول مشهور)"}],
  "6-20":[{t:"مولد السيدة فاطمة الزهراء ع"}],
  "7-1":[{t:"مولد الإمام محمد الباقر ع"}],
  "7-3":[{t:"شهادة الإمام علي الهادي ع"}],
  "7-10":[{t:"مولد الإمام محمد الجواد ع"}],
  "7-13":[{t:"مولد الإمام علي بن أبي طالب ع"}],
  "7-25":[{t:"شهادة الإمام موسى الكاظم ع"}],
  "7-27":[{t:"المبعث النبوي"}],
  "8-3":[{t:"مولد الإمام الحسين ع"}],
  "8-4":[{t:"مولد أبي الفضل العباس ع"}],
  "8-5":[{t:"مولد الإمام زين العابدين ع"}],
  "8-11":[{t:"مولد علي الأكبر ع"}],
  "8-15":[{t:"مولد الإمام المهدي عجل الله فرجه"}],
  "9-10":[{t:"وفاة السيدة خديجة الكبرى ع"}],
  "9-15":[{t:"مولد الإمام الحسن المجتبى ع"}],
  "9-19":[{t:"ضربة الإمام علي ع – ليلة قدر"}],
  "9-21":[{t:"شهادة الإمام علي ع – ليلة قدر"}],
  "9-23":[{t:"ليلة القدر (قول مشهور)"}],
  "10-1":[{t:"عيد الفطر المبارك"}],
  "10-8":[{t:"ذكرى هدم قبور البقيع"}],
  "10-25":[{t:"شهادة الإمام جعفر الصادق ع"}],
  "11-1":[{t:"مولد السيدة فاطمة المعصومة ع"}],
  "11-11":[{t:"مولد الإمام علي بن موسى الرضا ع"}],
  "11-23":[{t:"دحو الأرض"}],
  "11-29":[{t:"شهادة الإمام محمد الجواد ع"}],
  "12-7":[{t:"يوم التروية"}],
  "12-8":[{t:"الخروج إلى عرفة"}],
  "12-9":[{t:"يوم عرفة (وشهادة مسلم بن عقيل ع عند بعض الروايات)"}],
  "12-10":[{t:"عيد الأضحى المبارك"}],
  "12-18":[{t:"عيد الغدير الأغر"}],
  "12-24":[{t:"يوم المباهلة"}],
  "12-25":[{t:"يوم نزول سورة الإنسان"}]
};
async function renderEventsWithHijri(hijriObjToday, refToday){
  const todayM = Number(hijriObjToday?.month?.number||0);
  const todayD = Number(hijriObjToday?.day||0);
  const refTonight = new Date(refToday.getTime()+86400000);
  let hijriTomorrow=null;
  try{ hijriTomorrow = await fetchHijriFromAladhan(refTonight); }catch{}
  const nightM = Number(hijriTomorrow?.month?.number||0);
  const nightD = Number(hijriTomorrow?.day||0);
  drawEvents(todayM, todayD, nightM, nightD);
}
function renderEventsFallback(ref){
  let todayM,todayD,nightM,nightD;
  if(hasIntlIslamic()){
    const p1=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:TIMEZONE,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(ref);
    todayM=+p1.find(x=>x.type==='month').value; todayD=+p1.find(x=>x.type==='day').value;
    const ref2=new Date(ref.getTime()+86400000);
    const p2=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:TIMEZONE,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(ref2);
    nightM=+p2.find(x=>x.type==='month').value; nightD=+p2.find(x=>x.type==='day').value;
  }else{
    const {Y,M,D}=ymdInTZ(ref,TIMEZONE);
    const h1=jd2islamic(g2jd(+Y,+M,+D));
    const h2=jd2islamic(g2jd(+Y,+M,+D+1));
    todayM=h1.m; todayD=h1.d; nightM=h2.m; nightD=h2.d;
  }
  drawEvents(todayM, todayD, nightM, nightD);
}
function drawEvents(todayM,todayD,nightM,nightD){
  const box=document.getElementById('eventsBox');
  const colToday=document.getElementById('colToday');
  const colNight=document.getElementById('colNight');
  const todayEl=document.getElementById('eventsToday');
  const nightEl=document.getElementById('eventsTonight');

  const todayList = EVENTS[`${todayM}-${todayD}`] || [];
  const nightList = EVENTS[`${nightM}-${nightD}`] || [];

  if(todayList.length===0 && nightList.length===0){
    box.style.display='none';
    todayEl.innerHTML=""; nightEl.innerHTML="";
    return;
  }

  box.style.display='block';

  if(todayList.length){
    colToday.style.display='block';
    todayEl.innerHTML = todayList.map(e=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`).join("");
  }else{
    colToday.style.display='none';
    todayEl.innerHTML="";
  }

  if(nightList.length){
    colNight.style.display='block';
    nightEl.innerHTML = nightList.map(e=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`).join("");
  }else{
    colNight.style.display='none';
    nightEl.innerHTML="";
  }
}

/* ======= صندوق الحدث القادم + العداد ======= */
let cdTimer=null;
function updateNextBox(){
  if(!lastTimings) return;
  const key = nextKey(lastTimings);
  const target = dateForKeyToday(lastTimings, key);
  if(!key || !target){ nextName.textContent="--"; nextAt.textContent="--:-- --"; setCD(0); return; }

  nextName.textContent = NAMES[key] || key;
  nextAt.textContent = to12h(lastTimings[key]);
  nextNote.textContent = (key==="Sunrise" ? "زمن الشروق" : key==="Sunset" ? "وقت الغروب" : "الوقت المتبقي");

  if(cdTimer) clearInterval(cdTimer);
  cdTimer = setInterval(()=>tickCountdown(target,key),1000);
  tickCountdown(target,key);
}
function setCD(ms){
  ms = Math.max(0, ms|0);
  let s = Math.floor(ms/1000);
  const h = Math.floor(s/3600); s%=3600;
  const m = Math.floor(s/60); s%=60;
  cdH.textContent = String(h).padStart(2,'0');
  cdM.textContent = String(m).padStart(2,'0');
  cdS.textContent = String(s).padStart(2,'0');
}
function tickCountdown(target,key){
  const now=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const diff = target - now;
  setCD(diff);
  if(diff<=0){
    clearInterval(cdTimer);
    load();
  }
}

/* ========================= تحديد الموقع/الاسم ========================= */
async function fetchTimezone(lat, lon){
  try{
    const u=`https://api.aladhan.com/v1/timeZone?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}`;
    const r=await fetch(u,{cache:'no-store'}); const j=await r.json();
    return j?.data?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
  }catch{ return Intl.DateTimeFormat().resolvedOptions().timeZone; }
}
async function reverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&format=jsonv2&accept-language=ar`;
  const r = await fetch(url, {cache:'no-store', headers:{'User-Agent':'PrayerTimesApp/1.0'}});
  const j = await r.json();
  const addr = j.address || {};
  const city = addr.city || addr.town || addr.village || addr.suburb || j.name || '';
  const country = addr.country || '';
  const display = j.display_name || '';
  return {cityAr: city || 'غير معروف', countryAr: country || 'غير معروف', display};
}
async function geocodeQuery(q){
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=8&accept-language=ar&q=${encodeURIComponent(q)}`;
  const r = await fetch(url, {cache:'no-store', headers:{'User-Agent':'PrayerTimesApp/1.0'}});
  return await r.json();
}
function showPlaceText(){
  if (resolvedName){
    place.textContent = `${resolvedName.cityAr}، ${resolvedName.countryAr}`;
    place.title = resolvedName.display || '';
  }else{
    place.textContent = 'الموقع غير محدد';
    place.title = '';
  }
}

/* ========================= واجهة البحث ========================= */
let searchDebounce=null;
function attachSearch(){
  const box=document.getElementById('searchResults');
  placeSearch.addEventListener('input', ()=>{
    const q=placeSearch.value.trim();
    if(searchDebounce) clearTimeout(searchDebounce);
    if(!q){ box.style.display='none'; box.innerHTML=''; return; }
    searchDebounce=setTimeout(async ()=>{
      try{
        const list=await geocodeQuery(q);
        box.innerHTML = list.map(it=>`<div class="resItem" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${it.display_name.replace(/"/g,'&quot;')}">${it.display_name}</div>`).join('') || '<div class="resItem">لا نتائج</div>';
        box.style.display='block';
      }catch{
        box.innerHTML='<div class="resItem">تعذّر البحث</div>'; box.style.display='block';
      }
    }, 300);
  });
  box.addEventListener('click', async (e)=>{
    const item=e.target.closest('.resItem'); if(!item) return;
    const lat=Number(item.dataset.lat), lon=Number(item.dataset.lon);
    coords={lat,lon}; localStorage.setItem("jaq_coords", JSON.stringify(coords));
    resolvedName = await reverseGeocode(lat, lon);
    localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
    TIMEZONE = await fetchTimezone(lat, lon);
    localStorage.setItem("jaq_timezone", TIMEZONE);
    AUTO_DETECT=false; localStorage.setItem("jaq_auto_detect","false");
    showPlaceText(); await load();
    box.style.display='none';
  });
  document.addEventListener('click',(e)=>{ if(!box.contains(e.target) && e.target!==placeSearch){ box.style.display='none'; }});
}

/* ========================= طرق الحساب (ديناميكي) ========================= */
async function loadMethods(){
  try{
    const r=await fetch('https://api.aladhan.com/v1/methods',{cache:'no-store'});
    const j=await r.json(); const data=j.data||{};
    const entries=Object.entries(data).filter(([k,v])=>!isNaN(+k));
    methodSel.innerHTML = entries.map(([id,v])=>{
      const name = (v.name||'').replace(' - ', ' — ');
      const sel = (+id===METHOD_ID)?'selected':'';
      return `<option value="${id}" ${sel}>${name}</option>`;
    }).join('');
    if (!entries.some(([id])=>+id===METHOD_ID)) METHOD_ID=0;
  }catch{
    // احتياط: خيارين أساسيين
    methodSel.innerHTML = `
      <option value="0" selected>Shia Ithna-Ashari (Jafari)</option>
      <option value="3">Muslim World League</option>`;
    METHOD_ID=0;
  }
}

/* ========================= التشغيل ========================= */
function fmtGreg(){ return new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(new Date()); }

async function load(){
  greg.textContent=fmtGreg();
  hijri.textContent="--";
  times.innerHTML="<tr><td colspan=2>...</td></tr>";

  try{
    if(!coords){ times.innerHTML=`<tr><td colspan="2" style="color:#b91c1c">الموقع غير محدد.</td></tr>`; return; }
    const t=await fetchTimingsByCoords(coords.lat, coords.lon);
    await renderTimes(t);
  }catch{
    times.innerHTML=`<tr><td colspan="2" style="color:#b91c1c">تعذّر جلب المواقيت.</td></tr>`;
    document.getElementById('eventsBox').style.display='none';
    const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
    const civilWeekday = new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long'}).format(nowTZ);
    try{
      const hj = await fetchHijriFromAladhan(nowTZ);
      hijri.textContent = formatHijriFromObj(hj, civilWeekday);
    }catch{
      hijri.textContent = localHijriFallback(nowTZ, civilWeekday);
    }
    updateNextBox();
  }
  showPlaceText();
}

/* محاولة تحديد الموقع */
async function tryAutoLocate(alertErrors=false){
  if(!navigator.geolocation){
    if(alertErrors) alert('المتصفح لا يدعم تحديد الموقع.');
    return false;
  }
  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const {latitude, longitude}=pos.coords;
      coords={lat:+latitude, lon:+longitude};
      localStorage.setItem("jaq_coords", JSON.stringify(coords));
      try{
        resolvedName = await reverseGeocode(latitude, longitude);
      }catch{
        resolvedName = {cityAr:'موقعي', countryAr:'', display:''};
      }
      localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
      TIMEZONE = await fetchTimezone(latitude, longitude);
      localStorage.setItem("jaq_timezone", TIMEZONE);
      showPlaceText(); await load(); resolve(true);
    }, (err)=>{
      if(alertErrors) alert('تعذّر الوصول للموقع. اسمح بالإذن أو ابحث يدويًا.');
      resolve(false);
    }, {enableHighAccuracy:false, timeout:8000, maximumAge:300000});
  });
}

/* ساعة + حديث */
setInterval(updateClock,1000); updateClock(); setHadith();

/* عناصر DOM */
const modal=document.getElementById("modal");
const openPicker=document.getElementById("openPicker");
const cancelPlace=document.getElementById("cancelPlace");
const savePlace=document.getElementById("savePlace");
const hijriOffsetSel=document.getElementById("hijriOffsetSel");
const autoDetectChk=document.getElementById("autoDetectChk");
const useMyLocation=document.getElementById("useMyLocation");
const latInp=document.getElementById("latInp");
const lonInp=document.getElementById("lonInp");
const useCoords=document.getElementById("useCoords");
const methodSel=document.getElementById("methodSel");
const resetAll=document.getElementById("resetAll");

/* فتح/إغلاق الإعدادات */
function openModal(){
  autoDetectChk.checked = !!AUTO_DETECT;
  hijriOffsetSel.value = String(HIJRI_OFFSET_DAYS);
  placeSearch.value = '';
  latInp.value = coords?.lat ?? '';
  lonInp.value = coords?.lon ?? '';
  document.getElementById('searchResults').style.display='none';
  modal.classList.add("open");
  document.body.style.overflow='hidden';
}
function closeModal(){ modal.classList.remove("open"); document.body.style.overflow=''; }
openPicker.addEventListener("click",openModal);
cancelPlace.addEventListener("click",closeModal);
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });

/* بحث عالمي */
attachSearch();

/* تحميل طرق الحساب ديناميكيًا */
loadMethods();

/* أزرار الإعدادات */
useMyLocation.addEventListener("click", async ()=>{
  AUTO_DETECT = true; localStorage.setItem("jaq_auto_detect","true");
  autoDetectChk.checked = true;
  await tryAutoLocate(true);
});

useCoords.addEventListener("click", async ()=>{
  const la = Number(latInp.value), lo = Number(lonInp.value);
  if(isNaN(la)||isNaN(lo)){ alert('أدخل إحداثيات صحيحة'); return; }
  coords={lat:la, lon:lo}; localStorage.setItem("jaq_coords", JSON.stringify(coords));
  resolvedName = await reverseGeocode(la, lo); localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
  TIMEZONE = await fetchTimezone(la, lo); localStorage.setItem("jaq_timezone", TIMEZONE);
  AUTO_DETECT=false; localStorage.setItem("jaq_auto_detect","false");
  showPlaceText(); await load();
});

savePlace.addEventListener("click", async ()=>{
  AUTO_DETECT = !!autoDetectChk.checked;
  localStorage.setItem("jaq_auto_detect", JSON.stringify(AUTO_DETECT));
  HIJRI_OFFSET_DAYS = Number(hijriOffsetSel.value||"0");
  localStorage.setItem("jaq_hijri_offset_days", String(HIJRI_OFFSET_DAYS));
  METHOD_ID = Number(methodSel.value||"0");
  localStorage.setItem("jaq_method_id", String(METHOD_ID));

  if (AUTO_DETECT && !coords){
    await tryAutoLocate(true);
  }else{
    await load();
  }
  closeModal();
});

resetAll.addEventListener("click", ()=>{
  localStorage.removeItem("jaq_hijri_offset_days");
  localStorage.removeItem("jaq_auto_detect");
  localStorage.removeItem("jaq_coords");
  localStorage.removeItem("jaq_resolved_name");
  localStorage.removeItem("jaq_method_id");
  localStorage.removeItem("jaq_timezone");
  HIJRI_OFFSET_DAYS=0; AUTO_DETECT=true; coords=null; resolvedName=null; METHOD_ID=0; TIMEZONE=Intl.DateTimeFormat().resolvedOptions().timeZone;
  showPlaceText(); load(); alert('تمت إعادة الضبط.');
});

/* بدء التشغيل */
(async function init(){
  if (AUTO_DETECT){
    const ok = await tryAutoLocate(false);
    if(!ok){ showPlaceText(); await load(); }
  }else{
    showPlaceText(); await load();
  }
})();
</script>
</body>
</html>
