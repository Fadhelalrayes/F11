<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>مناسك الحج وفق رأي السيد القائد دامت بركاته</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff; --text:#0f172a; --muted:#6b7280; --edge:#e6e2cc;
    --gold1:#f9f4e7; --gold2:#e3c179; --gold3:#c9a144;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Cairo',system-ui}
  header{
    background:linear-gradient(135deg,var(--gold1),var(--gold2) 60%,var(--gold3));
    color:#3b2b09;text-align:center;padding:18px;border-bottom:2px solid var(--gold3);font-weight:700
  }
  .wrap{max-width:940px;margin:0 auto;padding:18px}
  /* صندوق الإجابة — أكبر + مهيأ للنصوص الطويلة */
  .answer{
    background:#fff;border:1px solid var(--edge);border-radius:18px;padding:22px;line-height:1.95;
    box-shadow:0 12px 34px #0000000a, inset 0 0 0 1px #f5e8c7;
    min-height:320px; max-height:62vh; overflow:auto;
  }
  .answer h3{margin:.1rem 0 .75rem 0;font-size:1.15rem}
  .turn{display:flex;gap:10px;align-items:flex-start;margin:.6rem 0}
  .who{flex:0 0 40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:700}
  .user{background:linear-gradient(135deg,#f0e6cf,#e3c179);color:#4b2e05;border:1px solid #e6d8b3}
  .bot{background:linear-gradient(135deg,#e9f7ef,#b2ebc7);color:#064e3b;border:1px solid #c8f2da}
  .bubble{background:#fffaf1;border:1px solid #efe3c3;border-radius:14px;padding:12px 14px;flex:1}
  .src{margin-top:.6rem;color:#6b5d3a;font-size:.9rem;border-top:1px dashed #e8dfc2;padding-top:.5rem}
  .tag{display:inline-block;margin:.2rem .25rem 0 0;padding:.2rem .6rem;border:1px solid #e6e2cc;border-radius:999px;background:#fffaf1;font-size:.8rem}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:.6rem}
  .chip{border:1px solid #e6e2cc;background:#fff;border-radius:999px;padding:8px 12px;font-size:.9rem;cursor:pointer}
  .chip:hover{background:#fff9ea}
  .qa-form{margin-top:22px}
  label{display:block;font-weight:700;margin:0 0 6px}
  input[type="text"]{
    width:100%;padding:14px;border:1px solid var(--edge);border-radius:12px;font-size:1rem;outline:none
  }
  input:focus{border-color:var(--gold3);box-shadow:0 0 0 3px #c9a14433}
  .btn{
    margin-top:10px;width:100%;
    background:linear-gradient(135deg,var(--gold2),var(--gold3));
    border:none;color:#fff;font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer;font-size:1rem
  }
  .btn:hover{filter:brightness(.98)}
  footer{margin:22px auto 18px;text-align:center;color:#7b6a42;font-size:.95rem}
  mark{background:#fff0c2;padding:0 .2em;border-radius:.25em}
  ul,ol{margin:.4rem 1.25rem 0 0}
</style>
</head>
<body>
  <header>مناسك الحج وفق رأي السيد القائد دامت بركاته</header>

  <div class="wrap">
    <!-- الإجابة (كبيرة ومحاكية لأسلوب شات جبيتي) -->
    <div id="ans" class="answer"></div>

    <!-- السؤال في الأسفل ثم زر الإرسال تحته -->
    <form id="form" class="qa-form" autocomplete="off">
      <label for="q">السؤال</label>
      <input id="q" type="text" inputmode="text">
      <button type="submit" class="btn">إرسال</button>
    </form>
  </div>

  <footer>برمجة وتطوير : فاضل الريس</footer>

  <!-- قاعدة معارف موسّعة: لكل جواب "فِهْرِس مفاتيح" + "صيغ أسئلة متوقعة" (fups) -->
  <script id="KB" type="application/json">[
    /* ===== الوجوب والاستطاعة ===== */
    {"qid":"S001","q":"شروط وجوب حجة الإسلام","keys":["شروط الوجوب","عاقل","بالغ","مستطيع","فورية"],"a":"تجب حجة الإسلام مرة واحدة على العاقل البالغ المستطيع، وهي فورية بعد تحقق الاستطاعة (مالية، بدنية، أمن الطريق، زمانية).","ref":"مسائل 23–26",
     "fups":["ما المقصود بالاستطاعة المالية؟","هل يجب بيع البيت لتحصيل الاستطاعة؟","هل الاقتراض يكفي؟"]},
    {"qid":"S002","q":"ترك الحج مع تحقق الاستطاعة","keys":["ترك الحج","كبائر","فوري"],"a":"ترك الحج بعد حصول الاستطاعة مع العلم بالوجوب من الكبائر، ويأثم بالتأخير بلا عذر معتبر.","ref":"مسألة 1",
     "fups":["ما الحكم لو أخّرت الحج ثم زالت الاستطاعة؟","هل يجب عليّ القضاء لاحقًا؟"]},
    {"qid":"S003","q":"الاستطاعة المالية","keys":["الزاد والراحلة","نفقة العيال","ضروريات","الرجوع إلى الكفاية"],"a":"يشترط ملك الزاد والراحلة ونفقة العيال زمن السفر مع صون الضروريات الموافقة للشأن، وأن يكون له بعد الرجوع كفايةٌ للمعاش.","ref":"مسائل 34–55",
     "fups":["هل يجوز أخذ إجازة غير مدفوعة؟","هل الهبة أو التذكرة الممنوحة تكفي؟"]},
    {"qid":"S004","q":"الدَّين والاقتراض مع الاستطاعة","keys":["دين حال","مطالبة","اقتراض"],"a":"مع مطالبة الدائن لا تتحقق الاستطاعة حتى تُبرأ الذمة أو يأذن الدائن. ولا يجب الحج لمجرد إمكان الاقتراض؛ نعم لو اقترض وصار واجدًا وجب الأداء.","ref":"مسائل 44 ، 49",
     "fups":["ماذا لو كان الدين مؤجّلًا؟","هل أقدم الحج إن رضي الدائن؟"]},

    /* ===== المواقيت والإحرام ===== */
    {"qid":"M001","q":"المواقيت ومحاذاتها","keys":["مسجد الشجرة","وادي العقيق","الجحفة","يلملم","قرن المنازل","محاذاة"],"a":"المواقيت: مسجد الشجرة، وادي العقيق (المسلخ/الغمرة/ذات عرق)، الجحفة، يلملم، قرن المنازل. من لم يمرّ بميقات يُحرم من المحاذاة الصحيحة لمساره (برًا/جوًا) على خبرة الطريق.","ref":"مسائل 100–106",
     "fups":["كيف أعرف المحاذاة في الطائرة؟","هل يجوز الإحرام قبل الميقات؟"]},
    {"qid":"M002","q":"ميقات العمرة المفردة لأهل مكة","keys":["أدنى الحل","التنعيم","الحديبية","الجعرانة"],"a":"من كان في مكة وأراد عمرة مفردة يُحرم من أدنى الحل، والأفضل: التنعيم أو الحديبية أو الجعرانة.","ref":"مسألة 111",
     "fups":["هل تكفي أي نقطة من أدنى الحل؟","لو خرجت إلى جدة ثم عدت؟"]},
    {"qid":"M003","q":"انعقاد الإحرام وصيغة التلبية","keys":["التلبية","ينعقد الإحرام"],"a":"ينعقد الإحرام بالتلبية. الصيغة الواجبة: «لبيك اللهم لبيك، لبيك لا شريك لك لبيك»، وتستحب الزيادات المأثورة.","ref":"مسائل 132–135",
     "fups":["متى ألبّي في الطائرة؟","هل يجب التلفظ بالعربية؟"]},

    /* ===== محرمات الإحرام (مختار) ===== */
    {"qid":"P001","q":"محرمات الإحرام إجمالًا","keys":["محرمات الإحرام","التظليل","الطيب","المخيط"],"a":"منها: لبس المخيط للرجال، تغطية رأس الرجل ووجه المرأة، التظليل للرجال نهارًا حال السير، الطيب، النظر في المرآة بقصد الزينة، الحناء، التدهين، إزالة الشعر، الكحل، تقليم الأظفار، إخراج الدم، الفسوق، الجدال، قتل هوام البدن، صيد البر، الجماع، عقد النكاح، الاستمناء… ولكل مورد تفصيل وكفارة.","ref":"مسائل 159–161",
     "fups":["ما حكم العطر الخفيف؟","هل يجوز ظل السيارة ليلًا؟","هل يجوز تقليم ظفر مكسور؟"]},
    {"qid":"P002","q":"لبس المخيط للرجال والنساء","keys":["لبس المخيط","قميص","قفازات"],"a":"يحرم على الرجال لبس المخيط كالقميص والسراويل ونحوهما. يجوز للنساء لبس المخيط، لكن لا يلبسن القفازات ولا يغطين الوجه بالقناع.","ref":"مسائل 162–170",
     "fups":["هل الحزام المخيط يضر؟","ما حكم الكمامة؟"]},
    {"qid":"P003","q":"التظليل نهارًا للمحرم","keys":["تظليل","سقف","مظلة"],"a":"يحرم على الرجل حال السير نهارًا التظليل بسقف ونحوه؛ ويختلف الحكم ليلًا أو في غير السير. وعند الضرورة تُلزم فدية غالبًا.","ref":"مسألة 168",
     "fups":["إن اضطررت للظل بسبب المرض؟","هل خيمة عرفة تدخل بالحظر؟"]},
    {"qid":"P004","q":"استعمال الطيب وشمّه","keys":["طيب","عطر"],"a":"يحرم استعمال الطيب وشمُّه بقصد التلذذ، وتجب الكفارة على العمد. يُفصّل في السهو ونوع الرائحة.","ref":"مسألة 171",
     "fups":["ما حكم صابون معطر؟","هل رائحة الطعام عطر؟"]},

    /* ===== أعمال العمرة ===== */
    {"qid":"A001","q":"أعمال عمرة التمتع","keys":["عمرة التمتع","أعمال العمرة"],"a":"الإحرام من الميقات → الطواف → صلاة الطواف → السعي بين الصفا والمروة → التقصير.","ref":"مسألة 13",
     "fups":["هل يجوز تقديم السعي على الطواف لمرض؟","كم أشواط الطواف والسعي؟"]},
    {"qid":"A002","q":"عدد الأشواط للطواف والسعي","keys":["عدد الأشواط","الطواف","السعي"],"a":"الطواف سبعة أشواط ابتداءً من الحجر، والسعي سبعة أشواط مبتدئًا بالصفا ختامًا بالمروة.","ref":"باب الطواف/السعي",
     "fups":["ماذا لو شككت في العدد؟","تركت شوطًا سهوًا فماذا أفعل؟"]},
    {"qid":"A003","q":"ترك شوط من الطواف نسيانًا","keys":["ترك شوط","نسيان الطواف"],"a":"قبل تمام أربعة أشواط يُستأنف الطواف، وبعد تجاوز النصف يُتدارك على تفصيل ثم تُصلّى صلاة الطواف.","ref":"باب الطواف",
     "fups":["هل أعيد الوضوء؟","لو تذكرت بعد يوم؟"]},
    {"qid":"A004","q":"الطهارة للطواف وصلاة الطواف","keys":["طهارة","صلاة الطواف"],"a":"يشترط للطواف وصلاة الطواف الطهارة من الحدث والنجاسة. ومن نسي صلاة الطواف أتى بها متى تذكّر في موضعها المقرر.","ref":"باب الطواف/الصلاة",
     "fups":["أُصلي خلف المقام بعيدًا؟","هل تجزئ الصلاة في أي مكان من المسجد؟"]},

    /* ===== أعمال الحج ===== */
    {"qid":"H001","q":"أعمال حج التمتع بإجمال","keys":["حج التمتع","أعمال الحج"],"a":"الإحرام من مكة → الوقوف بعرفات → الوقوف بالمشعر → رمي جمرة العقبة → الهدي → الحلق/التقصير → طواف الحج وصلاته → السعي → طواف النساء وصلاته → المبيت بمنى ورمي الجمار أيام التشريق.","ref":"مسألة 15",
     "fups":["ترتيب يوم العيد؟","هل أستطيع التقديم لعذر؟"]},
    {"qid":"H002","q":"وقت الوقوف بعرفات","keys":["عرفات","وقت الوقوف"],"a":"الاختياري: من زوال يوم التاسع إلى الغروب. للاضطراري أحكامه إذا فات الاختياري.","ref":"باب الوقوف بعرفات",
     "fups":["فاتني الغروب ماذا أفعل؟","دخلت بعد الزوال بلحظات؟"]},
    {"qid":"H003","q":"الوقوف بالمشعر (مزدلفة)","keys":["المشعر","مزدلفة","الليل"],"a":"من ليلة العيد إلى طلوع الفجر، ويكفي إدراك جزء منه للمعذورين على التفصيل.","ref":"باب المشعر",
     "fups":["خروج الضعفة قبل منتصف الليل؟","ما حكم من لم يدرك الفجر؟"]},
    {"qid":"H004","q":"ترتيب أعمال يوم العيد","keys":["يوم العيد","ترتيب"],"a":"بعد المشعر: رمي جمرة العقبة → الذبح (الهدي) → الحلق/التقصير؛ ثم طواف الحج وصلاته والسعي، ثم طواف النساء وصلاته.","ref":"مسألة 260",
     "fups":["قدّمت الذبح على الرمي؟","حَلقت قبل الذبح؟"]},
    {"qid":"H005","q":"المبيت بمنى","keys":["المبيت بمنى","ليالي التشريق"],"a":"المبيت واجب ليلة 11 و12، وللمتأخر ليلة 13. تُرخّص أعذار مع فدية غالبًا.","ref":"مسألة 240",
     "fups":["أنا عامل خدمة هل عليّ فدية؟","كم ساعة يكفي للمبيت؟"]},
    {"qid":"H006","q":"وقت رمي الجمار","keys":["رمي الجمار","وقت"],"a":"جمرة العقبة يوم العيد، والجمار الثلاث أيام التشريق. الأفضل النهار، ويجوز ليلًا للمعذور مع مراعاة الترتيب والعدد (سبع لكل جمرة).","ref":"مسألة 245",
     "fups":["هل يجوز الرمي ليلًا بلا عذر؟","فاتني رمي يوم فماذا أفعل؟"]},
    {"qid":"H007","q":"من لم يجد الهدي","keys":["عدم الوجدان","الصوم"],"a":"ينتقل إلى الصوم: ثلاثة أيام في الحج وسبعة إذا رجع إلى أهله، على الترتيب المذكور.","ref":"مسألة 250",
     "fups":["هل أصوم الثلاثة بمنى؟","إن وجدت الهدي بعد الصوم؟"]},
    {"qid":"H008","q":"الاستنابة في الرمي","keys":["استنابة","الرمي"],"a":"تصح نيابة العاجز أو من فيه حرج شديد، مع نية النيابة ومراعاة الترتيب.","ref":"مسألة 255",
     "fups":["أنيب زوجتي عني؟","أستطيع بعض الأيام فقط؟"]},
    {"qid":"H009","q":"تقديم بعض الأعمال على بعض","keys":["تقديم","ترتيب"],"a":"الأصل الترتيب، ويجوز التقديم في موارد العذر وفق الضوابط المنصوصة.","ref":"مسألة 265",
     "fups":["قدّمت الطواف على الحلق؟","سعيت قبل طواف الحج؟"]},
    {"qid":"H010","q":"إفساد الحج بالجماع قبل الوقوف","keys":["إفساد الحج","جماع"],"a":"يُتمّ الحج وتجب الإعادة في العام القادم مع الهدي؛ والتفصيل بحسب الموضع والزمان.","ref":"مسألة 280",
     "fups":["جماع بعد الوقوف وقبل الطواف؟","هل تُجزئ الكفارة؟"]},
    {"qid":"H011","q":"العدول إلى الإفراد لضيق الوقت","keys":["عدول","إفراد","ضيق الوقت"],"a":"يجوز عند ضيق الوقت عن إدراك العمرة والحج معًا؛ وتكون الوظيفة حج الإفراد مع عمرة مفردة بعده.","ref":"مسألة 210",
     "fups":["كيف أنشئ نية الإفراد؟","هل أرجع للتمتع لو اتسع الوقت؟"]},

    /* ===== مسائل النساء ===== */
    {"qid":"W001","q":"لباس المرأة في الإحرام","keys":["لباس المرأة","حجاب","قناع","قفازات"],"a":"تلبس الساتر غير المزخرف بلا زينة، ويجوز لبس المخيط. لا تغطي الوجه بالقناع/النقاب، ولا تلبس القفازات. يجوز ستر الرأس بلا طيب.","ref":"مسألة 170",
     "fups":["كمامة طبية؟","لبس الجوارب للمرأة؟"]},
    {"qid":"W002","q":"تغطية وجه المرأة بالإسدال","keys":["إسدال الخمار","تغطية الوجه"],"a":"يجوز الإسدال من دون لصوق مباشر للوجه عند الحاجة، مع الاحتياط في اجتناب التغطية المباشرة.","ref":"مسألة 170 وما يلحقها",
     "fups":["حجّابي يلامس الوجه قليلًا؟","أغطي الوجه عند الرجال فقط؟"]},
    {"qid":"W003","q":"المرأة حاضت قبل الطواف","keys":["حيض قبل الطواف"],"a":"لا تأتي بالطواف حتى تطهر؛ ومع ضيق الوقت تعمل بالرخص كالتوكيل أو ما يقرره باب العدول بحسب الموارد.","ref":"مسألة 220",
     "fups":["إن طهرت بعد السفر؟","هل يصح الطواف بلا صلاة؟"]},
    {"qid":"W004","q":"حاضت أثناء الطواف","keys":["حيض أثناء الطواف"],"a":"تقطع الطواف وتنتظر الطهر لإتمام الأشواط ثم صلاة الطواف وإكمال الأعمال؛ ومع الضيق توجد رخص منصوصة.","ref":"مسألة 220",
     "fups":["أبني أم أعيد من الأول؟","متى أصلّي صلاة الطواف؟"]},
    {"qid":"W005","q":"حاضت قبل طواف الحج بعد السعي","keys":["حيض قبل طواف الحج"],"a":"تنتظر الطهر لطواف الحج وصلاته؛ ومع الضيق تُستعمل الرخص كالاستنابة أو الانتظار بحسب الحال.","ref":"مسائل النساء/الطواف",
     "fups":["لو تعذّر الطهر؟","هل أقدّم السعي؟"]},
    {"qid":"W006","q":"حاضت قبل طواف النساء","keys":["حيض قبل طواف النساء"],"a":"لا تحل الأزواج حتى يؤتى بطواف النساء وصلاته؛ فإن ضاق الوقت تستنيب للطواف ثم تصلي عند الطهر على التفصيل.","ref":"مسألة 230",
     "fups":["سافرت ولم أطف؟","هل يكفي النيابة بلا صلاة؟"]},
    {"qid":"W007","q":"المستحاضة وأعمال الطواف والصلاة","keys":["استحاضة","أغسال","وضوء"],"a":"تعمل بوظيفتها (وضوء/أغسال/ربط) بحسب الصغرى/الوسطى/الكبرى، ثم تؤدي الطواف والصلاة على وفق ذلك.","ref":"أبواب الطهارة للمستحاضة",
     "fups":["إذا انقطع الدم مؤقتًا؟","هل أؤخر العمل؟"]},
    {"qid":"W008","q":"النفساء في المناسك","keys":["نفاس","نفساء"],"a":"حكمها حكم الحائض: لا تأتي بالطواف والصلاة حتى تطهر. ومع الضيق تُعمل بالرخص كالاستنابة وفق الضوابط.","ref":"مسائل النساء/النفاس",
     "fups":["كم مدة النفاس المحسوبة هنا؟","إن طهرت قبل الرجوع؟"]},

    /* ===== تفاصيل إضافية عملية ===== */
    {"qid":"D001","q":"التحلل الأول والثاني","keys":["تحلل","محظورات"],"a":"بعد الرمي والذبح والحلق/التقصير يتحقق التحلل الأول وترتفع أكثر المحظورات، ويبقى ما يتعلق بالنساء حتى طواف النساء وصلاته وهو التحلل الثاني.","ref":"أبواب التحلل",
     "fups":["هل الطيب بعد التحلل الأول جائز؟","متى يحل عقد النكاح؟"]},
    {"qid":"D002","q":"حصى الجمار وشروطها","keys":["حصى الجمار","سبع"],"a":"سبع حصيات لكل جمرة، صغيرة من الحرم، طاهرة غير مغصوبة، تُرمى متعاقبة بنية القربة.","ref":"باب الرمي",
     "fups":["أكرر الرمي إن لم أصب العمود؟","آخذ الحصى من أي مكان؟"]},
    {"qid":"D003","q":"الرمي عن الغير مع العجز","keys":["استنابة في الرمي"],"a":"يجوز عن العاجز مع نية النيابة، ويُراعى الترتيب والعدد.","ref":"باب الرمي",
     "fups":["أنيب أكثر من شخص؟","أجمع رمي يومين؟"]},
    {"qid":"D004","q":"السعي قبل طواف الحج لعذر","keys":["تقديم السعي"],"a":"الأصل بعد طواف الحج وصلاته، ومع عذر منصوص توجد رخص بالتقديم وفق الضوابط.","ref":"باب الترتيب",
     "fups":["ما الأعذار المعتبرة؟","هل أعيد عند زوال العذر؟"]},
    {"qid":"D005","q":"الذبح خارج منى عند التعذر","keys":["ذبح خارج منى"],"a":"الأصل الذبح بمنى؛ ومع التعذر تُذكر بدائل كالتذكية في مكة على التفصيل مع لزوم الشروط.","ref":"باب الهدي",
     "fups":["أوكل جمعية الذبح؟","هل يشترط سنّ معيّن للهدي؟"]}
  ]</script>

  <script>
    /* ============== مطابقة أقوى + إجابة حوارية مع أسئلة متابعة (أسلوب شبيه شات جبيتي) ============== */
    const KB = JSON.parse(document.getElementById('KB').textContent||'[]');

    // تطبيع عربي قوي
    function norm(s){
      return (s||'').toLowerCase()
        .replace(/[\u064B-\u065F]/g,'')    // حركات
        .replace(/[إأآا]/g,'ا').replace(/[ى]/g,'ي').replace(/[ة]/g,'ه')
        .replace(/[ؤئ]/g,'ء').replace(/[ـ]/g,'')
        .replace(/[^\u0600-\u06FFa-z0-9 ]+/g,' ')
        .replace(/\s+/g,' ').trim();
    }
    function stripAl(w){return w.startsWith('ال') && w.length>3 ? w.slice(2) : w;}
    function toks(s){return norm(s).split(/[^ \u0600-\u06FFa-z0-9]+/).filter(Boolean).map(stripAl);}
    function bigrams(arr){const out=new Set();for(let i=0;i<arr.length-1;i++) out.add(arr[i]+' '+arr[i+1]);return out;}

    // مرادفات لتوسيع الاستعلام
    const SYNS = {
      "حيض":"حائض حاضت دم",
      "استحاضه":"مستحاضه دم مستمر",
      "نفاس":"نفساء دم النفاس",
      "مزدلفه":"مشعر المشعر",
      "تظليل":"مظله ظل سقف شمس",
      "طواف النساء":"طواف النسا",
      "هدي":"ذبح نحر",
      "رمي":"جمره جمار",
      "محاذاه":"محاذيه موازاه طائره جو",
      "تحلل":"حل محظورات"
    };
    function expand(q){ let t=norm(q); for(const k in SYNS){ if(t.includes(k)) t+=' '+SYNS[k]; } return t; }

    // فهرسة: نزن (keys>question>answer) + ثنائيات
    const INDEX = KB.map((e,i)=>{
      const k=toks((e.keys||[]).join(' ')), q=toks(e.q||''), a=toks(e.a||'');
      return {i,kset:new Set(k),qset:new Set(q),aset:new Set(a),kbi:bigrams(k),qbi:bigrams(q),abi:bigrams(a)};
    });
    function scoreEntry(qt,qbi,E){
      let s=0;
      qt.forEach(w=>{ if(E.kset.has(w)) s+=7; if(E.qset.has(w)) s+=3; if(E.aset.has(w)) s+=1; });
      qbi.forEach(bg=>{ if(E.kbi.has(bg)) s+=6; if(E.qbi.has(bg)) s+=3; if(E.abi.has(bg)) s+=1; });
      return s;
    }
    function retrieve(query){
      const exp=expand(query); const qtok=toks(exp); const qset=new Set(qtok); const qbi=bigrams(qtok);
      let best=[], top=0;
      for(const E of INDEX){
        const sc=scoreEntry(qset,qbi,E);
        if(sc>0){ if(sc>top){ top=sc; best=[E.i]; } else if(sc===top){ best.push(E.i); } }
      }
      return {ids:best.slice(0,3), score:top};
    }

    // إبراز كلمات
    function hi(text,query){
      let t=text; toks(query).forEach(w=>{ if(!w) return; try{ t=t.replace(new RegExp('('+w+')','gi'),'<mark>$1</mark>'); }catch(_){} });
      return t;
    }

    // تركيب جواب "حواري": بصيغة سؤال/جواب مختصرة ثم تفصيل + خطوات + أسئلة متابعة
    function composeDialog(q, items){
      const u = `
        <div class="turn">
          <div class="who user">س</div>
          <div class="bubble"><b>سؤال:</b> ${q.replace(/</g,'&lt;')}</div>
        </div>
      `;
      const best = items[0];
      const combined = items.map(x=>x.a).join(' ');
      const summary = hi(combined, q);

      // إن أمكن، استخرج خطوات موجزة
      const bullets = [];
      items.forEach(x=>{
        const parts = x.a.split(/→|، ثم| ثم /).map(s=>s.trim()).filter(p=>p && p.length>2);
        parts.forEach(p=>bullets.push(p));
      });
      const uniqSteps = [...new Set(bullets)].slice(0,7);

      // أسئلة متابعة افتراضية من الـ KB
      const fups = (best.fups||[]).slice(0,6);

      const a = `
        <div class="turn">
          <div class="who bot">ج</div>
          <div class="bubble">
            <div><b>جواب مختصر:</b> ${summary}</div>
            ${uniqSteps.length? `<div style="margin-top:.6rem"><b>باختصار العمليّات:</b><ol>`+uniqSteps.map(s=>`<li>${hi(s,q)}</li>`).join('')+`</ol></div>` : ``}
            <div class="src">المصدر: كتيّب أحكام الحج (leader.ir) — ${items.map(x=>x.ref).join(' ، ')}</div>
            ${fups.length? `<div class="chips"><span class="muted" style="color:#6b5d3a">أسئلة مقترحة:</span>`+fups.map(f=>`<button class="chip" data-q="${f}">${f}</button>`).join('')+`</div>`:``}
          </div>
        </div>
      `;
      return u+a;
    }

    function setAnswer(html){
      const ans = document.getElementById('ans');
      ans.innerHTML = html;
      // فعّل أزرار المتابعة
      ans.querySelectorAll('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=> run(ch.dataset.q));
      });
    }

    function run(q){
      const {ids,score} = retrieve(q);
      if(score<6 || !ids.length){
        const fallback = composeDialog(q, [{
          a:"لم أعثر على مسألة دقيقة لهذه الصياغة. جرّب مفاتيح مثل: طواف النساء، التظليل، المحاذاة، المبيت بمنى، الاستحاضة.",
          ref:"—",
          fups:["طواف النساء وحكمه؟","التظليل نهارًا للمحرم؟","كيف أحرم من الطائرة؟"]
        }]);
        setAnswer(fallback);
        return;
      }
      const items = ids.map(i=>KB[i]);
      const html = composeDialog(q, items);
      setAnswer(html);
    }

    // إرسال النموذج
    document.getElementById('form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = document.getElementById('q').value.trim();
      if(!q) return;
      run(q);
    });
  </script>
</body>
</html>
