<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ููุงููุช ุงูุตูุงุฉ ููู ุงููุฐูุจ ุงูุฌุนูุฑู</title>
<link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@600&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#0f172a; --muted:#6b7280; --bg:#f6f8fb; --border:#e5e7eb; --accent:#0ea5a6; --shadow:0 8px 20px rgba(2,6,23,.08); --hadith-color:#0d2a58; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); font-family:"Tajawal",sans-serif; color:var(--ink); padding:16px;}
  .container{width:min(1000px,100%); margin:auto; display:flex; flex-direction:column; gap:16px}
  .topClock{text-align:right; font-size:.95rem; font-weight:700; color:#084241}
  .hero{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:18px; text-align:center}
  .heroTitle{margin:0; font-family:"Reem Kufi",sans-serif; font-size:1.4rem; color:var(--ink)}
  .locationBox{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px 14px; display:flex; justify-content:space-between; align-items:center}
  .place{font-weight:800}
  .changeBtn{background:#eef6ff; border:1px solid var(--border); padding:6px 12px; border-radius:999px; font-weight:800; cursor:pointer}
  .infoRow{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media(max-width:720px){.infoRow{grid-template-columns:1fr}}
  .chip{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px; display:flex; align-items:center; gap:12px}
  .ico{width:34px; height:34px; display:grid; place-items:center; border-radius:8px; background:#eef2ff; font-size:1.2rem}
  .stack{display:flex; flex-direction:column}
  .label{font-size:.85rem; color:var(--muted); font-weight:700}
  .value{font-weight:800; font-size:1rem; font-variant-numeric:tabular-nums}
  .card{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px}
  .card h3{margin:0 0 10px; font-size:1rem; font-weight:800}
  table{width:100%; border-collapse:collapse}
  th,td{padding:12px; border-bottom:1px solid #f0f0f0; font-size:1rem}
  th{background:#fafafa; font-weight:800}
  td.name{text-align:right; font-weight:700}
  td.time{text-align:left; font-weight:800}
  tr.next td{background:linear-gradient(90deg,#0ea5a61a,transparent)}
  .events{display:none; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:14px}
  .events h3{margin:0 0 8px; font-size:1rem; font-weight:800}
  .evtGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:720px){.evtGrid{grid-template-columns:1fr}}
  .evtCol{border:1px dashed #e3e8f0; border-radius:10px; padding:10px}
  .evtCol h4{margin:0 0 6px; font-size:.9rem; color:var(--ink)}
  .evtItem{padding:6px 0; border-bottom:1px solid #f0f0f0}
  .evtItem:last-child{border-bottom:none}
  .evtText{font-weight:700}
  .hadith{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; text-align:center}
  .htext{margin:0; font-size:1.06rem; color:var(--hadith-color); line-height:1.9}
  .hsrc{display:inline-block; margin-top:12px; padding:6px 14px; border-radius:10px; background:#f5f7fa; border:1px solid var(--border); font-weight:800; color:#3b4656}
  footer{text-align:center; margin-top:8px}
  .credit{color:var(--hadith-color); font-weight:800}
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.28); z-index:60}
  .modal.open{display:grid}
  .box{width:min(520px,96%); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .rowCtrl{display:flex; gap:10px; align-items:center; margin:8px 0}
  .rowCtrl label{width:110px; color:var(--muted); font-weight:700}
  select{flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); font-weight:700}
  .actions{display:flex; gap:10px; margin-top:12px}
  .btn{border:1px solid var(--border); border-radius:10px; padding:.55rem .9rem; font-weight:800; cursor:pointer; background:#fff}
  .btn.primary{background:#eef6ff}
</style>
</head>
<body>
  <div class="container">
    <div class="topClock" id="topClock">--:-- --</div>

    <section class="hero">
      <h1 class="heroTitle">ููุงููุช ุงูุตูุงุฉ ููู ุงููุฐูุจ ุงูุฌุนูุฑู</h1>
    </section>

    <div class="locationBox">
      <div class="place" id="place">ุงูููุงูุฉุ ุงูุจุญุฑูู</div>
      <button class="changeBtn" id="openPicker" type="button">ุชุบููุฑ</button>
    </div>

    <section class="infoRow">
      <div class="chip">
        <div class="ico">๐</div>
        <div class="stack"><div class="label">ุงูุชุงุฑูุฎ ุงููุฌุฑู</div><div class="value" id="hijri">--</div></div>
      </div>
      <div class="chip">
        <div class="ico">๐</div>
        <div class="stack"><div class="label">ุงูุชุงุฑูุฎ ุงููููุงุฏู</div><div class="value" id="greg">--</div></div>
      </div>
    </section>

    <section class="card">
      <h3>ุงูุฌุฏูู ุงููููู</h3>
      <table>
        <thead><tr><th>ุงูุญุฏุซ</th><th>ุงูููุช</th></tr></thead>
        <tbody id="times"><tr><td colspan="2">ุฌุงุฑู ุงูุชุญูููโฆ</td></tr></tbody>
      </table>
    </section>

    <!-- ุตูุฏูู ุงูููุงุณุจุงุช: ุณูุจูู ูุฎูููุง ุฅู ูู ุชูุฌุฏ ููุงุณุจุงุช -->
    <section class="events" id="eventsBox">
      <h3>ููุงุณุจุงุช ุงูููู</h3>
      <div class="evtGrid">
        <div class="evtCol"><h4>ุงูููู</h4><div id="eventsToday"></div></div>
        <div class="evtCol"><h4>ุงููููุฉ</h4><div id="eventsTonight"></div></div>
      </div>
    </section>

    <section class="hadith">
      <p class="htext" id="hadithText"></p>
      <div class="hsrc" id="hadithSource"></div>
    </section>

    <footer><span class="credit">ุจุฑูุฌุฉ ูุชุทููุฑ ูุงุถู ุงูุฑูุณ</span></footer>
  </div>

  <!-- ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="rowCtrl"><label>ุงูุจูุฏ</label><select id="countrySel"></select></div>
      <div class="rowCtrl"><label>ุงููุฏููุฉ</label><select id="citySel"></select></div>
      <div class="rowCtrl">
        <label>ุชุนููุถ ุงููุฌุฑู</label>
        <select id="hijriOffsetSel">
          <option value="-2">-2 ููู</option>
          <option value="-1">-1 ููู</option>
          <option value="0" selected>ุจุฏูู ุชุนููุถ</option>
          <option value="1">+1 ููู</option>
          <option value="2">+2 ููู</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn primary" id="savePlace" type="button">ุญูุธ</button>
        <button class="btn" id="cancelPlace" type="button">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>

<script>
/* ========================= ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ========================= */
const MAP=[
 {ar:"ุงูุจุญุฑูู",en:"Bahrain",tz:"Asia/Bahrain",cities:[
   {ar:"ุงูููุงูุฉ",en:"Manama"},{ar:"ุงููุญุฑู",en:"Muharraq"},{ar:"ูุฏููุฉ ุนูุณู",en:"Isa Town"},
   {ar:"ูุฏููุฉ ุญูุฏ",en:"Hamad Town"},{ar:"ุณุชุฑุฉ",en:"Sitra"},{ar:"ุณุงุฑ",en:"Saar"},
   {ar:"ุงูุฏุฑุงุฒ",en:"Draz"},{ar:"ุฌุฏุญูุต",en:"Jidhafs"}
 ]},
 {ar:"ูุจูุงู",en:"Lebanon",tz:"Asia/Beirut",cities:[{ar:"ุจูุฑูุช",en:"Beirut"},{ar:"ุทุฑุงุจูุณ",en:"Tripoli"},{ar:"ุตูุฏุง",en:"Sidon"}]},
 {ar:"ุงูุนุฑุงู",en:"Iraq",tz:"Asia/Baghdad",cities:[{ar:"ุจุบุฏุงุฏ",en:"Baghdad"},{ar:"ุงูุจุตุฑุฉ",en:"Basrah"},{ar:"ุฃุฑุจูู",en:"Erbil"}]},
 {ar:"ุฅูุฑุงู",en:"Iran",tz:"Asia/Tehran",cities:[{ar:"ุทูุฑุงู",en:"Tehran"},{ar:"ูุดูุฏ",en:"Mashhad"},{ar:"ุฃุตููุงู",en:"Isfahan"}]},
 {ar:"ุงููููุช",en:"Kuwait",tz:"Asia/Kuwait",cities:[{ar:"ูุฏููุฉ ุงููููุช",en:"Kuwait City"},{ar:"ุญููู",en:"Hawalli"},{ar:"ุงูุฃุญูุฏู",en:"Al Ahmadi"}]},
 {ar:"ุงูุณุนูุฏูุฉ",en:"Saudi Arabia",tz:"Asia/Riyadh",cities:[{ar:"ุงูุฑูุงุถ",en:"Riyadh"},{ar:"ุฌุฏุฉ",en:"Jeddah"},{ar:"ุงูุฏูุงู",en:"Dammam"},{ar:"ููุฉ",en:"Mecca"},{ar:"ุงููุฏููุฉ",en:"Medina"}]}
];

const DEFAULT={countryEn:"Bahrain",countryAr:"ุงูุจุญุฑูู",cityEn:"Manama",cityAr:"ุงูููุงูุฉ",tz:"Asia/Bahrain"};
let current = JSON.parse(localStorage.getItem("jaq_prayer_place")||"null") || {...DEFAULT};
let HIJRI_OFFSET_DAYS = Number(localStorage.getItem("jaq_hijri_offset_days")||"0");

/* ููู ุฎุงุฑุฌู ุงุฎุชูุงุฑู ูุฅุถุงูุฉ ููุงุณุจุงุชู ุงูุฎุงุตุฉ */
const EVENTS_SOURCE_URL = null; // ุถุน ุฑุงุจุท JSON ุฅู ุฑุบุจุช

/* ุฃุญุงุฏูุซ */
const HADITHS=[
  {t:"ูุงู ุงูุฅูุงู ุงูุจุงูุฑ (ุนููู ุงูุณูุงู): ุฅุฐุง ุงุณุชูุจู ุงููุตูู ุงููุจูุฉ ุงุณุชูุจู ุงูุฑุญูู ุจูุฌูู ูุง ุฅูู ุบูุฑู.",s:"ุงููุตุฏุฑ: ููุฒุงู ุงูุญููุฉ"},
  {t:"ูุงู ุงูุฅูุงู ุนูู (ุนููู ุงูุณูุงู): ุฅุฐุง ูุงู ุงูุฑุฌู ุฅูู ุงูุตูุงุฉ ุฃูุจู ุฅุจููุณ ููุธุฑ ุฅููู ุญุณุฏุงู ููุง ูุฑู ูู ุฑุญูุฉ ุงููู ุงูุชู ุชุบุดุงู.",s:"ุงููุตุฏุฑ: ููุฒุงู ุงูุญููุฉ"},
  {t:"ูุงู ุงูุฅูุงู ุงูุฑุถุง (ุนููู ุงูุณูุงู): ุงูุตูุงุฉ ููุง ุฃุฑุจุนุฉ ุขูุงู ุจุงุจ.",s:"ุงููุตุฏุฑ: ููุฒุงู ุงูุญููุฉ"},
  {t:"ูุงู ุงูุฅูุงู ุนูู (ุนููู ุงูุณูุงู): ูุง ูููู! ููุณ ุงูุดุฃู ุฃู ุชุตูู ูุชุตูู ูุชุชุตุฏูุ ุฅููุง ุงูุดุฃู ุฃู ุชููู ุงูุตูุงุฉ ูุนูุช ุจููุจ ูููุ ูุนูู ุนูุฏ ุงููู ูุฑุถูุ ูุฎุดูุน ุณูู.",s:"ุงููุตุฏุฑ: ููุฒุงู ุงูุญููุฉ"},
  {t:"ุนู ุณุนุฏ ุจู ุฃุจู ููุงุต: ุณุฃูุช ุงููุจู ุตูู ุงููู ุนููู ูุขูู ุนู ูููู: ุงูุฐูู ูู ุนู ุตูุงุชูู ุณุงููู. ูุงู: ูู ุงูุฐูู ูุคุฎุฑูู ุงูุตูุงุฉ ุนู ููุชูุง.",s:"ุงููุตุฏุฑ: ุงูุณูู ุงููุจุฑู"},
  {t:"ูุงู ุฑุณูู ุงููู ุตูู ุงููู ุนููู ูุขูู: ูู ุชุฑู ุตูุงุชู ูุชุนูุฏุงู ููุฏ ูุฏู ุฏูููุ ููู ุชุฑู ุฃููุงุชูุง ูุฏุฎู ุงููููุ ูุงูููู ูุงุฏู ูู ุฌููู ููุง ูุงู ุชุนุงูู: ูููู ูููุตููู ุงูุฐูู ูู ุนู ุตูุงุชูู ุณุงููู.",s:"ุงููุตุฏุฑ: ุฌุงูุน ุงูุฃุฎุจุงุฑ"},
  {t:"ูุงู ุนุจุฏ ุงููู ุจู ูุณุนูุฏ: ุณุฃูุช ุฑุณูู ุงููู ุตูู ุงููู ุนููู ูุขูู: ุฃูู ุงูุฃุนูุงู ุฃุญุจ ุฅูู ุงููู ุฌู ุฌูุงููุ ูุงู: ุงูุตูุงุฉ ูููุชูุง.",s:"ุงููุตุฏุฑ: ุงูุฎุตุงู"}
];
function setHadith(){
  const h=HADITHS[Math.floor(Math.random()*HADITHS.length)];
  hadithText.textContent=h.t; hadithSource.textContent=h.s;
}

/* ========================= ุชูููู ุงูููุงุณุจุงุช ุงูุดูุนูุฉ ุงูููุณูุน ========================= */
let EVENTS={
  /* ูุญุฑู */
  "1-1":[{t:"ุฑุฃุณ ุงูุณูุฉ ุงููุฌุฑูุฉ"}],
  "1-2":[{t:"ุฏุฎูู ุงูุฅูุงู ุงูุญุณูู ุน ูุฑุจูุงุก"}],
  "1-7":[{t:"ุจุฏุก ููุน ุงููุงุก ุนู ุฎูุงู ุงูุญุณูู ุน"}],
  "1-9":[{t:"ุชุงุณูุนุงุก โ ููู ุฃุจู ุงููุถู ุงูุนุจุงุณ ุน"}],
  "1-10":[{t:"ุนุงุดูุฑุงุก โ ุดูุงุฏุฉ ุงูุฅูุงู ุงูุญุณูู ุน ูุฃูู ุจูุชู ูุฃุตุญุงุจู"}],
  "1-12":[{t:"ุฏูู ุงูุฃุฌุณุงุฏ ุงูุทุงูุฑุฉ ุจูุฑุจูุงุก"}],
  "1-25":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ุฒูู ุงูุนุงุจุฏูู ุน"}],

  /* ุตูุฑ */
  "2-7":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ุงูุญุณู ุงููุฌุชุจู ุน (ุงุฎุชูุงู ุงูุฑูุงูุงุช)"}],
  "2-20":[{t:"ุงูุฃุฑุจุนูู โ ุฒูุงุฑุฉ ุงูุฅูุงู ุงูุญุณูู ุน"}],
  "2-28":[{t:"ููุงุฉ ุงููุจู ุงูุฃูุฑู ๏ทบ (ุนูู ุงููุดููุฑ)"},
          {t:"ุดูุงุฏุฉ ุงูุฅูุงู ุงูุญุณู ุงููุฌุชุจู ุน (ููู ูุดููุฑ)"}],

  /* ุฑุจูุน ุงูุฃูู */
  "3-8":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ุงูุญุณู ุงูุนุณูุฑู ุน"}],
  "3-9":[{t:"ูุฑุญุฉ ุงูุฒูุฑุงุก (ููู ุงูุจุฑุงุกุฉ)"}],
  "3-17":[{t:"ุงููููุฏ ุงููุจูู ุงูุดุฑูู (ุนูุฏ ุงูุฅูุงููุฉ)"}],

  /* ุฑุจูุน ุงูุขุฎุฑ */
  "4-8":[{t:"ููุงุฏุฉ ุงูุฅูุงู ุงูุญุณู ุงูุนุณูุฑู ุน (ุงุฎุชูุงู ุงูุฑูุงูุงุช)"}],
  "4-10":[{t:"ููุงุฏุฉ ุงูุฅูุงู ุงูุญุณู ุงูุนุณูุฑู ุน (ุงุฎุชูุงู ุงูุฑูุงูุงุช)"}],

  /* ุฌูุงุฏู ุงูุฃููู */
  "5-5":[{t:"ูููุฏ ุงูุณูุฏุฉ ุฒููุจ ุจูุช ุนูู ุน"}],
  "5-13":[{t:"ุดูุงุฏุฉ ุงูุณูุฏุฉ ูุงุทูุฉ ุงูุฒูุฑุงุก ุน (ุฅุญุฏู ุงูุฑูุงูุงุช)"}],

  /* ุฌูุงุฏู ุงูุขุฎุฑุฉ */
  "6-3":[{t:"ุดูุงุฏุฉ ุงูุณูุฏุฉ ูุงุทูุฉ ุงูุฒูุฑุงุก ุน (ููู ูุดููุฑ)"}],
  "6-20":[{t:"ูููุฏ ุงูุณูุฏุฉ ูุงุทูุฉ ุงูุฒูุฑุงุก ุน"}],

  /* ุฑุฌุจ */
  "7-1":[{t:"ูููุฏ ุงูุฅูุงู ูุญูุฏ ุงูุจุงูุฑ ุน"}],
  "7-3":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ุนูู ุงููุงุฏู ุน"}],
  "7-10":[{t:"ูููุฏ ุงูุฅูุงู ูุญูุฏ ุงูุฌูุงุฏ ุน"}],
  "7-13":[{t:"ูููุฏ ุงูุฅูุงู ุนูู ุจู ุฃุจู ุทุงูุจ ุน"}],
  "7-25":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ููุณู ุงููุงุธู ุน"}],
  "7-27":[{t:"ุงููุจุนุซ ุงููุจูู"}],

  /* ุดุนุจุงู */
  "8-3":[{t:"ูููุฏ ุงูุฅูุงู ุงูุญุณูู ุน"}],
  "8-4":[{t:"ูููุฏ ุฃุจู ุงููุถู ุงูุนุจุงุณ ุน"}],
  "8-5":[{t:"ูููุฏ ุงูุฅูุงู ุฒูู ุงูุนุงุจุฏูู ุน"}],
  "8-11":[{t:"ูููุฏ ุนูู ุงูุฃูุจุฑ ุน"}],
  "8-15":[{t:"ูููุฏ ุงูุฅูุงู ุงูููุฏู ุนุฌู ุงููู ูุฑุฌู"}],

  /* ุฑูุถุงู */
  "9-10":[{t:"ููุงุฉ ุงูุณูุฏุฉ ุฎุฏูุฌุฉ ุงููุจุฑู ุน"}],
  "9-15":[{t:"ูููุฏ ุงูุฅูุงู ุงูุญุณู ุงููุฌุชุจู ุน"}],
  "9-19":[{t:"ุถุฑุจุฉ ุงูุฅูุงู ุนูู ุน โ ูููุฉ ูุฏุฑ"}],
  "9-21":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ุนูู ุน โ ูููุฉ ูุฏุฑ"}],
  "9-23":[{t:"ูููุฉ ุงููุฏุฑ (ููู ูุดููุฑ)"}],

  /* ุดููุงู */
  "10-1":[{t:"ุนูุฏ ุงููุทุฑ ุงููุจุงุฑู"}],
  "10-8":[{t:"ุฐูุฑู ูุฏู ูุจูุฑ ุงูุจููุน"}],
  "10-25":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ุฌุนูุฑ ุงูุตุงุฏู ุน"}],

  /* ุฐู ุงููุนุฏุฉ */
  "11-1":[{t:"ูููุฏ ุงูุณูุฏุฉ ูุงุทูุฉ ุงููุนุตููุฉ ุน"}],
  "11-11":[{t:"ูููุฏ ุงูุฅูุงู ุนูู ุจู ููุณู ุงูุฑุถุง ุน"}],
  "11-23":[{t:"ุฏุญู ุงูุฃุฑุถ"}],
  "11-29":[{t:"ุดูุงุฏุฉ ุงูุฅูุงู ูุญูุฏ ุงูุฌูุงุฏ ุน"}],

  /* ุฐู ุงูุญุฌุฉ */
  "12-7":[{t:"ููู ุงูุชุฑููุฉ"}],
  "12-8":[{t:"ุงูุฎุฑูุฌ ุฅูู ุนุฑูุฉ"}],
  "12-9":[{t:"ููู ุนุฑูุฉ (ูุดูุงุฏุฉ ูุณูู ุจู ุนููู ุน ุนูุฏ ุจุนุถ ุงูุฑูุงูุงุช)"}],
  "12-10":[{t:"ุนูุฏ ุงูุฃุถุญู ุงููุจุงุฑู"}],
  "12-18":[{t:"ุนูุฏ ุงูุบุฏูุฑ ุงูุฃุบุฑ"}],
  "12-24":[{t:"ููู ุงููุจุงููุฉ"}],
  "12-25":[{t:"ููู ูุฒูู ุณูุฑุฉ ุงูุฅูุณุงู"}]
};

/* ุฏูุฌ ููุงุณุจุงุช ุฅุถุงููุฉ ูู ููู ุฎุงุฑุฌู (ุงุฎุชูุงุฑู) */
async function mergeExternalEvents(){
  if(!EVENTS_SOURCE_URL) return;
  try{
    const r=await fetch(EVENTS_SOURCE_URL,{cache:"no-store"});
    if(!r.ok) throw new Error();
    const j=await r.json();
    const extra = j?.events || {};
    for (const k of Object.keys(extra)){
      EVENTS[k] = (EVENTS[k]||[]).concat(extra[k]);
    }
    try { renderEvents(); } catch {}
  }catch(e){ /* ุชุฌุงูู ุงูุฎุทุฃ */ }
}

/* ========================= ุฃุฏูุงุช ุนุงูุฉ ========================= */
function to12h(raw){
  if(!raw) return "--:-- --";
  const pure=String(raw).replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(pure)) return raw;
  let [H,M]=pure.split(":").map(Number);
  H = (H===24)?0:H;
  const h=H%12||12; return `${h}:${String(M).padStart(2,"0")} ${H<12?"AM":"PM"}`;
}
function updateClock(){
  topClock.textContent=new Intl.DateTimeFormat('en-GB',{timeZone:current.tz,hour:'2-digit',minute:'2-digit',hour12:true}).format(new Date());
}
function ymdInTZ(date, tz){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  return {Y:p.find(x=>x.type==='year').value, M:p.find(x=>x.type==='month').value, D:p.find(x=>x.type==='day').value};
}

/* ====== ุงููุฌุฑู ุนุจุฑ Aladhan (ุฃู ุงููุฑู) ูุน ููุทู ุจุนุฏ ุงููุบุฑุจ ูุชุนููุถ ====== */
const HIJRI_MONTHS_AR=["","ูุญุฑู","ุตูุฑ","ุฑุจูุน ุงูุฃูู","ุฑุจูุน ุงูุขุฎุฑ","ุฌูุงุฏู ุงูุฃููู","ุฌูุงุฏู ุงูุขุฎุฑุฉ","ุฑุฌุจ","ุดุนุจุงู","ุฑูุถุงู","ุดูุงู","ุฐู ุงููุนุฏุฉ","ุฐู ุงูุญุฌุฉ"];
function hasIntlIslamic(){ try{ new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric'}).format(new Date()); return true; }catch{ return false; } }
function g2jd(y,m,d){ const a=Math.floor((14-m)/12); y=y+4800-a; m=m+12*a-3; return d + Math.floor((153*m+2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045; }
function jd2islamic(jd){
  const l = jd - 1948440 + 10632;
  const n = Math.floor((l - 1) / 10631);
  let l2 = l - 10631*n + 354;
  const j = (Math.floor((10985 - l2)/5316)) * (Math.floor((50*l2)/17719)) + (Math.floor(l2/5670)) * (Math.floor((43*l2)/15238));
  l2 = l2 - (Math.floor((30 - j)/15)) * (Math.floor((17719*j)/50)) - (Math.floor(j/16)) * (Math.floor((15238*j)/43)) + 29;
  const m = Math.floor((24*l2)/709);
  const d = l2 - Math.floor((709*m)/24);
  const y = 30*n + j - 30;
  return {y,m,d};
}

/* ุฃููุงุช ุงูุตูุงุฉ (ูุงุญุชุณุงุจ "ุจุนุฏ ุงููุบุฑุจ") */
let lastTimings=null;
function refGregorianDateForHijri(baseDate){
  let ref = new Date(baseDate);
  if(lastTimings?.Maghrib){
    const pure=lastTimings.Maghrib.replace(/\s*\(.*?\)\s*/g,"").trim();
    let [H,M]=pure.split(":").map(Number); H=(H===24)?0:H;
    const magh = new Date(baseDate); magh.setHours(H||0,M||0,0,0);
    if(baseDate >= magh) ref = new Date(ref.getTime() + 86400000);
  }
  return ref;
}
async function fetchHijriFromAladhan(refDate){
  const {Y,M,D}=ymdInTZ(refDate, current.tz);
  const url=`https://api.aladhan.com/v1/gToH?date=${encodeURIComponent(`${D}-${M}-${Y}`)}&adjustment=${encodeURIComponent(HIJRI_OFFSET_DAYS||0)}`;
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("Hijri API HTTP "+r.status);
  const j=await r.json();
  const hj=j?.data?.hijri; if(!hj) throw new Error("Hijri API malformed");
  return hj;
}
function formatHijriFromObj(h){
  const weekdayAr = h?.weekday?.ar ?? new Intl.DateTimeFormat('ar',{timeZone:current.tz,weekday:'long'}).format(new Date());
  const day = Number(h.day||h.date?.split('-')[0]);
  const monthName = h?.month?.ar || HIJRI_MONTHS_AR[h?.month?.number||0] || '';
  const year = h.year || (h.date? h.date.split('-')[2] : '');
  return `${weekdayAr}ุ ${day} ${monthName} ${year} ูู`;
}
function localHijriFallback(refDate){
  try{
    if(hasIntlIslamic()){
      return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{timeZone:current.tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(refDate);
    }else{
      const p=ymdInTZ(refDate,current.tz);
      const jd=g2jd(+p.Y,+p.M,+p.D), h=jd2islamic(jd);
      const wd=new Intl.DateTimeFormat('ar',{timeZone:current.tz,weekday:'long'}).format(refDate);
      return `${wd}ุ ${h.d} ${HIJRI_MONTHS_AR[h.m]} ${h.y} ูู`;
    }
  }catch{ return "ุงูุชุงุฑูุฎ ุงููุฌุฑู (ุบูุฑ ูุชุงุญ)"; }
}

/* ุชุญุฏูุฏ ุงูุญุฏุซ ุงููุงุฏู */
function nextKey(t, tz){
  const order=["Imsak","Fajr","Sunrise","Dhuhr","Asr","Sunset","Maghrib","Isha","Midnight"];
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  const {Y,M,D}=ymdInTZ(nowTZ, tz);
  const cand=order.map(k=>{
    const raw=(t[k]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
    if(!/^\d{1,2}:\d{2}$/.test(raw)) return {k,diff:Infinity};
    let [HH,MM]=raw.split(':').map(Number); HH=(HH===24)?0:HH;
    return {k,diff:new Date(+Y,+M-1,+D,HH||0,MM||0,0)-nowTZ};
  });
  let n=cand.filter(x=>x.diff>=0).sort((a,b)=>a.diff-b.diff)[0];
  if(!n) n=cand.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff))[0];
  return n?.k||null;
}

/* ุตู ุฌุฏูู */
function tr(name,val,next=false){return `<tr class="${next?'next':''}"><td class="name">${name}</td><td class="time">${to12h(val||'')}</td></tr>`;}

/* ุชูุฏูุฑ ุงูุฅูุณุงู ุฅุฐุง ุบุงุจ */
function ensureImsak(t){
  if(!t.Imsak && t.Fajr){
    const pure=String(t.Fajr).replace(/\s*\(.*?\)\s*/g,"").trim();
    let [H,M]=pure.split(":").map(Number);
    const d=new Date(); d.setHours((H||0), (M||0)-10, 0, 0);
    t.Imsak = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }
  return t;
}

/* ููุงููุช ุงูุตูุงุฉ (method=0 ุฌุนูุฑู) */
async function fetchTimings(countryEn, cityEn){
  const url=`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(cityEn)}&country=${encodeURIComponent(countryEn)}&method=0`;
  const r=await fetch(url); if(!r.ok) throw new Error("ุชุนุฐูุฑ ุฌูุจ ุงูููุงููุช");
  const j=await r.json();
  return j.data.timings;
}

/* ุฑุณู ุงูุฌุฏูู + ุงูุชุงุฑูุฎูู + ุงูููุงุณุจุงุช */
async function renderTimes(t, tz){
  const timings=ensureImsak({...t}); 
  lastTimings=timings;

  const rows=[
    {n:"ุงูุฅูุณุงู",k:"Imsak"},
    {n:"ุฃุฐุงู ุงููุฌุฑ",k:"Fajr"},
    {n:"ุงูุดุฑูู",k:"Sunrise"},
    {n:"ุฃุฐุงู ุงูุธูุฑ",k:"Dhuhr"},
    {n:"ุฃุฐุงู ุงูุนุตุฑ",k:"Asr"},
    {n:"ุงูุบุฑูุจ",k:"Sunset"},
    {n:"ุฃุฐุงู ุงููุบุฑุจ",k:"Maghrib"},
    {n:"ุฃุฐุงู ุงูุนุดุงุก",k:"Isha"},
    {n:"ููุชุตู ุงูููู",k:"Midnight"}
  ];
  const k=nextKey(timings,tz);
  times.innerHTML=rows.map(r=>tr(r.n,timings[r.k],r.k===k)).join("");

  const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:current.tz}));
  greg.textContent = new Intl.DateTimeFormat('ar',{timeZone:current.tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(nowTZ);

  // ุงููุฌุฑู ุงูููุซูู + ููุทู ุจุนุฏ ุงููุบุฑุจ
  const ref = refGregorianDateForHijri(nowTZ);
  try{
    const hijriObj = await fetchHijriFromAladhan(ref);
    hijri.textContent = formatHijriFromObj(hijriObj);
    await renderEventsWithHijri(hijriObj, ref); // ุณููุธูุฑ/ูุฎูู ุตูุฏูู ุงูููุงุณุจุงุช ุญุณุจ ุงูุญุงู
  }catch(e){
    // Fallback
    hijri.textContent = localHijriFallback(ref);
    renderEvents(); // ุณูุฎูู ุงูุตูุฏูู ุฅู ูู ุชูุฌุฏ ููุงุณุจุงุช
  }
}

/* ููุงุณุจุงุช ุงูููู/ุงููููุฉ โ ุจุงุณุชุฎุฏุงู ูุงุฆู ุงููุฌุฑู ูู API */
async function renderEventsWithHijri(hijriObjToday, refToday){
  const todayM = Number(hijriObjToday?.month?.number||0);
  const todayD = Number(hijriObjToday?.day||0);

  const refTonight = new Date(refToday.getTime()+86400000);
  let hijriTomorrow=null;
  try{ hijriTomorrow = await fetchHijriFromAladhan(refTonight); }catch{}

  const nightM = Number(hijriTomorrow?.month?.number||0);
  const nightD = Number(hijriTomorrow?.day||0);

  drawEvents(todayM, todayD, nightM, nightD);
}

/* ููุงุณุจุงุช Fallback ุนูุฏูุง ูุง ูุชููุฑ ูุงุฆู ุงููุฌุฑู ูู API */
function renderEvents(){
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:current.tz}));
  const ref = refGregorianDateForHijri(nowTZ);

  let todayM,todayD,nightM,nightD;
  if(hasIntlIslamic()){
    const p1=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:current.tz,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(ref);
    todayM=+p1.find(x=>x.type==='month').value; todayD=+p1.find(x=>x.type==='day').value;
    const ref2=new Date(ref.getTime()+86400000);
    const p2=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:current.tz,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(ref2);
    nightM=+p2.find(x=>x.type==='month').value; nightD=+p2.find(x=>x.type==='day').value;
  }else{
    const {Y,M,D}=ymdInTZ(ref,current.tz);
    const h1=jd2islamic(g2jd(+Y,+M,+D));
    const h2=jd2islamic(g2jd(+Y,+M,+D+1));
    todayM=h1.m; todayD=h1.d; nightM=h2.m; nightD=h2.d;
  }
  drawEvents(todayM, todayD, nightM, nightD);
}

/* ุฑุณู ุตูุงุฏูู ุงูููุงุณุจุงุช โ ูู ูุธูุฑ ุงูุตูุฏูู ุฅู ูุงูุช ุงููุงุฆูุชุงู ูุงุฑุบุชูู */
function drawEvents(todayM,todayD,nightM,nightD){
  const box=document.getElementById('eventsBox');
  const todayEl=document.getElementById('eventsToday');
  const nightEl=document.getElementById('eventsTonight');

  const todayList = EVENTS[`${todayM}-${todayD}`] || [];
  const nightList = EVENTS[`${nightM}-${nightD}`] || [];

  if(todayList.length===0 && nightList.length===0){
    box.style.display='none';
    return;
  }
  box.style.display='block';

  const itemHTML=(e)=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`;
  todayEl.innerHTML = todayList.length ? todayList.map(itemHTML).join("") : `<div class="evtItem"><span class="evtText">ูุง ุชูุฌุฏ ููุงุณุจุฉ.</span></div>`;
  nightEl.innerHTML = nightList.length ? nightList.map(itemHTML).join("") : `<div class="evtItem"><span class="evtText">ูุง ุชูุฌุฏ ููุงุณุจุฉ.</span></div>`;
}

/* ========================= ุงูุชุญููู ุงูุนุงู ========================= */
function fmtGreg(){ return new Intl.DateTimeFormat('ar',{timeZone:current.tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(new Date()); }
async function load(){
  place.textContent=`${current.cityAr}ุ ${current.countryAr}`;
  hijri.textContent="--";
  greg.textContent=fmtGreg();
  times.innerHTML="<tr><td colspan=2>...</td></tr>";
  try{
    const t=await fetchTimings(current.countryEn,current.cityEn);
    await renderTimes(t,current.tz);
  }catch{
    times.innerHTML=`<tr><td colspan="2" style="color:#b91c1c">ุชุนุฐูุฑ ุฌูุจ ุงูููุงููุช.</td></tr>`;
    document.getElementById('eventsBox').style.display='none';
    const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:current.tz}));
    const ref = refGregorianDateForHijri(nowTZ);
    try{
      const hj = await fetchHijriFromAladhan(ref);
      hijri.textContent = formatHijriFromObj(hj);
    }catch{
      hijri.textContent = localHijriFallback(ref);
    }
  }
  // ุชุญููู ููุงุณุจุงุช ุฎุงุฑุฌูุฉ (ุฅู ููุฌุฏ ุฑุงุจุท)
  mergeExternalEvents();
}

/* ุณุงุนุฉ + ุญุฏูุซ */
setInterval(updateClock,1000); updateClock();
setHadith();

/* ========================= ูุงูุฐุฉ ุงูุฅุนุฏุงุฏ ========================= */
const modal=document.getElementById("modal");
const openPicker=document.getElementById("openPicker");
const cancelPlace=document.getElementById("cancelPlace");
const savePlace=document.getElementById("savePlace");
const countrySel=document.getElementById("countrySel");
const citySel=document.getElementById("citySel");
const hijriOffsetSel=document.getElementById("hijriOffsetSel");

function populateCities(countryEn){
  const c=MAP.find(x=>x.en===countryEn);
  citySel.innerHTML=(c?.cities||[]).map(m=>`<option value="${m.en}">${m.ar}</option>`).join("");
}
function openModal(){
  countrySel.innerHTML=MAP.map(c=>`<option value="${c.en}">${c.ar}</option>`).join("");
  countrySel.value=current.countryEn;
  populateCities(countrySel.value);
  citySel.value=current.cityEn;
  hijriOffsetSel.value=String(HIJRI_OFFSET_DAYS);
  modal.classList.add("open");
  document.body.style.overflow='hidden';
}
function closeModal(){ modal.classList.remove("open"); document.body.style.overflow=''; }
openPicker.addEventListener("click",openModal);
cancelPlace.addEventListener("click",closeModal);
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });
countrySel.addEventListener("change",()=>populateCities(countrySel.value));
savePlace.addEventListener("click",()=>{
  const c=MAP.find(x=>x.en===countrySel.value);
  const m=(c?.cities||[]).find(x=>x.en===citySel.value);
  if(c&&m){
    current={countryEn:c.en,countryAr:c.ar,cityEn:m.en,cityAr:m.ar,tz:c.tz};
    localStorage.setItem("jaq_prayer_place",JSON.stringify(current));
  }
  HIJRI_OFFSET_DAYS = Number(hijriOffsetSel.value||"0");
  localStorage.setItem("jaq_hijri_offset_days", String(HIJRI_OFFSET_DAYS));
  closeModal();
  load();
});

/* ุจุฏุก ุงูุชุดุบูู */
load();
</script>
</body>
</html>
