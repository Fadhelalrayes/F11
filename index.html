<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>مناسك الحج وفق رأي السيد القائد دامت بركاته</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff; --text:#0f172a; --muted:#6b7280; --edge:#e6e2cc;
    --gold1:#f9f4e7; --gold2:#e3c179; --gold3:#c9a144;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Cairo',system-ui}
  header{
    background:linear-gradient(135deg,var(--gold1),var(--gold2) 60%,var(--gold3));
    color:#3b2b09;text-align:center;padding:18px;border-bottom:2px solid var(--gold3);font-weight:700
  }
  .wrap{max-width:960px;margin:0 auto;padding:18px}
  .pane{
    background:#fff;border:1px solid var(--edge);border-radius:18px;
    box-shadow:0 12px 34px #0000000a, inset 0 0 0 1px #f5e8c7;
    min-height:300px;max-height:60vh;overflow:auto;padding:20px;line-height:1.95
  }
  .answer .turn{display:flex;gap:10px;align-items:flex-start;margin:.6rem 0}
  .who{flex:0 0 40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:700}
  .user{background:linear-gradient(135deg,#f0e6cf,#e3c179);color:#4b2e05;border:1px solid #e6d8b3}
  .bot{background:linear-gradient(135deg,#e9f7ef,#b2ebc7);color:#064e3b;border:1px solid #c8f2da}
  .bubble{background:#fffaf1;border:1px solid #efe3c3;border-radius:14px;padding:12px 14px;flex:1}
  .src{margin-top:.6rem;color:#6b5d3a;font-size:.9rem;border-top:1px dashed #e8dfc2;padding-top:.5rem}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:.6rem}
  .chip{border:1px solid #e6e2cc;background:#fff;border-radius:999px;padding:8px 12px;font-size:.9rem;cursor:pointer}
  .chip:hover{background:#fff9ea}
  .qa-form{margin-top:18px}
  label{display:block;font-weight:700;margin:0 0 6px}
  textarea{
    width:100%;height:150px;border:1px solid var(--edge);border-radius:18px;padding:16px;
    font-size:1rem;outline:none;resize:vertical;line-height:1.9
  }
  textarea:focus{border-color:var(--gold3);box-shadow:0 0 0 3px #c9a14433}
  .btn{
    margin-top:10px;width:100%;background:linear-gradient(135deg,var(--gold2),var(--gold3));
    border:none;color:#fff;font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer;font-size:1rem
  }
  .btn:hover{filter:brightness(.98)}
  .btn:disabled{opacity:0.7;cursor:not-allowed}
  footer{margin:22px auto 18px;text-align:center;color:#7b6a42;font-size:.95rem}
  mark{background:#fff0c2;padding:0 .2em;border-radius:.25em}
  ul,ol{margin:.4rem 1.25rem 0 0}
  .loading{text-align:center;padding:10px;color:var(--muted)}
</style>
</head>
<body>
  <header>مناسك الحج وفق رأي السيد القائد دامت بركاته</header>
  <div class="wrap">
    <section id="ans" class="pane answer"></section>
    <form id="form" class="qa-form" autocomplete="off">
      <label for="q">السؤال</label>
      <textarea id="q" placeholder="اكتب سؤالك هنا (مثال: حج، إحرام، طواف، استطاعة)"></textarea>
      <button type="submit" class="btn">إرسال</button>
    </form>
  </div>
  <footer>برمجة وتطوير: فاضل الريس</footer>

  <script id="KB" type="application/json">[
    {"qid":"INTRO","q":"منزلة الحج وفضله","keys":["منزلة الحج","فضل الحج","روايات الحج"],"a":"الحج -شرعًا- مجموعة مناسك خاصة، وهو ركن من أركان الإسلام. قال الإمام الباقر: 'بُنيَ الإسلامُ على خمس'. عن الإمام الصادق: 'الحاج والمعتمر وفد الله، إن سألوه أعطاهم...'","ref":"الصفحة 4؛ الكافي ج1 ح1؛ ج4 ح255","fups":["شروط وجوب الحج؟","أقسام الحج؟"]},
    {"qid":"S002","q":"حكم ترك الحج مع الاستطاعة","keys":["ترك الحج","كبائر","التأخير"],"a":"ترك الحج بعد حصول الاستطاعة من الكبائر، ويأثم بالتأخير بلا عذر. يجب القضاء إذا عادت الاستطاعة.","ref":"مسألة 1","fups":["تأخرتُ ثم زالت الاستطاعة؟","هل يجب القضاء؟"]},
    {"qid":"S003","q":"أقسام الحج والعمرة","keys":["أقسام الحج","تمتع","إفراد","قران"],"a":"التمتع: عمرة + حج. الإفراد: حج مع عمرة مفردة بعده. القران: عمرة + حج في إحرام واحد. صورة التمتع: الإحرام → عرفات → مشعر → رمي → هدي → تقصير → طواف → سعي → طواف نساء → مبيت منى.","ref":"مسائل 6-10، 13، 15، 210","fups":["حج التمتع؟","حج الإفراد؟"]},
    {"qid":"S001","q":"شروط وجوب حجة الإسلام","keys":["شروط الوجوب","عاقل","بالغ","مستطيع","فورية"],"a":"تجب مرة على العاقل البالغ المستطيع، فورية بعد الاستطاعة (مالية، بدنية، أمن، زمانية).","ref":"مسائل 14-15، 23–26","fups":["الاستطاعة المالية؟","العقل والبلوغ؟"]},
    {"qid":"S004","q":"الاستطاعة في الحج","keys":["الاستطاعة","زاد","راحلة","نفقة عيال"],"a":"ملك الزاد والراحلة، نفقة العيال، صون الضروريات، كفاية بعد الرجوع. لا تتحقق مع مطالبة الدائن إلا بإذنه. الاقتراض لا يوجب إلا إذا أصبح واجدًا.","ref":"مسائل 16-19، 34–55، 44، 49","fups":["الدين والاقتراض؟","نفقة العيال؟"]},
    {"qid":"S005","q":"الحج النيابي","keys":["الحج النيابي","شروط النائب","منوب عنه"],"a":"شروط النائب: عقل، بلوغ، إيمان، عدالة، قدرة. شروط المنوب: استطاعة، نية. يجوز للمعذور، ويجب الالتزام بالأوامر.","ref":"مسائل 21-24","fups":["شروط النائب؟","مسائل المنوب؟"]},
    {"qid":"M001","q":"المواقيت في الحج والعمرة","keys":["المواقيت","مسجد الشجرة","جحفة","محاذاة"],"a":"مسجد الشجرة، وادي العقيق، الجحفة، يلملم، قرن المنازل. الإحرام عند المحاذاة إذا لم يمر بميقات. لأهل مكة: أدنى الحل، أفضل التنعيم.","ref":"مسائل 26-28، 100–106، 111","fups":["محاذاة بالطائرة؟","إحرام قبل الميقات؟"]},
    {"qid":"M003","q":"واجبات الإحرام","keys":["واجبات الإحرام","نية","تلبية","ثوبين"],"a":"1- النية. 2- التلبية: 'لبيك اللهم لبيك'. 3- لبس الثوبين (إزار ورداء). مستحبات: اغتسال، تطيب. مكروه: تأخير التلبية.","ref":"مسائل 30-37، 132–135","fups":["التلبية في الجو؟","لباس الإحرام؟"]},
    {"qid":"P001","q":"محرمات الإحرام","keys":["محرمات الإحرام","مخيط","تظليل","طيب"],"a":"لبس المخيط للرجال، تغطية الرأس/الوجه، التظليل نهارًا، الطيب، إزالة الشعر/أظفار، إخراج الدم، فسوق، جدال، قتل هوام، صيد، جماع، نكاح، استمناء. كفارة للعمد.","ref":"مسائل 38-62، 159–161، 162–170، 168، 171، 175، 182، 185","fups":["لبس المخيط؟","التظليل؟","الطيب؟"]},
    {"qid":"T001","q":"شروط الطواف وصلاته","keys":["شروط الطواف","طهارة","نية","أشواط"],"a":"نية، طهارة من حدث/نجاسة، طهارة بدن/لباس، ختان، ستر عورة، عدم غصب، موالاة. سبعة أشواط من الحجر. صلاة: ركعتان خلف مقام إبراهيم. نسيان: يؤدي متى تذكر.","ref":"مسائل 66-79","fups":["ترك الطواف؟","صلاة الطواف؟"]},
    {"qid":"S001","q":"السعي بين الصفا والمروة","keys":["السعي","صفا مروة","أشواط"],"a":"سبعة أشواط من الصفا إلى المروة. يجوز تقديم لعذر، يشترط طهارة إذا واجب.","ref":"مسائل 80-81","fups":["عدد الأشواط؟","ترك شوط؟"]},
    {"qid":"TQ001","q":"التقصير في العمرة","keys":["التقصير","حلق"],"a":"قص قليل من الشعر من الرأس/اللحية. للنساء: جزء من الرأس بطول إصبع.","ref":"مسألة 82، 13","fups":["حلق للرجال؟","تقصير للنساء؟"]},
    {"qid":"H001","q":"أعمال الحج","keys":["أعمال الحج","عرفات","مزدلفة","رمي","هدي"],"a":"إحرام من مكة. وقوف عرفات: زوال التاسع إلى غروب. مشعر: ليلة العيد إلى فجر. رمي عقبة يوم العيد، جمار ثلاث أيام تشريق. هدي: ذبح أو صوم. تقصير/حلق. طواف حج وسعي وطواف نساء. مبيت منى ليالي 11-12.","ref":"مسائل 83-94، 15، 240، 245، 250","fups":["وقت عرفات؟","رمي الجمرات؟"]},
    {"qid":"IST001","q":"استفتاءات الحج والعمرة","keys":["استفتاءات","استطاعة","نيابي","إفراد"],"a":"استطاعة: نفقة كافية. نيابي: للمعذور. إفراد: عند ضيق وقت. مواقيت: كما فوق. محرمات: كفارة. طواف: طهارة. سعي: سبعة. مزدلفة: جزء كافٍ. حلق: أفضل. هدي: صوم إذا فات. مبيت: إلا عذر. رمي: نهار أفضل.","ref":"مسائل 95-122؛ leader.ir","fups":["الحائض في الطواف؟","الجماع قبل طواف نساء؟"]},
    {"qid":"IST002","q":"الاستفتاءات الجديدة","keys":["استفتاءات جديدة","حج","عمرة"],"a":"إحرام قبل ميقات: لا. حائض في طواف: تنتظر طهر. جماع قبل طواف نساء: حرام، كفارة. (تفاصيل في استفتاءات 2024-2025).","ref":"مسألة 122؛ alkawthartv.ir","fups":["إحرام قبل ميقات؟","حيض في طواف؟"]}
  ]</script>

  <script>
    const KB = JSON.parse(document.getElementById('KB').textContent || '[]');
    function norm(s) {
      return (s || '').toLowerCase()
        .replace(/[\u064B-\u065F]/g, '')
        .replace(/[إأآا]/g, 'ا').replace(/[ى]/g, 'ي').replace(/[ة]/g, 'ه')
        .replace(/[ؤئ]/g, 'ء').replace(/[ـ]/g, '')
        .replace(/[^\u0600-\u06FFa-z0-9 ]+/g, ' ')
        .replace(/\s+/g, ' ').trim();
    }
    function stripAl(w) { return w.startsWith('ال') && w.length > 3 ? w.slice(2) : w; }
    function toks(s) { return norm(s).split(/[^ \u0600-\u06FFa-z0-9]+/).filter(Boolean).map(stripAl); }
    function bigrams(arr) { const out = new Set(); for (let i = 0; i < arr.length - 1; i++) out.add(arr[i] + ' ' + arr[i + 1]); return out; }
    function lev(a, b) {
      const m = a.length, n = b.length; const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i; for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) { for (let j = 1; j <= n; j++) {
        const c = a[i - 1] === b[j - 1] ? 0 : 1;
        dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + c);
      } } return dp[m][n];
    }
    function sim(a, b) {
      if (!a || !b) return 0;
      const L = Math.max(a.length, b.length);
      return 1 - (lev(a, b) / L);
    }
    const SYNS = {
      "حيض": "حائض حاضت دم",
      "استحاضه": "مستحاضه دم مستمر",
      "نفاس": "نفساء دم النفاس",
      "مزدلفه": "مشعر المشعر",
      "تظليل": "مظله ظل سقف شمس",
      "طواف النساء": "طواف النسا",
      "هدي": "ذبح نحر",
      "رمي": "جمره جمار",
      "محاذاه": "محاذيه موازاه طائره جو",
      "تحلل": "حل محظورات",
      "لباس": "كسوه ملابس",
      "نية": "النية التلبية",
      "مناسك": "أحكام واجبات شعائر",
      "أحكام": "مناسك واجبات حكم",
      "واجبات": "مناسك أحكام",
      "حج": "مناسك حجة الإسلام",
      "عمرة": "عمرة تمتع مفردة"
    };
    function expand(q) { let t = norm(q); for (const k in SYNS) { if (t.includes(k)) t += ' ' + SYNS[k]; } return t; }
    const INDEX = KB.map((e, i) => {
      const k = toks((e.keys || []).join(' ')), q = toks(e.q || ''), a = toks(e.a || '');
      return {
        i, e, kset: new Set(k), qset: new Set(q), aset: new Set(a),
        kbi: bigrams(k), qbi: bigrams(q), abi: bigrams(a),
        flat: norm([e.q, e.a, (e.keys || []).join(' ')].join(' '))
      };
    });
    function scoreEntry(query) {
      const exp = expand(query); const qtoks = toks(exp); const qset = new Set(qtoks); const qbi = bigrams(qtoks);
      let best = [], top = 0;
      for (const E of INDEX) {
        let s = 0;
        qset.forEach(w => { if (E.kset.has(w)) s += 7; if (E.qset.has(w)) s += 3; if (E.aset.has(w)) s += 1; });
        qbi.forEach(bg => { if (E.kbi.has(bg)) s += 6; if (E.qbi.has(bg)) s += 3; if (E.abi.has(bg)) s += 1; });
        s += Math.max(0, Math.floor(sim(norm(query), E.flat) * 6));
        if (s > 0) { if (s > top) { top = s; best = [E.i]; } else if (s === top) { best.push(E.i); } }
      }
      return { ids: best.slice(0, 3), score: top };
    }
    function hi(text, query) {
      let t = text; toks(query).forEach(w => { if (!w) return; try { t = t.replace(new RegExp('(' + w + ')', 'gi'), '<mark>$1</mark>'); } catch (_) { } });
      return t;
    }
    function renderDialog(q, items) {
      const questionBlock = `
        <div class="turn">
          <div class="who user">س</div>
          <div class="bubble"><b>سؤال:</b> ${q.replace(/</g, '&lt;')}</div>
        </div>`;
      const answerSummary = hi(items.map(x => x.a).join(' '), q);
      const steps = [];
      items.forEach(x => {
        const parts = x.a.split(/→|، ثم| ثم /).map(s => s.trim()).filter(p => p && p.length > 2);
        parts.forEach(p => steps.push(p));
      });
      const uniqSteps = [...new Set(steps)].slice(0, 7);
      const refs = items.map(x => x.ref).join(' ، ');
      const fups = items.reduce((acc, x) => acc.concat(x.fups || []), []).filter((v, i, a) => a.indexOf(v) === i).slice(0, 6);
      const answerBlock = `
        <div class="turn">
          <div class="who bot">ج</div>
          <div class="bubble">
            <div><b>إجابة مختصرة:</b> ${answerSummary}</div>
            ${uniqSteps.length ? `<div style="margin-top:.6rem"><b>باختصار العمليّات:</b><ol>` + uniqSteps.map(s => `<li>${hi(s, q)}</li>`).join('') + `</ol></div>` : ``}
            <div class="src">المصدر: كتيّب أحكام الحج (leader.ir) — ${refs}</div>
            ${fups.length ? `<div class="chips"><span style="color:#6b5d3a">أسئلة مقترحة:</span>` + fups.map(f => `<button class="chip" data-q="${f}">${f}</button>`).join('') + `</div>` : ``}
          </div>
        </div>`;
      return questionBlock + answerBlock;
    }
    function setAnswer(html) {
      const ans = document.getElementById('ans');
      ans.innerHTML += html;
      ans.querySelectorAll('.chip').forEach(ch => {
        ch.addEventListener('click', (e) => {
          e.preventDefault();
          run(ch.dataset.q);
        });
      });
      ans.scrollTop = ans.scrollHeight;
    }
    function showLoading(show) {
      const ans = document.getElementById('ans');
      if (show) {
        ans.innerHTML += '<div class="loading">جاري البحث...</div>';
        ans.scrollTop = ans.scrollHeight;
      } else {
        const loading = ans.querySelector('.loading');
        if (loading) loading.remove();
      }
    }
    function fallback(q) {
      const html = renderDialog(q, [{
        a: "لم أعثر على إجابة دقيقة. جرب كلمات مثل: حج، إحرام، طواف، استطاعة، مواقيت.",
        ref: "—",
        fups: ["شروط وجوب الحج؟", "محرمات الإحرام؟", "أعمال الحج؟"]
      }]);
      setAnswer(html);
    }
    async function run(q) {
      if (!q.trim()) return;
      showLoading(true);
      await new Promise(resolve => setTimeout(resolve, 300));
      const { ids, score } = scoreEntry(q);
      showLoading(false);
      if (score < 1 || !ids.length) { fallback(q); return; }
      const items = ids.map(i => KB[i]);
      const html = renderDialog(q, items);
      setAnswer(html);
    }
    const form = document.getElementById('form');
    const input = document.getElementById('q');
    const btn = form.querySelector('.btn');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) return;
      btn.disabled = true;
      await run(q);
      input.value = '';
      input.focus();
      btn.disabled = false;
    });
    setAnswer(`
      <div class="turn">
        <div class="who bot">ج</div>
        <div class="bubble">
          <div>مرحبا! اسأل عن أحكام الحج بكلمات بسيطة مثل: حج، إحرام، طواف، استطاعة، مواقيت، وسأجيب بناءً على الكتيب.</div>
          <div class="chips"><span style="color:#6b5d3a">أسئلة مقترحة:</span>
            <button class="chip" data-q="منزلة الحج وفضله">منزلة الحج</button>
            <button class="chip" data-q="شروط وجوب حجة الإسلام">شروط الوجوب</button>
            <button class="chip" data-q="محرمات الإحرام">محرمات الإحرام</button>
            <button class="chip" data-q="أعمال الحج">أعمال الحج</button>
          </div>
        </div>
      </div>
    `);
  </script>
</body>
</html>
