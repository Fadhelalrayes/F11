<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>خدمة المعزين - نموذج يعمل باللمس</title>
<style>
  :root{
    --bg:#0f0f12;
    --panel:#1b1b22;
    --accent:#d4af37;
    --text:#e8e8ef;
    --muted:#9aa0a6;
    --good:#31c48d;
    --bad:#ef4444;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  body{
    margin:0;background:linear-gradient(180deg,#0b0b0e,#16161c);
    color:var(--text);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Naskh Arabic", sans-serif;
    height:100svh;overflow:hidden;
  }
  /* HUD */
  .hud{
    position:fixed; inset:0 0 auto 0; display:flex; gap:10px; padding:10px; align-items:center; justify-content:space-between; pointer-events:none;
  }
  .badge{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:10px; font-weight:600; pointer-events:auto;
  }
  #carryBadge{display:flex; align-items:center; gap:8px; min-width:120px; justify-content:center}
  .pillbar{
    display:flex; align-items:center; gap:10px; width:min(460px,70vw);
  }
  .bar{
    flex:1; height:12px; background:#2a2a33; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)
  }
  .bar > span{display:block; height:100%; width:40%; background:linear-gradient(90deg,#36d399,#16a34a); transition:width .2s}
  .muted{color:var(--muted)}
  #timer{min-width:90px; text-align:center}

  /* World */
  #game{
    position:fixed; inset:0; display:grid; place-items:center;
  }
  #arena{
    position:relative; width:min(100vw,900px); aspect-ratio:16/9; background:
      radial-gradient(100% 100% at 50% 120%, #0a0a0e 0%, #0000 60%) ,
      linear-gradient(180deg,#17171f,#101016);
    border:2px solid #262633; border-radius:18px; overflow:hidden;
  }
  /* Stage / mimbar */
  .stage{
    position:absolute; top:0; left:0; right:0; height:16%;
    background:linear-gradient(180deg,#1d1d26,#15151c);
    border-bottom:2px solid #2a2a36; display:flex; align-items:center; justify-content:center; gap:12px;
  }
  .minbar{
    width:120px; height:60px; background:#3a2d1a; border:3px solid #2b210f; border-radius:8px;
    position:relative; box-shadow: inset 0 0 10px rgba(0,0,0,.4);
  }
  .khatib{
    position:absolute; left:50%; transform:translateX(-50%); bottom:-8px;
    width:54px; height:72px; background:#23232b; border:2px solid #2f2f3a; border-radius:10px;
    display:grid; place-items:center; font-size:22px;
  }
  .khatib::after{content:"🗣️"; filter:grayscale(0.2)}
  .khatib .pulse{
    position:absolute; top:-16px; right:-16px; width:12px; height:12px; border-radius:50%;
    background:#6ee7b7; box-shadow:0 0 0 0 rgba(110,231,183,.7); animation:pulse 1.4s infinite;
  }
  @keyframes pulse{
    to{box-shadow:0 0 0 20px rgba(110,231,183,0)}
  }

  /* Seating rows */
  .row{position:absolute; left:4%; right:4%; height:12%; display:flex; gap:10px; justify-content:center}
  .row .seat{
    flex:0 0 7.5%; max-width:7.5%; height:100%; border-radius:6px;
    background:#1b1b23; border:2px solid #22222c; position:relative; overflow:visible;
    display:grid; place-items:center;
  }
  .row .seat .azem{
    width:70%; height:70%; border-radius:6px; background:#111116; border:2px solid #2b2b37; display:grid; place-items:center;
    font-size:18px;
  }
  .bubble{
    position:absolute; top:-22px; right:50%; transform:translateX(50%);
    background:#101015; border:1px solid #2e2e39; border-radius:999px; padding:2px 8px; font-size:14px;
    display:none; align-items:center; gap:6px; white-space:nowrap;
  }
  .bubble.show{display:flex}
  .bubble i{font-style:normal; font-size:16px;}
  .bubble.small{opacity:.8; transform:translateX(50%) scale(.9)}

  /* Drink table */
  .table{
    position:absolute; bottom:10%; left:3%; width:26%; height:18%;
    background:#272732; border:3px solid #2f2f3b; border-radius:10px; display:flex; gap:8px; padding:8px; align-items:center; justify-content:center;
  }
  .drink{
    width:28%; aspect-ratio:1; border-radius:10px; display:grid; place-items:center; font-size:30px;
    background:#1a1a22; border:2px solid #2b2b36; position:relative; user-select:none;
    transition:transform .08s;
  }
  .drink:active{transform:scale(.96)}
  .drink .label{
    position:absolute; bottom:4px; inset-inline:4px; background:rgba(0,0,0,.45); border-radius:6px; padding:2px 4px; font-size:12px; text-align:center
  }
  .glow{box-shadow:0 0 0 3px rgba(212,175,55,.4), 0 0 18px rgba(212,175,55,.25)}

  /* Player */
  #player{
    position:absolute; width:38px; height:50px; border-radius:8px; background:#20202a; border:2px solid #2f2f39;
    display:grid; place-items:center; font-size:20px; left:50%; top:70%;
    transform:translate(-50%,-50%);
  }
  #player::after{content:"🧑‍🍳"}
  #carryIcon{
    position:absolute; top:-14px; left:50%; transform:translateX(-50%); font-size:18px; display:none;
    background:#0e0e13; border:1px solid #2f2f3b; padding:2px 6px; border-radius:999px
  }

  /* Touch controls */
  .controls{
    position:fixed; inset:auto 0 0 0; height:40svh; pointer-events:none;
  }
  .stick{
    position:absolute; bottom:18px; left:18px; width:130px; height:130px; pointer-events:auto;
    opacity:.95;
  }
  .ring{
    position:absolute; inset:0; border-radius:50%; border:3px solid rgba(255,255,255,.15); background:rgba(255,255,255,.03)
  }
  .nub{
    position:absolute; width:64px; height:64px; border-radius:50%; border:2px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.09); left:33px; top:33px; transition:transform .02s;
  }

  /* Buttons */
  .top-right{
    position:absolute; top:10px; right:10px; display:flex; gap:10px; pointer-events:auto;
  }
  button{
    background:var(--panel); color:var(--text); border:1px solid #2a2a36; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
  }
  button:active{transform:translateY(1px)}
  .hint{
    position:absolute; bottom:8px; right:12px; font-size:12px; color:var(--muted); pointer-events:none; text-align:end;
  }

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:14%; transform:translateX(-50%); background:#121219; border:1px solid #2b2b36; padding:10px 14px; border-radius:12px; display:none;
  }
  .toast.show{display:block; animation:fade 1.4s both}
  @keyframes fade{0%{opacity:0; transform:translateX(-50%) translateY(8px)} 10%{opacity:1; transform:translateX(-50%) translateY(0)} 90%{opacity:1} 100%{opacity:0}}

  /* Responsive tweaks */
  @media (max-width:700px){
    .row .seat{flex-basis:9%; max-width:9%}
    .table{width:34%}
  }
</style>
</head>
<body>

<div class="hud">
  <div class="pillbar">
    <span class="muted">الرضا</span>
    <div class="bar"><span id="satisfaction" style="width:50%"></span></div>
    <span id="score" class="badge">النقاط: 0</span>
  </div>
  <div id="carryBadge" class="badge"><span>تحمل الآن:</span> <span id="carryText" class="muted">لا شيء</span></div>
  <div id="timer" class="badge">الوقت: 90</div>
</div>

<div id="game">
  <div id="arena" aria-label="قاعة المأتم">
    <div class="stage">
      <div class="minbar">
        <div class="khatib" title="الخطيب">
          <span class="pulse"></span>
        </div>
      </div>
      <div style="font-weight:700; opacity:.85">مجلس العزاء</div>
    </div>

    <!-- seating rows -->
    <div class="row" style="top:20%" id="row1"></div>
    <div class="row" style="top:33%" id="row2"></div>
    <div class="row" style="top:46%" id="row3"></div>
    <div class="row" style="top:59%" id="row4"></div>

    <!-- drink table -->
    <div class="table" id="table">
      <div class="drink" data-drink="tea" id="tea"><div class="label">شاي</div>🍵</div>
      <div class="drink" data-drink="coffee" id="coffee"><div class="label">قهوة</div>☕</div>
      <div class="drink" data-drink="water" id="water"><div class="label">ماء</div>💧</div>
    </div>

    <!-- player -->
    <div id="player" role="button" aria-label="الخادم">
      <div id="carryIcon">🍵</div>
    </div>

  </div>
</div>

<!-- Touch controls -->
<div class="controls" aria-hidden="false">
  <div class="stick" id="stick">
    <div class="ring"></div>
    <div class="nub" id="nub"></div>
  </div>
  <div class="top-right">
    <button id="reset">إعادة</button>
    <button id="pause">إيقاف</button>
  </div>
  <div class="hint">نصيحة: المس كوبًا لالتقاطه، والمس معزٍّ يطلب مشروبًا لتقديمه.</div>
</div>

<div id="toast" class="toast">رسالة</div>

<script>
/* ====== Utilities ====== */
const $  = (sel, root=document)=>root.querySelector(sel);
const $$ = (sel, root=document)=>[...root.querySelectorAll(sel)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];

const ARENA = $("#arena");
const PLAYER = $("#player");
const CARRY_ICON = $("#carryIcon");
const CARRY_TEXT = $("#carryText");
const CARRY_BADGE = $("#carryBadge");
const SAT = $("#satisfaction");
const SCORE = $("#score");
const TIMER = $("#timer");
const TABLE = $("#table");
const TOAST = $("#toast");

let state = {
  running:true,
  score:0,
  satisfaction:60, // 0..100
  seconds:90,
  speed:1.25, // px per ms
  carry:null, // 'tea' | 'coffee' | 'water' | null
  seats:[], // {el, bubble, wants, satisfied}
  lastSpawn:0,
  spawnEvery:2500, // ms
};

/* ====== Build seats / mourners ====== */
function buildRows(){
  const rows = [$("#row1"),$("#row2"),$("#row3"),$("#row4")];
  rows.forEach((row,i)=>{
    row.innerHTML="";
    const seatsCount = 10;
    for(let s=0;s<seatsCount;s++){
      const seat = document.createElement("div");
      seat.className="seat";
      const azem = document.createElement("div");
      azem.className="azem";
      azem.textContent="🧑";
      seat.appendChild(azem);

      const bubble = document.createElement("div");
      bubble.className="bubble";
      bubble.innerHTML = `<i>…</i>`;
      seat.appendChild(bubble);

      row.appendChild(seat);

      // seat record
      state.seats.push({
        el: seat,
        person: azem,
        bubble,
        wants: null,
        satisfied: false,
        cooldown: rand(2000,6000)
      });

      // Tap to serve
      seat.addEventListener("touchstart",(e)=>{
        e.preventDefault();
        handleServeTap(seat);
      }, {passive:false});
      seat.addEventListener("mousedown",(e)=>{
        e.preventDefault();
        handleServeTap(seat);
      });
    }
  });
}

/* ====== Spawning drink requests ====== */
const DRINK_EMOJI = {tea:"🍵", coffee:"☕", water:"💧"};
const DRINK_NAME  = {tea:"شاي", coffee:"قهوة", water:"ماء"};

function maybeAskForDrink(now){
  state.seats.forEach(rec=>{
    if(rec.wants || !state.running) return;
    rec.cooldown -= TICK;
    if(rec.cooldown <= 0){
      rec.wants = choice(["tea","coffee","water"]);
      rec.bubble.innerHTML = `<i>${DRINK_EMOJI[rec.wants]}</i> <span>${DRINK_NAME[rec.wants]}</span>`;
      rec.bubble.classList.add("show");
      rec.cooldown = rand(7000,13000);
    }
  });
}

/* ====== Player movement (virtual joystick) ====== */
const stick = $("#stick");
const nub = $("#nub");
let stickState = {active:false, cx:0, cy:0, dx:0, dy:0};

function stickPos(el){
  const r = el.getBoundingClientRect();
  return {x:r.left + r.width/2, y:r.top + r.height/2, rad:r.width/2 - 10};
}
function onStickStart(x,y){
  stickState.active = true;
  const p = stickPos(stick);
  stickState.cx=p.x; stickState.cy=p.y; stickState.dx=0; stickState.dy=0;
  moveNub(0,0);
}
function onStickMove(x,y){
  if(!stickState.active) return;
  const p = stickPos(stick);
  let dx = x - p.x, dy = y - p.y;
  const len = Math.hypot(dx,dy);
  const max = p.rad;
  if(len>max){ dx = dx/len*max; dy = dy/len*max; }
  stickState.dx = dx/max;
  stickState.dy = dy/max;
  moveNub(dx,dy);
}
function onStickEnd(){
  stickState.active=false;
  stickState.dx=0; stickState.dy=0;
  moveNub(0,0);
}
function moveNub(dx,dy){
  nub.style.transform = `translate(${dx}px,${dy}px)`;
}
function bindStick(){
  const ev = {
    start: (e)=>{ const t = e.touches? e.touches[0]: e; onStickStart(t.clientX,t.clientY); },
    move:  (e)=>{ const t = e.touches? e.touches[0]: e; onStickMove(t.clientX,t.clientY); },
    end:   ()=> onStickEnd()
  };
  stick.addEventListener("touchstart", e=>{e.preventDefault(); ev.start(e)}, {passive:false});
  window.addEventListener("touchmove",  e=>{ev.move(e)}, {passive:false});
  window.addEventListener("touchend",   ev.end);

  stick.addEventListener("mousedown", e=>{ev.start(e)});
  window.addEventListener("mousemove", e=>{ev.move(e)});
  window.addEventListener("mouseup",   ev.end);
}

/* ====== Interactions: pick & serve ====== */
function distance(a,b){
  const ra = a.getBoundingClientRect(), rb = b.getBoundingClientRect();
  const ax = ra.left + ra.width/2, ay = ra.top + ra.height/2;
  const bx = rb.left + rb.width/2, by = rb.top + rb.height/2;
  return Math.hypot(ax-bx, ay-by);
}
function near(el, target, px){ return distance(el, target) <= px; }

function setCarry(kind){ // 'tea' | 'coffee' | 'water' | null
  state.carry = kind;
  if(kind){
    CARRY_ICON.style.display="block";
    CARRY_ICON.textContent = DRINK_EMOJI[kind];
    CARRY_TEXT.textContent = DRINK_NAME[kind];
    CARRY_BADGE.classList.add("glow");
  }else{
    CARRY_ICON.style.display="none";
    CARRY_TEXT.textContent = "لا شيء";
    CARRY_BADGE.classList.remove("glow");
  }
}

/* tap drink to pick (must be near table) */
$$(".drink", TABLE).forEach(d=>{
  d.addEventListener("touchstart",(e)=>{
    e.preventDefault(); attemptPick(d);
  }, {passive:false});
  d.addEventListener("mousedown",(e)=>{
    e.preventDefault(); attemptPick(d);
  });
});
function attemptPick(dEl){
  if(!state.running) return;
  if(!near(PLAYER, TABLE, 220)){
    toast("اقترب من الطاولة أولاً");
    return;
  }
  const kind = dEl.dataset.drink;
  setCarry(kind);
  dEl.classList.add("glow");
  setTimeout(()=>dEl.classList.remove("glow"),180);
}

/* tap seat to serve if wants */
function handleServeTap(seat){
  if(!state.running) return;
  const rec = state.seats.find(s=>s.el===seat);
  if(!rec) return;
  if(!near(PLAYER, seat, 160)){
    toast("اقترب من المعزّي");
    return;
  }
  if(!rec.wants){
    toast("لا يوجد طلب هنا");
    return;
  }
  if(!state.carry){
    toast("أحمل مشروبًا أولاً");
    return;
  }
  if(state.carry !== rec.wants){
    adjustSatisfaction(-6);
    toast("مشروب خاطئ ❌");
    // penalty, clear carry
    setCarry(null);
    return;
  }
  // success
  rec.wants = null;
  rec.bubble.classList.remove("show");
  setCarry(null);
  addScore(10);
  adjustSatisfaction(+5);
  // mini thank-you bubble
  rec.bubble.innerHTML = "شكرًا 🤍";
  rec.bubble.classList.add("show","small");
  setTimeout(()=>{
    if(!rec.wants){
      rec.bubble.classList.remove("show","small");
      rec.bubble.innerHTML = `<i>…</i>`;
    }
  }, 800);
}

/* ====== Player physics loop ====== */
let last=performance.now();
const TICK = 1000/60; // logic step hint

function step(now){
  const dt = now - last; last = now;
  if(state.running){
    // move
    const v = state.speed * dt * 0.8; // px
    const dx = stickState.dx * v, dy = stickState.dy * v;
    const r = ARENA.getBoundingClientRect();
    const p = PLAYER.getBoundingClientRect();
    let x = p.left + dx, y = p.top + dy;
    // clamp inside arena
    x = clamp(x, r.left+4, r.right - p.width - 4);
    y = clamp(y, r.top + r.height*0.16 + 4, r.bottom - p.height - 4); // not on stage
    PLAYER.style.left = (x - r.left + p.width/2) + "px";
    PLAYER.style.top  = (y - r.top  + p.height/2) + "px";

    // spawn wishes
    maybeAskForDrink(now);
  }
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/* ====== Score / satisfaction / timer ====== */
function addScore(n){
  state.score += n;
  SCORE.textContent = "النقاط: " + state.score;
}
function adjustSatisfaction(n){
  state.satisfaction = clamp(state.satisfaction + n, 0, 100);
  SAT.style.width = state.satisfaction + "%";
  if(n>0){ SAT.style.background="linear-gradient(90deg,#36d399,#16a34a)"; }
  else if(n<0){ SAT.style.background="linear-gradient(90deg,#f87171,#ef4444)"; }
}
let timerInterval=null;
function startTimer(){
  clearInterval(timerInterval);
  TIMER.textContent = "الوقت: " + state.seconds;
  timerInterval = setInterval(()=>{
    if(!state.running) return;
    state.seconds--;
    TIMER.textContent = "الوقت: " + state.seconds;
    // passive drain if many unserved
    const waiting = state.seats.filter(s=>!!s.wants).length;
    if(waiting>=6) adjustSatisfaction(-1);
    if(state.seconds<=0){
      endRun();
    }
  },1000);
}
function endRun(){
  state.running=false;
  toast(`انتهى الوقت! نتيجتك: ${state.score} — الرضا: ${state.satisfaction}%`);
}

/* ====== Toast ====== */
let toastTO=null;
function toast(msg){
  clearTimeout(toastTO);
  TOAST.textContent = msg;
  TOAST.classList.add("show");
  toastTO = setTimeout(()=>TOAST.classList.remove("show"), 1400);
}

/* ====== Pause / Reset ====== */
$("#pause").addEventListener("click", ()=>{
  state.running = !state.running;
  $("#pause").textContent = state.running ? "إيقاف" : "متابعة";
  toast(state.running ? "متابعة" : "إيقاف مؤقت");
});
$("#reset").addEventListener("click", resetGame);

function resetGame(){
  // clear seats and rebuild
  state.seats = [];
  buildRows();
  setCarry(null);
  state.score=0; SCORE.textContent="النقاط: 0";
  state.satisfaction=60; SAT.style.width="60%";
  state.seconds=90; TIMER.textContent="الوقت: 90";
  state.running=true; $("#pause").textContent="إيقاف";
  toast("بداية جديدة");
}

/* ====== Init ====== */
function init(){
  bindStick();
  buildRows();
  setCarry(null);
  startTimer();

  // make table drinks tappable area friendly
  TABLE.addEventListener("touchstart", e=>{}, {passive:false});
}
init();

/* ====== Accessibility (desktop click move helper) ====== */
// allow clicking arena to auto-walk near that point (optional mini assist on desktop)
ARENA.addEventListener("dblclick", (e)=>{
  const r = ARENA.getBoundingClientRect();
  const px = e.clientX - r.left, py = e.clientY - r.top;
  PLAYER.style.left = px + "px"; PLAYER.style.top = py + "px";
});

</script>
</body>
</html>
