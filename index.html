<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© â€” Ø¬Ø¹ÙØ±ÙŠ (Ø¹Ø§Ù„Ù…ÙŠ)</title>

<!-- Ø®Ø·ÙˆØ· -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Noto+Naskh+Arabic:wght@500;700&family=Reem+Kufi:wght@600&display=swap" rel="stylesheet">

<!-- jsPDF + AutoTable Ù„ØªØµØ¯ÙŠØ± PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --bg:#f6f8fb; --border:#e5e7eb; --accent:#0ea5a6; --accent-2:#0bb5b7;
    --shadow:0 10px 30px rgba(2,6,23,.08); --hadith-color:#0d2a58; --chip:#ffffff; --card:#ffffff;
    --focus:#145ea8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#f7fafc 0%,#f3f7fb 100%);
    font-family:"Cairo", system-ui, -apple-system, "Segoe UI", sans-serif;
    color:var(--ink); padding:16px; line-height:1.7;
  }
  .container{width:min(1100px,100%); margin:auto; display:flex; flex-direction:column; gap:16px}

  :focus{outline:3px solid var(--focus); outline-offset:2px}
  [role="tablist"]{display:flex; gap:8px; flex-wrap:wrap}
  [role="tab"]{padding:.55rem .9rem; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:800}
  [role="tab"][aria-selected="true"]{background:#e9fbfb; border-color:#c9f1f1}

  .topBar{display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap}
  .topClock{display:flex; gap:10px; font-size:.95rem; font-weight:700; color:#0b4a49}
  .pill{display:inline-block; padding:.2rem .6rem; border-radius:999px; background:#eef7ff; border:1px solid #e3eefc; font-weight:800; font-size:.82rem}

  .hero{
    background:radial-gradient(1200px 300px at 50% -80px,#e7fbfb,transparent), #fff;
    border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:20px; text-align:center
  }
  .heroTitle{margin:0; font-family:"Reem Kufi",sans-serif; font-size:1.6rem; color:var(--ink); letter-spacing:.2px}

  .locationBox{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    box-shadow:var(--shadow); padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:12px
  }
  .place{font-weight:800; font-size:1.05rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .btn{
    background:linear-gradient(180deg,#ffffff,#f7fbff);
    border:1px solid var(--border); padding:.6rem 1rem; border-radius:12px;
    font-weight:800; cursor:pointer; transition:transform .1s ease, box-shadow .2s ease
  }
  .btn:hover{box-shadow:0 6px 18px rgba(2,6,23,.08)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#d9fbfb,#cfefff); border-color:#cbe3ff}
  .btn.warn{background:linear-gradient(180deg,#fff2f2,#ffe1e1)}

  .nextBox{background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:16px; display:grid; gap:10px}
  .nextTitle{font-weight:800; color:#0b3b3a; text-align:center; letter-spacing:.3px}
  .nextRow{display:flex; justify-content:space-between; align-items:center; font-weight:800}
  .nextName{font-size:1.06rem}
  .nextAt{font-variant-numeric:tabular-nums}
  .countdown{display:flex; justify-content:center; gap:10px; font-weight:900; font-size:1.6rem; letter-spacing:.5px; direction:ltr}
  .cd-seg{min-width:2.2ch; text-align:center; padding:.25rem .6rem; border:1px solid var(--border); border-radius:10px; background:#f8fafc}
  .cd-colon{opacity:.6}
  .note{font-size:.86rem; color:var(--muted); text-align:center}

  .infoRow{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media(max-width:720px){.infoRow{grid-template-columns:1fr}}

  .chip{background:var(--chip); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px; display:flex; align-items:center; gap:12px}
  .ico{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:#eaf3ff; font-size:1.2rem}
  .stack{display:flex; flex-direction:column}
  .label{font-size:.85rem; color:var(--muted); font-weight:700}
  .value{font-weight:800; font-size:1.02rem; font-variant-numeric:tabular-nums}

  .card{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px}
  .card h3{margin:0 0 10px; font-size:1rem; font-weight:800; text-align:center;}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px 8px; border-bottom:1px solid #f0f0f0; font-size:.98rem}
  th{background:#fafafa; font-weight:800}
  td.name{text-align:right; font-weight:700}
  td.time{text-align:left; font-weight:800}
  tr.next td{background:linear-gradient(90deg,#0ea5a61a,transparent)}

  .tabsCard{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px}
  .tabPanel{margin-top:10px}

  .events{display:none; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:14px}
  .events h3{margin:0 0 8px; font-size:1rem; font-weight:800; text-align:center;}
  .evtGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:720px){.evtGrid{grid-template-columns:1fr}}
  .evtCol{border:1px dashed #e3e8f0; border-radius:10px; padding:10px}
  .evtCol h4{margin:0 0 6px; font-size:.9rem; color:var(--ink)}
  .evtItem{padding:6px 0; border-bottom:1px solid #f0f0f0}
  .evtItem:last-child{border-bottom:none}
  .evtText{font-weight:700}

  .hadith{background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; text-align:center}
  .htext{margin:0; font-size:1.08rem; color:#0d2a58; line-height:1.95; font-family:"Noto Naskh Arabic","Cairo",serif}
  .hsrc{display:inline-block; margin-top:12px; padding:6px 14px; border-radius:10px; background:#f5f7fa; border:1px solid var(--border); font-weight:800; color:#3b4656}
  footer{text-align:center; margin-top:8px}
  .credit{color:#0d2a58; font-weight:800}

  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.28); z-index:60}
  .modal.open{display:grid}
  .box{width:min(680px,96%); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .rowCtrl{display:grid; grid-template-columns:160px 1fr; gap:10px; align-items:center; margin:10px 0}
  .rowCtrl label{color:var(--muted); font-weight:700}
  input[type="text"], input[type="number"], select{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); font-weight:700; background:#fff
  }
  .switchLine{display:flex; align-items:center; gap:10px}
  .switchLine input{transform:scale(1.2)}
  .hint{font-size:.85rem; color:var(--muted); margin-top:2px}
  .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  .results{width:100%; max-height:220px; overflow:auto; border:1px solid #eef2f6; border-radius:12px; display:none}
  .resItem{padding:.65rem .8rem; border-bottom:1px dashed #eef2f6; cursor:pointer}
  .resItem:hover{background:#f7fbff}

  .monthHead{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
  .gridMonth{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .dayBox{border:1px solid #eef2f6; border-radius:10px; background:#fff; padding:6px; min-height:86px}
  .dayHead{display:flex; justify-content:space-between; align-items:center; font-weight:800; font-size:.9rem}
  .badge{font-size:.72rem; background:#f0f9ff; border:1px solid #e0f2fe; border-radius:999px; padding:.05rem .4rem}
  .miniTimes{margin-top:6px; font-size:.82rem; line-height:1.5}
  .is-today{outline:2px dashed #0ea5a6; outline-offset:2px}
  .is-event{background:linear-gradient(180deg,#fff,#f7fbff)}
  .monthToolbar{display:flex; gap:8px; flex-wrap:wrap}
  .weekTable th,.weekTable td{font-size:.95rem}
</style>
</head>
<body>
  <div class="container">
    <div class="topBar" aria-label="Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <div class="pill" id="tzPill">â€”</div>
        <div class="topClock" aria-live="polite"><span id="topClock">--:-- --</span></div>
      </div>
      <span class="pill" id="netStatus" style="background:#fff3cd;border-color:#ffeeba;color:#7a5a00">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„â€¦</span>
    </div>

    <section class="hero" aria-labelledby="title">
      <h1 id="title" class="heroTitle">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ</h1>
    </section>

    <div class="locationBox" aria-label="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ">
      <div class="place" id="place">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦</div>
      <div class="monthToolbar">
        <button class="btn" id="downloadPDF" type="button" aria-label="ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù PDF Ù„Ù„Ø´Ù‡Ø±">ØªÙ†Ø²ÙŠÙ„ PDF Ù„Ù„Ø´Ù‡Ø±</button>
        <button class="btn" id="openPicker" type="button" aria-haspopup="dialog" aria-controls="modal">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>
    </div>

    <section class="nextBox" id="nextBox" aria-labelledby="nextTitle">
      <div id="nextTitle" class="nextTitle">Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…</div>
      <div class="nextRow">
        <span class="nextName" id="nextName">--</span>
        <span class="nextAt" id="nextAt" aria-live="polite">--:-- --</span>
      </div>
      <div class="countdown" aria-live="polite" aria-atomic="true">
        <span class="cd-seg" id="cdH">00</span><span class="cd-colon">:</span>
        <span class="cd-seg" id="cdM">00</span><span class="cd-colon">:</span>
        <span class="cd-seg" id="cdS">00</span>
      </div>
      <div class="note" id="nextNote">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
    </section>

    <section class="infoRow" aria-label="Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®">
      <div class="chip" role="group" aria-label="Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ">
        <div class="ico" aria-hidden="true">ğŸ—“</div>
        <div class="stack"><div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</div><div class="value" id="hijri">--</div></div>
      </div>
      <div class="chip" role="group" aria-label="Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ">
        <div class="ico" aria-hidden="true">ğŸ“…</div>
        <div class="stack"><div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</div><div class="value" id="greg">--</div></div>
      </div>
    </section>

    <section class="tabsCard" aria-label="Ø§Ù„Ø¹Ø±Ø¶">
      <div role="tablist" aria-label="Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª">
        <button role="tab" id="tab-day" aria-selected="true" aria-controls="panel-day" class="btn">Ø§Ù„ÙŠÙˆÙ…</button>
        <button role="tab" id="tab-week" aria-selected="false" aria-controls="panel-week" class="btn">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button role="tab" id="tab-month" aria-selected="false" aria-controls="panel-month" class="btn">Ø§Ù„Ø´Ù‡Ø±</button>
      </div>

      <div id="panel-day" role="tabpanel" aria-labelledby="tab-day" class="tabPanel" tabindex="0">
        <section class="card">
          <h3>Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
          <table aria-label="Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…">
            <thead><tr><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
            <tbody id="times"><tr><td colspan="2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr></tbody>
          </table>
        </section>
      </div>

      <div id="panel-week" role="tabpanel" aria-labelledby="tab-week" class="tabPanel" hidden tabindex="0">
        <section class="card">
          <h3>Ù…ÙˆØ§Ù‚ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
          <div style="overflow:auto">
            <table class="weekTable" id="weekTable" aria-label="Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹">
              <thead>
                <tr>
                  <th>Ø§Ù„ÙŠÙˆÙ…</th>
                  <th>Ø§Ù„ÙØ¬Ø±</th><th>Ø§Ù„Ø´Ø±ÙˆÙ‚</th><th>Ø§Ù„Ø¸Ù‡Ø±</th><th>Ø§Ù„Ø¹ØµØ±</th><th>Ø§Ù„Ù…ØºØ±Ø¨</th><th>Ø§Ù„Ø¹Ø´Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody id="weekBody"><tr><td colspan="7">â€¦</td></tr></tbody>
            </table>
          </div>
        </section>
      </div>

      <div id="panel-month" role="tabpanel" aria-labelledby="tab-month" class="tabPanel" hidden tabindex="0">
        <section class="card">
          <div class="monthHead">
            <h3 id="monthTitle" style="margin:0">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø´Ù‡Ø±</h3>
            <div>
              <button class="btn" id="prevMonth" aria-label="Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚">â€¹</button>
              <button class="btn" id="nextMonth" aria-label="Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ">â€º</button>
            </div>
          </div>
          <div class="gridMonth" id="gridMonth" aria-label="ØªÙ‚ÙˆÙŠÙ… Ø´Ù‡Ø±ÙŠ" data-offset="0"></div>
        </section>
      </div>
    </section>

    <section class="events" id="eventsBox" aria-label="Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…">
      <h3>Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="evtGrid">
        <div class="evtCol" id="colToday"><h4>Ø§Ù„ÙŠÙˆÙ…</h4><div id="eventsToday"></div></div>
        <div class="evtCol" id="colNight"><h4>Ø§Ù„Ù„ÙŠÙ„Ø©</h4><div id="eventsTonight"></div></div>
      </div>
    </section>

    <section class="hadith" aria-label="Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…">
      <p class="htext" id="hadithText"></p>
      <div class="hsrc" id="hadithSource"></div>
    </section>

    <footer><span class="credit">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Aladhan & OpenStreetMap â€” Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³</span></footer>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="box">
      <h3 id="modalTitle" style="margin:0 0 10px; text-align:center;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>

      <div class="rowCtrl">
        <label class="switchLine"><input type="checkbox" id="autoDetectChk"> <span>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span></label>
        <div class="hint">Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¬Ù‡Ø§Ø²Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
      </div>

      <div class="rowCtrl">
        <label for="placeSearch">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙƒØ§Ù†</label>
        <div>
          <input id="placeSearch" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¯ÙˆØ­Ø©ØŒ Ù‚Ø·Ø± | Berlin, Germany" aria-describedby="placeHint">
          <div id="placeHint" class="hint">Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ø¨Ø± OpenStreetMap/Nominatim.</div>
          <div id="searchResults" class="results" role="listbox" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«"></div>
        </div>
      </div>

      <div class="rowCtrl">
        <label>Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="latInp" type="number" step="any" placeholder="Latitude" aria-label="Latitude">
          <input id="lonInp" type="number" step="any" placeholder="Longitude" aria-label="Longitude">
          <button class="btn" id="useCoords" type="button">ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </div>

      <div class="rowCtrl">
        <label for="methodSel">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</label>
        <div>
          <select id="methodSel" aria-describedby="methodHint"></select>
          <div id="methodHint" class="hint">Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Shia Ithna-Ashari (Jafari).</div>
        </div>
      </div>

      <div class="rowCtrl">
        <label class="switchLine"><input type="checkbox" id="customAnglesChk"> <span>Ø²ÙˆØ§ÙŠØ§ Ù…Ø®ØµÙ‘ØµØ©</span></label>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="fajrAngle" type="number" step="0.1" placeholder="Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙØ¬Ø± (Â°)" aria-label="Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙØ¬Ø±" disabled>
          <input id="ishaAngle" type="number" step="0.1" placeholder="Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø´Ø§Ø¡ (Â°)" aria-label="Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø´Ø§Ø¡" disabled>
        </div>
        <div class="hint">Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù†Ø³ØªØ®Ø¯Ù… method=99 Ù…Ø¹ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ù…Ø®ØµÙ‘ØµØ©.</div>
      </div>

      <div class="rowCtrl">
        <label for="hijriOffsetSel">ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù‡Ø¬Ø±ÙŠ</label>
        <select id="hijriOffsetSel">
          <option value="-2">-2 ÙŠÙˆÙ…</option>
          <option value="-1">-1 ÙŠÙˆÙ…</option>
          <option value="0" selected>Ø¨Ø¯ÙˆÙ† ØªØ¹ÙˆÙŠØ¶</option>
          <option value="1">+1 ÙŠÙˆÙ…</option>
          <option value="2">+2 ÙŠÙˆÙ…</option>
        </select>
      </div>

      <div class="actions">
        <button class="btn" id="useMyLocation" type="button">Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†</button>
        <button class="btn primary" id="savePlace" type="button">Ø­ÙØ¸</button>
        <button class="btn" id="cancelPlace" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn warn" id="resetAll" type="button">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>
    </div>
  </div>

<script>
/* ========================= Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ========================= */
let HIJRI_OFFSET_DAYS = Number(localStorage.getItem("jaq_hijri_offset_days")||"0");
let AUTO_DETECT = JSON.parse(localStorage.getItem("jaq_auto_detect")||"true");
let coords = JSON.parse(localStorage.getItem("jaq_coords")||"null"); // {lat, lon}
let resolvedName = JSON.parse(localStorage.getItem("jaq_resolved_name")||"null"); // {cityAr,countryAr,display}
let METHOD_ID = Number(localStorage.getItem("jaq_method_id")||"0"); // 0: Jafari
let TIMEZONE = localStorage.getItem("jaq_timezone") || Intl.DateTimeFormat().resolvedOptions().timeZone;
let CUSTOM_ANGLES = JSON.parse(localStorage.getItem("jaq_custom_angles_on")||"false");
let FAJR_ANGLE = Number(localStorage.getItem("jaq_fajr_angle")||"0");
let ISHA_ANGLE = Number(localStorage.getItem("jaq_isha_angle")||"0");

/* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø¤Ø´Ù‘Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©) */
function setStatus(msg, ok=false){
  const el=document.getElementById('netStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.background = ok ? '#e6fffa' : '#fff3cd';
  el.style.borderColor = ok ? '#b2f5ea' : '#ffeeba';
  el.style.color = ok ? '#0b534e' : '#7a5a00';
}

/* ØªØ³Ù…ÙŠØ§Øª */
const NAMES = {Imsak:"Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ",Fajr:"Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø±",Sunrise:"Ø§Ù„Ø´Ø±ÙˆÙ‚",Dhuhr:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¸Ù‡Ø±",Asr:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹ØµØ±",Sunset:"Ø§Ù„ØºØ±ÙˆØ¨",Maghrib:"Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨",Isha:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø´Ø§Ø¡",Midnight:"Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„"};

/* Ø£Ø­Ø§Ø¯ÙŠØ« */
const HADITHS=[
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¨Ø§Ù‚Ø± (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØµÙ„ÙŠ Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø­Ù…Ù† Ø¨ÙˆØ¬Ù‡Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ ØºÙŠØ±Ù‡.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ø±Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø© Ø£Ù‚Ø¨Ù„ Ø¥Ø¨Ù„ÙŠØ³ ÙŠÙ†Ø¸Ø± Ø¥Ù„ÙŠÙ‡ Ø­Ø³Ø¯Ø§Ù‹ Ù„Ù…Ø§ ÙŠØ±Ù‰ Ù…Ù† Ø±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ Ø§Ù„ØªÙŠ ØªØºØ´Ø§Ù‡.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„ØµÙ„Ø§Ø© Ù„Ù‡Ø§ Ø£Ø±Ø¨Ø¹Ø© Ø¢Ù„Ø§Ù Ø¨Ø§Ø¨.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): ÙŠØ§ ÙƒÙ…ÙŠÙ„! Ù„ÙŠØ³ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªØµÙ„ÙŠ ÙˆØªØµÙˆÙ… ÙˆØªØªØµØ¯Ù‚ØŒ Ø¥Ù†Ù…Ø§ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ØµÙ„Ø§Ø© ÙØ¹Ù„Øª Ø¨Ù‚Ù„Ø¨ Ù†Ù‚ÙŠØŒ ÙˆØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù‡ Ù…Ø±Ø¶ÙŠØŒ ÙˆØ®Ø´ÙˆØ¹ Ø³ÙˆÙŠ.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ø¹Ù† Ø³Ø¹Ø¯ Ø¨Ù† Ø£Ø¨ÙŠ ÙˆÙ‚Ø§Øµ: Ø³Ø£Ù„Øª Ø§Ù„Ù†Ø¨ÙŠ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ¢Ù„Ù‡ Ø¹Ù† Ù‚ÙˆÙ„Ù‡: Ø§Ù„Ø°ÙŠÙ† Ù‡Ù… Ø¹Ù† ØµÙ„Ø§ØªÙ‡Ù… Ø³Ø§Ù‡ÙˆÙ†. Ù‚Ø§Ù„: Ù‡Ù… Ø§Ù„Ø°ÙŠÙ† ÙŠØ¤Ø®Ø±ÙˆÙ† Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù† ÙˆÙ‚ØªÙ‡Ø§.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ø§Ù„Ø³Ù†Ù† Ø§Ù„ÙƒØ¨Ø±Ù‰"},
  {t:"Ù‚Ø§Ù„ Ø±Ø³ÙˆÙ„ Ø§Ù„Ù„Ù‡ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ¢Ù„Ù‡: Ù…Ù† ØªØ±Ùƒ ØµÙ„Ø§ØªÙ‡ Ù…ØªØ¹Ù…Ø¯Ø§Ù‹ ÙÙ‚Ø¯ Ù‡Ø¯Ù… Ø¯ÙŠÙ†Ù‡ØŒ ÙˆÙ…Ù† ØªØ±Ùƒ Ø£ÙˆÙ‚Ø§ØªÙ‡Ø§ ÙŠØ¯Ø®Ù„ Ø§Ù„ÙˆÙŠÙ„ØŒ ÙˆØ§Ù„ÙˆÙŠÙ„ ÙˆØ§Ø¯Ù ÙÙŠ Ø¬Ù‡Ù†Ù… ÙƒÙ…Ø§ Ù‚Ø§Ù„ ØªØ¹Ø§Ù„Ù‰: ÙÙˆÙŠÙ„ Ù„Ù„Ù…ØµÙ„ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù‡Ù… Ø¹Ù† ØµÙ„Ø§ØªÙ‡Ù… Ø³Ø§Ù‡ÙˆÙ†.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±"},
  {t:"Ù‚Ø§Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¨Ù† Ù…Ø³Ø¹ÙˆØ¯: Ø³Ø£Ù„Øª Ø±Ø³ÙˆÙ„ Ø§Ù„Ù„Ù‡ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ¢Ù„Ù‡: Ø£ÙŠÙ‘ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø£Ø­Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø¬Ù„ Ø¬Ù„Ø§Ù„Ù‡ØŸ Ù‚Ø§Ù„: Ø§Ù„ØµÙ„Ø§Ø© Ù„ÙˆÙ‚ØªÙ‡Ø§.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ø§Ù„Ø®ØµØ§Ù„"}
];
function setHadith(){ const h=HADITHS[Math.floor(Math.random()*HADITHS.length)]; hadithText.textContent=h.t; hadithSource.textContent=h.s; }

/* Ø³Ø§Ø¹Ø© */
function updateClock(){
  topClock.textContent=new Intl.DateTimeFormat('ar-EG',{timeZone:TIMEZONE,hour:'2-digit',minute:'2-digit',hour12:true}).format(new Date());
  tzPill.textContent = TIMEZONE;
}
setInterval(updateClock,1000); updateClock();

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆÙ‚Øª */
function to12h(raw){
  if(!raw) return "--:-- --";
  const pure=String(raw).replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(pure)) return raw;
  let [H,M]=pure.split(":").map(Number); H=(H===24)?0:H;
  const h=H%12||12; return `${h}:${String(M).padStart(2,"0")} ${H<12?"AM":"PM"}`;
}
function ymdInTZ(date, tz){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  return {Y:p.find(x=>x.type==='year').value, M:p.find(x=>x.type==='month').value, D:p.find(x=>x.type==='day').value};
}

/* Ø§Ù„Ù‡Ø¬Ø±ÙŠ */
const HIJRI_MONTHS_AR=["","Ù…Ø­Ø±Ù…","ØµÙØ±","Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„","Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø±","Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰","Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©","Ø±Ø¬Ø¨","Ø´Ø¹Ø¨Ø§Ù†","Ø±Ù…Ø¶Ø§Ù†","Ø´ÙˆØ§Ù„","Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©","Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©"];
function hasIntlIslamic(){ try{ new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric'}).format(new Date()); return true; }catch{ return false; } }
function g2jd(y,m,d){ const a=Math.floor((14-m)/12); y=y+4800-a; m=m+12*a-3; return d + Math.floor((153*m+2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045; }
function jd2islamic(jd){
  const l = jd - 1948440 + 10632;
  const n = Math.floor((l - 1) / 10631);
  let l2 = l - 10631*n + 354;
  const j = (Math.floor((10985 - l2)/5316)) * (Math.floor((50*l2)/17719)) + (Math.floor(l2/5670)) * (Math.floor((43*l2)/15238));
  l2 = l2 - (Math.floor((30 - j)/15)) * (Math.floor((17719*j)/50)) - (Math.floor(j/16)) * (Math.floor((15238*j)/43)) + 29;
  const m = Math.floor((24*l2)/709);
  const d = l2 - Math.floor((709*m)/24);
  const y = 30*n + j - 30;
  return {y,m,d};
}
async function fetchHijriFromAladhan(refDate){
  const {Y,M,D}=ymdInTZ(refDate, TIMEZONE);
  const url=`https://api.aladhan.com/v1/gToH?date=${encodeURIComponent(`${D}-${M}-${Y}`)}&adjustment=${encodeURIComponent(HIJRI_OFFSET_DAYS||0)}`;
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("Hijri API HTTP "+r.status);
  const j=await r.json();
  const hj=j?.data?.hijri; if(!hj) throw new Error("Hijri API malformed");
  return hj;
}
function formatHijriFromObj(h, civilWeekday){
  const day = Number(h.day||h.date?.split('-')[0]);
  const monthName = h?.month?.ar || HIJRI_MONTHS_AR[h?.month?.number||0] || '';
  const year = h.year || (h.date? h.date.split('-')[2] : '');
  return `${civilWeekday}ØŒ ${day} ${monthName} ${year} Ù‡Ù€`;
}
function localHijriFallback(refDate, civilWeekday){
  try{
    if(hasIntlIslamic()){
      const parts=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:TIMEZONE,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(refDate);
      const y=+parts.find(p=>p.type==='year').value;
      const m=+parts.find(p=>p.type==='month').value;
      const d=+parts.find(p=>p.type==='day').value;
      return `${civilWeekday}ØŒ ${d} ${HIJRI_MONTHS_AR[m]} ${y} Ù‡Ù€`;
    }else{
      const p=ymdInTZ(refDate,TIMEZONE);
      const jd=g2jd(+p.Y,+p.M,+p.D), h=jd2islamic(jd);
      return `${civilWeekday}ØŒ ${h.d} ${HIJRI_MONTHS_AR[h.m]} ${h.y} Ù‡Ù€`;
    }
  }catch{ return "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ (ØºÙŠØ± Ù…ØªØ§Ø­)"; }
}

/* Ù…ÙˆØ§Ù‚ÙŠØª + Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù… */
let lastTimings=null;
function ensureImsak(t){
  if(!t.Imsak && t.Fajr){
    const pure=String(t.Fajr).replace(/\s*\(.*?\)\s*/g,"").trim();
    let [H,M]=pure.split(":").map(Number);
    const d=new Date(); d.setHours((H||0), (M||0)-10, 0, 0);
    t.Imsak = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }
  return t;
}
function nextKey(t){
  const order=["Imsak","Fajr","Sunrise","Dhuhr","Asr","Sunset","Maghrib","Isha","Midnight"];
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const {Y,M,D}=ymdInTZ(nowTZ, TIMEZONE);
  const cand=order.map(k=>{
    const raw=(t[k]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
    if(!/^\d{1,2}:\d{2}$/.test(raw)) return {k,diff:Infinity};
    let [HH,MM]=raw.split(':').map(Number); HH=(HH===24)?0:HH;
    return {k,diff:new Date(+Y,+M-1,+D,HH||0,MM||0,0)-nowTZ};
  });
  let n=cand.filter(x=>x.diff>=0).sort((a,b)=>a.diff-b.diff)[0];
  if(!n) n=cand.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff))[0];
  return n?.k||null;
}
function dateForKeyToday(timings, key){
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const {Y,M,D}=ymdInTZ(nowTZ, TIMEZONE);
  const raw=(timings[key]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(raw)) return null;
  let [H,Min]=raw.split(':').map(Number); H=(H===24)?0:H;
  return new Date(+Y,+M-1,+D,H||0,Min||0,0);
}

/* API URLs */
function timingsURL(lat, lon, dateObj){
  const ref = dateObj
    ? new Date(dateObj)
    : new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const {Y,M,D} = ymdInTZ(ref, TIMEZONE);
  const base = `https://api.aladhan.com/v1/timings/${D}-${M}-${Y}`;
  const params = new URLSearchParams({
    latitude: lat, longitude: lon,
    method: (CUSTOM_ANGLES && FAJR_ANGLE && ISHA_ANGLE) ? 99 : METHOD_ID
  });
  if (CUSTOM_ANGLES && FAJR_ANGLE && ISHA_ANGLE){
    params.set('fajr', String(FAJR_ANGLE));
    params.set('isha', String(ISHA_ANGLE));
  }
  return `${base}?${params.toString()}`;
}
function calendarURL(lat, lon, month, year){
  const params = new URLSearchParams({
    latitude: lat, longitude: lon, month, year,
    method: (CUSTOM_ANGLES && FAJR_ANGLE && ISHA_ANGLE) ? 99 : METHOD_ID
  });
  if (CUSTOM_ANGLES && FAJR_ANGLE && ISHA_ANGLE){
    params.set('fajr', String(FAJR_ANGLE));
    params.set('isha', String(ISHA_ANGLE));
  }
  return `https://api.aladhan.com/v1/calendar?${params.toString()}`;
}

/* Ø¬Ù„Ø¨ Ù…Ø¹ ÙƒØ§Ø´ */
const CACHE_TTL_MS = 6*60*60*1000; // 6 Ø³Ø§Ø¹Ø§Øª
function cacheGet(key){
  try{
    const j=JSON.parse(localStorage.getItem(key)||'null'); if(!j) return null;
    if (Date.now()-j.ts > CACHE_TTL_MS) return null;
    return j.data;
  }catch{return null;}
}
function cacheSet(key,data){ try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), data})); }catch{} }

async function fetchJSON(url){
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    return await r.json();
  }catch(e){
    console.error('[API ERROR]', e);
    throw e;
  }
}
async function getTodayTimings(lat, lon){
  const k=`pt_day_${TIMEZONE}_${Math.round(lat*10000)}_${Math.round(lon*10000)}_${METHOD_ID}_${CUSTOM_ANGLES?'C':''}_${FAJR_ANGLE}_${ISHA_ANGLE}`;
  const c=cacheGet(k); if(c) return c;
  try{
    const j=await fetchJSON(timingsURL(lat,lon));
    const data=j?.data?.timings; if(!data) throw new Error('No timings');
    cacheSet(k,data);
    return data;
  }catch(e){
    if(c) return c;
    throw e;
  }
}
async function getMonthCalendar(lat, lon, m, y){
  const k=`pt_mon_${y}_${m}_${TIMEZONE}_${Math.round(lat*10000)}_${Math.round(lon*10000)}_${METHOD_ID}_${CUSTOM_ANGLES?'C':''}_${FAJR_ANGLE}_${ISHA_ANGLE}`;
  const c=cacheGet(k); if(c) return c;
  try{
    const j=await fetchJSON(calendarURL(lat,lon,m,y));
    const data=j?.data; if(!data) throw new Error('No calendar');
    cacheSet(k,data);
    return data;
  }catch(e){
    if(c) return c;
    throw e;
  }
}

/* Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù…Ø®ØªØµØ±Ø© */
const EVENTS={
  "1-1":[{t:"Ø±Ø£Ø³ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù‡Ø¬Ø±ÙŠØ©"}],
  "1-2":[{t:"Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³ÙŠÙ† Ø¹ ÙƒØ±Ø¨Ù„Ø§Ø¡"}],
  "1-10":[{t:"Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ â€“ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³ÙŠÙ† Ø¹"}],
  "2-20":[{t:"Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ† â€“ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³ÙŠÙ† Ø¹"}],
  "3-17":[{t:"Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙˆÙŠ Ø§Ù„Ø´Ø±ÙŠÙ"}],
  "7-27":[{t:"Ø§Ù„Ù…Ø¨Ø¹Ø« Ø§Ù„Ù†Ø¨ÙˆÙŠ"}],
  "10-1":[{t:"Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ"}],
  "12-10":[{t:"Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ"}],
  "12-18":[{t:"Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯ÙŠØ± Ø§Ù„Ø£ØºØ±"}]
};
function drawEvents(todayM,todayD,nightM,nightD){
  const box=document.getElementById('eventsBox');
  const colToday=document.getElementById('colToday');
  const colNight=document.getElementById('colNight');
  const todayEl=document.getElementById('eventsToday');
  const nightEl=document.getElementById('eventsTonight');

  const todayList = EVENTS[`${todayM}-${todayD}`] || [];
  const nightList = EVENTS[`${nightM}-${nightD}`] || [];
  if(todayList.length===0 && nightList.length===0){
    box.style.display='none'; todayEl.innerHTML=""; nightEl.innerHTML=""; return;
  }
  box.style.display='block';
  if(todayList.length){ colToday.style.display='block'; todayEl.innerHTML = todayList.map(e=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`).join(""); } else { colToday.style.display='none'; todayEl.innerHTML=""; }
  if(nightList.length){ colNight.style.display='block'; nightEl.innerHTML = nightList.map(e=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`).join(""); } else { colNight.style.display='none'; nightEl.innerHTML=""; }
}

/* Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹/Ø§Ù„Ø´Ù‡Ø± */
function fillDayTable(t){
  const rows=[["Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ","Imsak"],["Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø±","Fajr"],["Ø§Ù„Ø´Ø±ÙˆÙ‚","Sunrise"],["Ø£Ø°Ø§Ù† Ø§Ù„Ø¸Ù‡Ø±","Dhuhr"],["Ø£Ø°Ø§Ù† Ø§Ù„Ø¹ØµØ±","Asr"],["Ø§Ù„ØºØ±ÙˆØ¨","Sunset"],["Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨","Maghrib"],["Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø´Ø§Ø¡","Isha"],["Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„","Midnight"]];
  const k=nextKey(t);
  times.innerHTML = rows.map(([n,kx])=>`<tr class="${kx===k?'next':''}"><td class="name">${n}</td><td class="time">${to12h(t[kx])}</td></tr>`).join("");
}
function getWeekRange(date){
  const d=new Date(date);
  const day=(d.getDay()+6)%7; // Ø§Ù„Ø§Ø«Ù†ÙŠÙ†=0
  const mon=new Date(d); mon.setDate(d.getDate()-day);
  const days=[...Array(7)].map((_,i)=>{ const x=new Date(mon); x.setDate(mon.getDate()+i); return x; });
  return days;
}
async function fillWeekTable(lat,lon){
  const today=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const week=getWeekRange(today);
  const rows=[];
  for(const d of week){
    let j=null;
    try{ j=await fetchJSON(timingsURL(lat,lon,d)); }catch(e){ j=null; }
    const t=ensureImsak(j?.data?.timings||{});
    const wd=new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long'}).format(d);
    rows.push(`<tr>
      <td>${wd}</td>
      <td>${to12h(t.Fajr)||'â€”'}</td><td>${to12h(t.Sunrise)||'â€”'}</td><td>${to12h(t.Dhuhr)||'â€”'}</td>
      <td>${to12h(t.Asr)||'â€”'}</td><td>${to12h(t.Maghrib)||'â€”'}</td><td>${to12h(t.Isha)||'â€”'}</td>
    </tr>`);
  }
  weekBody.innerHTML = rows.join('');
}
function monthNameAr(date){
  return new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,month:'long',year:'numeric'}).format(date);
}
async function fillMonthGrid(lat,lon,monthOffset=0){
  const base=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const first=new Date(base.getFullYear(), base.getMonth()+monthOffset, 1);
  const y=first.getFullYear(), m=first.getMonth()+1;
  monthTitle.textContent = `Ù…ÙˆØ§Ù‚ÙŠØª ${monthNameAr(first)}`;
  const cal = await getMonthCalendar(lat,lon,m,y);
  const grid = [];
  const startW=(new Date(y, m-1, 1).getDay()+6)%7; // Ø§Ù„Ø§Ø«Ù†ÙŠÙ†=0
  for(let i=0;i<startW;i++) grid.push('<div></div>');
  const todayYMD = ymdInTZ(new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE})), TIMEZONE);
  for(let i=0;i<cal.length;i++){
    const d=cal[i];
    const dd = d.date.readable.split(' ')[0]; // DD
    const hj = d.date.hijri;
    const t = ensureImsak(d.timings||{});
    const isToday = (+todayYMD.D===+dd && +todayYMD.M===m && +todayYMD.Y===y);
    const evts = EVENTS[`${hj.month.number}-${+hj.day}`];
    grid.push(`<div class="dayBox ${isToday?'is-today':''} ${evts?'is-event':''}">
      <div class="dayHead"><span>${+dd}</span><span class="badge">${hj.day} ${hj.month.ar}</span></div>
      <div class="miniTimes">
        ÙØ¬Ø±: ${to12h(t.Fajr)||'â€”'}<br>
        Ø¸Ù‡Ø±: ${to12h(t.Dhuhr)||'â€”'}<br>
        Ù…ØºØ±Ø¨: ${to12h(t.Maghrib)||'â€”'}<br>
        Ø¹Ø´Ø§Ø¡: ${to12h(t.Isha)||'â€”'}
      </div>
    </div>`);
  }
  gridMonth.innerHTML = grid.join('');
  gridMonth.dataset.offset = String(monthOffset);
}

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
function selectTab(id){
  const tabs=[tab-day,tab-week,tab-month];
  const panels=[panel-day,panel-week,panel-month];
  tabs.forEach((t,i)=>{ const sel=(t.id===id); t.setAttribute('aria-selected', sel?'true':'false'); panels[i].hidden = tabs[i].id!==id; if(sel) panels[i].focus(); });
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù… + Ø§Ù„Ø¹Ø¯Ø§Ø¯ */
let cdTimer=null;
function updateNextBox(){
  if(!lastTimings) return;
  const key = nextKey(lastTimings);
  const target = dateForKeyToday(lastTimings, key);
  if(!key || !target){ nextName.textContent="--"; nextAt.textContent="--:-- --"; setCD(0); return; }
  nextName.textContent = NAMES[key] || key;
  nextAt.textContent = to12h(lastTimings[key]);
  nextNote.textContent = (key==="Sunrise" ? "Ø²Ù…Ù† Ø§Ù„Ø´Ø±ÙˆÙ‚" : key==="Sunset" ? "ÙˆÙ‚Øª Ø§Ù„ØºØ±ÙˆØ¨" : "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ");
  if(cdTimer) clearInterval(cdTimer);
  cdTimer = setInterval(()=>tickCountdown(target,key),1000);
  tickCountdown(target,key);
}
function setCD(ms){
  ms = Math.max(0, ms|0);
  let s = Math.floor(ms/1000);
  const h = Math.floor(s/3600); s%=3600;
  const m = Math.floor(s/60); s%=60;
  cdH.textContent = String(h).padStart(2,'0');
  cdM.textContent = String(m).padStart(2,'0');
  cdS.textContent = String(s).padStart(2,'0');
}
function tickCountdown(target,key){
  const now=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const diff = target - now; setCD(diff);
  if(diff<=0){ clearInterval(cdTimer); loadAll(); }
}

/* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© */
async function fetchTimezone(lat, lon){
  try{
    const u=`https://api.aladhan.com/v1/timeZone?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}`;
    const j=await fetchJSON(u);
    return j?.data?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
  }catch{ return Intl.DateTimeFormat().resolvedOptions().timeZone; }
}
async function reverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&format=jsonv2&accept-language=ar`;
  const r = await fetch(url, {cache:'no-store'});
  const j = await r.json();
  const addr = j.address || {};
  const city = addr.city || addr.town || addr.village || addr.suburb || j.name || '';
  const country = addr.country || '';
  const display = j.display_name || '';
  return {cityAr: city || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', countryAr: country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', display};
}
function showPlaceText(){
  if (resolvedName){
    place.textContent = `${resolvedName.cityAr}ØŒ ${resolvedName.countryAr}`;
    place.title = resolvedName.display || '';
  }else{ place.textContent = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; place.title=''; }
}

/* Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ + Ø§Ù„Ø­Ø§Ù„Ø© */
async function renderCore(lat,lon){
  setStatus('Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…â€¦');
  let t=null;
  try{ t=await getTodayTimings(lat,lon); }catch(e){ console.error(e); }
  if(!t){
    times.innerHTML=`<tr><td colspan="2" style="color:#b91c1c">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ….</td></tr>`;
    setStatus('ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…', false);
  }else{
    lastTimings=ensureImsak(t); fillDayTable(lastTimings); updateNextBox();
    setStatus('ØªÙ… Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…', true);
  }

  const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  greg.textContent = new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(nowTZ);
  const civilWeekday = new Intl.DateTimeFormat('ar',{timeZone:TIMEZONE,weekday:'long'}).format(nowTZ);

  try{
    const hijriObj = await fetchHijriFromAladhan(nowTZ);
    hijri.textContent = formatHijriFromObj(hijriObj, civilWeekday);
    const tomorrow = new Date(nowTZ.getTime()+86400000);
    let hijriTomorrow=null; try{ hijriTomorrow = await fetchHijriFromAladhan(tomorrow); }catch{}
    const todayM = Number(hijriObj?.month?.number||0), todayD=Number(hijriObj?.day||0);
    const nightM = Number(hijriTomorrow?.month?.number||0), nightD=Number(hijriTomorrow?.day||0);
    drawEvents(todayM,todayD,nightM,nightD);
  }catch{
    let todayM,todayD,nightM,nightD;
    if(hasIntlIslamic()){
      const p1=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:TIMEZONE,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(nowTZ);
      todayM=+p1.find(x=>x.type==='month').value; todayD=+p1.find(x=>x.type==='day').value;
      const ref2=new Date(nowTZ.getTime()+86400000);
      const p2=new Intl.DateTimeFormat('en-TN-u-ca-islamic'){timeZone:TIMEZONE,year:'numeric',month:'numeric',day:'numeric'}.formatToParts(ref2);
      nightM=+p2.find(x=>x.type==='month').value; nightD=+p2.find(x=>x.type==='day').value;
    }else{
      const {Y,M,D}=ymdInTZ(nowTZ,TIMEZONE);
      const h1=jd2islamic(g2jd(+Y,+M,+D));
      const h2=jd2islamic(g2jd(+Y,+M,+D+1));
      todayM=h1.m; todayD=h1.d; nightM=h2.m; nightD=h2.d;
    }
    drawEvents(todayM,todayD,nightM,nightD);
    hijri.textContent = localHijriFallback(nowTZ, civilWeekday);
  }

  setStatus('Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹â€¦');
  await fillWeekTable(lat,lon).then(()=>setStatus('Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø§Ù‡Ø²', true)).catch(()=>setStatus('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', false));

  setStatus('Ø¬Ù„Ø¨ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ù‡Ø±â€¦');
  const off = Number(gridMonth.dataset.offset||"0");
  await fillMonthGrid(lat,lon, off).then(()=>setStatus('Ø§Ù„Ø´Ù‡Ø± Ø¬Ø§Ù‡Ø²', true)).catch(()=>setStatus('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø±', false));
}

/* ØªÙ†Ø²ÙŠÙ„ PDF Ù„Ù„Ø´Ù‡Ø± */
async function downloadMonthPDF(){
  if(!coords){ alert('Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  const base=new Date(new Date().toLocaleString('en-US',{timeZone:TIMEZONE}));
  const monthOffset = Number(gridMonth.dataset.offset||"0");
  const first=new Date(base.getFullYear(), base.getMonth()+monthOffset, 1);
  const y=first.getFullYear(), m=first.getMonth()+1;
  let cal=null;
  try{ cal=await getMonthCalendar(coords.lat, coords.lon, m, y); }catch{ alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ù‡Ø±.'); return; }

  const rows = cal.map(d=>{
    const t=ensureImsak(d.timings||{});
    const gr = d.date.readable; // DD MMM YYYY
    const hj = `${d.date.hijri.day} ${d.date.hijri.month.ar}`;
    return [gr, hj, to12h(t.Fajr), to12h(t.Sunrise), to12h(t.Dhuhr), to12h(t.Asr), to12h(t.Maghrib), to12h(t.Isha)];
  });

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  const title = `Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© â€” ${place.textContent} â€” ${monthNameAr(first)}`;
  doc.text(title, 40, 40, {align:'left'});
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.autoTable({
    startY: 60,
    styles: { halign: 'center', fontSize: 10, cellPadding: 6 },
    headStyles: { fillColor: [14,165,166] },
    head: [['Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ','Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ','Ø§Ù„ÙØ¬Ø±','Ø§Ù„Ø´Ø±ÙˆÙ‚','Ø§Ù„Ø¸Ù‡Ø±','Ø§Ù„Ø¹ØµØ±','Ø§Ù„Ù…ØºØ±Ø¨','Ø§Ù„Ø¹Ø´Ø§Ø¡']],
    body: rows
  });
  doc.setFontSize(9);
  doc.text('Ø§Ù„Ù…ØµØ¯Ø±: Aladhan API â€” Ø·ÙØ¨ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª', 40, doc.internal.pageSize.getHeight()-20);
  doc.save(`Ù…ÙˆØ§Ù‚ÙŠØª-${place.textContent.replace(/\s+/g,'_')}-${y}-${String(m).padStart(2,'0')}.pdf`);
}

/* ØªØ¨ÙˆÙŠØ¨/ØªÙ†Ù‚Ù„ */
tab-day.addEventListener('click', ()=>selectTab('tab-day'));
tab-week.addEventListener('click', ()=>selectTab('tab-week'));
tab-month.addEventListener('click', ()=>selectTab('tab-month'));
prevMonth.addEventListener('click', async ()=>{
  const off = Number(gridMonth.dataset.offset||"0")-1; gridMonth.dataset.offset=off; if(coords) await fillMonthGrid(coords.lat, coords.lon, off);
});
nextMonth.addEventListener('click', async ()=>{
  const off = Number(gridMonth.dataset.offset||"0")+1; gridMonth.dataset.offset=off; if(coords) await fillMonthGrid(coords.lat, coords.lon, off);
});
downloadPDF.addEventListener('click', downloadMonthPDF);

/* Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ */
let searchDebounce=null;
function attachSearch(){
  const box=document.getElementById('searchResults');
  placeSearch.addEventListener('input', ()=>{
    const q=placeSearch.value.trim();
    if(searchDebounce) clearTimeout(searchDebounce);
    if(!q){ box.style.display='none'; box.innerHTML=''; return; }
    searchDebounce=setTimeout(async ()=>{
      try{
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=8&accept-language=ar&q=${encodeURIComponent(q)}`;
        const r = await fetch(url, {cache:'no-store'});
        const list = await r.json();
        box.innerHTML = (list||[]).map(it=>`<div class="resItem" role="option" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${(it.display_name||'').replace(/"/g,'&quot;')}">${it.display_name}</div>`).join('') || '<div class="resItem">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</div>';
        box.style.display='block';
      }catch{
        box.innerHTML='<div class="resItem">ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¨Ø­Ø«</div>'; box.style.display='block';
      }
    }, 500);
  });
  box.addEventListener('click', async (e)=>{
    const item=e.target.closest('.resItem'); if(!item) return;
    const lat=Number(item.dataset.lat), lon=Number(item.dataset.lon);
    coords={lat,lon}; localStorage.setItem("jaq_coords", JSON.stringify(coords));
    resolvedName = await reverseGeocode(lat, lon);
    localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
    TIMEZONE = await fetchTimezone(lat, lon);
    localStorage.setItem("jaq_timezone", TIMEZONE);
    AUTO_DETECT=false; localStorage.setItem("jaq_auto_detect","false");
    showPlaceText(); await loadAll();
    box.style.display='none';
  });
  document.addEventListener('click',(e)=>{ if(!box.contains(e.target) && e.target!==placeSearch){ box.style.display='none'; }});
}

/* Ø·Ø±Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ + Ø²ÙˆØ§ÙŠØ§ */
async function loadMethods(){
  try{
    const j=await fetchJSON('https://api.aladhan.com/v1/methods');
    const data=j.data||{};
    const entries=Object.entries(data).filter(([k])=>!isNaN(+k));
    methodSel.innerHTML = entries.map(([id,v])=>{
      const name = (v.name||'').replace(' - ', ' â€” ');
      const sel = (+id===METHOD_ID)?'selected':'';
      return `<option value="${id}" ${sel}>${name}</option>`;
    }).join('');
    if (!entries.some(([id])=>+id===METHOD_ID)) METHOD_ID=0;
  }catch{
    methodSel.innerHTML = `<option value="0" selected>Shia Ithna-Ashari (Jafari)</option><option value="3">Muslim World League</option>`;
    METHOD_ID=0;
  }
}

/* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
function openModal(){ 
  autoDetectChk.checked = !!AUTO_DETECT;
  hijriOffsetSel.value = String(HIJRI_OFFSET_DAYS);
  customAnglesChk.checked = !!CUSTOM_ANGLES;
  fajrAngle.value = FAJR_ANGLE || '';
  ishaAngle.value = ISHA_ANGLE || '';
  fajrAngle.disabled = ishaAngle.disabled = !CUSTOM_ANGLES;

  placeSearch.value = '';
  latInp.value = coords?.lat ?? '';
  lonInp.value = coords?.lon ?? '';
  document.getElementById('searchResults').style.display='none';
  modal.classList.add("open"); document.body.style.overflow='hidden';
  modal.querySelector('.box').focus();
}
function closeModal(){ modal.classList.remove("open"); document.body.style.overflow=''; }
openPicker.addEventListener("click",openModal);
cancelPlace.addEventListener("click",closeModal);
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeModal(); });

/* Ø¹Ù†Ø§ØµØ± DOM */
const autoDetectChk=document.getElementById("autoDetectChk");
const placeSearch=document.getElementById("placeSearch");
const latInp=document.getElementById("latInp");
const lonInp=document.getElementById("lonInp");
const useCoords=document.getElementById("useCoords");
const hijriOffsetSel=document.getElementById("hijriOffsetSel");
const savePlace=document.getElementById("savePlace");
const useMyLocation=document.getElementById("useMyLocation");
const resetAll=document.getElementById("resetAll");
const methodSel=document.getElementById("methodSel");
const customAnglesChk=document.getElementById("customAnglesChk");
const fajrAngle=document.getElementById("fajrAngle");
const ishaAngle=document.getElementById("ishaAngle");

/* ØªÙØ§Ø¹Ù„Ø§Øª */
customAnglesChk.addEventListener('change',()=>{
  const on = customAnglesChk.checked;
  fajrAngle.disabled = ishaAngle.disabled = !on;
});
useMyLocation.addEventListener("click", async ()=>{
  AUTO_DETECT = true; localStorage.setItem("jaq_auto_detect","true");
  autoDetectChk.checked = true;
  await tryAutoLocate(true);
});
useCoords.addEventListener("click", async ()=>{
  const la = Number(latInp.value), lo = Number(lonInp.value);
  if(isNaN(la)||isNaN(lo)){ alert('Ø£Ø¯Ø®Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØµØ­ÙŠØ­Ø©'); return; }
  coords={lat:la, lon:lo}; localStorage.setItem("jaq_coords", JSON.stringify(coords));
  resolvedName = await reverseGeocode(la, lo); localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
  TIMEZONE = await fetchTimezone(la, lo); localStorage.setItem("jaq_timezone", TIMEZONE);
  AUTO_DETECT=false; localStorage.setItem("jaq_auto_detect","false");
  showPlaceText(); await loadAll();
});
savePlace.addEventListener("click", async ()=>{
  AUTO_DETECT = !!autoDetectChk.checked;
  localStorage.setItem("jaq_auto_detect", JSON.stringify(AUTO_DETECT));
  HIJRI_OFFSET_DAYS = Number(hijriOffsetSel.value||"0");
  localStorage.setItem("jaq_hijri_offset_days", String(HIJRI_OFFSET_DAYS));
  METHOD_ID = Number(methodSel.value||"0");
  localStorage.setItem("jaq_method_id", String(METHOD_ID));
  CUSTOM_ANGLES = !!customAnglesChk.checked;
  localStorage.setItem("jaq_custom_angles_on", JSON.stringify(CUSTOM_ANGLES));
  FAJR_ANGLE = Number(fajrAngle.value||"0");
  ISHA_ANGLE = Number(ishaAngle.value||"0");
  localStorage.setItem("jaq_fajr_angle", String(FAJR_ANGLE));
  localStorage.setItem("jaq_isha_angle", String(ISHA_ANGLE));

  if (AUTO_DETECT && !coords){
    await tryAutoLocate(true);
  }else{
    await loadAll();
  }
  closeModal();
});
resetAll.addEventListener("click", ()=>{
  localStorage.removeItem("jaq_hijri_offset_days");
  localStorage.removeItem("jaq_auto_detect");
  localStorage.removeItem("jaq_coords");
  localStorage.removeItem("jaq_resolved_name");
  localStorage.removeItem("jaq_method_id");
  localStorage.removeItem("jaq_timezone");
  localStorage.removeItem("jaq_custom_angles_on");
  localStorage.removeItem("jaq_fajr_angle");
  localStorage.removeItem("jaq_isha_angle");
  HIJRI_OFFSET_DAYS=0; AUTO_DETECT=true; coords=null; resolvedName=null; METHOD_ID=0; TIMEZONE=Intl.DateTimeFormat().resolvedOptions().timeZone;
  CUSTOM_ANGLES=false; FAJR_ANGLE=0; ISHA_ANGLE=0;
  showPlaceText(); loadAll(); alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·.');
});

/* Ø¨Ø­Ø« + Ø·Ø±Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ */
attachSearch();
loadMethods();

/* GPS */
async function tryAutoLocate(alertErrors=false){
  if(!navigator.geolocation){
    if(alertErrors) alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
    return false;
  }
  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const {latitude, longitude}=pos.coords;
      coords={lat:+latitude, lon:+longitude};
      localStorage.setItem("jaq_coords", JSON.stringify(coords));
      try{ resolvedName = await reverseGeocode(latitude, longitude); }
      catch{ resolvedName = {cityAr:'Ù…ÙˆÙ‚Ø¹ÙŠ', countryAr:'', display:''}; }
      localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
      TIMEZONE = await fetchTimezone(latitude, longitude);
      localStorage.setItem("jaq_timezone", TIMEZONE);
      showPlaceText(); await loadAll(); setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± GPS', true); resolve(true);
    }, (err)=>{
      if(alertErrors) alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ø°Ù† Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
      resolve(false);
    }, {enableHighAccuracy:false, timeout:8000, maximumAge:300000});
  });
}

/* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± IP */
async function locateByIP(){
  try{
    setStatus('ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± IPâ€¦');
    let r = await fetch('https://ipapi.co/json/', {cache:'no-store'});
    if(r.ok){
      const j = await r.json();
      if(j && j.latitude && j.longitude){
        return { lat:+j.latitude, lon:+j.longitude, city: j.city||'', country: j.country_name||'' };
      }
    }
  }catch{}
  try{
    let r2 = await fetch('https://ipwho.is/', {cache:'no-store'});
    if(r2.ok){
      const j2 = await r2.json();
      if(j2 && j2.success && j2.latitude && j2.longitude){
        return { lat:+j2.latitude, lon:+j2.longitude, city: j2.city||'', country: j2.country||'' };
      }
    }
  }catch{}
  return null;
}

/* ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ù…Ù„ */
async function loadAll(){
  if(!coords){
    times.innerHTML=`<tr><td colspan="2">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯.</td></tr>`;
    gridMonth.innerHTML=''; weekBody.innerHTML='';
    return;
  }
  setHadith(); showPlaceText(); updateClock();
  await renderCore(coords.lat, coords.lon);
}

/* init Ù…Ø¹ Fallback IP + Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ù†Ø§Ù…Ø© */
(async function init(){
  try{
    setStatus('ØªÙ‡ÙŠØ¦Ø©â€¦');

    if (AUTO_DETECT){
      const ok = await tryAutoLocate(false);
      if(ok) return;

      const ip = await locateByIP();
      if(ip){
        coords = {lat:ip.lat, lon:ip.lon};
        localStorage.setItem("jaq_coords", JSON.stringify(coords));
        resolvedName = {cityAr: ip.city||'Ù…ÙˆÙ‚Ø¹ÙŠ', countryAr: ip.country||'', display: (ip.city? `${ip.city}, ${ip.country}` : '')};
        localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
        TIMEZONE = await fetchTimezone(ip.lat, ip.lon);
        localStorage.setItem("jaq_timezone", TIMEZONE);
        showPlaceText();
        await loadAll();
        setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± IP', true);
        return;
      }

      // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¢Ù…Ù†: Ø§Ù„Ù…Ù†Ø§Ù…Ø©
      coords = {lat:26.2235, lon:50.5876};
      localStorage.setItem("jaq_coords", JSON.stringify(coords));
      resolvedName = {cityAr:'Ø§Ù„Ù…Ù†Ø§Ù…Ø©', countryAr:'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', display:'Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†'};
      localStorage.setItem("jaq_resolved_name", JSON.stringify(resolvedName));
      TIMEZONE = 'Asia/Bahrain';
      localStorage.setItem("jaq_timezone", TIMEZONE);
      showPlaceText();
      await loadAll();
      setStatus('Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ù…ÙˆÙ‚Ø¹Ù‹Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ (Ø§Ù„Ù…Ù†Ø§Ù…Ø©)', true);
    }else{
      showPlaceText();
      await loadAll();
      setStatus('Ø¬Ø§Ù‡Ø²', true);
    }
  }catch(e){
    console.error(e);
    setStatus('ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© â€” ØªÙÙ‚Ø¯ Ø§Ù„Ø´Ø¨ÙƒØ©/Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„');
    if(!coords){
      coords = {lat:26.2235, lon:50.5876};
      resolvedName = {cityAr:'Ø§Ù„Ù…Ù†Ø§Ù…Ø©', countryAr:'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', display:'Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†'};
      TIMEZONE = 'Asia/Bahrain';
      showPlaceText();
      await loadAll();
    }
  }
})();
</script>
</body>
</html>
