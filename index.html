<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Ø·Ù‚Ø³ Ø¹Ø§Ù„Ù…ÙŠ â€” Ø£Ø¨ÙŠØ¶â€“Ø°Ù‡Ø¨ÙŠâ€“Ø£Ø³ÙˆØ¯</title>
<meta name="description" content="Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©ØŒ ØªÙˆÙ‚Ø¹ 7 Ø£ÙŠØ§Ù…ØŒ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡ØŒ ÙˆØ±Ø§Ø¯Ø§Ø± Ø£Ù…Ø·Ø§Ø±/Ø³Ø­Ø¨ Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.">
<link rel="canonical" href="">
<link rel="alternate" hreflang="ar" href="">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Ø·Ù‚Ø³ Ø¹Ø§Ù„Ù…ÙŠ â€” Ø£Ø¨ÙŠØ¶â€“Ø°Ù‡Ø¨ÙŠâ€“Ø£Ø³ÙˆØ¯">
<meta property="og:description" content="Ø·Ù‚Ø³ Ø§Ù„Ø¢Ù† + ØªÙˆÙ‚Ø¹ 7 Ø£ÙŠØ§Ù… + Ø±Ø§Ø¯Ø§Ø± + Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡.">
<meta property="og:locale" content="ar_AR">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@600&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<!-- Leaflet (Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø§Ø¯Ø§Ø±) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Chart.js (Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#fafafa; --card:#ffffff; --ink:#111; --muted:#6b7280;
    --gold:#d4af37; --border:#e6e2d2; --glow:0 10px 26px rgba(180,150,40,.12);
    --chip-grad:linear-gradient(135deg, rgba(212,175,55,.10), rgba(0,0,0,.02));
    --accent-txt:linear-gradient(90deg, var(--gold), #ffdf7f);
  }
  *{box-sizing:border-box}
  body{margin:0; padding:20px; background:var(--bg); color:var(--ink); font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .container{width:min(1200px,100%); margin:auto; display:flex; flex-direction:column; gap:18px}

  .hero{position:relative; overflow:hidden; background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--glow); padding:22px; text-align:center;}
  .hero::before{content:""; position:absolute; inset:-35% -20% auto auto; height:210px; width:65%; background:radial-gradient(closest-side, rgba(212,175,55,.18), rgba(212,175,55,.08) 60%, transparent); filter:blur(18px)}
  .heroTitle{margin:0; font-family:"Reem Kufi",sans-serif; font-size:1.9rem; letter-spacing:.2px; background:var(--accent-txt); -webkit-background-clip:text; background-clip:text; color:transparent;}

  .topRow{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center}
  .locationBox{display:flex; align-items:center; gap:10px; background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--glow); padding:12px}
  .place{font-weight:900; font-size:1.1rem}
  .subPlace{font-size:.9rem; color:var(--muted)}
  .controls{display:flex; gap:8px; align-items:center}
  .searchWrap{position:relative}
  .search{padding:10px 12px; border:1px solid var(--border); border-radius:12px; width:250px; background:#fff}
  .suggest{position:absolute; top:110%; right:0; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--glow); width:100%; z-index:20; display:none; max-height:260px; overflow:auto}
  .suggest div{padding:10px; cursor:pointer}
  .suggest div:hover{background:#fffaf0}
  .toggle{padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-weight:800}

  .nowBox{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--glow); padding:16px; display:grid; gap:12px}
  .nowTitle{font-weight:900; text-align:center; background:var(--accent-txt); -webkit-background-clip:text; background-clip:text; color:transparent;}
  .nowRow{display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap}
  .nowMain{display:flex; align-items:center; gap:12px}
  .nowIcon{width:72px; height:72px}
  .tempNow{font-size:2.4rem; font-weight:900}
  .condNow{font-weight:800; color:#333}
  .miniGrid{display:grid; grid-template-columns:repeat(6,1fr); gap:10px; width:100%}
  @media(max-width:900px){.miniGrid{grid-template-columns:repeat(3,1fr)}}
  .chip{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--glow); padding:12px; display:flex; align-items:center; gap:10px; background-image:var(--chip-grad)}
  .label{font-size:.86rem; color:var(--muted); font-weight:800}
  .value{font-weight:900; font-size:1.02rem; font-variant-numeric:tabular-nums}

  .cards{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
  @media(max-width:1000px){.cards{grid-template-columns:1fr}}

  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--glow); padding:12px}
  .card h3{margin:0 0 10px; font-size:1.05rem; font-weight:900; text-align:center; background:var(--accent-txt); -webkit-background-clip:text; background-clip:text; color:transparent;}

  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #eee7c9; font-size:.98rem}
  th{background:#fffaf0; font-weight:900; color:#111}
  .small{font-size:.9rem; color:var(--muted)}
  .hourRow{display:grid; grid-template-columns:repeat(8,1fr); gap:10px}

  .daysGrid{display:grid; grid-template-columns:repeat(7,1fr); gap:10px}
  @media(max-width:1200px){.daysGrid{grid-template-columns:repeat(4,1fr)}}
  @media(max-width:700px){.daysGrid{grid-template-columns:repeat(2,1fr)}}
  .dayCard{border:1px solid var(--border); border-radius:14px; padding:10px; text-align:center; background:#fff; box-shadow:var(--glow)}
  .dayName{font-weight:900; margin-bottom:4px}

  #map{height:420px; border-radius:14px; border:1px solid var(--border)}
  .layerToggles{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .layerToggles button{padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-weight:800}

  footer{text-align:center; margin-top:8px}
  .credit{color:#7a5a00; font-weight:800}
</style>
</head>
<body>
<div class="container">
  <section class="hero" aria-labelledby="title">
    <h1 id="title" class="heroTitle">Ø§Ù„Ø·Ù‚Ø³ â€” ØªØ¬Ø±Ø¨Ø© Ø¹Ø§Ù„Ù…ÙŠØ©</h1>
  </section>

  <div class="topRow">
    <div class="locationBox" aria-live="polite">
      <div>
        <div class="place" id="place">â€”</div>
        <div class="subPlace" id="subPlace"></div>
      </div>
    </div>
    <div class="controls">
      <div class="searchWrap">
        <input id="search" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ù†Ø§Ù…Ø©)" autocomplete="off">
        <div id="suggest" class="suggest"></div>
      </div>
      <button id="unitBtn" class="toggle" title="ØªØ¨Ø¯ÙŠÙ„ Â°Ù…/Â°Ù">Â°Ù…</button>
    </div>
  </div>

  <section class="nowBox">
    <div class="nowTitle">Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø¢Ù†</div>
    <div class="nowRow">
      <div class="nowMain">
        <img id="iconNow" class="nowIcon" alt="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·Ù‚Ø³" src="">
        <div>
          <div class="tempNow"><span id="tNow">--</span>Â°</div>
          <div class="condNow" id="condNow">â€”</div>
          <div class="small" id="updateNote">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« â€”</div>
        </div>
      </div>
      <div class="miniGrid">
        <div class="chip"><div class="label">Ø£Ø¹Ù„Ù‰/Ø£Ø¯Ù†Ù‰</div><div class="value"><span id="hi">--</span>Â° / <span id="lo">--</span>Â°</div></div>
        <div class="chip"><div class="label">Ø§Ù„Ø¥Ø­Ø³Ø§Ø³</div><div class="value"><span id="feels">--</span>Â°</div></div>
        <div class="chip"><div class="label">Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><div class="value"><span id="hum">--</span>%</div></div>
        <div class="chip"><div class="label">Ø§Ù„Ø¶ØºØ·</div><div class="value"><span id="press">--</span> hPa</div></div>
        <div class="chip"><div class="label">Ø§Ù„Ø±ÙŠØ§Ø­</div><div class="value"><span id="wind">--</span> ÙƒÙ…/Ø³</div></div>
        <div class="chip"><div class="label">Ø§Ù„Ø±Ø¤ÙŠØ©</div><div class="value"><span id="vis">--</span> ÙƒÙ…</div></div>
        <div class="chip"><div class="label">Ù†Ø¯Ù‰</div><div class="value"><span id="dew">--</span>Â°</div></div>
        <div class="chip"><div class="label">UV</div><div class="value"><span id="uv">--</span></div></div>
        <div class="chip"><div class="label">Ø§Ù„Ø´Ø±ÙˆÙ‚</div><div class="value"><span id="sunrise">--:--</span></div></div>
        <div class="chip"><div class="label">Ø§Ù„ØºØ±ÙˆØ¨</div><div class="value"><span id="sunset">--:--</span></div></div>
        <div class="chip"><div class="label">Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡</div><div class="value"><span id="aqi">--</span></div></div>
        <div class="chip"><div class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div><div class="value"><span id="tzLbl">--</span></div></div>
      </div>
    </div>
  </section>

  <div class="cards">
    <section class="card">
      <h3>Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (24 Ø³Ø§Ø¹Ø©)</h3>
      <canvas id="hourChart" height="120"></canvas>
      <div class="small">Ø§Ù„Ø®Ø·: Ø­Ø±Ø§Ø±Ø© â€¢ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„Ø£Ù…Ø·Ø§Ø± %</div>
    </section>

    <section class="card">
      <h3>ØªÙˆÙ‚Ø¹ 7 Ø£ÙŠØ§Ù…</h3>
      <div class="daysGrid" id="daysGrid"></div>
    </section>
  </div>

  <section class="card">
    <h3>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø£Ù…Ø·Ø§Ø±</h3>
    <div id="map"></div>
    <div class="layerToggles">
      <button data-layer="clouds_new">â˜ï¸ Ø§Ù„Ø³Ø­Ø¨</button>
      <button data-layer="precipitation_new">ğŸŒ§ Ø§Ù„Ø£Ù…Ø·Ø§Ø±</button>
      <button data-layer="pressure_new">ğŸ—º Ø§Ù„Ø¶ØºØ·</button>
      <button data-layer="wind_new">ğŸ’¨ Ø§Ù„Ø±ÙŠØ§Ø­</button>
      <button data-layer="temp_new">ğŸŒ¡ Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
      <button id="centerBtn">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
    </div>
  </section>

  <footer><span class="credit">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³</span></footer>
</div>

<script>
/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
document.querySelector('link[rel="canonical"]').href = location.href.split('#')[0];
document.querySelector('link[rel="alternate"]').href = location.href.split('#')[0];

const OWM_KEY = "YOUR_OPENWEATHER_KEY"; // â† Ø¶Ø¹ Ù…ÙØªØ§Ø­ OpenWeather
const DEFAULT = { nameAr:"Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†", nameEn:"Manama, Bahrain", lat:26.2235, lon:50.5876, tz: Intl.DateTimeFormat().resolvedOptions().timeZone };
let state = JSON.parse(localStorage.getItem("wx_state_pro")||"null") || {...DEFAULT};
let useMetric = JSON.parse(localStorage.getItem("wx_units_metric")||"true"); // true=metric Â°Ù…
let map, baseLayer, owLayers = {}, activeLayerName = null;
let hourChart = null;

/* ===== Ø£Ø¯ÙˆØ§Øª ØªÙ†Ø³ÙŠÙ‚ ===== */
const kmh = ms => Math.round(ms*3.6);
const toKm = m => (m/1000).toFixed(1);
const fmtDate = (d,tz) => new Intl.DateTimeFormat('ar',{timeZone:tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(d);
const fmtTime = (ts,tz) => new Intl.DateTimeFormat('ar',{timeZone:tz,hour:'2-digit',minute:'2-digit'}).format(new Date(ts*1000));
const fmtNum = n => (n!=null && !isNaN(n)) ? Math.round(n) : "--";
const cToF = c => (c*9/5)+32;
const msToMph = ms => ms*2.23694;

/* ===== Ø¨Ø­Ø« Ø§Ù„Ù…Ø¯Ù† (Autocomplete) ===== */
const search = document.getElementById('search');
const suggest = document.getElementById('suggest');
let suggestTimer = null;

search.addEventListener('input', ()=>{
  const q = search.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ suggest.style.display='none'; return; }
  suggestTimer = setTimeout(async ()=>{
    try{
      const u = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(q)}&limit=5&appid=${OWM_KEY}`;
      const r = await fetch(u); const j = await r.json();
      suggest.innerHTML = (j||[]).map(it=>{
        const nameAr = it.local_names?.ar || it.name;
        const line = [nameAr||it.name, it.state, it.country].filter(Boolean).join("ØŒ ");
        return `<div data-lat="${it.lat}" data-lon="${it.lon}" data-name="${line}">${line}</div>`;
      }).join('') || '<div>Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</div>';
      suggest.style.display='block';
    }catch{ suggest.style.display='none'; }
  }, 300);
});

suggest.addEventListener('click', (e)=>{
  const div = e.target.closest('div[data-lat]');
  if(!div) return;
  state.lat = +div.dataset.lat; state.lon = +div.dataset.lon; state.nameAr = div.dataset.name; state.nameEn = div.dataset.name;
  suggest.style.display='none'; search.value='';
  saveState(); refreshAll();
});

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒØ§Ù† ===== */
function setPlace(){
  place.textContent = state.nameAr || state.nameEn || 'Ù…ÙˆÙ‚Ø¹Ùƒ';
  subPlace.textContent = `Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©: ${state.tz||Intl.DateTimeFormat().resolvedOptions().timeZone}`;
  tzLbl.textContent = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
}

/* ===== Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ===== */
async function reverseName(lat,lon){
  try{
    const u = `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OWM_KEY}`;
    const r = await fetch(u); const j = await r.json(); const it = j?.[0];
    if(it){
      const city = it.local_names?.ar || it.name || "";
      const country = it.country || "";
      return {ar: city && country ? `${city}ØŒ ${country}` : (city||country||"Ù…ÙˆÙ‚Ø¹Ùƒ"), en:`${it.name||city}, ${country}`}
    }
  }catch{}
  return {ar:"Ù…ÙˆÙ‚Ø¹Ùƒ", en:"Your location"}
}

/* ===== API: One Call + fallback ===== */
async function getOneCall(lat,lon,units,lang='ar'){
  const u = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=${units}&lang=${lang}&exclude=minutely`;
  const r = await fetch(u, {cache:'no-store'});
  if(!r.ok) throw new Error('OneCall failed');
  return r.json();
}
async function getForecast3h(lat,lon,units,lang='ar'){
  const u = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=${units}&lang=${lang}`;
  const r = await fetch(u, {cache:'no-store'});
  if(!r.ok) throw 0;
  return r.json();
}
async function getAir(lat,lon){
  try{
    const u = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_KEY}`;
    const r = await fetch(u); const j = await r.json(); return j?.list?.[0];
  }catch{ return null; }
}

/* ===== ØªØ¹Ø¨Ø¦Ø© ÙˆØ§Ø¬Ù‡Ø© "Ø§Ù„Ø¢Ù†" ===== */
function fillNow(data){
  const tz = data.timezone || state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
  const current = data.current || {};
  const daily0 = (data.daily?.[0]) || {};
  const w = current.weather?.[0] || {};
  const temp = current.temp, feels = current.feels_like;
  iconNow.src = w.icon ? `https://openweathermap.org/img/wn/${w.icon}@2x.png` : "";
  iconNow.alt = w.description || "Ø·Ù‚Ø³";
  condNow.textContent = w.description || "â€”";
  tNow.textContent = fmtNum(temp);
  hi.textContent = fmtNum(daily0.temp?.max ?? temp);
  lo.textContent = fmtNum(daily0.temp?.min ?? temp);
  feels.textContent = fmtNum(feels);
  hum.textContent = current.humidity ?? "--";
  press.textContent = current.pressure ?? "--";
  wind.textContent = useMetric ? kmh(current.wind_speed||0) : Math.round(msToMph(current.wind_speed||0));
  vis.textContent = (current.visibility!=null) ? toKm(current.visibility) : "--";
  dew.textContent = (current.dew_point!=null) ? fmtNum(current.dew_point) : "--";
  uv.textContent = (current.uvi!=null) ? current.uvi.toFixed(1) : "--";
  sunrise.textContent = current.sunrise ? fmtTime(current.sunrise, tz) : "--:--";
  sunset.textContent = current.sunset ? fmtTime(current.sunset, tz)  : "--:--";
  updateNote.textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« " + new Intl.DateTimeFormat('ar',{timeStyle:'short'}).format(new Date());
  greg.textContent = fmtDate(new Date(), tz);
}

/* ===== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ===== */
function buildHourChart(hourly){
  const labels = hourly.slice(0,24).map(h=>{
    const dt = new Date(h.dt*1000);
    return new Intl.DateTimeFormat('ar',{hour:'2-digit'}).format(dt);
  });
  const temps = hourly.slice(0,24).map(h=>Math.round(h.temp));
  const pops  = hourly.slice(0,24).map(h=>Math.round((h.pop||0)*100));

  const ctx = document.getElementById('hourChart').getContext('2d');
  if(hourChart){ hourChart.destroy(); }
  hourChart = new Chart(ctx, {
    type:'bar',
    data:{ labels,
      datasets:[
        { type:'line', label:'Ø§Ù„Ø­Ø±Ø§Ø±Ø©', data:temps, borderWidth:2, tension:.3, yAxisID:'y' },
        { type:'bar',  label:'% Ø£Ù…Ø·Ø§Ø±', data:pops, borderWidth:0, yAxisID:'y1' }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:true, rtl:true } },
      scales:{
        y:{ position:'left', beginAtZero:false },
        y1:{ position:'right', beginAtZero:true, suggestedMax:100, grid:{ drawOnChartArea:false } }
      }
    }
  });
}

/* ===== 7 Ø£ÙŠØ§Ù… ===== */
function fillDays(daily){
  const tz = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
  daysGrid.innerHTML = (daily||[]).slice(0,7).map(d=>{
    const dn = new Intl.DateTimeFormat('ar',{timeZone:tz, weekday:'long'}).format(new Date(d.dt*1000));
    const dt = new Intl.DateTimeFormat('ar',{timeZone:tz, month:'short', day:'2-digit'}).format(new Date(d.dt*1000));
    const iconUrl = d.weather?.[0]?.icon ? `https://openweathermap.org/img/wn/${d.weather[0].icon}.png` : "";
    const desc = d.weather?.[0]?.description || '';
    const max = Math.round(d.temp.max), min = Math.round(d.temp.min);
    return `<div class="dayCard">
      <div class="dayName">${dn}</div>
      <div class="small">${dt}</div>
      <div style="margin:6px 0">${iconUrl?`<img src="${iconUrl}" alt="${desc}" width="42" height="42">`:''}</div>
      <div><strong>${max}Â°</strong> / <span>${min}Â°</span></div>
      <div class="small">${desc}</div>
    </div>`;
  }).join("");
}

/* ===== AQI ===== */
function aqiLabel(aqi){
  // 1-5 Ø­Ø³Ø¨ OpenWeather
  return {
    1:"Ø¬ÙŠÙ‘Ø¯ Ø¬Ø¯Ù‹Ø§", 2:"Ø¬ÙŠÙ‘Ø¯", 3:"Ù…ØªÙˆØ³Ø·", 4:"Ø³ÙŠÙ‘Ø¦", 5:"Ø³ÙŠÙ‘Ø¦ Ø¬Ø¯Ù‹Ø§"
  }[aqi] || "--";
}

/* ===== Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ===== */
function initMap(){
  if(map) return;
  map = L.map('map', { zoomControl:true });
  baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Â© OpenStreetMap'
  }).addTo(map);
  centerMap();
}
function centerMap(){
  map.setView([state.lat, state.lon], 7);
}
function owmLayer(name){
  if(owLayers[name]) return owLayers[name];
  const url = `https://tile.openweathermap.org/map/${name}/{z}/{x}/{y}.png?appid=${OWM_KEY}`;
  owLayers[name] = L.tileLayer(url, { opacity:0.7 });
  return owLayers[name];
}
function switchLayer(name){
  if(activeLayerName && owLayers[activeLayerName]) map.removeLayer(owLayers[activeLayerName]);
  const lyr = owmLayer(name);
  lyr.addTo(map); activeLayerName = name;
}

/* ===== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ===== */
const unitBtn = document.getElementById('unitBtn');
function setUnitBtn(){
  unitBtn.textContent = useMetric ? 'Â°Ù…' : 'Â°Ù';
  localStorage.setItem('wx_units_metric', JSON.stringify(useMetric));
}
unitBtn.addEventListener('click', ()=>{
  useMetric = !useMetric;
  setUnitBtn();
  refreshAll(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø¨ Ø¨Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
});

/* ===== Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ===== */
function saveState(){ localStorage.setItem("wx_state_pro", JSON.stringify(state)); setPlace(); centerMap(); }

/* ===== Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ù…Ù„ ===== */
async function refreshAll(){
  try{
    setPlace();
    initMap();
    centerMap();

    const units = useMetric ? 'metric' : 'imperial';
    let one = null;
    try{
      one = await getOneCall(state.lat, state.lon, units);
    }catch{}

    if(one){
      state.tz = one.timezone;
      fillNow(one);
      buildHourChart(one.hourly||[]);
      fillDays(one.daily||[]);
      // AQI
      const air = await getAir(state.lat, state.lon);
      if(air){ aqi.textContent = `${aqiLabel(air.main?.aqi)} (${air.main?.aqi})`; }
    }else{
      // Fallback: Ø·Ù‚Ø³ Ø­Ø§Ù„ÙŠ + ØªÙˆÙ‚Ø¹ 5 Ø£ÙŠØ§Ù… (3 Ø³Ø§Ø¹Ø§Øª)
      const curU = `https://api.openweathermap.org/data/2.5/weather?lat=${state.lat}&lon=${state.lon}&appid=${OWM_KEY}&units=${units}&lang=ar`;
      const curR = await fetch(curU); const current = await curR.json();

      const fore = await getForecast3h(state.lat, state.lon, units);
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      state.tz = tz;

      // Ø¨Ù†Ø§Ø¡ Ø¨Ù†ÙŠØ© Ø´Ø¨Ù‡ OneCall Ù„Ù„Ø¹Ø±Ø¶
      const oneLike = {
        timezone: tz,
        current: {
          temp: current.main?.temp,
          feels_like: current.main?.feels_like,
          humidity: current.main?.humidity,
          pressure: current.main?.pressure,
          wind_speed: current.wind?.speed,
          visibility: current.visibility,
          dew_point: null,
          uvi: null,
          sunrise: current.sys?.sunrise,
          sunset: current.sys?.sunset,
          weather: current.weather
        },
        hourly: fore.list.map(it=>({
          dt: it.dt,
          temp: it.main.temp,
          pop: (it.pop || 0),
          weather: it.weather
        }))
      };

      // Ø­Ø³Ø§Ø¨ 7 Ø£ÙŠØ§Ù… Ù…Ù† Ù†Ù‚Ø§Ø· 3 Ø³Ø§Ø¹Ø§Øª (ØªØ¨Ø³ÙŠØ·)
      const byDay = {};
      for(const it of fore.list){
        const d = new Date(it.dt*1000);
        const key = d.getUTCFullYear()+"-"+(d.getUTCMonth()+1)+"-"+d.getUTCDate();
        byDay[key] = byDay[key] || {temps:[], dt: it.dt, weather: it.weather?.[0]};
        byDay[key].temps.push(it.main.temp_min ?? it.main.temp, it.main.temp_max ?? it.main.temp);
      }
      oneLike.daily = Object.values(byDay).slice(0,7).map(x=>{
        const min = Math.round(Math.min(...x.temps));
        const max = Math.round(Math.max(...x.temps));
        return { dt:x.dt, temp:{min, max}, weather:[x.weather||{}] };
      });

      fillNow(oneLike);
      buildHourChart(oneLike.hourly);
      fillDays(oneLike.daily);
      const air = await getAir(state.lat, state.lon);
      if(air){ aqi.textContent = `${aqiLabel(air.main?.aqi)} (${air.main?.aqi})`; }
    }

    // Ø·Ø¨Ù‚Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø±Ø§Ø¯Ø§Ø±
    switchLayer('clouds_new');

  }catch(e){
    console.error(e);
    alert('ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³. ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØªØ§Ø­ OpenWeather Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.');
  }
}

/* ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ===== */
async function init(){
  try{
    setPlace(); setUnitBtn();
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(async pos=>{
        state.lat = pos.coords.latitude; state.lon = pos.coords.longitude;
        const nm = await reverseName(state.lat, state.lon);
        state.nameAr = nm.ar; state.nameEn = nm.en;
        saveState(); refreshAll();
      }, async ()=>{
        // Ù…Ø±ÙÙˆØ¶ Ø£Ùˆ Ø®Ø·Ø£ â†’ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©/Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const nm = await reverseName(state.lat, state.lon);
        state.nameAr = state.nameAr || nm.ar; state.nameEn = state.nameEn || nm.en;
        saveState(); refreshAll();
      }, {enableHighAccuracy:false, timeout:8000, maximumAge:600000});
    }else{
      const nm = await reverseName(state.lat, state.lon);
      state.nameAr = state.nameAr || nm.ar; state.nameEn = state.nameEn || nm.en;
      saveState(); refreshAll();
    }
  }catch(e){
    console.error(e);
    refreshAll();
  }
}

/* Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø§Ø¯Ø§Ø± */
document.querySelectorAll('.layerToggles button[data-layer]').forEach(btn=>{
  btn.addEventListener('click', ()=> switchLayer(btn.dataset.layer));
});
document.getElementById('centerBtn').addEventListener('click', centerMap);

/* Ø§Ø¨Ø¯Ø£ */
init();
</script>
</body>
</html>
