<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مولّد سيرة ذاتية — ذهبي/أبيض</title>
<style>
  :root{
    --bg:#FFFFFF;
    --fg:#0F172A;           /* نص داكن */
    --muted:#475569;        /* نص ثانوي */
    --accent:#C7A046;       /* ذهبي راقٍ */
    --accent-weak:#EAD9A2;  /* ذهبي فاتح */
    --border:#E5E7EB;
    --card:#FFFFFF;
    --chip:#F8FAFC;
    --danger:#DC2626;
    --ok:#16A34A;
    --radius:14px;
    --shadow:0 6px 24px rgba(15,23,42,.06);
  }
  html,body{background:var(--bg);color:var(--fg);font-family:"Cairo","Noto Naskh Arabic","Inter","Helvetica",Arial,sans-serif;line-height:1.45}
  *{box-sizing:border-box}
  a{color:var(--accent);text-decoration:none}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:24px;height:24px;border-radius:6px;background:linear-gradient(145deg,var(--accent),#d8b45a);}
  h1{font-size:20px;margin:0}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btn{border:1px solid var(--accent);color:#fff;background:var(--accent);padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
  .btn.secondary{background:transparent;color:var(--accent)}
  .btn.ghost{background:transparent;border-color:var(--border);color:var(--fg)}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1024px){.row{grid-template-columns:420px 1fr}}

  /* Cards */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .card-h{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .card .card-h h2{font-size:16px;margin:0;position:relative;padding-bottom:6px}
  .card .card-h h2:after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:var(--accent);opacity:.85}
  .card .card-b{padding:16px}

  /* Form */
  form{display:flex;flex-direction:column;gap:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:640px){.grid.two{grid-template-columns:1fr 1fr}}
  @media(min-width:840px){.grid.three{grid-template-columns:1fr 1fr 1fr}}

  label{font-weight:600;font-size:13px;color:var(--muted)}
  input[type="text"],input[type="email"],input[type="tel"],input[type="url"],textarea,select{
    width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;color:var(--fg);
    outline:none;transition:.2s border;
  }
  textarea{min-height:96px;resize:vertical}
  input:focus,textarea:focus,select:focus{border-color:var(--accent)}
  .hint{font-size:12px;color:var(--muted)}
  .chipline{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:12px}
  .muted{color:var(--muted)}
  .inline{display:flex;gap:8px;flex-wrap:wrap}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .hr{height:1px;background:var(--border);margin:8px 0}

  /* Repeatable item */
  .rep{border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:8px}
  .rep .rep-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .rep .rep-actions{display:flex;gap:6px}
  .sm{padding:6px 9px;font-size:12px;border-radius:8px}

  /* Preview (CV) */
  .cv{
    background:#fff;border:1px solid var(--border);border-radius:var(--radius);
    padding:28px;min-height:400px;box-shadow:var(--shadow)
  }
  .cv header .title{font-size:24px;font-weight:800;margin:0 0 6px}
  .cv header .subtitle{font-size:14px;color:var(--muted);margin:0 0 12px}
  .cv .bar{height:2px;background:var(--accent);margin:10px 0 18px}
  .cv .sec{margin-bottom:18px}
  .cv .sec h3{font-size:15px;margin:0 0 8px;position:relative;padding-bottom:6px}
  .cv .sec h3:after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:var(--accent-weak)}
  .cv .item{margin-bottom:10px}
  .cv .pos{display:flex;flex-wrap:wrap;gap:8px;align-items:baseline}
  .cv .pos .role{font-weight:700}
  .cv .pos .company{color:var(--muted)}
  .cv .meta{font-size:12px;color:var(--muted)}
  .cv ul{margin:6px 0 0 18px}
  .cv li{margin:4px 0}

  /* Print A4 */
  @page{size:A4;margin:20mm}
  @media print{
    body{background:#fff}
    .no-print{display:none !important}
    .cv{box-shadow:none;border:none;padding:0}
    .cv .sec h3:after{height:1.5px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header no-print">
      <div class="brand"><div class="logo" aria-hidden="true"></div><h1>مولِّد سيرة ذاتية — ذهبي/أبيض</h1></div>
      <div class="controls">
        <button class="btn" id="btnPrint" title="طباعة إلى PDF">طباعة PDF</button>
        <button class="btn secondary" id="btnWord" title="تنزيل Word">تنزيل Word (.doc)</button>
        <button class="btn ghost" id="btnSave" title="تنزيل JSON">حفظ JSON</button>
        <label class="btn ghost" for="jsonFile" title="استيراد JSON" style="cursor:pointer;">استيراد JSON</label>
        <input id="jsonFile" type="file" accept="application/json" class="no-print" style="display:none" />
        <select id="dirSelect" class="btn ghost" title="اتجاه الصفحة">
          <option value="rtl" selected>RTL (عربي)</option>
          <option value="ltr">LTR (English)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <!-- ============== FORM ============== -->
      <div class="card no-print" id="formCard">
        <div class="card-h"><h2>البيانات</h2></div>
        <div class="card-b">
          <form id="cvForm" novalidate>
            <!-- Basics -->
            <div class="grid two">
              <div>
                <label>الاسم الكامل *</label>
                <input type="text" id="fullName" required placeholder="مثال: محمد أحمد العبدالله" />
              </div>
              <div>
                <label>المسمّى المستهدف *</label>
                <input type="text" id="targetTitle" required placeholder="مثال: مطوّر واجهات أمامية" />
              </div>
              <div>
                <label>البريد الإلكتروني *</label>
                <input type="email" id="email" required placeholder="name@example.com" />
              </div>
              <div>
                <label>رقم الهاتف *</label>
                <input type="tel" id="phone" required placeholder="+966 5x xxx xxxx" />
              </div>
              <div>
                <label>المدينة / الدولة *</label>
                <input type="text" id="location" required placeholder="الرياض، السعودية" />
              </div>
              <div>
                <label>روابط (LinkedIn / GitHub / موقع)</label>
                <input type="url" id="links" placeholder="https://linkedin.com/in/username" />
                <div class="hint">يمكن إدخال عدة روابط مفصولة بفاصلة</div>
              </div>
            </div>

            <div>
              <label>الملخّص المهني</label>
              <textarea id="summary" maxlength="600" placeholder="3–5 جمل تُبرز خبرتك وإنجازاتك مع أرقام"></textarea>
              <div class="hint"><span id="summaryCount">0</span> / 600</div>
            </div>

            <!-- Skills & Languages -->
            <div class="grid two">
              <div>
                <label>المهارات (افصل بفواصل)</label>
                <input type="text" id="skills" placeholder="JavaScript, React, Node.js, Agile, Communication" />
                <div class="hint">تظهر كشرائط قصيرة في السيرة</div>
              </div>
              <div>
                <label>اللغات (مثال: العربية:Native، الإنجليزية:C1)</label>
                <input type="text" id="languages" placeholder="العربية:Native، الإنجليزية:C1" />
              </div>
            </div>

            <!-- Experience -->
            <div>
              <div class="inline" style="justify-content:space-between">
                <label>الخبرة العملية</label>
                <button type="button" class="btn sm secondary" id="addExp">+ إضافة خبرة</button>
              </div>
              <div id="expList"></div>
            </div>

            <!-- Education -->
            <div>
              <div class="inline" style="justify-content:space-between">
                <label>التعليم</label>
                <button type="button" class="btn sm secondary" id="addEdu">+ إضافة مؤهل</button>
              </div>
              <div id="eduList"></div>
            </div>

            <!-- Projects -->
            <div>
              <div class="inline" style="justify-content:space-between">
                <label>المشاريع</label>
                <button type="button" class="btn sm secondary" id="addProj">+ إضافة مشروع</button>
              </div>
              <div id="projList"></div>
            </div>

            <!-- Certifications -->
            <div>
              <div class="inline" style="justify-content:space-between">
                <label>الشهادات</label>
                <button type="button" class="btn sm secondary" id="addCert">+ إضافة شهادة</button>
              </div>
              <div id="certList"></div>
            </div>

          </form>
          <div class="hr"></div>
          <div class="muted hint">
            * الحقول ذات النجمة مطلوبة للتصدير. — جرّب الطباعة إلى PDF أو تنزيل Word حين يكتمل الحد الأدنى.
          </div>
        </div>
      </div>

      <!-- ============== PREVIEW ============== -->
      <div class="card">
        <div class="card-h"><h2>المعاينة الحيّة</h2></div>
        <div class="card-b">
          <article id="cv" class="cv" aria-label="معاينة السيرة">
            <header>
              <h1 class="title" id="v_name">اسم المتقدّم</h1>
              <p class="subtitle" id="v_title">المسمّى المستهدف</p>
              <div class="meta" id="v_contacts">email@example.com · +000000000 · المدينة، الدولة · linkedin.com/in/…</div>
              <div class="bar"></div>
            </header>

            <section class="sec" id="sec_summary" hidden>
              <h3>الملخّص</h3>
              <p id="v_summary"></p>
            </section>

            <section class="sec" id="sec_experience" hidden>
              <h3>الخبرة العملية</h3>
              <div id="v_experience"></div>
            </section>

            <section class="sec" id="sec_projects" hidden>
              <h3>المشاريع</h3>
              <div id="v_projects"></div>
            </section>

            <section class="sec" id="sec_skills" hidden>
              <h3>المهارات</h3>
              <div class="chipline" id="v_skills"></div>
            </section>

            <section class="sec" id="sec_education" hidden>
              <h3>التعليم</h3>
              <div id="v_education"></div>
            </section>

            <section class="sec" id="sec_languages" hidden>
              <h3>اللغات</h3>
              <div id="v_languages"></div>
            </section>

            <section class="sec" id="sec_certs" hidden>
              <h3>الشهادات</h3>
              <div id="v_certs"></div>
            </section>
          </article>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (sel, root=document)=>root.querySelector(sel);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  const form = $('#cvForm');
  const state = {
    basics:{fullName:"",targetTitle:"",email:"",phone:"",location:"",links:"",summary:"",skills:"",languages:""},
    experience:[], education:[], projects:[], certs:[]
  };

  // DOM refs
  const refs = {
    fullName: $('#fullName'), targetTitle: $('#targetTitle'), email: $('#email'),
    phone: $('#phone'), location: $('#location'), links: $('#links'), summary: $('#summary'),
    skills: $('#skills'), languages: $('#languages'),
    expList: $('#expList'), eduList: $('#eduList'), projList: $('#projList'), certList: $('#certList'),
    v: {
      name: $('#v_name'), title: $('#v_title'), contacts: $('#v_contacts'),
      summarySec: $('#sec_summary'), summary: $('#v_summary'),
      expSec: $('#sec_experience'), exp: $('#v_experience'),
      eduSec: $('#sec_education'), edu: $('#v_education'),
      skillsSec: $('#sec_skills'), skills: $('#v_skills'),
      langSec: $('#sec_languages'), lang: $('#v_languages'),
      projSec: $('#sec_projects'), proj: $('#v_projects'),
      certSec: $('#sec_certs'), cert: $('#v_certs')
    }
  };

  // Helpers
  function sanitize(s){ return (s||"").toString().replace(/\s+/g,' ').trim(); }
  function splitByComma(s){ return sanitize(s).split(/[,，،]\s*/).filter(Boolean); }

  function renderContacts(){
    const b = state.basics;
    const parts = [];
    if (b.email) parts.push(b.email);
    if (b.phone) parts.push(b.phone);
    if (b.location) parts.push(b.location);
    if (b.links){
      const links = splitByComma(b.links).map(x=>{
        try{
          const u = new URL(x);
          return (u.hostname.replace(/^www\./,'') + u.pathname).replace(/\/$/,'');
        }catch{ return x; }
      });
      parts.push(links.join(' · '));
    }
    refs.v.contacts.textContent = parts.join(' · ');
  }

  function toggleSec(el, show){ el.hidden = !show; }

  function renderChips(container, items){
    container.innerHTML = '';
    items.forEach(t=>{
      const span = document.createElement('span');
      span.className='chip'; span.textContent = t;
      container.appendChild(span);
    });
  }

  function para(text){ const p=document.createElement('p'); p.textContent=text; return p; }

  function bulletList(list){
    const ul=document.createElement('ul');
    list.filter(Boolean).forEach(item=>{ const li=document.createElement('li'); li.textContent=item; ul.appendChild(li); });
    return ul;
  }

  // Experience item UI
  function expItem(data={}){
    const def = Object.assign({role:"",company:"",location:"",start:"",end:"",highlights:""}, data);
    const wrap = document.createElement('div'); wrap.className='rep';
    wrap.innerHTML = `
      <div class="rep-head">
        <strong>خبرة</strong>
        <div class="rep-actions">
          <button type="button" class="btn sm ghost moveUp">▲</button>
          <button type="button" class="btn sm ghost moveDn">▼</button>
          <button type="button" class="btn sm danger del">حذف</button>
        </div>
      </div>
      <div class="grid two">
        <div><label>المسمّى</label><input type="text" class="role" placeholder="مثال: مهندس برمجيات" value="${def.role}"></div>
        <div><label>الشركة</label><input type="text" class="company" placeholder="اسم الشركة" value="${def.company}"></div>
        <div><label>الموقع</label><input type="text" class="loc" placeholder="الرياض، السعودية" value="${def.location}"></div>
        <div><label>الفترة (بداية–نهاية)</label><div class="inline"><input type="text" class="start" placeholder="YYYY-MM" value="${def.start}" style="flex:1"><input type="text" class="end" placeholder="YYYY-MM أو حاضر" value="${def.end}" style="flex:1"></div></div>
        <div class="grid"><label>إنجازات (سطور مفصولة بفواصل منقوطة ;)</label><textarea class="highlights" placeholder="رفعت الدقة 23% ; خفّضت زمن البناء 12 دقيقة">${def.highlights}</textarea></div>
      </div>
    `;
    return wrap;
  }

  function eduItem(data={}){
    const def = Object.assign({degree:"",major:"",school:"",location:"",date:""}, data);
    const wrap = document.createElement('div'); wrap.className='rep';
    wrap.innerHTML = `
      <div class="rep-head">
        <strong>تعليم</strong>
        <div class="rep-actions">
          <button type="button" class="btn sm ghost moveUp">▲</button>
          <button type="button" class="btn sm ghost moveDn">▼</button>
          <button type="button" class="btn sm danger del">حذف</button>
        </div>
      </div>
      <div class="grid two">
        <div><label>الدرجة</label><input type="text" class="degree" placeholder="بكالوريوس / ماجستير" value="${def.degree}"></div>
        <div><label>التخصّص</label><input type="text" class="major" placeholder="علوم حاسب" value="${def.major}"></div>
        <div><label>المؤسسة</label><input type="text" class="school" placeholder="اسم الجامعة" value="${def.school}"></div>
        <div><label>الموقع</label><input type="text" class="loc" placeholder="الرياض، السعودية" value="${def.location}"></div>
        <div><label>تاريخ التخرج</label><input type="text" class="date" placeholder="YYYY-MM" value="${def.date}"></div>
      </div>
    `;
    return wrap;
  }

  function projItem(data={}){
    const def = Object.assign({name:"",role:"",stack:"",desc:"",link:""}, data);
    const wrap = document.createElement('div'); wrap.className='rep';
    wrap.innerHTML = `
      <div class="rep-head">
        <strong>مشروع</strong>
        <div class="rep-actions">
          <button type="button" class="btn sm ghost moveUp">▲</button>
          <button type="button" class="btn sm ghost moveDn">▼</button>
          <button type="button" class="btn sm danger del">حذف</button>
        </div>
      </div>
      <div class="grid two">
        <div><label>اسم المشروع</label><input type="text" class="name" placeholder="Project X" value="${def.name}"></div>
        <div><label>الدور</label><input type="text" class="role" placeholder="قائد فريق / مطوّر" value="${def.role}"></div>
        <div><label>التقنيات</label><input type="text" class="stack" placeholder="React, Node.js, Docker" value="${def.stack}"></div>
        <div><label>رابط</label><input type="url" class="link" placeholder="https://…" value="${def.link}"></div>
        <div class="grid"><label>وصف مختصر</label><textarea class="desc" placeholder="هدف المشروع، مساهمتك، نتيجة قابلة للقياس">${def.desc}</textarea></div>
      </div>
    `;
    return wrap;
  }

  function certItem(data={}){
    const def = Object.assign({name:"",issuer:"",date:""}, data);
    const wrap = document.createElement('div'); wrap.className='rep';
    wrap.innerHTML = `
      <div class="rep-head">
        <strong>شهادة</strong>
        <div class="rep-actions">
          <button type="button" class="btn sm ghost moveUp">▲</button>
          <button type="button" class="btn sm ghost moveDn">▼</button>
          <button type="button" class="btn sm danger del">حذف</button>
        </div>
      </div>
      <div class="grid two">
        <div><label>الاسم</label><input type="text" class="name" placeholder="PMP / AWS SAA" value="${def.name}"></div>
        <div><label>الجهة</label><input type="text" class="issuer" placeholder="PMI / AWS" value="${def.issuer}"></div>
        <div><label>التاريخ</label><input type="text" class="date" placeholder="YYYY-MM" value="${def.date}"></div>
      </div>
    `;
    return wrap;
  }

  function attachRepHandlers(container){
    container.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const rep = e.target.closest('.rep'); if(!rep) return;
      const list = rep.parentElement;
      if(btn.classList.contains('del')) rep.remove();
      if(btn.classList.contains('moveUp') && rep.previousElementSibling) list.insertBefore(rep, rep.previousElementSibling);
      if(btn.classList.contains('moveDn') && rep.nextElementSibling) list.insertBefore(rep.nextElementSibling, rep);
      saveLocal(); render();
    });
    container.addEventListener('input', ()=>{ saveLocal(); render(); });
  }

  // Add initial one each (optional)
  $('#addExp').addEventListener('click', ()=>{ refs.expList.appendChild(expItem()); attachRepHandlers(refs.expList); saveLocal(); });
  $('#addEdu').addEventListener('click', ()=>{ refs.eduList.appendChild(eduItem()); attachRepHandlers(refs.eduList); saveLocal(); });
  $('#addProj').addEventListener('click', ()=>{ refs.projList.appendChild(projItem()); attachRepHandlers(refs.projList); saveLocal(); });
  $('#addCert').addEventListener('click', ()=>{ refs.certList.appendChild(certItem()); attachRepHandlers(refs.certList); saveLocal(); });

  attachRepHandlers(refs.expList);
  attachRepHandlers(refs.eduList);
  attachRepHandlers(refs.projList);
  attachRepHandlers(refs.certList);

  // Bind basics
  ['fullName','targetTitle','email','phone','location','links','summary','skills','languages'].forEach(id=>{
    const el = refs[id]; if(!el) return;
    el.addEventListener('input', ()=>{
      if(id==='summary'){ $('#summaryCount').textContent = el.value.length; }
      saveLocal(); render();
    });
  });

  // Direction toggle
  $('#dirSelect').addEventListener('change', (e)=>{
    const dir = e.target.value;
    document.documentElement.setAttribute('dir', dir);
    document.documentElement.setAttribute('lang', dir==='rtl'?'ar':'en');
  });

  // Save/Load JSON
  $('#btnSave').addEventListener('click', ()=>{
    const data = collect();
    download('cv-data.json', JSON.stringify(data, null, 2), 'application/json');
  });
  $('#jsonFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      loadData(data);
      saveLocal(); render();
    }catch(err){ alert('تعذّر استيراد JSON'); }
    e.target.value='';
  });

  // Print PDF
  $('#btnPrint').addEventListener('click', ()=>{ if(validateMin()) window.print(); });

  // Word .doc (HTML)
  $('#btnWord').addEventListener('click', ()=>{
    if(!validateMin()) return;
    const html = buildWordHtml();
    download('CV.doc', html, 'application/msword');
  });

  // Persistence
  function saveLocal(){
    const data = collect();
    try{ localStorage.setItem('cv-data', JSON.stringify(data)); }catch{}
  }
  function restoreLocal(){
    try{
      const raw = localStorage.getItem('cv-data');
      if(raw){ loadData(JSON.parse(raw)); }
    }catch{}
  }

  // Collect form to JSON
  function collect(){
    const basics = {
      fullName:sanitize(refs.fullName.value),
      targetTitle:sanitize(refs.targetTitle.value),
      email:sanitize(refs.email.value),
      phone:sanitize(refs.phone.value),
      location:sanitize(refs.location.value),
      links:sanitize(refs.links.value),
      summary:sanitize(refs.summary.value),
      skills:sanitize(refs.skills.value),
      languages:sanitize(refs.languages.value)
    };
    const experience = $$('#expList .rep').map(rep=>({
      role:sanitize($('.role',rep).value),
      company:sanitize($('.company',rep).value),
      location:sanitize($('.loc',rep).value),
      start:sanitize($('.start',rep).value),
      end:sanitize($('.end',rep).value),
      highlights:sanitize($('.highlights',rep).value)
    }));
    const education = $$('#eduList .rep').map(rep=>({
      degree:sanitize($('.degree',rep).value),
      major:sanitize($('.major',rep).value),
      school:sanitize($('.school',rep).value),
      location:sanitize($('.loc',rep).value),
      date:sanitize($('.date',rep).value)
    }));
    const projects = $$('#projList .rep').map(rep=>({
      name:sanitize($('.name',rep).value),
      role:sanitize($('.role',rep).value),
      stack:sanitize($('.stack',rep).value),
      desc:sanitize($('.desc',rep).value),
      link:sanitize($('.link',rep).value)
    }));
    const certs = $$('#certList .rep').map(rep=>({
      name:sanitize($('.name',rep).value),
      issuer:sanitize($('.issuer',rep).value),
      date:sanitize($('.date',rep).value)
    }));
    return {basics,experience,education,projects,certs};
  }

  // Load data into form
  function loadData(data){
    const b = data.basics||{};
    refs.fullName.value = b.fullName||"";
    refs.targetTitle.value = b.targetTitle||"";
    refs.email.value = b.email||"";
    refs.phone.value = b.phone||"";
    refs.location.value = b.location||"";
    refs.links.value = b.links||"";
    refs.summary.value = b.summary||"";
    refs.skills.value = b.skills||"";
    refs.languages.value = b.languages||"";
    $('#summaryCount').textContent = refs.summary.value.length;

    refs.expList.innerHTML = '';
    (data.experience||[]).forEach(x=>refs.expList.appendChild(expItem(x)));
    refs.eduList.innerHTML = '';
    (data.education||[]).forEach(x=>refs.eduList.appendChild(eduItem(x)));
    refs.projList.innerHTML = '';
    (data.projects||[]).forEach(x=>refs.projList.appendChild(projItem(x)));
    refs.certList.innerHTML = '';
    (data.certs||[]).forEach(x=>refs.certList.appendChild(certItem(x)));

    attachRepHandlers(refs.expList);
    attachRepHandlers(refs.eduList);
    attachRepHandlers(refs.projList);
    attachRepHandlers(refs.certList);
  }

  // Minimal validation for export
  function validateMin(){
    const b = state.basics;
    const missing = [];
    if(!b.fullName) missing.push('الاسم الكامل');
    if(!b.targetTitle) missing.push('المسمّى المستهدف');
    if(!b.email) missing.push('البريد الإلكتروني');
    if(!b.phone) missing.push('رقم الهاتف');
    if(!b.location) missing.push('المدينة/الدولة');
    if(missing.length){
      alert('فضلاً أكمل الحقول الأساسية:\n• ' + missing.join('\n• '));
      return false;
    }
    return true;
  }

  // Render CV preview
  function render(){
    Object.assign(state, collect());
    const b = state.basics;

    refs.v.name.textContent = b.fullName || 'اسم المتقدّم';
    refs.v.title.textContent = b.targetTitle || 'المسمّى المستهدف';
    renderContacts();

    // Summary
    toggleSec(refs.v.summarySec, !!b.summary);
    refs.v.summary.textContent = b.summary||'';

    // Skills
    const skillItems = splitByComma(b.skills);
    toggleSec(refs.v.skillsSec, skillItems.length>0);
    renderChips(refs.v.skills, skillItems);

    // Languages
    const langs = splitByComma(b.languages);
    toggleSec(refs.v.langSec, langs.length>0);
    refs.v.lang.innerHTML = '';
    langs.forEach(l=>refs.v.lang.appendChild(para('• '+l)));

    // Experience
    refs.v.exp.innerHTML='';
    state.experience.forEach(x=>{
      if(!(x.role||x.company||x.highlights)) return;
      const wrap = document.createElement('div'); wrap.className='item';
      const pos = document.createElement('div'); pos.className='pos';
      const role = document.createElement('span'); role.className='role'; role.textContent = x.role;
      const company = document.createElement('span'); company.className='company'; company.textContent = x.company?(' — '+x.company):'';
      pos.append(role, company);
      const meta = document.createElement('div'); meta.className='meta';
      const date = [x.start, x.end].filter(Boolean).join(' – ');
      meta.textContent = [x.location, date].filter(Boolean).join(' · ');
      const hi = (x.highlights||'').split(/\s*;\s*/).filter(Boolean);
      wrap.append(pos, meta, bulletList(hi));
      refs.v.exp.appendChild(wrap);
    });
    toggleSec(refs.v.expSec, refs.v.exp.children.length>0);

    // Education
    refs.v.edu.innerHTML='';
    state.education.forEach(x=>{
      if(!(x.degree||x.school)) return;
      const wrap = document.createElement('div'); wrap.className='item';
      const line = document.createElement('div'); line.className='pos';
      const degree = document.createElement('span'); degree.className='role'; degree.textContent = x.degree + (x.major?(' — '+x.major):'');
      const school = document.createElement('span'); school.className='company'; school.textContent = x.school?(' — '+x.school):'';
      line.append(degree, school);
      const meta = document.createElement('div'); meta.className='meta';
      meta.textContent = [x.location, x.date].filter(Boolean).join(' · ');
      refs.v.edu.append(line, meta);
    });
    toggleSec(refs.v.eduSec, refs.v.edu.children.length>0);

    // Projects
    refs.v.proj.innerHTML='';
    state.projects.forEach(x=>{
      if(!(x.name||x.desc)) return;
      const wrap = document.createElement('div'); wrap.className='item';
      const line = document.createElement('div'); line.className='pos';
      const name = document.createElement('span'); name.className='role'; name.textContent = x.name;
      const role = document.createElement('span'); role.className='company'; role.textContent = x.role?(' — '+x.role):'';
      line.append(name, role);
      const meta = document.createElement('div'); meta.className='meta';
      meta.textContent = [x.stack, x.link].filter(Boolean).join(' · ');
      wrap.append(line, meta, para(x.desc||''));
      refs.v.proj.appendChild(wrap);
    });
    toggleSec(refs.v.projSec, refs.v.proj.children.length>0);

    // Certs
    refs.v.cert.innerHTML='';
    state.certs.forEach(x=>{
      if(!(x.name||x.issuer)) return;
      const wrap = document.createElement('div'); wrap.className='item';
      const line = document.createElement('div'); line.className='pos';
      const name = document.createElement('span'); name.className='role'; name.textContent = x.name;
      const issuer = document.createElement('span'); issuer.className='company'; issuer.textContent = x.issuer?(' — '+x.issuer):'';
      line.append(name, issuer);
      const meta = document.createElement('div'); meta.className='meta';
      meta.textContent = x.date || '';
      wrap.append(line, meta);
      refs.v.cert.appendChild(wrap);
    });
    toggleSec(refs.v.certSec, refs.v.cert.children.length>0);
  }

  // Build Word (.doc) as HTML
  function buildWordHtml(){
    const dir = document.documentElement.getAttribute('dir') || 'rtl';
    const cv = $('#cv').cloneNode(true);
    // إزالة عناصر تفاعلية إن وجدت (لا يوجد هنا)
    const styles = `
      <style>
        body{font-family:"Cairo","Noto Naskh Arabic",Arial;direction:${dir};color:#0F172A}
        h1{margin:0 0 6px;font-size:24px}
        h3{margin:14px 0 6px;font-size:15px}
        .bar{height:2px;background:#C7A046;margin:10px 0 18px}
        .meta{color:#475569;font-size:12px}
        ul{margin:6px 0 0 18px}
        li{margin:4px 0}
        .chip{display:inline-block;margin:2px 4px;padding:3px 8px;border:1px solid #E5E7EB;border-radius:999px;font-size:12px;background:#F8FAFC}
      </style>
    `;
    // تحويل chips إلى نص بسيط داخل DOC (Word يدعم الـ span)
    // لا حاجة لتعديل لأن Word يقرأ الـ span.
    const html =
`<!DOCTYPE html><html><head><meta charset="utf-8"><title>CV</title>${styles}</head><body>${cv.outerHTML}</body></html>`;
    return html;
  }

  function download(filename, content, mime){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
  }

  // Init
  restoreLocal();
  render();

})();
</script>
</body>
</html>
