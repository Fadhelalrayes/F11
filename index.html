<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>الابراج والاستبصار</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0d12; --fg:#f7f7f7; --muted:#bdbdbd;
    --brand:#ffd54a; --card:#141823; --stroke:#242a36; --accent:#5ad1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:"Tajawal","Cairo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    overflow-x:hidden;
  }

  /* خلفية نجوم */
  body::before, body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:-2;
  }
  body::before{
    background:
      radial-gradient(1200px 600px at 50% -10%, #1b2140 0%, rgba(27,33,64,0) 60%),
      radial-gradient(800px 500px at 80% 120%, #1a2336 0%, rgba(26,35,54,0) 60%),
      linear-gradient(180deg, #0b0d12 0%, #0e1320 55%, #0b0d12 100%);
  }
  body::after{
    background:
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240"><g fill="%23ffffff" opacity="0.45"><circle cx="20" cy="30" r="1.2"/><circle cx="80" cy="60" r="0.8"/><circle cx="140" cy="20" r="1"/><circle cx="200" cy="90" r="1.1"/><circle cx="110" cy="140" r="0.9"/><circle cx="40" cy="190" r="1.2"/><circle cx="210" cy="200" r="0.9"/></g></svg>') repeat;
    background-size:240px 240px;
    animation: twinkle 6s ease-in-out infinite;
    opacity:.35;
  }
  @keyframes twinkle { 0%,100%{opacity:.28} 50%{opacity:.42} }

  header{
    position:sticky; top:0; z-index:10; background:rgba(11,13,18,.75);
    backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--stroke); padding:14px 16px;
    display:flex; align-items:center; justify-content:center; text-align:center;
  }
  .brand{display:block}
  .title{
    font-weight:800; letter-spacing:.3px; line-height:1;
    font-size: clamp(28px, 5vw, 48px); color:var(--brand); text-align:center;
  }
  .subtitle{
    color:var(--muted); font-size:14px; margin-top:6px; text-align:center;
  }
  .clear-mini{
    display:block; margin:6px auto 0; width:max-content;
    font-size:12px; color:var(--brand); background:transparent; border:0; cursor:pointer;
    text-decoration:underline; text-underline-offset:3px;
  }

  .container{max-width:980px;margin:0 auto;padding:18px 16px}
  .card{
    background:rgba(20,24,35,.9); border:1px solid var(--stroke); border-radius:18px; padding:22px; margin:16px 0;
    box-shadow:0 18px 40px rgba(0,0,0,.35)
  }
  h1,h2{color:var(--brand); margin:10px 0 8px; text-align:center}
  label{display:block; margin:10px 0 6px; color:#eaeaea; font-size:14px}
  input,select,button{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--stroke);
    background:#0f1320; color:var(--fg); font-size:16px; outline:none
  }
  input:focus, select:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(255,213,74,.15)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .btn{
    border:0; background:linear-gradient(135deg, var(--brand), #ffb300);
    color:#221; font-weight:800; cursor:pointer; transition:transform .08s ease, filter .2s ease; letter-spacing:.2px
  }
  .btn:active{transform:scale(.99)}
  .ghost{background:transparent; border:1px solid var(--brand); color:var(--brand)}
  .center{display:grid; place-items:center; text-align:center}
  .hidden{display:none !important}
  .topic-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px}
  @media (max-width:640px){ .topic-grid{grid-template-columns:1fr} }
  .topic{padding:18px; border:1px dashed var(--brand); border-radius:14px; background:#0f1320; cursor:pointer}
  .topic:hover{background:#12172a}
  .topic span{display:block; color:var(--muted); font-size:14px; margin-top:4px}
  .result{line-height:1.95}
  .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; border:1px solid var(--stroke); color:#fff; font-size:14px; background:#0f1320}
  .z-emoji{font-size:20px}
  .stars{position:relative; overflow:hidden; border-radius:16px}
  .quota{margin-top:8px; font-size:13px; color:#cfd8dc; text-align:center}

  footer{
    padding:24px 16px; text-align:center; color:var(--muted);
    border-top:1px solid var(--stroke); display:flex; flex-direction:column; gap:10px; align-items:center
  }
  .socials{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
  .socials button{
    width:34px; height:34px; display:inline-grid; place-items:center; border-radius:10px;
    border:1px solid var(--stroke); background:#0f1320; transition:transform .1s ease, border-color .2s ease; cursor:pointer
  }
  .socials button:hover{transform:translateY(-1px); border-color:var(--accent)}
  .socials svg{width:18px;height:18px; fill:#cfd8dc}

  /* حلقة الانتظار */
  .ring-wrap{height:260px; display:grid; place-items:center}
  .ring{
    width:130px; height:130px; border-radius:50%;
    border:6px solid rgba(255,255,255,.08); border-top-color:var(--brand);
    animation:spin 1.2s linear infinite; position:relative
  }
  .ring:after{
    content:""; position:absolute; inset:16px; border-radius:50%;
    border:4px dashed rgba(255,255,255,.12)
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  ul{margin:8px 0 0 0; padding:0 18px}

  /* منع التحديد أثناء الحظر */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; justify-content:center; align-items:center; z-index:20;
  }
  .overlay .modal{
    background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:18px; max-width:420px; margin:16px; text-align:center;
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="title">الابراج والاستبصار</div>
    <div class="subtitle">قراءات فلكية تنبؤية موجزة — إيجابيات وتحذيرات تتغير في كل مرة</div>
    <button class="clear-mini" id="clearBtn" title="حذف كل البيانات المحلية">حذف بياناتي</button>
  </div>
</header>

<main class="container">

  <!-- الخطوة 1: إدخال البيانات -->
  <section id="step1" class="card stars center">
    <h1 style="margin-bottom:6px">ابدأ قراءتك</h1>

    <div class="grid" style="max-width:680px; margin:10px auto 0;">
      <div>
        <label>الجنس</label>
        <select id="gender">
          <option value="">اختر</option>
          <option>ذكر</option>
          <option>أنثى</option>
        </select>
      </div>
      <div>
        <label>الحالة الاجتماعية</label>
        <select id="status">
          <option value="">اختر</option>
          <option>أعزب/عزباء</option>
          <option>متزوج/متزوجة</option>
          <option>منفصل/منفصلة</option>
          <option>مخطوب/مخطوبة</option>
        </select>
      </div>
      <div style="grid-column:1 / -1">
        <label>تاريخ الميلاد</label>
        <input id="birthdate" type="date">
      </div>
    </div>

    <div style="margin-top:16px;">
      <button class="btn" id="startBtn" style="min-width:220px">ابدأ القراءة</button>
    </div>
    <div class="quota" id="quotaInfo"></div>
  </section>

  <!-- الخطوة 2: شاشة انتظار -->
  <section id="stepLoading" class="card hidden center stars">
    <div>
      <div class="ring-wrap"><div class="ring" aria-hidden="true"></div></div>
      <h2>جاري الاستبصار…</h2>
      <p class="muted">ثوانٍ قليلة وتظهر الإشارات.</p>
    </div>
  </section>

  <!-- الخطوة 3: اختيار الموضوع -->
  <section id="stepTopics" class="card hidden stars center">
    <h2>اختر موضوع قراءتك</h2>
    <div id="zodiacBadge" style="margin:8px 0 14px"></div>
    <div class="topic-grid" style="max-width:700px; margin:10px auto 0;">
      <button class="topic" data-topic="love">الحب ❤️<span>العلاقات، الانجذاب، المصالحات</span></button>
      <button class="topic" data-topic="health">الصحة 💊<span>الطاقة، العادات، التوازن</span></button>
      <button class="topic" data-topic="career">المهنة/الثروة 💼<span>الفرص، القرارات، الاستثمارات</span></button>
      <button class="topic" data-topic="general">عام ✨<span>رؤية شاملة للأيام المقبلة</span></button>
    </div>
    <div class="quota" id="quotaInfoTopics"></div>
  </section>

  <!-- الخطوة 4: النتيجة -->
  <section id="stepResult" class="card hidden stars">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
      <h2 style="margin:0">الإشارات الظاهرة</h2>
      <div class="tag" id="userEcho">
        <span class="z-emoji" id="zEmoji">♈︎</span>
        <span id="zName">الحمل</span>
      </div>
    </div>

    <div id="resultText" class="result" style="margin-top:10px"></div>
    <div id="omen" class="muted" style="margin-top:12px; font-size:15px"></div>

    <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; justify-content:center">
      <button class="btn" id="againBtn">إشارة جديدة (نفس الموضوع)</button>
      <button class="ghost" id="topicsBtn">اختيار موضوع آخر</button>
      <button class="ghost" id="restartBtn">إعادة البدء</button>
    </div>
    <div class="quota" id="quotaInfoResult" style="margin-top:10px"></div>
  </section>

</main>

<footer>
  <div>شارك الصفحة</div>
  <div class="socials" aria-label="مشاركة">
    <button id="shareNative" title="مشاركة"><svg viewBox="0 0 24 24"><path d="M18 8a3 3 0 1 0-2.83-3.99L8.91 7.1a3.02 3.02 0 0 0-2.01-.78A3 3 0 1 0 9.9 9l6.26-3.08A3.02 3.02 0 0 0 18 8Zm-9 7a3 3 0 1 0-3 3 3 3 0 0 0 3-3Zm12-1a3 3 0 1 0-3 3 3 3 0 0 0 3-3Z"/></svg></button>
    <button id="shareX" title="X / Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2H21l-6.56 7.51L22.5 22h-6.79l-4.87-6.37L4.94 22H2l7.02-8.03L1.5 2h6.87l4.39 5.86L18.244 2Zm-2.38 18h1.84L8.23 4h-1.9l9.534 16Z"/></svg></button>
    <button id="shareWA" title="WhatsApp"><svg viewBox="0 0 24 24"><path d="M12.04 2A10 10 0 0 0 2 12.04C2 17.55 6.46 22 11.97 22c1.76 0 3.43-.43 4.9-1.2l3.13.82-.84-3.06A9.93 9.93 0 0 0 22 12.04 10 10 0 0 0 12.04 2Zm5.86 14.57c-.25.71-1.47 1.35-2.03 1.38-.56.03-1.28.18-4.35-1.42-3.69-1.82-6.06-6.4-6.25-6.69-.19-.29-1.5-2-1.5-3.83 0-1.83.96-2.73 1.3-3.11.34-.38.74-.48.99-.48.25 0 .5 0 .72.01.23.01.55-.09.86.66.31.76 1.06 2.6 1.15 2.79.09.19.16.41.03.66-.13.24-.2.39-.4.6-.19.21-.42.47-.6.63-.19.16-.39.34-.17.72.22.38.97 1.6 2.09 2.6 1.44 1.26 2.66 1.65 3.04 1.84.38.19.6.16.83-.1.23-.25.96-1.12 1.22-1.5.25-.38.51-.32.86-.19.34.13 2.16 1.02 2.54 1.21.38.19.63.28.72.44.09.16.09.94-.16 1.65Z"/></svg></button>
    <button id="shareFB" title="Facebook"><svg viewBox="0 0 24 24"><path d="M13 22v-8h3l1-4h-4V7.5A1.5 1.5 0 0 1 14.5 6H17V2h-3.5A4.5 4.5 0 0 0 9 6.5V10H6v4h3v8h4Z"/></svg></button>
  </div>
  <div>© <span id="year"></span> الابراج والاستبصار</div>
</footer>

<!-- حظر عند نفاد الحصّة -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3 style="color:var(--brand); margin-top:0">وصلت إلى الحد اليومي</h3>
    <p>المتاح: 4 قراءات كل 24 ساعة. الرجاء الانتظار حتى انتهاء العداد لإتاحة قراءات جديدة.</p>
    <p class="quota"><span id="countdown">00:00:00</span> حتى التجديد</p>
    <button class="ghost" id="closeOverlay">حسنًا</button>
  </div>
</div>

<script>
  /* ====== بيانات الأبراج ====== */
  const ZODIAC = [
    {name:"الحمل",   emoji:"♈︎", from:[3,21],  to:[4,19]},
    {name:"الثور",   emoji:"♉︎", from:[4,20],  to:[5,20]},
    {name:"الجوزاء", emoji:"♊︎", from:[5,21],  to:[6,20]},
    {name:"السرطان", emoji:"♋︎", from:[6,21],  to:[7,22]},
    {name:"الأسد",   emoji:"♌︎", from:[7,23],  to:[8,22]},
    {name:"العذراء", emoji:"♍︎", from:[8,23],  to:[9,22]},
    {name:"الميزان", emoji:"♎︎", from:[9,23],  to:[10,22]},
    {name:"العقرب",  emoji:"♏︎", from:[10,23], to:[11,21]},
    {name:"القوس",   emoji:"♐︎", from:[11,22], to:[12,21]},
    {name:"الجدي",   emoji:"♑︎", from:[12,22], to:[1,19]},
    {name:"الدلو",   emoji:"♒︎", from:[1,20],  to:[2,18]},
    {name:"الحوت",   emoji:"♓︎", from:[2,19],  to:[3,20]}
  ];
  function getZodiac(dt){
    if(!dt) return {name:"غير معروف", emoji:"☆"};
    const d = new Date(dt);
    const m = d.getMonth()+1, day = d.getDate();
    for(const z of ZODIAC){
      const [fm,fd]=z.from, [tm,td]=z.to;
      const inSame = (m===fm && day>=fd) || (m===tm && day<=td);
      const inWrap = (fm>tm) && ((m===fm && day>=fd) || (m===tm && day<=td) || (m>fm || m<tm));
      if((fm<tm && inSame) || (fm>tm && inWrap)) return z;
    }
    return {name:"غير معروف", emoji:"☆"};
  }

  /* ====== نصوص عامة (إيجابي/تحذيري) + حسب البرج + موضوع ====== */
  const BASE_POS = [
    "مؤشر إيجابي يلمع في محيطك القريب؛ باب صغير يُفتح بتوقيت مفاجئ.",
    "رسالة موجزة تغيّر إيقاع يومك نحو انفتاح أسرع مما توقعت.",
    "همس انسجام يعبر علاقاتك؛ التفاؤل يسبق الخطوات هذه المرة.",
    "خبر سار يأتي من جهة لم تكن في الحسبان، كأنه وعد قديم عاد الآن."
  ];
  const BASE_WARN = [
    "تذبذب قصير قد يربك قراءتك للمشهد؛ لا تنجرف مع أول انفعال.",
    "تفصيل ناقص في قصة متداولة حولك؛ الجزء الغائب يُبدّل المعنى.",
    "سطوع مفاجئ في عرضٍ ما قد يخفي ظلالًا لاحقة؛ اللمعان ليس معيارًا.",
    "نافذة ارتباك عابرة تلوّح؛ إن استسلمت لها تؤخر وصول الفرج قليلًا."
  ];

  const TOPICS = {
    love: {
      title:"الحب",
      pos:[
        "قلبك يلتقط تردّدًا دافئًا؛ مصادفة قصيرة تعيد بريقًا قديمًا.",
        "إشارة انجذاب تظهر حين يتقاطع الصدق مع الطمأنينة.",
        "حالة صُلح محتملة بعد فتور، وتلاقي على نيةٍ واضحة."
      ],
      warn:[
        "وعدٌ سريع يبهرك ثم يخفت.",
        "حبيبٌ تُحيط به علامات شك؛ راقب إشارات الغياب والتردد.",
        "شخص جديد يدخل الدائرة يبدأ اسمه بحرف: <LETTER> — حضوره لافت لكنه يمتحن ثقتك."
      ]
    },
    health: {
      title:"الصحة",
      pos:[
        "صفاء داخلي يمر كنسمة؛ الجسد يستجيب لإيقاعٍ أهدأ.",
        "يقظة خفيفة تعيد الانسجام بين المزاج والحركة."
      ],
      warn:[
        "ثِقل خفي يتراكم إن تجاهلت همس الإرهاق.",
        "قلق عابر يتجلى في توتر عضلي؛ انتبه لإشارات الجسد."
      ]
    },
    career: {
      title:"المهنة/الثروة",
      pos:[
        "نافذة عمل جانبية تحمل توقيعًا صغيرًا وتأثيرًا كبيرًا.",
        "وارد مالي منتظر يأتي كتعويض أو مكافأة مرتبطة بإنجاز سابق."
      ],
      warn:[
        "بندٌ مخفي يقلب الميزان إن لم يُقرأ جيدًا.",
        "احتمال أزمة مالية حادة إن انسقت وراء إغراء إنفاق مفاجئ."
      ]
    },
    general: {
      title:"عام",
      pos:[
        "خبر سار يأتي من جهة بعيدة كهدية مؤجّلة.",
        "بوادر صُلح عائلي تُطفئ شرارة خلاف قديم."
      ],
      warn:[
        "توتّر عائلي قصير يُختبر فيه صبرك قبل أن يهدأ.",
        "حديثٌ مُلتبس في محيطك قد يُفهم على غير مقصده."
      ]
    }
  };

  const SIGN_SNIPPETS = {
    "الحمل":   {pos:["اندفاعة موفقة تعيد الحياة لمشروع غفا."], warn:["حدة سريعة قد تصنع سوء فهم."]},
    "الثور":   {pos:["ثباتك يثمر مردودًا ملموسًا."], warn:["عنادٌ بسيط يحجب مرونة مطلوبة."]},
    "الجوزاء": {pos:["فطنة حوارية تقتنص فرصة."], warn:["تشعّب المواضيع يبدد تركيزك."]},
    "السرطان": {pos:["دفء عائلي يرمم ما تصدّع."], warn:["حساسية زائدة تقرأ ما ليس مقصودًا."]},
    "الأسد":   {pos:["ظهور لافت يثبت مكانتك."], warn:["توقعات عالية تُثقِل اللحظة."]},
    "العذراء": {pos:["تفصيل صغير يصحّح مسارًا."], warn:["مثالية مفرطة تؤخر الانطلاق."]},
    "الميزان": {pos:["اتزان يجلب تفاهمًا سريعًا."], warn:["ميل لإرضاء الجميع يذيب حقك."]},
    "العقرب":  {pos:["حدسك يصيب الهدف."], warn:["شكّ زائد يطفئ بريق إنجاز."]},
    "القوس":   {pos:["نَفَس مغامرة يفتح بابًا."], warn:["حماس زائد يقفز فوق خطوة أساسية."]},
    "الجدي":   {pos:["انضباط يضع حجر أساس لربح."], warn:["صرامة تُفهم كبرود."]},
    "الدلو":   {pos:["فكرة مبتكرة تجد آذانًا مصغية."], warn:["مزاج متقلب يشتته التنبيه المستمر." ]},
    "الحوت":   {pos:["رهافة شعور تقود لاختيار مُلهِم."], warn:["ضباب عاطفي يختبر وضوح قرارك."]},
    "غير معروف":{pos:["إشارة عامة نحو انفراج."], warn:["لوحة المشهد غير مكتملة بعد."]}
  };

  const OMENS = [
    "ومضة: باب يُفتح مرتين؛ الأولى امتحان، والثانية فرج.",
    "ومضة: رسالة مقتضبة تغيّر اتجاه الأسبوع.",
    "ومضة: لقاء عابر يترك أثرًا أطول من زمنه."
  ];

  /* ====== عناصر DOM ====== */
  const $ = sel => document.querySelector(sel);
  const step1 = $("#step1"), stepLoading = $("#stepLoading"), stepTopics = $("#stepTopics"), stepResult = $("#stepResult");
  const userEcho = $("#userEcho"), resultText = $("#resultText"), omenEl = $("#omen");
  const startBtn = $("#startBtn"), againBtn = $("#againBtn"), topicsBtn = $("#topicsBtn"), restartBtn = $("#restartBtn");
  const clearBtn = $("#clearBtn");
  const zBadge = $("#zodiacBadge"), zEmojiEl = $("#zEmoji"), zNameEl = $("#zName");
  const quotaInfo = $("#quotaInfo"), quotaInfoTopics = $("#quotaInfoTopics"), quotaInfoResult = $("#quotaInfoResult");
  const overlay = $("#overlay"), countdownEl = $("#countdown"), closeOverlay = $("#closeOverlay");
  const yearEl = $("#year"); yearEl.textContent = new Date().getFullYear();

  /* ====== مشاركة الصفحة ====== */
  function shareData(){
    const data = {
      title: "الابراج والاستبصار",
      text: "جرّب قراءات فلكية تنبؤية موجزة — إيجابيات وتحذيرات تتغير في كل مرة.",
      url: location.href
    };
    if(navigator.share){ navigator.share(data).catch(()=>{}); }
    else { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}`,'_blank'); }
  }
  $("#shareNative").addEventListener("click", shareData);
  $("#shareFB").addEventListener("click", ()=>window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}`,'_blank'));
  $("#shareX").addEventListener("click", ()=>window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("قراءات فلكية تنبؤية موجزة — الابراج والاستبصار")}&url=${encodeURIComponent(location.href)}`,'_blank'));
  $("#shareWA").addEventListener("click", ()=>window.open(`https://wa.me/?text=${encodeURIComponent("قراءات فلكية تنبؤية — الابراج والاستبصار: "+location.href)}`,'_blank'));

  /* ====== حفظ البيانات محليًا ====== */
  function saveForm(){
    const data = {
      gender: $("#gender").value || "",
      status: $("#status").value || "",
      birthdate: $("#birthdate").value || ""
    };
    localStorage.setItem("istibsar_form", JSON.stringify(data));
  }
  function loadForm(){
    try{
      const data = JSON.parse(localStorage.getItem("istibsar_form")||"{}");
      if(data.gender) $("#gender").value = data.gender;
      if(data.status) $("#status").value = data.status;
      if(data.birthdate) $("#birthdate").value = data.birthdate;
    }catch(e){}
  }
  function clearForm(){
    localStorage.removeItem("istibsar_form");
    $("#gender").value=""; $("#status").value=""; $("#birthdate").value="";
  }
  ["gender","status","birthdate"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("input", saveForm);
    el.addEventListener("change", saveForm);
  });
  clearBtn.addEventListener("click", ()=>{ clearForm(); alert("تم حذف بياناتك من هذا المتصفح."); });

  /* ====== العشوائية + حساب البرج ====== */
  function seeded(seed){ let x = seed ^ Date.now(); return function(){ x ^= x<<13; x ^= x>>>17; x ^= x<<5; return ((x>>>0)/4294967296); } }
  function strHash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  function pick(rand, arr){ return arr[Math.floor(rand()*arr.length)] }
  function getRandomLetterArabic(){
    const letters = "أبتثجحخدذرزسشصضطظعغفقكلمنهوي";
    return letters[Math.floor(Math.random()*letters.length)];
  }

  let currentTopic = "general";
  let currentRand = seeded(123);
  let currentSign = {name:"غير معروف", emoji:"☆"};

  function formSeed(){
    const g = $("#gender").value || "";
    const s = $("#status").value || "";
    const b = $("#birthdate").value || "";
    const key = `${g}|${s}|${b}`;
    return key ? strHash(key) : Math.floor(Math.random()*1e9);
  }

  function updateZodiacUI(){
    currentSign = getZodiac($("#birthdate").value);
    zEmojiEl.textContent = currentSign.emoji;
    zNameEl.textContent = currentSign.name;
    zBadge.innerHTML = `<div class="tag"><span class="z-emoji">${currentSign.emoji}</span> برجك: ${currentSign.name}</div>`;
  }

  function echoUser(){
    const g = $("#gender").value || "غير محدد";
    const s = $("#status").value || "غير محددة";
    const b = $("#birthdate").value || "غير معروف";
    userEcho.innerHTML = `<span class="z-emoji">${currentSign.emoji}</span> ${currentSign.name} • ${g} • ${s} • ${b}`;
  }

  /* ====== إدارة الحصّة اليومية (4 قراءات / 24 ساعة) ====== */
  const MAX_READS = 4;
  function getQuota(){
    const raw = localStorage.getItem("istibsar_quota");
    const now = Date.now();
    if(!raw) return {count:0, resetAt:null};
    try{
      const data = JSON.parse(raw);
      if(data.resetAt && now > data.resetAt) return {count:0, resetAt:null};
      return data;
    }catch(e){ return {count:0, resetAt:null}; }
  }
  function setQuota(q){ localStorage.setItem("istibsar_quota", JSON.stringify(q)); }
  function incQuota(){
    const q = getQuota();
    const now = Date.now();
    const resetAt = q.resetAt || (now + 24*60*60*1000);
    const next = {count: (q.count||0)+1, resetAt};
    setQuota(next);
    return next;
  }
  function remainingQuota(){ const q=getQuota(); return Math.max(0, MAX_READS - (q.count||0)); }
  function updateQuotaUI(){
    const rem = remainingQuota();
    const q = getQuota();
    const base = `المتبقي اليوم: ${rem} / ${MAX_READS}` + (q.resetAt ? ` — تجديد خلال ${fmtRemaining(q.resetAt - Date.now())}` : "");
    [quotaInfo, quotaInfoTopics, quotaInfoResult].forEach(el=>{ if(el) el.textContent = base; });
  }
  function fmtRemaining(ms){
    if(ms<=0) return "00:00:00";
    const s = Math.floor(ms/1000);
    const h = String(Math.floor(s/3600)).padStart(2,"0");
    const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const sec = String(s%60).padStart(2,"0");
    return `${h}:${m}:${sec}`;
  }
  function showOverlayCountdown(){
    const q = getQuota();
    if(!q.resetAt) return;
    overlay.style.display = "flex";
    function tick(){
      const left = q.resetAt - Date.now();
      countdownEl.textContent = fmtRemaining(left);
      if(left<=0){
        overlay.style.display="none";
        setQuota({count:0, resetAt:null});
        updateQuotaUI();
      } else {
        requestAnimationFrame(tick);
      }
    }
    tick();
  }
  closeOverlay.addEventListener("click", ()=>overlay.style.display="none");

  /* ====== تدفق الصفحات ====== */
  function show(el){ el.classList.remove("hidden") }
  function hide(el){ el.classList.add("hidden") }

  function startFlow(){
    hide(step1); show(stepLoading);
    setTimeout(()=>{ hide(stepLoading); show(stepTopics); updateZodiacUI(); updateQuotaUI(); }, 2200);
  }

  /* ====== إنتاج التقرير ====== */
  function buildBlock(title, items){
    return `<h3 style="text-align:center">${title}</h3><ul>${items.map(i=>`<li>${i}</li>`).join("")}</ul>`;
  }

  function buildReport(topic){
    const bank = TOPICS[topic] || TOPICS.general;
    const pack = SIGN_SNIPPETS[currentSign.name] || SIGN_SNIPPETS["غير معروف"];
    const r = seeded(Math.floor(currentRand()*1e9));

    const letter = getRandomLetterArabic();
    const posBase = pick(r, BASE_POS), posTopic = pick(r, bank.pos), posSign = pick(r, pack.pos);
    let warnTopic = pick(r, bank.warn);
    warnTopic = warnTopic.replace("<LETTER>", letter);
    const warnBase = pick(r, BASE_WARN), warnSign = pick(r, pack.warn);

    // إضافة عمق أحداث محددة كما طلبت (خلاف/صلح/مال/أزمة/حبيب مشكوك…)
    const deepPos = pick(r, [
      "بوادر صُلح أسري تُطفئ شرارة خلاف قديم، وتفتح باب التقارب.",
      "مبلَغ مالي يصل بشكل مفاجئ (تعويض/هبة/فرصة عابرة) يخفف عبئًا سابقًا."
    ]);
    const deepWarn = pick(r, [
      "احتمال خلاف عائلي قصير لكن حادّ قبل أن يهدأ سريعًا.",
      "بوادر أزمة مادية إن تم اتخاذ خطوة إنفاق طائشة خلال أيام."
    ]);

    const intro = `<p style="text-align:center"><strong>${bank.title}:</strong> الإشارات تميل إلى الظهور بوضوح؛ بعضها يقود لفرجٍ قريب وبعضها يحذّر من خطوة خاطفة.</p>`;
    const positives = buildBlock("توقعات إيجابية", [posBase, posTopic, posSign, deepPos]);
    const warnings  = buildBlock("تحذيرات محتملة", [warnBase, warnTopic, warnSign, deepWarn]);

    return `${intro}${positives}${warnings}`;
  }

  function genReading(topic){
    // تحقق من الحصّة
    const q = getQuota();
    if((q.count||0) >= MAX_READS){
      updateQuotaUI();
      showOverlayCountdown();
      return;
    }
    // زيادة العدّاد وتحديث واجهة الحصّة
    const newQ = incQuota();
    updateQuotaUI();

    const html = buildReport(topic);
    resultText.innerHTML = html;
    omenEl.textContent = pick(seeded(Date.now()), OMENS);
  }

  /* ====== أحداث ====== */
  document.getElementById("startBtn").addEventListener("click", ()=>{
    currentRand = seeded(formSeed());
    updateZodiacUI();
    startFlow();
  });

  document.querySelectorAll(".topic").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      // منع الدخول إذا الحصّة صفر قبل عرض النتيجة
      if(remainingQuota()<=0){ showOverlayCountdown(); return; }
      currentTopic = btn.dataset.topic;
      hide(stepTopics); show(stepResult);
      echoUser(); genReading(currentTopic);
    });
  });

  document.getElementById("againBtn").addEventListener("click", ()=>{
    currentRand = seeded(formSeed()); genReading(currentTopic);
  });
  document.getElementById("topicsBtn").addEventListener("click", ()=>{
    hide(stepResult); show(stepTopics); updateQuotaUI();
  });
  document.getElementById("restartBtn").addEventListener("click", ()=>{
    hide(stepResult); hide(stepTopics); show(step1); window.scrollTo({top:0, behavior:"smooth"});
    updateQuotaUI();
  });

  // تهيئة
  (function init(){
    loadForm();
    updateZodiacUI();
    updateQuotaUI();
    // تحدّث العدّاد كل ثانية عند وجود resetAt
    setInterval(()=>{ updateQuotaUI(); }, 1000);
  })();
</script>
</body>
</html>
