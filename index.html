<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>الأبراج والاستبصار – قراءة الطالع العميقة</title>
<meta name="description" content="قراءات فلكية تنبؤية حاسمة بصياغة عرّاف" />
<meta name="robots" content="index, follow" />
<meta name="theme-color" content="#0b0d12" />
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0d12; --fg:#f7f7f7; --muted:#bdbdbd;
    --brand:#ffd54a; --card:#141823; --stroke:#242a36; --accent:#5ad1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    line-height:1.9; overflow-x:hidden;
  }
  body::before, body::after{ content:""; position:fixed; inset:0; pointer-events:none; z-index:-2; }
  body::before{
    background:
      radial-gradient(1200px 600px at 50% -10%, #1b2140 0%, rgba(27,33,64,0) 60%),
      radial-gradient(800px 500px at 80% 120%, #1a2336 0%, rgba(26,35,54,0) 60%),
      linear-gradient(180deg, #0b0d12 0%, #0e1320 55%, #0b0d12 100%);
  }
  body::after{
    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240"><g fill="%23ffffff" opacity="0.30"><circle cx="20" cy="30" r="1.2"/><circle cx="80" cy="60" r="0.8"/><circle cx="140" cy="20" r="1"/><circle cx="200" cy="90" r="1.1"/><circle cx="110" cy="140" r="0.9"/><circle cx="40" cy="190" r="1.2"/><circle cx="210" cy="200" r="0.9"/></g></svg>') repeat;
    background-size:240px 240px; animation: twinkle 6s ease-in-out infinite; opacity:.26;
  }
  header{ text-align:center; padding:18px 16px 10px; background:rgba(11,13,18,.75); backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--stroke); }
  .title{ margin:0; font-weight:700; line-height:1.2; font-size: clamp(28px,5vw,46px); color:var(--brand);}
  .subtitle{ color:var(--muted); font-size:14px; margin-top:6px }
  .seer-wrap{display:flex; justify-content:center; margin:10px 0 8px}
  .seer{ width:min(520px, 88vw); height:auto; filter: drop-shadow(0 14px 30px rgba(0,0,0,.4)); }

  .container{max-width:1000px;margin:0 auto;padding:18px 16px}
  .card{ background:rgba(20,24,35,.92); border:1px solid var(--stroke); border-radius:18px; padding:22px; margin:16px 0; box-shadow:0 18px 40px rgba(0,0,0,.35) }
  h2{color:var(--brand); margin:10px 0 8px; text-align:center}
  label{display:block; margin:10px 0 6px; color:#eaeaea; font-size:15px}

  input,select,button{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--stroke);
    background:#0f1320; color:#f7f7f7; font-size:16px; outline:none;
  }
  input:focus, select:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(255,213,74,.15)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .btn{ border:0; background:linear-gradient(135deg, var(--brand), #ffb300); color:#221; font-weight:700; cursor:pointer; transition:transform .08s ease }
  .btn:active{transform:scale(.99)}
  .ghost{background:transparent; border:1px solid var(--brand); color:var(--brand)}
  .center{display:grid; place-items:center; text-align:center}
  .hidden{display:none !important}

  .topic-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px}
  @media (max-width:640px){ .topic-grid{grid-template-columns:1fr} }
  .topic{padding:18px; border:1px dashed var(--brand); border-radius:14px; background:#0f1320; cursor:pointer; text-align:center}
  .topic:hover{background:#12172a}
  .topic span{display:block; color:#cfd8dc; font-size:14px; margin-top:4px}

  .result{ font-size:19px; text-align:justify; }
  .result p{ margin:10px 0; }
  .result .lead{font-weight:700}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; border:1px solid var(--stroke); background:#0f1320; color:#fff; font-size:14px}
  .z-emoji{font-size:20px}
  .quota{margin-top:8px; font-size:13px; color:#cfd8dc; text-align:center}
  .muted{color:#bdbdbd}

  .notice{ margin:10px auto 0; padding:12px 14px; border-radius:12px; border:1px solid #3a2a2a; background:#1a1010; color:#ffd0d0; font-size:14px; max-width:820px; }
  .notice.ok{background:#0f1a14; border-color:#234832; color:#c9ffd9}

  footer{ padding:24px 16px; text-align:center; color:#cfd8dc; border-top:1px solid var(--stroke); display:flex; flex-direction:column; gap:10px; align-items:center }
  .socials{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
  .socials button{ width:36px; height:36px; display:inline-grid; place-items:center; border-radius:10px; border:1px solid var(--stroke); background:#0f1320; cursor:pointer }
  .socials svg{width:18px;height:18px; fill:#cfd8dc}

  .ring-wrap{height:220px; display:grid; place-items:center}
  .ring{width:110px; height:110px; border-radius:50%; border:6px solid rgba(255,255,255,.08); border-top-color:var(--brand); animation:spin 1.0s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* للطباعة */
  #printDoc{ display:none; }
  #printDoc .paper{ background:#0b0d12; color:#f7f7f7; border:1px solid #2a3550; border-radius:16px; padding:18px; }
  #printDoc h1{ color:#ffd54a; margin:0 0 6px; text-align:center; font-size:26px; }
  #printDoc h2{ color:#ffd54a; font-size:20px; text-align:center; margin:6px 0 10px; }
  #printDoc .meta{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin:10px 0 12px; }
  #printDoc .meta div{ background:#0f1320; border:1px solid #2a3550; border-radius:10px; padding:10px; font-size:14px; }
  #printDoc .reading{ font-size:18px; line-height:1.9; text-align:justify; }
  #printDoc .brandline{ text-align:center; color:#bdbdbd; font-size:12px; margin-top:12px }
  @media print {
    @page{ size:A4; margin:14mm; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    header, main > *, footer, .overlay { display:none !important; }
    #printDoc{ display:block !important; }
  }
</style>
</head>
<body>

<header>
  <h1 class="title">الأبراج والاستبصار</h1>
  <p class="subtitle">قراءات فلكية تنبؤية حاسمة بصياغة عرّاف</p>
  <div class="seer-wrap" aria-hidden="true">
    <svg class="seer" viewBox="0 0 800 260" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="g1" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#7fd3ff" stop-opacity="0.95"/><stop offset="60%" stop-color="#5ea8ff" stop-opacity="0.35"/><stop offset="100%" stop-color="#1f2a48" stop-opacity="0.0"/></radialGradient></defs><circle cx="400" cy="130" r="70" fill="url(#g1)"/></svg>
  </div>
</header>

<main class="container">

  <div id="globalNotice" class="notice hidden" role="alert"></div>

  <!-- الخطوة 1 -->
  <section id="step1" class="card center">
    <h2>أدخل بياناتك لبدء القراءة</h2>
    <div class="grid" style="max-width:760px; margin:10px auto 0;">
      <div>
        <label for="gender">الجنس</label>
        <select id="gender" required><option value="">اختر</option><option>ذكر</option><option>أنثى</option></select>
        <div class="notice hidden" id="e_gender">الرجاء اختيار الجنس.</div>
      </div>
      <div>
        <label for="status">الحالة الاجتماعية</label>
        <select id="status" required>
          <option value="">اختر</option>
          <option>أعزب/عزباء</option><option>متزوج/متزوجة</option>
          <option>منفصل/منفصلة</option><option>مخطوب/مخطوبة</option>
        </select>
        <div class="notice hidden" id="e_status">الرجاء اختيار الحالة الاجتماعية.</div>
      </div>
      <div>
        <label for="work">الوضع المهني</label>
        <select id="work" required>
          <option value="">اختر</option>
          <option>أعمل</option><option>عاطل</option><option>طالب</option>
        </select>
        <div class="notice hidden" id="e_work">الرجاء اختيار الوضع المهني.</div>
      </div>
      <div>
        <label for="birthdate">تاريخ الميلاد</label>
        <input id="birthdate" type="date" required>
        <div class="notice hidden" id="e_birthdate">الرجاء إدخال تاريخ الميلاد.</div>
      </div>
    </div>
    <div style="margin-top:16px;">
      <button class="btn" id="startBtn" style="min-width:220px">ابدأ القراءة</button>
    </div>
    <div class="quota" id="quotaInfo"></div>
  </section>

  <!-- انتظار -->
  <section id="stepLoading" class="card hidden center" aria-live="polite">
    <div class="ring-wrap"><div class="ring" aria-hidden="true"></div></div>
    <h2>جاري الاستبصار…</h2>
    <p class="muted">ثوانٍ قليلة وتظهر النبوءة.</p>
  </section>

  <!-- اختيار الموضوع -->
  <section id="stepTopics" class="card hidden center">
    <h2>اختر موضوع قراءتك</h2>
    <div id="zodiacBadge" style="margin:8px 0 14px"></div>
    <div class="topic-grid" style="max-width:820px; margin:10px auto 0;">
      <button class="topic" data-topic="love">الحب ❤️<span>العلاقة، التلاقي، المصالحة</span></button>
      <button class="topic" data-topic="health">الصحة 💊<span>النوم، الطاقة، الإيقاع</span></button>
      <button class="topic" data-topic="career">المهنة والمال 💼<span>الفرص، القرارات، النمو</span></button>
      <button class="topic" data-topic="general">عام / دراسي ✨<span>بوصلتك لهذا الأسبوع</span></button>
    </div>
    <div class="quota" id="quotaInfoTopics"></div>
  </section>

  <!-- النتيجة -->
  <section id="stepResult" class="card hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
      <h2 id="resultTitle" style="margin:0">الإشارات الظاهرة</h2>
      <div class="chip" id="userEcho"><span class="z-emoji" id="zEmoji">☆</span><span id="zName">—</span></div>
    </div>
    <article id="resultText" class="result" style="margin-top:10px"></article>
    <p id="omen" class="muted" style="margin-top:12px; font-size:15px"></p>

    <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; justify-content:center">
      <button class="ghost" id="topicsBtn">اختيار موضوع آخر</button>
      <button class="ghost" id="restartBtn">إعادة البدء</button>
      <button class="btn" id="printBtn" title="تحميل PDF">تحميل PDF</button>
    </div>
    <div class="quota" id="quotaInfoResult" style="margin-top:10px"></div>
  </section>

</main>

<footer>
  <div>© <span id="year"></span> الأبراج والاستبصار</div>
</footer>

<!-- نافذة الحد اليومي -->
<div class="overlay" id="overlayLimit" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:20">
  <div class="modal" style="background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:18px; max-width:520px; margin:16px; text-align:center">
    <h3 style="color:var(--brand); margin-top:0">وصلت إلى الحد اليومي</h3>
    <p>المتاح: <strong>15 قراءة</strong> كل 24 ساعة.</p>
    <p class="quota"><span id="countdown">00:00:00</span> حتى التجديد</p>
    <div class="actions" style="display:flex; gap:10px; justify-content:center; margin-top:10px">
      <button class="ghost" id="closeLimit">حسنًا</button>
    </div>
  </div>
</div>

<!-- قالب PDF -->
<div id="printDoc" aria-hidden="true">
  <div class="paper">
    <h1>الأبراج والاستبصار</h1>
    <h2>قراءة الطالع العميقة</h2>
    <div class="meta" id="printMeta"></div>
    <div class="reading" id="printReading"></div>
    <div class="brandline">— مستخرج آلي من صفحة الاستبصار —</div>
  </div>
</div>

<script>
  /* سنة الفوتر */
  document.getElementById("year").textContent = new Date().getFullYear();

  const $ = s=>document.querySelector(s);

  /* نطاقات الأبراج */
  const ZODIAC = [
    {name:"الحمل",   emoji:"♈︎", from:[3,21],  to:[4,19]},
    {name:"الثور",   emoji:"♉︎", from:[4,20],  to:[5,20]},
    {name:"الجوزاء", emoji:"♊︎", from:[5,21],  to:[6,20]},
    {name:"السرطان", emoji:"♋︎", from:[6,21],  to:[7,22]},
    {name:"الأسد",   emoji:"♌︎", from:[7,23],  to:[8,22]},
    {name:"العذراء", emoji:"♍︎", from:[8,23],  to:[9,22]},
    {name:"الميزان", emoji:"♎︎", from:[9,23],  to:[10,22]},
    {name:"العقرب",  emoji:"♏︎", from:[10,23], to:[11,21]},
    {name:"القوس",   emoji:"♐︎", from:[11,22], to:[12,21]},
    {name:"الجدي",   emoji:"♑︎", from:[12,22], to:[1,19]},
    {name:"الدلو",   emoji:"♒︎", from:[1,20],  to:[2,18]},
    {name:"الحوت",   emoji:"♓︎", from:[2,19],  to:[3,20]}
  ];
  function getZodiac(dt){
    if(!dt) return {name:"—", emoji:"☆"};
    const d=new Date(dt); if(isNaN(d)) return {name:"—", emoji:"☆"};
    const m=d.getMonth()+1, day=d.getDate();
    for(const z of ZODIAC){
      const [fm,fd]=z.from,[tm,td]=z.to;
      const inSame=(m===fm && day>=fd)||(m===tm && day<=td);
      const inWrap=(fm>tm)&&((m===fm && day>=fd)||(m===tm && day<=td)||(m>fm || m<tm));
      if((fm<tm && inSame)||(fm>tm && inWrap)) return z;
    } return {name:"—", emoji:"☆"};
  }

  /* خامات نبوئية أنيقة (لا رموز تقنية) */
  const LUCKY_COLORS = ["الأزرق النيلي","الأخضر الزمردي","العنّابي","الذهبي","الرمادي الدافئ","التركواز"];
  const LUCKY_SLOTS  = ["بين التاسعة والحادية عشرة صباحًا","عند الغروب","بعد الظهر مباشرة","ليلًا قبل منتصف الليل","في أول ساعة من اليوم"];
  function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

  const DESCRIPTORS = [
    "صريح يخلط الود بالمصلحة","هادئ ثم حادّ عند القرار","يؤجّل كثيرًا ويطلب أعذارًا طويلة",
    "كثير الكلام قليل الفعل","منطقي لكنه بارد","عملي يدعمك بالفعل لا بالوعد"
  ];

  const TEMPLATES = {
    love: [
      "القلب يُستدعى اليوم إلى اختبار نضج. الفعل المكرر يثبت ما يعجز عنه الكلام. خلال اثنتين وسبعين ساعة يظهر ثبات شخصٍ واحد بوضوح.",
      "باب مصالحة قابل للفتح بجملة قصيرة محددة. لا تُطِل الشرح، قل ما يلزم واترك الباب يعمل عمله.",
      "شبح غيرة يقترب عبر طرفٍ ثالث. أحط حدودك بالهدوء لا بالانفعال، فالحدود الواضحة أمان لا قسوة.",
      "لقاء عابر يوقظ فكرة قديمة، لكنه يحتاج دليلًا على الاستمرارية قبل أن تنطقه اسمًا."
    ],
    career: [
      "نافذة عمل قصيرة الوهج لكنها حاسمة. أنجز في نفس اليوم خطوة ملموسة، فالأثر الأول يسبق السمعة.",
      "سطر دقيق في ورقة كبيرة يختبئ من العين. مراجعته الآن تمنع تأخيرًا مزعجًا لاحقًا.",
      "فرصة جانبية تكبر بلا ضجيج. ابدأ صغيرًا، ثبّت الجودة، ثم وسّع حين يميل الميزان إليك.",
      "شريك محتمل يبدو لامعًا لكنه يغطي التفاصيل. أخرج البنود إلى الضوء قبل أي توقيع."
    ],
    health: [
      "النوم يُعاد ضبطه حين يخف الضوء ساعة كاملة قبل الموعد. صفاء الذهن يرتفع تدريجيًا خلال يومين.",
      "توتّر الظهر والكتفين إنذار مبكر. دقيقة تمدّد بين المهمات تمنع وجعًا متراكمًا.",
      "الماء يمهّد الطريق، والمشي الهادئ يلمّ شتات التركيز لبقية الأسبوع.",
      "ابتعد اليوم عن الضجيج الاجتماعي، فثقل الكلام يستهلك طاقتك أكثر مما تتوقع."
    ],
    general: [
      "خبر سار يقترب بخطوات قصيرة كأنه يعوّض طول الانتظار. لا تتراجع عند الباب الأخير.",
      "رسالة مقتضبة تغيّر اتجاه الأسبوع. حين يأتي الإلهام، اكتب وارسِل في نفس اللحظة.",
      "مبلغ متوسط يظهر بلا ميعاد فيسدّ ثغرة قديمة. لا تُسرف بعده بيومين.",
      "شخص يختبر حدودك بهدوء. الصرامة اللطيفة هي درعك اليوم."
    ]
  };

  function bank(topic){
    const base=TEMPLATES[topic]||TEMPLATES.general, list=[];
    let id=1;
    for(const t of base){
      const d = t.replace("{desc}", pick(DESCRIPTORS));
      list.push({id:`${topic}-${id++}`, text:d});
      list.push({id:`${topic}-${id++}`, text:d}); // زيادة تنويع مع خلط لاحق
    }
    while(list.length<24){ list.push({id:`${topic}-${id++}`,text:pick(base)}); }
    return list.sort(()=>Math.random()-0.5).slice(0,24);
  }

  const BANK = {
    love: bank("love"),
    career: bank("career"),
    health: bank("health"),
    general: bank("general")
  };

  /* حفظ/تحميل */
  function saveForm(){ localStorage.setItem("istibsar_form", JSON.stringify({
    gender: $("#gender").value||"", status: $("#status").value||"", work: $("#work").value||"", birthdate: $("#birthdate").value||""
  })); }
  function loadForm(){ try{ const d=JSON.parse(localStorage.getItem("istibsar_form")||"{}");
    if(d.gender) $("#gender").value=d.gender; if(d.status) $("#status").value=d.status;
    if(d.work) $("#work").value=d.work; if(d.birthdate) $("#birthdate").value=d.birthdate;
  }catch(e){} }

  ["gender","status","work","birthdate"].forEach(id=>{
    const el=$("#"+id);
    el.addEventListener("input", saveForm);
    el.addEventListener("change", ()=>{ saveForm(); if(id==="birthdate") updateZodiacUI(); });
  });

  let currentSign={name:"—", emoji:"☆"};
  function updateZodiacUI(){
    const bd=$("#birthdate").value; currentSign=getZodiac(bd);
    $("#zodiacBadge").innerHTML=`<div class="chip"><span class="z-emoji">${currentSign.emoji}</span><span>برجك: ${currentSign.name}</span></div>`;
    $("#zEmoji").textContent=currentSign.emoji; $("#zName").textContent=currentSign.name;
  }

  /* كوتا */
  const MAX_READS=15;
  function getQuota(){ const raw=localStorage.getItem("istibsar_quota"), now=Date.now(); if(!raw) return {count:0, resetAt:null};
    try{ const q=JSON.parse(raw); if(q.resetAt && now>q.resetAt) return {count:0, resetAt:null}; return q; }catch(e){ return {count:0, resetAt:null}; } }
  function setQuota(q){ localStorage.setItem("istibsar_quota", JSON.stringify(q)); }
  function incQuota(){ const q=getQuota(); const now=Date.now(); const resetAt=q.resetAt||(now+24*60*60*1000); const next={count:(q.count||0)+1, resetAt}; setQuota(next); return next; }
  function remainingQuota(){ const q=getQuota(); return Math.max(0, MAX_READS-(q.count||0)); }
  function fmtRemaining(ms){ if(ms<=0) return "00:00:00"; const s=Math.floor(ms/1000), h=String(Math.floor(s/3600)).padStart(2,"0"), m=String(Math.floor((s%3600)/60)).padStart(2,"0"), sc=String(s%60).padStart(2,"0"); return `${h}:${m}:${sc}`; }
  function updateQuotaUI(){ const rem=remainingQuota(); const q=getQuota(); const base=`المتبقي اليوم: ${rem} / ${MAX_READS}`+(q.resetAt?` — تجديد خلال ${fmtRemaining(q.resetAt - Date.now())}`:""); ["quotaInfo","quotaInfoTopics","quotaInfoResult"].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=base; }); }
  function showLimitOverlay(){ const q=getQuota(); if(!q.resetAt) return; document.getElementById("overlayLimit").style.display="flex"; (function tick(){ const left=q.resetAt-Date.now(); document.getElementById("countdown").textContent=fmtRemaining(left); if(left<=0){ document.getElementById("overlayLimit").style.display="none"; setQuota({count:0, resetAt:null}); updateQuotaUI(); } else { requestAnimationFrame(tick); } })(); }

  /* إشعار */
  function showGlobal(msg, ok=false){
    const n=$("#globalNotice"); n.textContent=msg; n.classList.toggle("ok", ok); n.classList.remove("hidden");
    setTimeout(()=>{ n.classList.add("hidden"); n.classList.remove("ok"); }, 3200);
  }

  /* تحقق الإدخال */
  function validateForm(){
    let ok=true; const g=$("#gender").value.trim(), s=$("#status").value.trim(), w=$("#work").value.trim(), b=$("#birthdate").value.trim();
    ["e_gender","e_status","e_work","e_birthdate"].forEach(id=>$("#"+id).classList.add("hidden"));
    if(!g){ $("#e_gender").classList.remove("hidden"); ok=false; }
    if(!s){ $("#e_status").classList.remove("hidden"); ok=false; }
    if(!w){ $("#e_work").classList.remove("hidden"); ok=false; }
    if(!b){ $("#e_birthdate").classList.remove("hidden"); ok=false; }
    if(!ok){ showGlobal("أكمل البيانات للمتابعة."); }
    return ok;
  }

  /* منع التكرار */
  function userKey(){
    const form = JSON.stringify({g:$("#gender").value||"", s:$("#status").value||"", w:$("#work").value||"", b:$("#birthdate").value||""});
    let h=2166136261>>>0; for(let i=0;i<form.length;i++){ h^=form.charCodeAt(i); h=Math.imul(h,16777619); }
    return h.toString(16);
  }
  function getUsed(topic){
    const key = `istibsar_used_${userKey()}_${topic}`;
    try{ return new Set(JSON.parse(localStorage.getItem(key) || "[]")); }catch(_){ return new Set(); }
  }
  function addUsed(topic, id){
    const key = `istibsar_used_${userKey()}_${topic}`;
    const s = getUsed(topic); s.add(id);
    localStorage.setItem(key, JSON.stringify([...s]));
  }
  function pickVariant(topic){
    const list = BANK[topic] || BANK.general;
    const used = getUsed(topic);
    const pool = list.filter(v=> !used.has(v.id));
    if(pool.length===0){ localStorage.removeItem(`istibsar_used_${userKey()}_${topic}`); return list[Math.floor(Math.random()*list.length)]; }
    return pool[Math.floor(Math.random()*pool.length)];
  }

  /* تفريعات حسب الحالة (بأسلوب عرّاف) */
  function loveBranch(status){
    const map = {
      "متزوج/متزوجة": [
        "قرار واضح يُنهي التذبذب القصير. حدّد شرطًا واحدًا والتزم به، وستظهر الاستجابة قبل مساء اليوم الثالث.",
        "شخص ثالث يقترب بلباقة. أغلق ثغور الخصوصية، وإلا خرج الحديث من اليد.",
        "جلسة مصارحة بلا مقاطعات تُنظّف ٨٠٪ من سوء الفهم الحالي."
      ],
      "مخطوب/مخطوبة": [
        "اتفاق عملي على المال والوقت يحسم التردد ويُسرّع الخطوة الرسمية.",
        "غيرة خفيفة من طرف قريب، لا تُسرف في التفاصيل الآن.",
        "موعد واحد محسوب يكشف جدّية الطرف الآخر فورًا."
      ],
      "أعزب/عزباء": [
        "نافذة تعارف قريبة عبر سياق مهني أو دراسي. لا تعِد سريعًا، راقب الثبات أسبوعًا.",
        "انجذاب سريع لشخص صريح يخلط الود بالمصلحة. اختبره بسؤالين محدّدين ثم قرّر.",
        "رسالة قصيرة ستفتح باب حديث جديد؛ ردّك السريع يصنع النتيجة."
      ],
      "منفصل/منفصلة": [
        "هذه الأيام تصلح لإغلاق نظيف. لا تعد لأسئلة بلا جواب.",
        "وجه هادئ يدخل بتوصية صديق. امنح التجربة مساحة قصيرة فقط.",
        "الحنين يجمّل القديم. الزم الوقائع واترك المزاج للوقت."
      ]
    };
    return map[status] || map["أعزب/عزباء"];
  }

  function careerBranch(work){
    const map = {
      "أعمل": [
        "مهمة قصيرة الموعد تُظهر اسمك في المكان الصحيح. أنجز مسودة اليوم، ولا تؤجّل.",
        "سطر صغير في عقد أو رسالة يحتاج قراءة ثانية. يهديك وقتًا ومالًا لاحقًا.",
        "أثر عمل قديم يعود بتوصية واضحة. المتابعة السريعة تكمل الدائرة."
      ],
      "عاطل": [
        "مساران اليوم: مهارة صغيرة تُصنع في ساعة، ورسالة موجّهة إلى جهة محددة.",
        "شبكة قريبة تقدّم بابًا واحدًا فعّالًا. تحدّث قبل أن تُرسل السيرة.",
        "الانتظار الصامت يمدّ الفترة. كبّر نتائج صغيرة يومية، وستزحف الحظوظ."
      ],
      "طالب": [
        "جلسة تركيز خمسون دقيقة تتبعها مراجعة عشر دقائق ترفع الدرجة في الامتحان القادم.",
        "مشروع قصير يسبق الامتحان يعوّض تذبذبًا سابقًا ويُظهر جديتك.",
        "زميل كثير الكلام قليل الفعل يحاول تشتيتك. الزم جدولك المكتوب."
      ]
    };
    return map[work] || map["أعمل"];
  }

  function composeReading(topic){
    const main = pickVariant(topic); addUsed(topic, main.id);
    const blocks = [];
    const lucky = `لون الحظ: ${pick(LUCKY_COLORS)}. نافذة موفقة: ${pick(LUCKY_SLOTS)}. رقم بارز اليوم: ${Math.floor(3+Math.random()*7)}.`;

    // افتتاحية حاسمة
    blocks.push(`<p class="lead">${main.text}</p>`);

    const status = ($("#status").value || "").trim();
    const work   = ($("#work").value   || "").trim();

    if(topic==="love"){
      const b = loveBranch(status);
      const a = pick(b); let c; do{ c=pick(b); }while(c===a);
      blocks.push(`<p>${a}</p>`, `<p>${c}</p>`);
      blocks.push(`<p><strong>تحذير مباشر:</strong> لا تمنح سرًّا شخصيًّا لمن لا يقدّم فعلًا واضحًا. اختبر ولا تتعلق.</p>`);
    }
    if(topic==="career"){
      const b = careerBranch(work);
      const a = pick(b); let c; do{ c=pick(b); }while(c===a);
      blocks.push(`<p>${a}</p>`, `<p>${c}</p>`);
      blocks.push(`<p><strong>تحذير مهني:</strong> رقمٌ صغير في مستند كبير يقرّر نتيجة أسبوع كامل. راجعه قبل الخميس.</p>`);
    }
    if(topic==="health"){
      const pack = TEMPLATES.health;
      const a = pick(pack); let c; do{ c=pick(pack); }while(c===a);
      blocks.push(`<p>${a}</p>`, `<p>${c}</p>`);
      blocks.push(`<p><strong>تنبيه:</strong> قلّل الحديث الثقيل بعد المغيب، يهبط النوم ويصعد الصداع.</p>`);
    }
    if(topic==="general"){
      const pack = TEMPLATES.general;
      const a = pick(pack); let c; do{ c=pick(pack); }while(c===a);
      blocks.push(`<p>${a}</p>`, `<p>${c}</p>`);
      blocks.push(`<p><strong>بوصلة الأسبوع:</strong> اكتب القرار في سطرين وخذ خطوة واحدة الآن.</p>`);
    }

    // سطر حظ أنيق
    blocks.push(`<p class="muted">${lucky}</p>`);
    return blocks.join("");
  }

  /* واجهة */
  function echoUser(){
    const g=$("#gender").value||"—", s=$("#status").value||"—", w=$("#work").value||"—", b=$("#birthdate").value||"—";
    $("#userEcho").innerHTML=`<span class="z-emoji">${currentSign.emoji}</span> ${currentSign.name} • ${g} • ${s} • ${w} • ${b}`;
  }
  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  function startFlow(){
    if(!validateForm()) return;
    hide($("#step1")); show($("#stepLoading"));
    setTimeout(()=>{ hide($("#stepLoading")); show($("#stepTopics")); updateZodiacUI(); updateQuotaUI(); }, 700);
  }

  function runTopic(topic){
    if(remainingQuota()<=0){ updateQuotaUI(); showLimitOverlay(); return; }
    hide($("#stepTopics")); show($("#stepLoading"));
    setTimeout(()=>{
      hide($("#stepLoading")); show($("#stepResult"));
      incQuota(); updateQuotaUI(); echoUser();
      const titleMap = {love:"قراءة الحب", health:"قراءة الصحة", career:"قراءة المهنة والمال", general:"قراءة عامة/دراسية"};
      document.getElementById("resultTitle").textContent = titleMap[topic] || "الإشارات الظاهرة";
      document.getElementById("resultText").innerHTML = composeReading(topic);
      document.getElementById("omen").textContent =
        ["توقيت الرد نصف اليقين. لا تؤجل اليوم.","خطوة صغيرة الآن تسرّع خبرًا منتظرًا.","وضوحك يحسم الطريق، والغموض يطيله."][Math.floor(Math.random()*3)];
    }, 650);
  }

  document.getElementById("startBtn").addEventListener("click", startFlow);
  document.querySelectorAll(".topic").forEach(btn=> btn.addEventListener("click", ()=> runTopic(btn.dataset.topic)));
  document.getElementById("topicsBtn").addEventListener("click", ()=>{ hide($("#stepResult")); show($("#stepTopics")); updateQuotaUI(); });
  document.getElementById("restartBtn").addEventListener("click", ()=>{ hide($("#stepResult")); hide($("#stepTopics")); show($("#step1")); window.scrollTo({top:0, behavior:"smooth"}); updateQuotaUI(); });

  /* PDF */
  function buildPrintDoc(){
    const meta=document.getElementById("printMeta"), reading=document.getElementById("printReading");
    const g=$("#gender").value||"—", s=$("#status").value||"—", w=$("#work").value||"—", b=$("#birthdate").value||"—";
    const now=new Date(); const when=now.toLocaleString('ar', {hour12:false});
    meta.innerHTML = `
      <div>البرج: ${currentSign.emoji} ${currentSign.name}</div>
      <div>الجنس: ${g}</div>
      <div>الحالة الاجتماعية: ${s}</div>
      <div>الوضع المهني: ${w}</div>
      <div>تاريخ الميلاد: ${b}</div>
      <div>تاريخ الإصدار: ${when}</div>
    `;
    reading.innerHTML = document.getElementById("resultText").innerHTML;
  }
  document.getElementById("printBtn").addEventListener("click", ()=>{
    if(document.getElementById("stepResult").classList.contains("hidden")){ showGlobal("أكمل القراءة أولًا ثم حمّل PDF."); return; }
    buildPrintDoc(); window.print();
  });

  /* تهيئة */
  (function init(){
    updateZodiacUI(); loadForm(); updateZodiacUI(); updateQuotaUI();
  })();
</script>
</body>
</html>
