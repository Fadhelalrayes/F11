<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقويم الصلاة الشهري</title>
  <style>
    :root{
      --bg:#f7f7f7;--card:#fff;--ink:#111;--muted:#666;--brand:#1e7e34;--accent:#0a58ca;
      --grid:#e7e7e7;--warn:#b02a37;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Kufi Arabic",Tahoma,Arial,sans-serif}
    header{padding:18px 16px;background:var(--card);position:sticky;top:0;z-index:5;border-bottom:1px solid var(--grid)}
    h1{margin:0 0 8px;font-size:22px}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
    .controls>div{display:flex;gap:6px;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select,input,button{
      padding:10px;border:1px solid var(--grid);border-radius:10px;background:#fff;font-size:14px
    }
    button{cursor:pointer}
    .nav{display:flex;gap:8px;align-items:center}
    .nav button{background:var(--card)}
    .nav strong{min-width:160px;text-align:center}
    main{max-width:1100px;margin:18px auto;padding:0 12px}
    .legend{margin:10px 0 16px;color:var(--muted);font-size:13px}
    .table-wrap{background:var(--card);border:1px solid var(--grid);border-radius:14px;overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:760px}
    thead th{position:sticky;top:60px;background:var(--card);z-index:4}
    th,td{padding:10px 12px;border-bottom:1px solid var(--grid);text-align:center;white-space:nowrap}
    thead th{font-size:13px;color:#333}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody td:first-child, thead th:first-child{position:sticky;right:0;background:inherit}
    .badge{display:inline-block;padding:.15rem .45rem;border-radius:6px;font-size:12px;background:#eef7ee;color:#1e7e34;border:1px solid #cfe7cf}
    .danger{background:#fdeceb;color:#b02a37;border-color:#f6cacc}
    .muted{color:var(--muted)}
    footer{max-width:1100px;margin:28px auto 40px;padding:0 12px;color:var(--muted);font-size:12px}
    .error{color:var(--warn);margin-top:8px}
    .events-note{font-size:12px;color:var(--muted)}
    .events-tag{font-size:12px}
    @media (max-width:780px){
      .controls{grid-template-columns:1fr 1fr}
      thead th{top:112px}
    }
  </style>
</head>
<body>
  <header>
    <h1>تقويم أوقات الصلاة الشهري</h1>
    <div class="controls">
      <div>
        <label for="country">الدولة</label>
        <input id="country" placeholder="مثال: Bahrain" value="Bahrain" />
      </div>
      <div>
        <label for="city">المدينة</label>
        <input id="city" placeholder="مثال: Manama" value="Manama" />
      </div>
      <div>
        <label for="method">طريقة الحساب</label>
        <select id="method" title="طريقة الحساب">
          <option value="5" selected>أم القرى (السعودية)</option>
          <option value="3">الجمعية الإسلامية لشمال أمريكا</option>
          <option value="2">رابطة العالم الإسلامي</option>
          <option value="12">هيئة الشؤون الإسلامية (الإمارات)</option>
          <option value="4">أوقاف مصر</option>
          <option value="1">جامعة العلوم الإسلامية (كراتشي)</option>
          <option value="7">هيئة المساحة (المغرب)</option>
          <option value="9">تركيا</option>
        </select>
      </div>
      <div class="nav">
        <button id="prev">‹ الشهر السابق</button>
        <strong id="title"></strong>
        <button id="next">الشهر التالي ›</button>
      </div>
    </div>
    <div id="status" class="error" hidden></div>
  </header>

  <main>
    <p class="legend">
      يتم جلب البيانات عبر <span class="badge">AlAdhan API</span>.
      أوقات الشروق تُعرض للمعلومية، ولا تُعد صلاة.
    </p>

    <div class="table-wrap">
      <table id="cal">
        <thead>
          <tr>
            <th>اليوم</th>
            <th>هجري</th>
            <th>ميلادي</th>
            <th>الفجر</th>
            <th>الشروق</th>
            <th>الظهر</th>
            <th>العصر</th>
            <th>المغرب</th>
            <th>العشاء</th>
            <th>المناسبات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="events-note">
      لإضافة “المناسبات” آليًا، ضع ملف JSON مستضافًا لديك (أو Google Sheets كـJSON) بالشكل:
      <code>[{ "hijri":"1447-04-08", "title":"مولد الإمام الحسن العسكري" }]</code>
      ثم حدّث المتغيّر <code>EVENTS_URL</code> أدناه.
    </p>
  </main>

  <footer>
    <div>ملاحظة: يتم التخزين المؤقت محليًا لمدّة 24 ساعة لكل شهر لتقليل النداءات.</div>
  </footer>

  <script>
    // ====== إعدادات قابلة للتخصيص ======
    const EVENTS_URL = ""; // مثال: "https://example.com/events.json"
    const CACHE_TTL_MS = 24*60*60*1000; // 24h

    // ====== مساعدات عامة ======
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const weekdaysAr = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];

    function fmt12(hm){ // "HH:MM" -> "HH:MM"
      // API يرجع بصيغة 24h أصلًا؛ نكتفي بالتنظيف
      return hm.replace(/^0/,''); // إزالة الصفر اليسار للتجميل
    }
    function pad(n){return n<10?("0"+n):(""+n)}

    function yearMonthLabel(d){
      const g = d.toLocaleDateString('ar', { year:'numeric', month:'long' });
      return g;
    }

    function cacheKey({y,m,city,country,method}){
      return `cal:${y}-${m}:${country}:${city}:m${method}`;
    }

    function getCached(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(Date.now() - obj.ts > CACHE_TTL_MS) return null;
        return obj.data;
      }catch{ return null }
    }
    function setCached(key,data){
      try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), data})) }catch{}
    }

    // ====== جلب المناسبات (اختياري) ======
    async function fetchEvents(){
      if(!EVENTS_URL) return [];
      try{
        const res = await fetch(EVENTS_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('حدث خطأ في جلب المناسبات');
        const arr = await res.json();
        // فهرسة حسب التاريخ الهجري "YYYY-MM-DD"
        const map = {};
        for(const e of arr){
          if(e.hijri){
            (map[e.hijri] ||= []).push(e.title || e.name || "");
          }
        }
        return map;
      }catch(e){
        console.warn(e);
        return [];
      }
    }

    // ====== جلب تقويم الشهر من AlAdhan ======
    async function fetchMonth({y,m,city,country,method}){
      const key = cacheKey({y,m,city,country,method});
      const cached = getCached(key);
      if(cached) return cached;

      const url = `https://api.aladhan.com/v1/calendarByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=${method}&month=${m}&year=${y}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('تعذّر الاتصال بواجهة أوقات الصلاة');
      const json = await res.json();
      if(json.code!==200 || !json.data) throw new Error('استجابة غير متوقعة من الواجهة');
      setCached(key, json.data);
      return json.data;
    }

    // ====== بناء الجدول ======
    async function buildTable(targetDate){
      const status = $('#status');
      status.hidden = true;

      const country = $('#country').value.trim();
      const city = $('#city').value.trim();
      const method = +$('#method').value;

      const y = targetDate.getFullYear();
      const m = targetDate.getMonth()+1;

      $('#title').textContent = `${yearMonthLabel(targetDate)} — ${city}, ${country}`;

      try{
        const [rows, eventsMap] = await Promise.all([
          fetchMonth({y,m,city,country,method}),
          fetchEvents()
        ]);

        const tbody = $('#cal tbody');
        tbody.innerHTML = '';

        rows.forEach((row) => {
          const t = row.timings;
          const d = row.date;
          // تنظيف " (+03:00)" من الأوقات
          const clean = k => (t[k]||'').split(' ')[0];
          const g = d.gregorian;
          const h = d.hijri;

          const tr = document.createElement('tr');

          const day = new Date(g.date.replace(/-/g,'/')); // لضمان التوافق
          const weekday = weekdaysAr[day.getDay()];

          const hijriStr = `${h.day.padStart(2,'0')} ${h.month.ar} ${h.year}`;
          const gregStr = `${g.day.padStart(2,'0')} ${g.month.en} ${g.year}`;

          tr.innerHTML = `
            <td><span>${weekday}</span></td>
            <td>${hijriStr}</td>
            <td class="muted">${gregStr}</td>
            <td>${fmt12(clean('Fajr'))}</td>
            <td>${fmt12(clean('Sunrise'))}</td>
            <td>${fmt12(clean('Dhuhr'))}</td>
            <td>${fmt12(clean('Asr'))}</td>
            <td>${fmt12(clean('Maghrib'))}</td>
            <td>${fmt12(clean('Isha'))}</td>
            <td class="events-tag"></td>
          `;

          // المناسبات (إن وجدت)
          const hijriISO = `${h.year}-${pad(+h.month.number)}-${pad(+h.day)}`;
          const cell = tr.querySelector('.events-tag');
          if(eventsMap && eventsMap[hijriISO]){
            eventsMap[hijriISO].forEach((title, i) => {
              const b = document.createElement('span');
              b.className = 'badge danger';
              b.textContent = title;
              if(i>0) cell.append(' ');
              cell.appendChild(b);
            });
          }

          tbody.appendChild(tr);
        });

      }catch(err){
        status.textContent = 'عذرًا، حدث خطأ: ' + err.message;
        status.hidden = false;
      }
    }

    // ====== ربط الواجهة ======
    (function init(){
      const today = new Date();
      let current = new Date(today.getFullYear(), today.getMonth(), 1);

      const render = () => buildTable(current);

      $('#prev').addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); render(); });
      $('#next').addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); render(); });
      $('#country').addEventListener('change', render);
      $('#city').addEventListener('change', render);
      $('#method').addEventListener('change', render);

      // محاولة قراءة إعدادات محفوظة
      try{
        const saved = JSON.parse(localStorage.getItem('cal:prefs')||'{}');
        if(saved.city) $('#city').value = saved.city;
        if(saved.country) $('#country').value = saved.country;
        if(saved.method) $('#method').value = saved.method;
      }catch{}

      // حفظ التفضيلات
      const savePrefs = () => {
        try{
          localStorage.setItem('cal:prefs', JSON.stringify({
            city: $('#city').value.trim(),
            country: $('#country').value.trim(),
            method: +$('#method').value
          }));
        }catch{}
      };
      $$('#country,#city,#method').forEach(el=>el.addEventListener('change', savePrefs));

      render();
    })();
  </script>
</body>
</html>
