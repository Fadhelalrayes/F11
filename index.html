<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    /* Ù†Ø¸Ø§Ù… Ù…Ø³Ø§ÙØ§Øª 8px */
    --s1:8px; --s2:16px; --s3:24px; --s4:32px;

    /* Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ù‡Ø§Ø¯Ø¦Ø© Ø±Ø§Ù‚ÙŠØ© */
    --ink:#0f172a; --muted:#657085;
    --bg:#f6f8fb; --surface:#ffffff; --border:#e7eaf0; --line:#dde3eb;
    --brand:#0ea5a6; --brand2:#2563eb; --accent:#0ea5a61a;

    --shadow:0 10px 28px rgba(2,6,23,.08);
    --radius:16px; --rsm:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Tajawal", system-ui, -apple-system, "Noto Kufi Arabic", Segoe UI, sans-serif;
    color:var(--ink);
    background:
      radial-gradient(700px 480px at 12% -10%, #ecfbff 0%, transparent 55%),
      radial-gradient(640px 420px at 95% 5%, #eef0ff 0%, transparent 50%),
      var(--bg);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    padding: var(--s2);
  }
  .container{
    width:min(1120px, 100%);
    margin:0 auto;
    display:flex; flex-direction:column; gap:var(--s2);
  }

  /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ù†Ø­ÙŠÙ + Ø³Ø§Ø¹Ø© ÙŠØ³Ø§Ø± */
  .topbar{
    position:relative;
    background:linear-gradient(180deg,#fff,#fbfdff);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:var(--s2) var(--s3);
    display:flex; align-items:center; justify-content:center;
  }
  .brandTitle{margin:0; font-weight:800; font-size:1.15rem; letter-spacing:.2px}
  .clock{
    position:absolute; left:var(--s2); top:var(--s2);
    background:#fff; border:1px solid var(--border); border-radius:12px;
    padding:.38rem .6rem; font-size:.98rem; font-weight:800;
    font-variant-numeric:tabular-nums; color:#084241; box-shadow:0 8px 18px rgba(0,0,0,.06);
  }

  /* ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Ø§Ù„Ù…ÙƒØ§Ù†/Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®) Ù…Ø­Ø§Ø°Ø§Ø© ÙƒØªØ§Ø¨ */
  .infoRow{
    display:grid; grid-template-columns: 1fr 1fr 1fr; gap:var(--s2);
  }
  @media (max-width:900px){ .infoRow{grid-template-columns:1fr} }

  .chipCard{
    background:var(--surface); border:1px solid var(--border); border-radius:var(--rsm);
    box-shadow:var(--shadow); padding:var(--s2);
    display:flex; align-items:center; gap:var(--s2); min-height:66px;
  }
  .chipIcon{
    width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
    background:linear-gradient(135deg,#effaff,#fff); border:1px solid #d9e9ff; color:#0b5aa5; font-size:1.05rem;
    flex:0 0 auto;
  }
  .chipStack{display:flex; flex-direction:column; gap:2px}
  .chipLabel{font-size:.86rem; color:var(--muted); font-weight:700}
  .chipValue{font-size:1.06rem; font-weight:800; color:#0b213f; font-variant-numeric:tabular-nums; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© â€” Ø²Ø± ÙˆØ§Ø­Ø¯ Ø£Ù†ÙŠÙ‚ ÙŠÙØªØ­ Ù„ÙˆØ­ Ø³ÙÙ„ÙŠ */
  .pickerBar{
    background:var(--surface); border:1px solid var(--border); border-radius:var(--rsm);
    box-shadow:var(--shadow); padding:var(--s2);
    display:flex; gap:var(--s2); align-items:center; justify-content:space-between;
  }
  .pickBtn{
    border:1px solid var(--border); background:#fff; border-radius:999px;
    padding:.55rem .9rem; font-weight:800; cursor:pointer;
  }
  .pickBtn span{opacity:.8}
  .pickHint{color:var(--muted); font-weight:700}

  /* Ø§Ù„Ù„ÙˆØ­ Ø§Ù„Ø³ÙÙ„ÙŠ (Bottom Sheet) Ù…Ù†Ø¸Ù… */
  .sheet{
    position:fixed; inset:0; display:none; place-items:end center; z-index:50;
    background:rgba(15,23,42,.25);
  }
  .sheet.open{display:grid}
  .sheetPanel{
    width:min(800px,100%); background:#fff; border-radius:16px 16px 0 0; border:1px solid var(--border);
    box-shadow:var(--shadow); padding:var(--s3);
  }
  .sheetHeader{display:flex; gap:var(--s2); align-items:center; margin-bottom:var(--s2)}
  .search{
    flex:1; border:1px solid var(--border); border-radius:999px; padding:.6rem .9rem; font-weight:700; outline:none;
  }
  .close{border:1px solid var(--border); background:#fff; border-radius:999px; padding:.55rem .9rem; font-weight:800; cursor:pointer}
  .gridCities{display:grid; grid-template-columns:repeat(3,1fr); gap:var(--s2)}
  @media (max-width:700px){ .gridCities{grid-template-columns:repeat(2,1fr)} }
  .cityItem{
    border:1px solid var(--border); border-radius:12px; padding:.7rem .8rem; cursor:pointer;
    display:flex; align-items:center; gap:var(--s2); font-weight:800; color:#0b2749; background:#fff;
  }
  .cityItem:hover{background:#f6fbff}
  .cityDot{width:22px; height:22px; border-radius:999px; display:grid; place-items:center; background:linear-gradient(135deg,#ecfeff,#fff); border:1px solid #cde8ff; color:#0b5aa5}

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª */
  .card{
    background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:var(--s2);
  }
  .card h3{margin:0 0 var(--s2); font-size:1rem; font-weight:800}
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{
    text-align:right; font-weight:800; color:#1f2937; font-size:.92rem; padding:var(--s2) var(--s2);
    background:#f6f8fc; border-bottom:1px solid var(--line);
  }
  tbody tr{transition:.12s background}
  tbody tr:hover{background:#fbfdff}
  tbody td{padding:var(--s2); border-bottom:1px dashed var(--line); font-size:1rem}
  tbody tr:last-child td{border-bottom:none}
  .row{display:flex; align-items:center; gap:var(--s1); font-weight:800}
  .ico{width:24px; height:24px; border-radius:9px; display:grid; place-items:center; background:linear-gradient(135deg,#ecfeff,#fff); border:1px solid #d9eef2; color:#0b5a64}
  .t{font-variant-numeric:tabular-nums; font-weight:800}
  tr.next td{background:linear-gradient(90deg,var(--accent),transparent 40%)}
  tr.next td:first-child{border-inline-start:3px solid var(--brand)}

  /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¯ÙŠØ« â€“ Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ø­ØªØ±Ø§ÙÙŠ */
  .quote{
    background:var(--surface); border:1px solid var(--border); border-radius:var(--rsm);
    box-shadow:var(--shadow); padding:var(--s3);
    position:relative; overflow:hidden;
  }
  .quote:before{
    content:"â€œ"; position:absolute; inset-inline-start:var(--s2); top:var(--s2); font-size:56px; line-height:1; color:#e7eef7;
    font-weight:800; pointer-events:none;
  }
  .qtext{margin:0; font-size:1.02rem; line-height:1.95}
  .qsrc{margin-top:var(--s1); color:var(--muted); font-size:.92rem; font-weight:700}

  footer{ text-align:center; color:var(--muted); font-weight:700; padding:var(--s1) 0 }
  .brand{ color:var(--brand) }
</style>
</head>
<body>
  <div class="container">
    <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
    <div class="topbar" aria-live="polite">
      <div id="clock" class="clock">--:-- --</div>
      <h1 class="brandTitle">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h1>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø±ØªØ¨Ø© ÙƒÙ€ â€œÙƒØªØ¨â€: Ø§Ù„Ù…ÙƒØ§Ù†/Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† -->
    <section class="infoRow">
      <div class="chipCard">
        <div class="chipIcon">ğŸ“</div>
        <div class="chipStack">
          <div class="chipLabel">Ø§Ù„Ù…ÙƒØ§Ù†</div>
          <div class="chipValue" id="place">Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</div>
        </div>
      </div>
      <div class="chipCard">
        <div class="chipIcon">ğŸ—“</div>
        <div class="chipStack">
          <div class="chipLabel">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</div>
          <div class="chipValue" id="hijri">--</div>
        </div>
      </div>
      <div class="chipCard">
        <div class="chipIcon">ğŸ“…</div>
        <div class="chipStack">
          <div class="chipLabel">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</div>
          <div class="chipValue" id="greg">--</div>
        </div>
      </div>
    </section>

    <!-- Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ­Ù‘Ø¯ Ù„Ù„Ø¯ÙˆÙ„Ø© ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
    <section class="pickerBar">
      <button class="pickBtn" id="openPicker" type="button">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</button>
      <div class="pickHint">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª -->
    <section class="card">
      <h3>Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
      <table>
        <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø³Ø§Ø¹Ø© (12h)</th></tr></thead>
        <tbody id="times"><tr><td colspan="2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØªâ€¦</td></tr></tbody>
      </table>
    </section>

    <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¯ÙŠØ« -->
    <section class="quote">
      <p class="qtext" id="hadithText"></p>
      <div class="qsrc" id="hadithSource"></div>
    </section>

    <footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± <span class="brand">ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³</span></footer>
  </div>

  <!-- Ø§Ù„Ù„ÙˆØ­ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
  <div class="sheet" id="sheet">
    <div class="sheetPanel">
      <div class="sheetHeader">
        <input id="search" class="search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©â€¦ (Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ù†Ø§Ù…Ø©)">
        <button class="close" id="closeSheet" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="gridCities" id="gridCities"></div>
    </div>
  </div>

<script>
  /* Ø§Ù„Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù…Ø¯Ù† + Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (AR/EN) */
  const MAP = {
    "Bahrain": { tz:"Asia/Bahrain",  cities:[{en:"Manama",ar:"Ø§Ù„Ù…Ù†Ø§Ù…Ø©"},{en:"Muharraq",ar:"Ø§Ù„Ù…Ø­Ø±Ù‚"},{en:"Isa Town",ar:"Ù…Ø¯ÙŠÙ†Ø© Ø¹ÙŠØ³Ù‰"},{en:"Hamad Town",ar:"Ù…Ø¯ÙŠÙ†Ø© Ø­Ù…Ø¯"},{en:"Sitra",ar:"Ø³ØªØ±Ø©"},{en:"Saar",ar:"Ø³Ø§Ø±"},{en:"Draz",ar:"Ø§Ù„Ø¯Ø±Ø§Ø²"},{en:"Jidhafs",ar:"Ø¬Ø¯Ø­ÙØµ"}], ar:"Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†" },
    "Lebanon": { tz:"Asia/Beirut",   cities:[{en:"Beirut",ar:"Ø¨ÙŠØ±ÙˆØª"},{en:"Tripoli",ar:"Ø·Ø±Ø§Ø¨Ù„Ø³"},{en:"Sidon",ar:"ØµÙŠØ¯Ø§"}], ar:"Ù„Ø¨Ù†Ø§Ù†" },
    "Iraq":    { tz:"Asia/Baghdad",  cities:[{en:"Baghdad",ar:"Ø¨ØºØ¯Ø§Ø¯"},{en:"Basrah",ar:"Ø§Ù„Ø¨ØµØ±Ø©"},{en:"Erbil",ar:"Ø£Ø±Ø¨ÙŠÙ„"}], ar:"Ø§Ù„Ø¹Ø±Ø§Ù‚" },
    "Iran":    { tz:"Asia/Tehran",   cities:[{en:"Tehran",ar:"Ø·Ù‡Ø±Ø§Ù†"},{en:"Mashhad",ar:"Ù…Ø´Ù‡Ø¯"},{en:"Isfahan",ar:"Ø£ØµÙÙ‡Ø§Ù†"}], ar:"Ø¥ÙŠØ±Ø§Ù†" },
    "Kuwait":  { tz:"Asia/Kuwait",   cities:[{en:"Kuwait City",ar:"Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙƒÙˆÙŠØª"},{en:"Hawalli",ar:"Ø­ÙˆÙ„ÙŠ"},{en:"Al Ahmadi",ar:"Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ"}], ar:"Ø§Ù„ÙƒÙˆÙŠØª" },
    "Saudi Arabia":{ tz:"Asia/Riyadh", cities:[{en:"Riyadh",ar:"Ø§Ù„Ø±ÙŠØ§Ø¶"},{en:"Jeddah",ar:"Ø¬Ø¯Ø©"},{en:"Dammam",ar:"Ø§Ù„Ø¯Ù…Ø§Ù…"},{en:"Mecca",ar:"Ù…ÙƒØ©"},{en:"Medina",ar:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"}], ar:"Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©" }
  };
  const DEFAULT = { country:"Bahrain", city:"Manama" };

  /* Ø£Ø­Ø§Ø¯ÙŠØ« */
  const HADITHS = [
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¨Ø§Ù‚Ø± (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØµÙ„ÙŠ Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø­Ù…Ù† Ø¨ÙˆØ¬Ù‡Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ ØºÙŠØ±Ù‡.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" },
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ø±Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø© Ø£Ù‚Ø¨Ù„ Ø¥Ø¨Ù„ÙŠØ³ ÙŠÙ†Ø¸Ø± Ø¥Ù„ÙŠÙ‡ Ø­Ø³Ø¯Ø§Ù‹ Ù„Ù…Ø§ ÙŠØ±Ù‰ Ù…Ù† Ø±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ Ø§Ù„ØªÙŠ ØªØºØ´Ø§Ù‡.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" },
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„ØµÙ„Ø§Ø© Ù„Ù‡Ø§ Ø£Ø±Ø¨Ø¹Ø© Ø¢Ù„Ø§Ù Ø¨Ø§Ø¨.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" },
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): ÙŠØ§ ÙƒÙ…ÙŠÙ„! Ù„ÙŠØ³ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªØµÙ„ÙŠ ÙˆØªØµÙˆÙ… ÙˆØªØªØµØ¯Ù‚ØŒ Ø¥Ù†Ù…Ø§ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ØµÙ„Ø§Ø© ÙØ¹Ù„Øª Ø¨Ù‚Ù„Ø¨ Ù†Ù‚ÙŠØŒ ÙˆØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù‡ Ù…Ø±Ø¶ÙŠØŒ ÙˆØ®Ø´ÙˆØ¹ Ø³ÙˆÙŠ.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" }
  ];
  function setRandomHadith(){
    const h = HADITHS[Math.floor(Math.random()*HADITHS.length)];
    hadithText.textContent = h.text;
    hadithSource.textContent = h.src;
  }

  /* 12h */
  function to12h(t){
    if(!t) return "--:-- --";
    const pure = t.replace(/\s*\(.*?\)\s*/g,"");
    const [H,M] = pure.split(":").map(Number);
    if(Number.isNaN(H)||Number.isNaN(M)) return t;
    let h = H % 12; if(h===0) h = 12;
    const ampm = H < 12 ? "AM" : "PM";
    return `${String(h).padStart(2,"0")}:${String(M).padStart(2,"0")} ${ampm}`;
  }

  /* Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® */
  function fmtClock(tz){
    return new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:true}).format(new Date());
  }
  function fmtGreg(tz){
    return new Intl.DateTimeFormat('ar',{timeZone:tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(new Date());
  }
  function fmtHijri(tz){
    try{
      return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{timeZone:tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(new Date());
    }catch{ return "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…)"; }
  }

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª */
  function tr(label, icon, val, next=false){
    return `<tr class="${next?'next':''}">
      <td><div class="row"><span class="ico">${icon}</span>${label}</div></td>
      <td class="t">${to12h(val||'')}</td>
    </tr>`;
  }
  function ensureImsak(t){
    if(!t.Imsak && t.Fajr){
      const pure = t.Fajr.replace(/\s*\(.*?\)\s*/g,"");
      const [H,M] = pure.split(":").map(Number);
      const d = new Date(); d.setHours(H, M-10, 0, 0);
      t.Imsak = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }
    return t;
  }
  function nextKey(timings, tz){
    const order=["Imsak","Fajr","Dhuhr","Asr","Maghrib","Isha","Midnight"];
    const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    const dstr=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(nowTZ);
    const [Y,M,D]=dstr.split('-').map(Number);
    const cand=order.map(k=>{
      const raw=(timings[k]||"").replace(/\s*\(.*?\)\s*/g,"");
      if(!raw.includes(':')) return {k,diff:Infinity};
      const [HH,MM]=raw.split(':').map(Number);
      return {k,diff:new Date(Y,M-1,D,HH,MM,0)-nowTZ};
    });
    let n=cand.filter(x=>x.diff>=0).sort((a,b)=>a.diff-b.diff)[0];
    if(!n) n=cand.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff))[0];
    return n?.k||null;
  }
  function renderTimes(timings, tz){
    const t=ensureImsak({...timings});
    const rows=[
      {label:"Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ",key:"Imsak",icon:"ğŸŒ™"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø±",key:"Fajr",icon:"ğŸ•Œ"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¸Ù‡Ø±",key:"Dhuhr",icon:"â˜€ï¸"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹ØµØ±",key:"Asr",icon:"ğŸŒ¤ï¸"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨",key:"Maghrib",icon:"ğŸŒ†"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø´Ø§Ø¡",key:"Isha",icon:"ğŸŒ™"},
      {label:"Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„",key:"Midnight",icon:"ğŸŒŒ"}
    ];
    const k=nextKey(t,tz);
    times.innerHTML = rows.map(r=>tr(r.label, r.icon, t[r.key], r.key===k)).join("");
  }

  /* API (method=0 Ø¬Ø¹ÙØ±ÙŠ) */
  async function fetchTimings(country, city){
    const url=`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=0`;
    const res=await fetch(url);
    if(!res.ok) throw new Error("ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª");
    const json=await res.json();
    return json.data.timings;
  }

  /* Ø§Ù„Ù„ÙˆØ­ Ø§Ù„Ø³ÙÙ„ÙŠ: Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¯Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆÙ„ Ù„Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ */
  function buildCityList(){
    const all=[];
    for(const code of Object.keys(MAP)){
      const countryAR=MAP[code].ar;
      MAP[code].cities.forEach(c=> all.push({country:code, countryAR, cityEN:c.en, cityAR:c.ar}));
    }
    gridCities.innerHTML = all.map(x=>`
      <div class="cityItem" data-country="${x.country}" data-city="${x.cityEN}" data-label="${x.cityAR}ØŒ ${x.countryAR}">
        <span class="cityDot">ğŸ™</span><span>${x.cityAR}ØŒ ${x.countryAR}</span>
      </div>
    `).join("");
    Array.from(gridCities.children).forEach(el=>{
      el.addEventListener('click',()=>{
        const country=el.getAttribute('data-country');
        const cityEN=el.getAttribute('data-city');
        const label=el.getAttribute('data-label');
        setPlace(country, cityEN, label);
        closeSheet();
      });
    });
  }
  function filterCities(q){
    q=(q||"").trim();
    Array.from(gridCities.children).forEach(el=>{
      const label=el.getAttribute('data-label');
      const cityEN=el.getAttribute('data-city');
      const show=!q || label.includes(q) || cityEN.toLowerCase().includes(q.toLowerCase());
      el.style.display = show ? "" : "none";
    });
  }

  /* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø³Ø§Ø¹Ø© */
  function updateTop(country, city){
    const tz=MAP[country]?.tz || MAP[DEFAULT.country].tz;
    place.textContent = `${cityLabelAR(country, city)}`;
    hijri.textContent = fmtHijri(tz);
    greg.textContent  = fmtGreg(tz);
    clearInterval(window._clk);
    clock.textContent = fmtClock(tz);
    window._clk=setInterval(()=> clock.textContent=fmtClock(tz), 1000);
    return tz;
  }
  function cityLabelAR(country, cityEN){
    const c = MAP[country];
    const cityObj = (c?.cities||[]).find(x=>x.en===cityEN);
    return `${cityObj ? cityObj.ar : cityEN}ØŒ ${c?.ar||country}`;
  }

  /* Ø­Ø§Ù„Ø© Ø­Ø§Ù„ÙŠØ© */
  let current = { country: DEFAULT.country, city: DEFAULT.city };

  async function setPlace(country, cityEN, labelAR){
    current.country = country;
    current.city    = cityEN;
    place.textContent = labelAR || cityLabelAR(country, cityEN);
    await load();
  }

  async function load(){
    const tz=updateTop(current.country, current.city);
    times.innerHTML = `<tr><td colspan="2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØªâ€¦</td></tr>`;
    try{
      const t=await fetchTimings(current.country, current.city);
      renderTimes(t, tz);
    }catch(e){
      console.error(e);
      times.innerHTML = `<tr><td colspan="2" style="color:#b91c1c">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.</td></tr>`;
    }
  }

  /* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­ */
  function openSheet(){ sheet.classList.add('open'); search.focus(); }
  function closeSheet(){ sheet.classList.remove('open'); search.value=""; filterCities(""); }

  /* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ */
  function init(){
    setRandomHadith();
    buildCityList();
    openPicker.addEventListener('click', openSheet);
    closeSheetBtn = document.getElementById('closeSheet');
    closeSheetBtn.addEventListener('click', closeSheet);
    search.addEventListener('input', e=> filterCities(e.target.value));
    document.addEventListener('click', e=> { if(!e.target.closest('.sheetPanel') && !e.target.closest('#openPicker')) sheet.classList.remove('open'); });
    setPlace(DEFAULT.country, DEFAULT.city); // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†
  }
  init();
</script>
</body>
</html>
