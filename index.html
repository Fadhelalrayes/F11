<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FadhelTalk - محادثة ذكية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2d3748; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }
        
        .container {
            width: 100%; 
            max-width: 500px; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); 
            overflow: hidden; 
            backdrop-filter: blur(10px); 
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn { 
            from {opacity: 0; transform: translateY(20px);} 
            to {opacity: 1; transform: translateY(0);} 
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
            color: white; 
            padding: 25px; 
            text-align: center; 
            position: relative; 
            overflow: hidden;
        }
        
        .header::before {
            content: ''; 
            position: absolute; 
            top: -50%; 
            left: -50%; 
            width: 200%; 
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%); 
            transform: rotate(30deg);
        }
        
        .logo { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .logo-icon {
            font-size: 32px; 
            background: white; 
            color: #7c3aed; 
            width: 60px; 
            height: 60px; 
            border-radius: 50%;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 
            0% {transform: scale(1);} 
            50% {transform: scale(1.05);} 
            100% {transform: scale(1);} 
        }
        
        h1 { 
            font-size: 28px; 
            font-weight: 700; 
            margin-bottom: 5px; 
            letter-spacing: -0.5px; 
        }
        
        .subtitle { 
            font-size: 14px; 
            opacity: 0.9; 
            font-weight: 400; 
        }
        
        .status {
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 13px; 
            margin-top: 15px;
            background: rgba(255,255,255,0.2); 
            padding: 5px 12px; 
            border-radius: 20px; 
            backdrop-filter: blur(5px);
        }
        
        .status-dot { 
            width: 8px; 
            height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
        }
        
        .chat-container {
            height: 400px; 
            overflow-y: auto; 
            padding: 25px; 
            background: #f8fafc; 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
            scrollbar-width: thin; 
            scrollbar-color: #cbd5e0 transparent;
        }
        
        .chat-container::-webkit-scrollbar { 
            width: 5px; 
        }
        
        .chat-container::-webkit-scrollbar-thumb { 
            background: #cbd5e0; 
            border-radius: 10px; 
        }
        
        .message {
            max-width: 80%; 
            padding: 16px 20px; 
            border-radius: 20px; 
            line-height: 1.5; 
            position: relative;
            animation: messageAppear 0.3s ease-out; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            word-wrap: break-word;
        }
        
        @keyframes messageAppear { 
            from {opacity: 0; transform: translateY(10px);} 
            to {opacity: 1; transform: translateY(0);} 
        }
        
        .user-message { 
            align-self: flex-end; 
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); 
            color: white; 
            border-bottom-right-radius: 5px; 
        }
        
        .ai-message { 
            align-self: flex-start; 
            background: white; 
            color: #374151; 
            border-bottom-left-radius: 5px; 
            border: 1px solid #e5e7eb; 
        }
        
        .message-content { 
            margin-bottom: 5px; 
            font-size: 15px; 
        }
        
        .message-time { 
            font-size: 11px; 
            opacity: 0.7; 
            margin-top: 5px; 
            text-align: left;
        }
        
        .input-container { 
            display: flex; 
            padding: 20px; 
            background: #f8fafc; 
            border-top: 1px solid #e5e7eb; 
            gap: 12px; 
        }
        
        input {
            flex: 1; 
            padding: 16px 20px; 
            border: none; 
            border-radius: 24px; 
            outline: none; 
            font-size: 15px; 
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            transition: all 0.3s;
        }
        
        input:focus { 
            box-shadow: 0 2px 12px rgba(59,130,246,0.2); 
        }
        
        input::placeholder { 
            color: #9ca3af; 
        }
        
        button {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); 
            color: white; 
            border: none; 
            border-radius: 24px;
            padding: 16px 24px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s;
            display: flex; 
            align-items: center; 
            gap: 8px; 
            box-shadow: 0 4px 12px rgba(139,92,246,0.3);
        }
        
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(139,92,246,0.4); 
        }
        
        button:active { 
            transform: translateY(0); 
        }
        
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .footer { 
            text-align: center; 
            padding: 15px; 
            background: #f1f5f9; 
            color: #64748b; 
            font-size: 12px; 
            border-top: 1px solid #e2e8f0; 
        }
        
        .typing-indicator {
            display: flex; 
            align-items: center; 
            color: #6b7280; 
            font-style: italic; 
            padding: 12px 18px; 
            background: white; 
            border-radius: 20px;
            align-self: flex-start; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border: 1px solid #e5e7eb; 
            animation: messageAppear 0.3s ease-out;
        }
        
        .typing-dots { 
            display: flex; 
            margin-left: 10px; 
        }
        
        .typing-dots span { 
            width: 6px; 
            height: 6px; 
            background: #9ca3af; 
            border-radius: 50%; 
            margin: 0 2px; 
            animation: typing 1.4s infinite both; 
        }
        
        .typing-dots span:nth-child(2) { 
            animation-delay: 0.2s; 
        }
        
        .typing-dots span:nth-child(3) { 
            animation-delay: 0.4s; 
        }
        
        @keyframes typing { 
            0% {transform: scale(1); opacity: .5;} 
            50% {transform: scale(1.5); opacity: 1;} 
            100% {transform: scale(1); opacity: .5;} 
        }
        
        .api-status { 
            padding: 10px 20px; 
            background: #dcfce7; 
            color: #166534; 
            text-align: center; 
            font-size: 14px; 
            border-bottom: 1px solid #bbf7d0; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .api-status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .retry-btn {
            background: transparent;
            color: inherit;
            border: 1px solid currentColor;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .key-info {
            padding: 8px 15px;
            background: #e0f2fe;
            color: #0c4a6e;
            text-align: center;
            font-size: 12px;
            border-bottom: 1px solid #bae6fd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .key-info.hidden {
            display: none;
        }
        
        .api-key-container {
            padding: 15px;
            background: #fffbeb;
            border-bottom: 1px solid #fef3c7;
            display: flex;
            flex-direction: column;
            gap: 10px;
            display: none;
        }
        
        .api-key-input {
            display: flex;
            gap: 10px;
        }
        
        .api-key-input input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
        }
        
        .api-key-input button {
            padding: 12px 20px;
            font-size: 14px;
        }
        
        .key-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .key-status i {
            font-size: 16px;
        }
        
        .key-status.valid {
            color: #166534;
        }
        
        .key-status.invalid {
            color: #991b1b;
        }
        
        .change-key-btn {
            background: transparent;
            color: #7c3aed;
            border: 1px solid #7c3aed;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
            cursor: pointer;
            display: none;
        }
        
        .phone-input-container {
            padding: 15px;
            background: #f0f9ff;
            border-bottom: 1px solid #bae6fd;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .phone-input {
            display: flex;
            gap: 10px;
        }
        
        .phone-input input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            direction: ltr;
            text-align: left;
        }
        
        .phone-input button {
            padding: 12px 20px;
            font-size: 14px;
        }
        
        .phone-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .phone-status i {
            font-size: 16px;
        }
        
        .phone-status.valid {
            color: #166534;
        }
        
        .phone-status.invalid {
            color: #991b1b;
        }
        
        @media (max-width: 600px) {
            .container { 
                border-radius: 20px; 
                max-width: 100%; 
            }
            
            .header { 
                padding: 20px; 
            }
            
            .chat-container { 
                height: 50vh; 
                padding: 20px; 
            }
            
            .message { 
                max-width: 90%; 
            }
            
            .input-container { 
                padding: 15px; 
            }
            
            input { 
                padding: 14px 16px; 
            }
            
            button { 
                padding: 14px 20px; 
            }
            
            .api-key-input, .phone-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-comments"></i></div>
            </div>
            <h1>FadhelTalk</h1>
            <p class="subtitle">تطبيق المحادثة الذكية</p>
            <div class="status">
                <span id="status-text">من الصفحة الرئيسية</span>
                <div class="status-dot" id="status-dot"></div>
            </div>
        </div>

        <div class="phone-input-container" id="phone-input-container">
            <div class="phone-input">
                <input type="tel" id="phone-input" placeholder="أدخل رقم الهاتف (مثال: 0512345678)" aria-label="رقم الهاتف">
                <button id="verify-phone-btn">
                    <i class="fas fa-check"></i>
                    <span>تحقق</span>
                </button>
            </div>
            <div class="phone-status" id="phone-status">
                <i class="fas fa-info-circle"></i>
                <span>يرجى إدخال رقم الهاتف للوصول إلى الخدمة</span>
            </div>
        </div>

        <div class="key-info" id="key-info">
            <i class="fas fa-key"></i>
            <span>الخدمة تعمل تلقائياً</span>
        </div>

        <div class="api-status" id="api-status">
            <i class="fas fa-check-circle"></i>
            <span>تم الاتصال بنجاح</span>
        </div>

        <div class="chat-container" id="chat-container">
            <div class="message ai-message">
                <div class="message-content">مرحبًا! أنا مساعدك في FadhelTalk. يرجى إدخال رقم الهاتف للبدء.</div>
                <div class="message-time" id="current-time"></div>
            </div>
        </div>

        <div class="input-container">
            <input type="text" id="user-input" placeholder="اكتب رسالتك هنا..." aria-label="رسالة المحادثة" disabled>
            <button id="send-btn" aria-label="إرسال الرسالة" disabled>
                <i class="fas fa-paper-plane"></i>
                <span>إرسال</span>
            </button>
        </div>

        <div class="footer">برمجة وتطوير: فاضل الريس | جميع الحقوق محفوظة</div>
    </div>

    <script>
        // عناصر DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const currentTimeElement = document.getElementById('current-time');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const apiStatus = document.getElementById('api-status');
        const keyInfo = document.getElementById('key-info');
        const phoneInputContainer = document.getElementById('phone-input-container');
        const phoneInput = document.getElementById('phone-input');
        const verifyPhoneBtn = document.getElementById('verify-phone-btn');
        const phoneStatus = document.getElementById('phone-status');

        // حالة التطبيق
        let isConnected = false;
        let isWaitingForResponse = false;
        let userPhone = '';

        // دالة تشفير بسيطة (لأغراض التوضيح فقط - في الإنتاج الحقيقي يجب استخدام تشفير أقوى)
        function simpleEncrypt(text) {
            return btoa(text).split('').reverse().join('');
        }

        // دالة فك التشفير البسيط
        function simpleDecrypt(encryptedText) {
            return atob(encryptedText.split('').reverse().join(''));
        }

        // تحديث الوقت الحالي
        function updateCurrentTime() {
            const now = new Date();
            const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            if (currentTimeElement) currentTimeElement.textContent = timeString;
            return timeString;
        }
        updateCurrentTime();

        // تحديث حالة الاتصال
        function updateConnectionStatus(connected, message) {
            isConnected = connected;
            
            if (connected) {
                statusText.textContent = "متصل بالخدمة";
                statusDot.style.background = "#10b981";
                apiStatus.innerHTML = '<i class="fas fa-check-circle"></i> <span>تم الاتصال بنجاح</span>';
                apiStatus.className = 'api-status';
                userInput.disabled = false;
                sendBtn.disabled = false;
            } else {
                statusText.textContent = "غير متصل";
                statusDot.style.background = "#ef4444";
                apiStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${message}</span> 
                                       <button class="retry-btn" id="retry-btn">إعادة المحاولة</button>`;
                apiStatus.className = 'api-status error';
                userInput.disabled = true;
                sendBtn.disabled = true;
                
                // إضافة حدث لإعادة المحاولة
                setTimeout(() => {
                    const retryBtn = document.getElementById('retry-btn');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', testConnection);
                    }
                }, 100);
            }
        }

        // اختبار الاتصال بالخدمة
        async function testConnection() {
            try {
                updateConnectionStatus(false, "جاري اختبار الاتصال...");
                
                // محاولة الاتصال بخادمنا (يجب استبدال هذا الرابط بخادمك الخاص)
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    updateConnectionStatus(true, "تم الاتصال بنجاح");
                    return true;
                } else {
                    throw new Error(`خطأ في الخدمة: ${response.status}`);
                }
            } catch (error) {
                console.error('فشل اختبار الاتصال:', error);
                updateConnectionStatus(false, `تعذّر الاتصال بالخدمة: ${error.message}`);
                return false;
            }
        }

        // التحقق من رقم الهاتف
        function verifyPhoneNumber() {
            const phone = phoneInput.value.trim();
            
            // تحقق بسيط من رقم الهاتف (يمكن تطوير هذا التحقق حسب الحاجة)
            if (!phone || phone.length < 10 || !/^[0-9]+$/.test(phone)) {
                phoneStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>يرجى إدخال رقم هاتف صحيح</span>';
                phoneStatus.className = 'phone-status invalid';
                return false;
            }
            
            // تخزين رقم الهاتف (مشفر) في localStorage
            userPhone = simpleEncrypt(phone);
            localStorage.setItem('userPhone', userPhone);
            
            // إخفاء حقل إدخال الهاتف وإظهار واجهة المحادثة
            phoneInputContainer.style.display = 'none';
            keyInfo.style.display = 'block';
            apiStatus.style.display = 'block';
            
            // تحديث رسالة الترحيب
            const welcomeMessage = `مرحبًا! أنا مساعدك في FadhelTalk. كيف يمكنني مساعدتك اليوم؟`;
            const messages = chatContainer.querySelectorAll('.message');
            if (messages.length > 0) {
                messages[0].querySelector('.message-content').textContent = welcomeMessage;
            }
            
            // اختبار الاتصال
            testConnection();
            
            return true;
        }

        // إضافة رسالة للمحادثة
        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', isUser ? 'user-message' : 'ai-message');
            messageDiv.setAttribute('role', isUser ? 'user-message' : 'assistant-message');

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            messageContent.textContent = text;

            const messageTime = document.createElement('div');
            messageTime.classList.add('message-time');
            messageTime.textContent = updateCurrentTime();

            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // مؤشر الكتابة
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('typing-indicator');
            typingDiv.id = 'typing-indicator';

            const dotsDiv = document.createElement('div');
            dotsDiv.classList.add('typing-dots');
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dotsDiv.appendChild(dot);
            }

            typingDiv.appendChild(document.createTextNode('جاري المعالجة'));
            typingDiv.appendChild(dotsDiv);
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return typingDiv;
        }

        // استدعاء خدمة الذكاء الاصطناعي عبر الخادم الخاص بنا
        async function getAIResponse(message) {
            if (!isConnected) {
                const connected = await testConnection();
                if (!connected) {
                    return "عذرًا، لا يمكن الاتصال بالخدمة حالياً. يرجى المحاولة لاحقًا.";
                }
            }
            
            try {
                // هنا يجب استبدال الرابط برابط الخادم الخاص بك
                const response = await fetch('https://jsonplaceholder.typicode.com/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        phone: userPhone // إرسال الرقم المشفر
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        updateConnectionStatus(false, "خطأ في المصادقة");
                        throw new Error("خطأ في المصادقة مع الخادم");
                    } else if (response.status === 429) {
                        throw new Error("تم تجاوز الحد المسموح من الطلبات");
                    } else {
                        throw new Error(`خطأ في الخادم: ${response.status}`);
                    }
                }
                
                // في التطبيق الحقيقي، سيعيد الخادم الرد المناسب
                // هذا مجرد نموذج للتوضيح
                const data = await response.json();
                
                // محاكاة رد الذكاء الاصطناعي
                const responses = [
                    "شكرًا على سؤالك. كيف يمكنني مساعدتك بشكل أفضل؟",
                    "هذا سؤال مثير للاهتمام. هل يمكنك تقديم المزيد من التفاصيل؟",
                    "أنا هنا لمساعدتك. هل هناك شيء محدد تريد معرفته؟",
                    "أفهم استفسارك. دعني أقدم لك المعلومات المناسبة.",
                    "هذا موضوع رائع! لدي الكثير لأشاركه معك حول هذا."
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            } catch (error) {
                console.error('Error:', error);
                updateConnectionStatus(false, `تعذّر الاتصال: ${error.message}`);
                return `عذرًا، حدث خطأ: ${error.message}. يرجى المحاولة مرة أخرى.`;
            }
        }

        // إرسال الرسالة
        async function sendMessage() {
            if (isWaitingForResponse) return;
            
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            userInput.value = '';
            isWaitingForResponse = true;
            sendBtn.disabled = true;

            const typingIndicator = showTypingIndicator();
            
            try {
                const answer = await getAIResponse(message);
                typingIndicator.remove();
                addMessage(answer, false);
            } catch (e) {
                typingIndicator.remove();
                addMessage('عذرًا، حدث خطأ غير متوقع في المعالجة.', false);
            } finally {
                isWaitingForResponse = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // تهيئة الأحداث
        function initEvents() {
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => { 
                if (e.key === 'Enter' && !isWaitingForResponse) sendMessage(); 
            });
            
            verifyPhoneBtn.addEventListener('click', verifyPhoneNumber);
            phoneInput.addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') verifyPhoneNumber(); 
            });
            
            // التحقق من وجود رقم هاتف مخزن
            const savedPhone = localStorage.getItem('userPhone');
            if (savedPhone) {
                try {
                    userPhone = savedPhone;
                    const decryptedPhone = simpleDecrypt(userPhone);
                    phoneInput.value = decryptedPhone;
                    verifyPhoneNumber();
                } catch (e) {
                    localStorage.removeItem('userPhone');
                }
            }
            
            window.addEventListener('load', () => {
                phoneInput.focus();
            });
        }

        // بدء التطبيق
        initEvents();
    </script>
</body>
</html>
