<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقويم أوقات الصلاة (الجعفري)</title>
  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--ink:#111;--muted:#6b7280;--grid:#e5e7eb;
      --brand:#0f766e;--accent:#2563eb;--danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Kufi Arabic",Tahoma,Arial,sans-serif}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--grid);z-index:10}
    .wrap{max-width:1100px;margin:auto;padding:12px}
    h1{font-size:20px;margin:4px 0 8px}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,button,select{width:100%;padding:10px;border:1px solid var(--grid);border-radius:10px;background:#fff;font-size:14px}
    button{cursor:pointer}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid var(--grid);background:#fff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .nav{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
    .nav .title{flex:1;text-align:center;font-weight:600}
    main{max-width:1100px;margin:12px auto;padding:0 12px}
    .table-wrap{background:var(--card);border:1px solid var(--grid);border-radius:14px;overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--grid);text-align:center;white-space:nowrap}
    thead th{position:sticky;top:96px;background:var(--card);z-index:5;font-size:12px;color:#374151}
    tbody tr:nth-child(odd){background:#fafafa}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:6px;border:1px solid #c7ece8;background:#ecfdf5;color:#065f46;font-size:12px}
    .error{color:var(--danger);margin-top:6px}
    @media(min-width:820px){
      .controls{grid-template-columns:2fr 2fr 1fr}
      thead th{top:84px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>تقويم أوقات الصلاة (وفق المذهب الجعفري)</h1>
      <div class="controls">
        <div>
          <label>الدولة</label>
          <input id="country" placeholder="Bahrain" value="Bahrain">
        </div>
        <div>
          <label>المدينة</label>
          <input id="city" placeholder="Manama" value="Manama">
        </div>
        <div class="row">
          <button id="useGps" class="pill" title="تحديد الموقع تلقائيًا">استخدام موقعي</button>
          <button id="resetLoc" class="pill">مسح الموقع</button>
        </div>
      </div>

      <div class="nav">
        <button id="prev" class="pill">‹ الشهر السابق</button>
        <div class="title" id="title"></div>
        <button id="next" class="pill">الشهر التالي ›</button>
      </div>
      <div id="status" class="error" hidden></div>
      <div class="hint">
        الحساب: <span class="badge">Jafari (Shia Ithna-Ashari)</span> من <strong>AlAdhan API</strong>.
      </div>
    </div>
  </header>

  <main>
    <div class="table-wrap">
      <table id="cal">
        <thead>
          <tr>
            <th>اليوم</th>
            <th>هجري</th>
            <th>ميلادي</th>
            <th>الإمساك</th>
            <th>أذان الفجر</th>
            <th>الشروق</th>
            <th>أذان الظهر</th>
            <th>أذان المغرب</th>
            <th>وقت صلاة الليل</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="hint">وقت صلاة الليل يُحسب هنا كبداية <strong>الثلث الأخير</strong> (منه حتى الفجر). منتصف الليل الشرعي = نِصف المسافة بين المغرب والفجر.</p>
  </main>

  <script>
    // ==== تفضيلات وساعدات ====
    const CACHE_TTL_MS = 12*60*60*1000; // 12 ساعة
    const JAFARI_METHOD = 0; // طريقة الحساب الجعفري في AlAdhan
    const $ = (s,root=document)=>root.querySelector(s);
    const weekdaysAr = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    const pad = n => (n<10? "0"+n : ""+n);

    function cleanTime(txt){ return (txt||"").split(" ")[0]; } // يحذف (+03:00)

    function keyFor(params){
      const {y,m,mode,city,country,lat,lng} = params;
      return `shiaCal:${y}-${m}:${mode}:${city||""}:${country||""}:${lat||""},${lng||""}`;
    }
    function getCached(k){
      try{
        const raw = localStorage.getItem(k); if(!raw) return null;
        const obj = JSON.parse(raw);
        if(Date.now()-obj.ts > CACHE_TTL_MS) return null;
        return obj.data;
      }catch{ return null }
    }
    function setCached(k,data){
      try{ localStorage.setItem(k, JSON.stringify({ts:Date.now(), data})) }catch{}
    }

    // تحويل "HH:MM" إلى Date بناء على تاريخ ميلادي محدد
    function timeToDate(baseDate, hhmm){
      const [H,M] = hhmm.split(":").map(x=>parseInt(x,10));
      const d = new Date(baseDate);
      d.setHours(H, M, 0, 0);
      return d;
    }
    // مدة زمنية إلى "HH:MM"
    function dateToHM(d){
      return pad(d.getHours())+":"+pad(d.getMinutes());
    }
    // إضافة دقائق
    function addMinutes(date, mins){
      const d = new Date(date); d.setMinutes(d.getMinutes()+mins); return d;
    }
    // فرق الدقائق
    function diffMinutes(later, earlier){
      return Math.round((later - earlier)/60000);
    }

    // يحسب منتصف الليل الشرعي وبداية الثلث الأخير
    function nightTimes(baseDate, maghribHM, fajrHM){
      const maghrib = timeToDate(baseDate, maghribHM);
      // الفجر لليوم التالي
      const fajr = addMinutes(timeToDate(baseDate, fajrHM), 24*60); // +24h
      const nightLen = diffMinutes(fajr, maghrib);
      const half = addMinutes(maghrib, Math.floor(nightLen/2));
      const lastThirdStart = addMinutes(maghrib, Math.floor(nightLen*(2/3)));
      return {midnightHM: dateToHM(half), lastThirdHM: dateToHM(lastThirdStart)};
    }

    function monthLabel(d){
      return d.toLocaleDateString('ar', {month:'long', year:'numeric'});
    }

    async function getCalendar(params){
      const k = keyFor(params);
      const cached = getCached(k);
      if(cached) return cached;

      let url;
      if(params.mode === "gps"){
        const {lat,lng,y,m} = params;
        url = `https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lng}&method=${JAFARI_METHOD}&month=${m}&year=${y}`;
      }else{
        const {city,country,y,m} = params;
        url = `https://api.aladhan.com/v1/calendarByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=${JAFARI_METHOD}&month=${m}&year=${y}`;
      }

      const res = await fetch(url);
      if(!res.ok) throw new Error("تعذّر الاتصال بالخدمة");
      const json = await res.json();
      if(json.code!==200 || !json.data) throw new Error("استجابة غير متوقعة من الواجهة");
      setCached(k, json.data);
      return json.data;
    }

    function renderRows(data){
      const tbody = $("#cal tbody");
      tbody.innerHTML = "";

      data.forEach(row=>{
        const t = row.timings, d = row.date;
        const g = d.gregorian, h = d.hijri;

        // أوقات خام
        const imsak = cleanTime(t.Imsak);
        const fajr  = cleanTime(t.Fajr);
        const sunrise = cleanTime(t.Sunrise);
        const dhuhr = cleanTime(t.Dhuhr);
        const maghrib = cleanTime(t.Maghrib);

        // حساب وقت صلاة الليل (بداية الثلث الأخير)
        const baseDate = new Date(g.date.replace(/-/g,'/')); // لضمان التوافق
        const { lastThirdHM } = nightTimes(baseDate, maghrib, fajr);

        const weekday = weekdaysAr[new Date(baseDate).getDay()];
        const hijriStr = `${pad(+h.day)} ${h.month.ar} ${h.year}`;
        const gregStr = `${pad(+g.day)} ${g.month.en} ${g.year}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${weekday}</td>
          <td>${hijriStr}</td>
          <td class="muted">${gregStr}</td>
          <td>${imsak}</td>
          <td>${fajr}</td>
          <td>${sunrise}</td>
          <td>${dhuhr}</td>
          <td>${maghrib}</td>
          <td><span class="badge" title="بداية الثلث الأخير من الليل">${lastThirdHM}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function build(targetDate){
      const status = $("#status"); status.hidden = true;

      const city = $("#city").value.trim();
      const country = $("#country").value.trim();

      const gps = JSON.parse(localStorage.getItem("shia:gps")||"null");
      const mode = gps ? "gps" : "city";

      const y = targetDate.getFullYear();
      const m = targetDate.getMonth()+1;

      $("#title").textContent = `${monthLabel(targetDate)} — ${mode==="gps" ? "اعتماد الموقع الحالي" : `${city}, ${country}`}`;

      try{
        const data = await getCalendar({y,m,mode,city,country,lat:gps?.lat,lng:gps?.lng});
        renderRows(data);
      }catch(e){
        status.textContent = "عذرًا، حدث خطأ: " + e.message;
        status.hidden = false;
      }
    }

    // ===== التهيئة وربط الواجهة =====
    (function init(){
      let current = new Date(); current = new Date(current.getFullYear(), current.getMonth(), 1);

      const render = ()=>build(current);
      $("#prev").addEventListener("click", ()=>{ current.setMonth(current.getMonth()-1); render(); });
      $("#next").addEventListener("click", ()=>{ current.setMonth(current.getMonth()+1); render(); });

      // GPS
      $("#useGps").addEventListener("click", ()=>{
        if(!("geolocation" in navigator)){ alert("المتصفح لا يدعم تحديد الموقع"); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude:lat, longitude:lng} = pos.coords;
          localStorage.setItem("shia:gps", JSON.stringify({lat:+lat.toFixed(6), lng:+lng.toFixed(6)}));
          render();
        }, err=>{
          alert("تعذّر تحديد الموقع: "+err.message);
        }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
      });
      $("#resetLoc").addEventListener("click", ()=>{
        localStorage.removeItem("shia:gps");
        render();
      });

      // حفظ تفضيلات المدينة/الدولة
      const savePrefs = ()=>{
        localStorage.setItem("shia:prefs", JSON.stringify({
          city: $("#city").value.trim(),
          country: $("#country").value.trim()
        }));
      };
      ["change","blur","keyup"].forEach(ev=>{
        $("#city").addEventListener(ev, savePrefs);
        $("#country").addEventListener(ev, savePrefs);
      });
      try{
        const p = JSON.parse(localStorage.getItem("shia:prefs")||"{}");
        if(p.city) $("#city").value = p.city;
        if(p.country) $("#country").value = p.country;
      }catch{}

      render();
    })();
  </script>
</body>
</html>
