<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>عداد الركعات — وضع الوسواس (الشيعة)</title>
<meta name="theme-color" content="#0b2a33">
<style>
  :root{
    --bg:#0b2a33; --card:#102f3a; --accent:#ffd166; --muted:#96b1b8; --text:#eaf6f8; --ok:#4ade80; --warn:#f59e0b; --danger:#ef4444;
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
    radial-gradient(1200px 1200px at 80% -200px, #143b47 0%, var(--bg) 60%) fixed;
    color:var(--text); font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", "Helvetica Neue", Arial, sans-serif;
    line-height:1.5;
  }
  header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px}
  .logo{display:flex;gap:10px;align-items:center}
  .logo span{font-weight:700;letter-spacing:.3px}
  .chip{padding:.25rem .6rem;border-radius:999px;background:#0f3945;color:#bfe7ef;font-size:.8rem;border:1px solid #1d5566}
  .container{max-width:980px;margin:0 auto;padding:12px 16px 48px}
  .hero{
    text-align:center;background:linear-gradient(180deg,#0e3541, #0c2f39);border:1px solid #1a4c59;
    border-radius:calc(var(--radius) + 6px); padding:28px 18px; box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .hero h1{margin:10px 0 8px;font-size:1.7rem}
  .hero p{margin:0;color:#c9e6eb}
  .cta{margin-top:16px}
  button{
    appearance:none;border:0;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer;
    background:var(--accent);color:#1a2d33;box-shadow:0 6px 0 #b18a2d;transition:.15s transform ease,.15s filter ease;
  }
  button:hover{filter:brightness(.98)}
  button:active{transform:translateY(2px);box-shadow:0 4px 0 #b18a2d}
  .ghost{background:transparent;border:1px solid #2b5561;color:#bfe7ef;box-shadow:none}
  .grid{
    margin-top:20px;display:grid;gap:14px;grid-template-columns:repeat(auto-fill, minmax(140px,1fr));
  }
  .card{
    background:var(--card); border:1px solid #1a4c59; border-radius:var(--radius); padding:14px; text-align:center;
    transition:.2s transform ease, .2s box-shadow ease; cursor:pointer; position:relative; overflow:hidden;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .icon{width:48px;height:48px;margin:8px auto 6px;display:grid;place-items:center;background:#0f3945;border-radius:14px;border:1px solid #1a4c59}
  .card small{display:block;color:var(--muted)}
  .footer-note{margin-top:18px;font-size:.9rem;color:#bdd7dc}
  /* Counter Panel */
  .panel{margin-top:22px;background:var(--card);border:1px solid #1a4c59;border-radius:var(--radius);padding:16px;display:none}
  .panel.active{display:block}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grow{flex:1}
  .pill{background:#0f3945;border:1px solid #1a4c59;border-radius:999px;padding:.35rem .7rem;color:#cbe9ee;font-size:.9rem}
  .counter{
    margin-top:14px;display:grid;gap:14px;grid-template-columns:1fr;justify-items:center;text-align:center
  }
  .big{
    font-size:4rem;font-weight:800;line-height:1;margin-top:4px;background:#0f3945;border:1px solid #1a4c59;
    border-radius:28px;padding:16px 26px;min-width:220px;display:inline-block;
  }
  .progress{width:100%;height:10px;background:#0f3945;border:1px solid #1a4c59;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#ffe08b, #ffc857)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .controls button{min-width:90px}
  .controls .danger{background:var(--danger);box-shadow:0 6px 0 #b02a2a;color:#fff}
  .controls .ok{background:var(--ok);box-shadow:0 6px 0 #2f855a;color:#003220}
  .hint{background:#0f3945;border:1px dashed #1a4c59;border-radius:14px;padding:10px 12px;color:#cbe9ee}
  .hint b{color:#fff}
  .muted{color:#9fc6cd}
  .section-title{margin:22px 0 10px;font-weight:800}
  .kufi{font-family:"Noto Kufi Arabic", "Noto Sans Arabic", system-ui}
  @media (min-width:860px){
    .counter{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
  <header>
    <div class="logo">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <rect x="3" y="3" width="18" height="18" rx="4" stroke="#bfe7ef" stroke-width="1.4"/>
        <path d="M8 18V7h8v11" stroke="#ffd166" stroke-width="1.6"/>
        <path d="M10 18v-3a2 2 0 1 1 4 0v3" stroke="#bfe7ef" stroke-width="1.4"/>
      </svg>
      <span>عداد الركعات</span>
    </div>
    <span class="chip">وضع الوسواس</span>
  </header>

  <div class="container">
    <!-- HERO -->
    <section class="hero">
      <div style="display:grid;place-items:center;">
        <div class="icon" aria-hidden="true">
          <!-- سجادة -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <rect x="7" y="4" width="10" height="16" rx="1.2" stroke="#ffd166" stroke-width="1.4"/>
            <rect x="10" y="8" width="4" height="6" rx=".8" stroke="#bfe7ef" stroke-width="1.2"/>
          </svg>
        </div>
      </div>
      <h1 class="kufi">علاج مشكلة السهو في الصلاة</h1>
      <p>اضغط “ابدأ صلاتك” ثم اختر الصلاة، وسيحسب التطبيق ركعاتك بثبات خاص لمن يكثر عندهم الشك.</p>
      <div class="cta">
        <button id="startBtn">ابدأ صلاتك</button>
        <button class="ghost" id="howBtn">شرح سريع</button>
      </div>
    </section>

    <!-- PRAYER PICKER -->
    <section id="picker" class="grid" aria-label="اختر الصلاة" style="display:none">
      <!-- تُملأ ديناميكياً -->
    </section>

    <!-- COUNTER PANEL -->
    <section id="panel" class="panel" aria-live="polite">
      <div class="row">
        <div class="pill" id="selName">—</div>
        <div class="pill">الهدف: <b id="targetRakaat">0</b> ركعة</div>
        <label class="pill" style="cursor:pointer">
          <input id="waswasToggle" type="checkbox" checked style="accent-color:#ffd166; transform:translateY(1px)"> تفعيل وضع الوسواس
        </label>
        <div class="grow"></div>
        <button class="ghost" id="backBtn">تبديل الصلاة</button>
      </div>

      <div class="counter">
        <div>
          <div class="big" id="rakaat">0</div>
          <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
        </div>
        <div>
          <div class="controls">
            <button id="incBtn">+ ركعة</button>
            <button id="decBtn" class="ghost">– تراجع</button>
            <button id="resetBtn" class="danger">إعادة</button>
            <button id="doneBtn" class="ok">إتمام</button>
          </div>
          <div class="hint" id="hintBox" style="margin-top:10px">
            <b>وضع الوسواس:</b> يثبت العد بعد 3 ثوانٍ لكل زيادة ويمنع التراجعات السريعة. قاعدة عامة عند كثير الشك: <b>تجاهل الشك واستمر</b>، واسأل مرجع تقليدك عند المسائل الخاصة.
          </div>
        </div>
      </div>
    </section>

    <h3 class="section-title kufi">ملاحظات فقهية عامة (مختصرة)</h3>
    <div class="hint">
      هذا التطبيق يساعد على <b>الانضباط العددي</b> فقط. في فقه الإمامية:
      من ابتُلي بكثرة الشك <span class="muted">(الوسواس)</span> يُطالب شرعًا بتجاهل الشك والبناء على الصحة. 
      أما شبهات عدد الركعات في الصلوات الرباعية فلها أحكام تفصيلية (صلاة الاحتياط، سجدتا السهو…). 
      عند الشك الفعلي استفتِ مرجعك المعتمد.
    </div>

    <p class="footer-note">يُخزن التطبيق آخر صلاة وعدد الركعات محليًا على جهازك.</p>
  </div>

<script>
/* ------------------ البيانات ------------------ */
const PRAYERS = [
  { key:"fajr",  name:"صلاة الصبح",  defaultR:2,  icon:"sunrise" },
  { key:"dhuhr", name:"صلاة الظهر",  defaultR:4,  icon:"sun" },
  { key:"asr",   name:"صلاة العصر",  defaultR:4,  icon:"sun" },
  { key:"magh",  name:"صلاة المغرب", defaultR:3,  icon:"sunset" },
  { key:"isha",  name:"صلاة العشاء", defaultR:4,  icon:"moon" },
  { key:"qiyam", name:"صلاة الليل",  defaultR:11, icon:"crescent", editable:true },
  { key:"nafl",  name:"الصلوات الخاصة", defaultR:2, icon:"infty", editable:true },
  { key:"rules", name:"أحكام السهو", defaultR:null, icon:"help", isInfo:true }
];

/* ------------------ مراجع العناصر ------------------ */
const picker = document.getElementById('picker');
const panel  = document.getElementById('panel');
const startBtn = document.getElementById('startBtn');
const howBtn = document.getElementById('howBtn');
const backBtn = document.getElementById('backBtn');
const rakaatEl = document.getElementById('rakaat');
const bar = document.getElementById('bar');
const incBtn = document.getElementById('incBtn');
const decBtn = document.getElementById('decBtn');
const resetBtn = document.getElementById('resetBtn');
const doneBtn = document.getElementById('doneBtn');
const targetEl = document.getElementById('targetRakaat');
const nameEl = document.getElementById('selName');
const waswasToggle = document.getElementById('waswasToggle');
const hintBox = document.getElementById('hintBox');

/* ------------------ حالة التطبيق ------------------ */
let state = {
  selected: null, // {key,name,defaultR, ...}
  count: 0,
  target: 0,
  waswas: true,
  lockUntil: 0, // زمن تثبيت الزيادة
};

const LS_KEY = "rakaat-state-v1";

/* ------------------ رسم مُلتقط الصلاة ------------------ */
function iconSVG(kind){
  const base = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">';
  const end  = '</svg>';
  const stroke1 = '#ffd166', stroke2='#bfe7ef';
  switch(kind){
    case 'sunrise': return base+`<path d="M12 4v4" stroke="${stroke1}" stroke-width="1.6"/><circle cx="12" cy="14" r="4" stroke="${stroke2}" stroke-width="1.4"/><path d="M4 20h16" stroke="${stroke2}" stroke-width="1.4"/>`+end;
    case 'sunset':  return base+`<path d="M12 20v-4" stroke="${stroke1}" stroke-width="1.6"/><circle cx="12" cy="10" r="4" stroke="${stroke2}" stroke-width="1.4"/><path d="M4 4h16" stroke="${stroke2}" stroke-width="1.4"/>`+end;
    case 'sun':     return base+`<circle cx="12" cy="12" r="4.2" stroke="${stroke1}" stroke-width="1.6"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.5 4.5l2.2 2.2M17.3 17.3l2.2 2.2M19.5 4.5l-2.2 2.2M4.5 19.5l2.2-2.2" stroke="${stroke2}" stroke-width="1.2"/>`+end;
    case 'moon':    return base+`<path d="M14 3a8 8 0 1 0 7 11.5A7 7 0 0 1 14 3z" stroke="${stroke1}" stroke-width="1.6" fill="none"/>`+end;
    case 'crescent':return base+`<path d="M15 3a8.5 8.5 0 1 1-6.5 14A7.5 7.5 0 0 0 15 3z" stroke="${stroke1}" stroke-width="1.6" fill="none"/>`+end;
    case 'infty':   return base+`<path d="M7 15c2.5-3 5-6 8-6 2 0 3 1.5 3 3s-1 3-3 3-4-2-5-3-2-3-4-3-3 1.5-3 3 1 3 3 3 3-1 4-2" stroke="${stroke1}" stroke-width="1.6" fill="none"/>`+end;
    default:        return base+`<circle cx="12" cy="12" r="8" stroke="${stroke2}" stroke-width="1.4"/><text x="12" y="16" text-anchor="middle" font-size="10" fill="${stroke1}">؟</text>`+end;
  }
}
function drawPicker(){
  picker.innerHTML = "";
  PRAYERS.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.setAttribute('role','button');
    card.innerHTML = `
      <div class="icon">${iconSVG(p.icon)}</div>
      <div class="kufi" style="font-weight:700">${p.name}</div>
      <small>${p.defaultR? (p.editable? `افتراضي: ${p.defaultR} ركعات (قابل للتعديل)`:`${p.defaultR} ركعات`): 'قراءة مختصرة'}</small>
    `;
    card.onclick = ()=> selectPrayer(p);
    picker.appendChild(card);
  });
}

/* ------------------ منطق العد ------------------ */
function selectPrayer(p){
  if(p.isInfo){ alert('أحكام السهو: القاعدة العامة لمن يكثر شكه هي التجاهل والبناء على الصحة. مسائل الشك في الرباعية لها صور متعددة (2↔3↔4) قد يترتب عليها صلاة الاحتياط وسجدتا السهو؛ راجع فتوى مرجع تقليدك.'); return; }
  state.selected = p;
  state.target = p.defaultR ?? 2;
  if(p.editable){
    const t = prompt(`أدخل عدد الركعات لصلاة: ${p.name}`, state.target);
    const val = parseInt(t,10);
    if(!isNaN(val) && val>0 && val<100) state.target = val;
  }
  state.count = 0;
  updateUI();
  saveState();
  showPanel(true);
}
function updateUI(){
  nameEl.textContent = state.selected ? state.selected.name : "—";
  targetEl.textContent = state.target;
  rakaatEl.textContent = state.count;
  const pct = Math.min(100, Math.round((state.count/state.target)*100));
  bar.style.width = pct + "%";
}
function showPanel(on){
  panel.classList.toggle('active', !!on);
  window.scrollTo({top: panel.offsetTop - 12, behavior:'smooth'});
}
function haptic(){
  if(navigator.vibrate) navigator.vibrate(15);
}
function inc(){
  const now = Date.now();
  if(state.waswas && now < state.lockUntil){ // مثبت
    return;
  }
  state.count = Math.min(state.count + 1, 99);
  updateUI(); haptic();
  if(state.waswas){
    state.lockUntil = now + 3000; // تثبيت 3 ثوانٍ
  }
  if(state.count >= state.target){
    done(true);
  }
  saveState();
}
function dec(){
  const now = Date.now();
  if(state.waswas && now < state.lockUntil){ // منع التراجع السريع
    hintTemp('التراجع معطّل مؤقتًا (وضع الوسواس). انتظر ثوانٍ قليلة.');
    return;
  }
  state.count = Math.max(0, state.count - 1);
  updateUI(); haptic();
  saveState();
}
function resetAll(){
  if(confirm('إعادة العدّ؟')) {
    state.count = 0; updateUI(); saveState();
  }
}
function done(auto=false){
  const msg = auto ? 'بلغت الهدف المعيّن لعدد الركعات.' : 'هل تريد إنهاء العدّ؟';
  if(auto || confirm(msg)){
    hintTemp('تم الإتمام. إن كنت كثير الشك فابْنِ على الصحة ولا تلتفت للوساوس.');
    if(state.waswas) state.lockUntil = Date.now() + 2000;
  }
  saveState();
}
function hintTemp(text){
  hintBox.textContent = text;
  setTimeout(()=>{ hintBox.innerHTML = '<b>وضع الوسواس:</b> يثبت العد بعد 3 ثوانٍ لكل زيادة ويمنع التراجعات السريعة. قاعدة عامة عند كثير الشك: <b>تجاهل الشك واستمر</b>، واسأل مرجع تقليدك عند المسائل الخاصة.' }, 3500);
}

/* ------------------ تخزين محلي ------------------ */
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify({
  k: state.selected?.key, c: state.count, t: state.target, w: state.waswas
})); }
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if(!s) return;
    const p = PRAYERS.find(x=>x.key===s.k);
    if(p){ state.selected = p; state.count = s.c||0; state.target = s.t||p.defaultR; state.waswas = !!s.w; }
  }catch(e){}
}

/* ------------------ أحداث ------------------ */
startBtn.onclick = ()=>{
  drawPicker();
  picker.style.display = 'grid';
  window.scrollTo({top: picker.offsetTop - 8, behavior:'smooth'});
}
howBtn.onclick = ()=>{
  alert('الخطوات:\n1) اضغط "ابدأ صلاتك".\n2) اختر الصلاة.\n3) اضغط + بعد كل ركعة.\n— وضع الوسواس يثبّت كل زيادة 3 ثوانٍ ويمنع التراجع السريع.\n4) عند بلوغ الهدف، يتم الإشعار بالإتمام.\nيمكن تخصيص عدد ركعات صلاة الليل أو الصلوات الخاصة.');
}
backBtn.onclick = ()=>{ picker.style.display='grid'; showPanel(false); }
incBtn.onclick = inc;
decBtn.onclick = dec;
resetBtn.onclick = resetAll;
doneBtn.onclick = ()=>done(false);
waswasToggle.onchange = (e)=>{ state.waswas = e.target.checked; saveState(); hintTemp(state.waswas?'تم تفعيل وضع الوسواس.':'تم إيقاف وضع الوسواس. يمكنك التراجع بحرية.'); };

/* ------------------ بدء التشغيل ------------------ */
loadState();
drawPicker();
if(state.selected){ picker.style.display='grid'; showPanel(true); updateUI(); waswasToggle.checked = state.waswas; }
</script>
</body>
</html>
