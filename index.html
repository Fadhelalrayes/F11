<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    /* Ù„ÙˆØ­Ø© Ø­Ø¯ÙŠØ«Ø© Ø£Ù†ÙŠÙ‚Ø© */
    --ink:#0b132b; --muted:#67738a; --bg:#f6f8fb;
    --card:#ffffff; --border:#e6e8ef; --line:#dfe4ec;
    --brand:#06b6d4; --brand2:#2563eb; --accent:#06b6d433;
    --shadow:0 10px 28px rgba(2,6,23,.08);
    --radius:16px; --rsm:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Tajawal", system-ui, -apple-system, Segoe UI, "Noto Kufi Arabic", sans-serif;
    color:var(--ink);
    background:
      radial-gradient(700px 480px at 12% -10%, #ecfbff 0%, transparent 55%),
      radial-gradient(640px 420px at 95% 5%, #eef0ff 0%, transparent 50%),
      var(--bg);
    min-height:100svh; padding:18px;
  }
  .wrap{width:min(1180px,100%); margin-inline:auto; display:flex; flex-direction:column; gap:14px; animation:fade .45s ease both}
  @keyframes fade{from{opacity:0; transform:translateY(4px)}to{opacity:1; transform:translateY(0)}}

  /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ù†Ø­ÙŠÙ + Ø³Ø§Ø¹Ø© Ø«Ø§Ø¨ØªØ© ÙŠØ³Ø§Ø± */
  .topbar{
    position:relative; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#ffffff,#fbfdff);
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:10px 16px;
  }
  .clock{
    position:absolute; left:12px; top:10px; z-index:3;
    background:#fff; border:1px solid var(--border); border-radius:10px;
    padding:.34rem .6rem; font-variant-numeric:tabular-nums; font-weight:800; color:#0c3a3b;
    box-shadow:0 8px 18px rgba(0,0,0,.06); font-size:.95rem;
  }
  .brandTitle{margin:0; font-size:1.05rem; font-weight:800}

  /* Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® */
  .panel{
    display:grid; gap:12px;
    grid-template-columns: 1.1fr .9fr;
  }
  @media (max-width: 950px){ .panel{grid-template-columns:1fr} }

  /* 1) Ø¯ÙˆÙ„ ÙƒÙ€ Pills Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ± */
  .countryPills{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:10px; display:flex; align-items:center; gap:10px;
    overflow:auto; scrollbar-width:none;
  }
  .countryPills::-webkit-scrollbar{display:none}
  .pill{
    flex:0 0 auto;
    border:1px solid var(--border); background:#fff; color:#0b2749;
    padding:.45rem .75rem; border-radius:999px; font-weight:800; font-size:.95rem;
    transition:.15s transform, .15s background;
    cursor:pointer; user-select:none;
  }
  .pill[aria-selected="true"]{
    background:linear-gradient(135deg, #e9fbff, #eef2ff);
    border-color:#cae9ff; color:#0b2749; box-shadow:0 6px 16px rgba(6,182,212,.15);
  }
  .pill:hover{ transform: translateY(-1px) }

  /* 2) Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯ÙŠÙ†Ø©: Ø­Ù‚Ù„ Ø°ÙƒÙŠ + Ù„ÙˆØ­Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ø¨Ø¨Ø·Ø§Ù‚Ø§Øª */
  .cityPicker{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:12px;
  }
  .cityHeader{display:flex; gap:8px; align-items:center}
  .cityInput{
    flex:1; border:1px solid var(--border); border-radius:999px; padding:.55rem .9rem; font-weight:700; outline:none;
  }
  .openBtn{
    border:1px solid var(--border); background:#fff; padding:.55rem .75rem; border-radius:999px; font-weight:800; cursor:pointer;
  }

  .overlay{
    position:relative; margin-top:10px;
  }
  .sheet{
    display:none;
    position:absolute; inset-inline:0; z-index:5;
    background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:10px; max-height:280px; overflow:auto;
  }
  .sheet.open{display:block}
  .cityGrid{
    display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px;
  }
  @media (max-width: 720px){ .cityGrid{grid-template-columns: repeat(2,1fr)} }
  .cityCard{
    border:1px solid var(--border); border-radius:12px; padding:.6rem .7rem; background:#fff; cursor:pointer;
    display:flex; align-items:center; gap:8px; font-weight:800; color:#0b2749;
  }
  .cityCard:hover{ background:#f8fbff }
  .ccDot{width:22px; height:22px; border-radius:999px; background:linear-gradient(180deg,#ecfeff,#fff); border:1px solid #cde8ff; display:grid; place-items:center; font-size:.9rem; color:#0b5aa5}

  /* 3) ØªØ°ÙƒØ±ØªØ§ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ù‡Ø¬Ø±ÙŠ/Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ) */
  .tickets{
    display:flex; gap:10px; align-items:stretch;
  }
  @media (max-width: 480px){ .tickets{flex-direction:column} }
  .ticket{
    position:relative; flex:1; background:linear-gradient(180deg,#ffffff,#fbfdff);
    border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
    padding:10px 14px; display:flex; align-items:center; gap:10px;
  }
  .ticket .ico{
    width:34px; height:34px; border-radius:10px; display:grid; place-items:center; font-size:1.05rem;
    background:linear-gradient(135deg,#effaff,#ffffff); border:1px solid #d9e9ff; color:#0c5a88; flex:0 0 auto;
  }
  .ticket .stack{display:flex; flex-direction:column; line-height:1.35}
  .ticket .label{font-size:.85rem; color:var(--muted); font-weight:700}
  .ticket .value{font-size:1.05rem; font-weight:800; font-variant-numeric:tabular-nums; color:#0b213f}
  /* Ø«Ù‚ÙˆØ¨ Ø§Ù„Ù‚ØµÙ‘ Ø¨ÙŠÙ† Ø§Ù„ØªØ°ÙƒØ±ØªÙŠÙ† */
  .tickets:before{
    content:""; align-self:stretch; width:10px; background:
      radial-gradient(circle at center, #d9dee6 2px, transparent 2px) left/10px 10px repeat-y;
    display:block; border-radius:6px;
  }

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª */
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:12px;
  }
  .card h3{margin:0 0 8px; font-size:1rem; font-weight:800}
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{
    text-align:right; font-weight:800; color:#1f2937; font-size:.92rem; padding:10px 10px;
    background:#f6f8fc; border-bottom:1px solid var(--line);
  }
  tbody tr{transition:.12s background}
  tbody tr:hover{background:#fbfdff}
  tbody td{padding:10px; border-bottom:1px dashed var(--line); font-size:1rem}
  tbody tr:last-child td{border-bottom:none}
  .row{display:flex; align-items:center; gap:8px; font-weight:800}
  .icoTime{width:24px; height:24px; border-radius:9px; display:grid; place-items:center; background:linear-gradient(135deg,#ecfeff,#ffffff); border:1px solid #d9eef2; color:#0b5a64; font-size:.95rem}
  .time{font-variant-numeric:tabular-nums; font-weight:800}
  tr.next td{background:linear-gradient(90deg,var(--accent),transparent 40%)}
  tr.next td:first-child{border-inline-start:3px solid var(--brand)}

  /* Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ… */
  .hadith{
    background:#fff; border:1px solid var(--border); border-radius:12px;
    box-shadow:var(--shadow); padding:12px 14px; font-size:.98rem; color:#0b213f;
  }
  .hMeta{color:var(--muted); font-size:.9rem; margin-top:6px}

  footer{ text-align:center; color:var(--muted); font-weight:700; padding:4px 0 }
  .brand{ color:var(--brand) }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
    <div class="topbar" aria-live="polite">
      <div id="clock" class="clock">--:-- --</div>
      <h1 class="brandTitle">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h1>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¯ÙˆÙ„/Ø§Ù„Ù…Ø¯Ù† + Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ -->
    <section class="panel">
      <!-- Ø¯ÙˆÙ„ ÙƒÙ€ Pills -->
      <div class="countryPills" id="countryPills" role="tablist" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø©"></div>

      <!-- ØªØ°Ø§ÙƒØ± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
      <div class="tickets">
        <div class="ticket">
          <div class="ico">ğŸ—“</div>
          <div class="stack">
            <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</div>
            <div class="value" id="hijri">--</div>
          </div>
        </div>
        <div class="ticket">
          <div class="ico">ğŸ“…</div>
          <div class="stack">
            <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</div>
            <div class="value" id="greg">--</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ -->
    <section class="cityPicker" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
      <div class="cityHeader">
        <input id="citySearch" class="cityInput" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø©â€¦" />
        <button id="cityOpen" class="openBtn" type="button">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù†</button>
        <span id="placeLabel" style="color:var(--muted); font-weight:800; margin-inline-start:auto;">Ø§Ù„Ø¨Ø­Ø±ÙŠÙ† â€“ Ø§Ù„Ù…Ù†Ø§Ù…Ø©</span>
      </div>
      <div class="overlay">
        <div class="sheet" id="citySheet">
          <div class="cityGrid" id="cityGrid"><!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¯Ù† --></div>
        </div>
      </div>
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª -->
    <section class="card">
      <h3>Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
      <table>
        <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø³Ø§Ø¹Ø© (12h)</th></tr></thead>
        <tbody id="times"><!-- ÙŠÙÙˆÙ„Ù‘Ø¯ --></tbody>
      </table>
    </section>

    <!-- Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ… -->
    <section class="hadith">
      <div id="hadithText"></div>
      <div class="hMeta" id="hadithSource"></div>
    </section>

    <footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± <span class="brand">ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³</span></footer>
  </div>

<script>
  /* Ø§Ù„Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù…Ø¯Ù† + Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© */
  const MAP = {
    "Bahrain": { tz:"Asia/Bahrain", cities:[{en:"Manama",ar:"Ø§Ù„Ù…Ù†Ø§Ù…Ø©"},{en:"Muharraq",ar:"Ø§Ù„Ù…Ø­Ø±Ù‚"},{en:"Isa Town",ar:"Ù…Ø¯ÙŠÙ†Ø© Ø¹ÙŠØ³Ù‰"},{en:"Hamad Town",ar:"Ù…Ø¯ÙŠÙ†Ø© Ø­Ù…Ø¯"},{en:"Sitra",ar:"Ø³ØªØ±Ø©"},{en:"Saar",ar:"Ø³Ø§Ø±"},{en:"Draz",ar:"Ø§Ù„Ø¯Ø±Ø§Ø²"},{en:"Jidhafs",ar:"Ø¬Ø¯Ø­ÙØµ"}]},
    "Lebanon": { tz:"Asia/Beirut",  cities:[{en:"Beirut",ar:"Ø¨ÙŠØ±ÙˆØª"},{en:"Tripoli",ar:"Ø·Ø±Ø§Ø¨Ù„Ø³"},{en:"Sidon",ar:"ØµÙŠØ¯Ø§"}]},
    "Iraq":    { tz:"Asia/Baghdad", cities:[{en:"Baghdad",ar:"Ø¨ØºØ¯Ø§Ø¯"},{en:"Basrah",ar:"Ø§Ù„Ø¨ØµØ±Ø©"},{en:"Erbil",ar:"Ø£Ø±Ø¨ÙŠÙ„"}]},
    "Iran":    { tz:"Asia/Tehran",  cities:[{en:"Tehran",ar:"Ø·Ù‡Ø±Ø§Ù†"},{en:"Mashhad",ar:"Ù…Ø´Ù‡Ø¯"},{en:"Isfahan",ar:"Ø£ØµÙÙ‡Ø§Ù†"}]},
    "Kuwait":  { tz:"Asia/Kuwait",  cities:[{en:"Kuwait City",ar:"Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙƒÙˆÙŠØª"},{en:"Hawalli",ar:"Ø­ÙˆÙ„ÙŠ"},{en:"Al Ahmadi",ar:"Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ"}]},
    "Saudi Arabia":{ tz:"Asia/Riyadh", cities:[{en:"Riyadh",ar:"Ø§Ù„Ø±ÙŠØ§Ø¶"},{en:"Jeddah",ar:"Ø¬Ø¯Ø©"},{en:"Dammam",ar:"Ø§Ù„Ø¯Ù…Ø§Ù…"},{en:"Mecca",ar:"Ù…ÙƒØ©"},{en:"Medina",ar:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"}]}
  };
  const DEFAULT_COUNTRY = "Bahrain";

  /* Ø£Ø­Ø§Ø¯ÙŠØ« */
  const HADITHS = [
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¨Ø§Ù‚Ø± (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØµÙ„ÙŠ Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø­Ù…Ù† Ø¨ÙˆØ¬Ù‡Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ ØºÙŠØ±Ù‡.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" },
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ø±Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø© Ø£Ù‚Ø¨Ù„ Ø¥Ø¨Ù„ÙŠØ³ ÙŠÙ†Ø¸Ø± Ø¥Ù„ÙŠÙ‡ Ø­Ø³Ø¯Ø§Ù‹ Ù„Ù…Ø§ ÙŠØ±Ù‰ Ù…Ù† Ø±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ Ø§Ù„ØªÙŠ ØªØºØ´Ø§Ù‡.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" },
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„ØµÙ„Ø§Ø© Ù„Ù‡Ø§ Ø£Ø±Ø¨Ø¹Ø© Ø¢Ù„Ø§Ù Ø¨Ø§Ø¨.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" },
    { text:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): ÙŠØ§ ÙƒÙ…ÙŠÙ„! Ù„ÙŠØ³ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªØµÙ„ÙŠ ÙˆØªØµÙˆÙ… ÙˆØªØªØµØ¯Ù‚ØŒ Ø¥Ù†Ù…Ø§ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ØµÙ„Ø§Ø© ÙØ¹Ù„Øª Ø¨Ù‚Ù„Ø¨ Ù†Ù‚ÙŠØŒ ÙˆØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù‡ Ù…Ø±Ø¶ÙŠØŒ ÙˆØ®Ø´ÙˆØ¹ Ø³ÙˆÙŠ.", src:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©" }
  ];
  function setRandomHadith(){
    const h = HADITHS[Math.floor(Math.random()*HADITHS.length)];
    hadithText.textContent = h.text;
    hadithSource.textContent = h.src;
  }

  /* 12h */
  function to12h(t){
    if(!t) return "--:-- --";
    const pure = t.replace(/\s*\(.*?\)\s*/g, "");
    const [H,M] = pure.split(":").map(Number);
    if(Number.isNaN(H)||Number.isNaN(M)) return t;
    let h = H % 12; if(h===0) h = 12;
    const ampm = H < 12 ? "AM" : "PM";
    return `${String(h).padStart(2,"0")}:${String(M).padStart(2,"0")} ${ampm}`;
  }

  /* Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® */
  function fmtClock(tz){
    return new Intl.DateTimeFormat('en-GB', {timeZone:tz, hour:'2-digit', minute:'2-digit', hour12:true}).format(new Date());
  }
  function fmtGreg(tz){
    return new Intl.DateTimeFormat('ar', {timeZone:tz, weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(new Date());
  }
  function fmtHijri(tz){
    try{
      return new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {timeZone:tz, weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(new Date());
    }catch{ return "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…)"; }
  }

  /* Ø¨Ù†Ø§Ø¡ ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  function trHTML(label, icon, val, next=false){
    return `<tr class="${next?'next':''}">
      <td><div class="row"><span class="icoTime">${icon}</span> ${label}</div></td>
      <td class="time">${to12h(val||'')}</td>
    </tr>`;
  }

  /* Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© */
  function nextPrayerKey(timings, tz){
    const order = ["Imsak","Fajr","Dhuhr","Asr","Maghrib","Isha","Midnight"];
    const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    const dstr = new Intl.DateTimeFormat('en-CA', {timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit'}).format(nowTZ);
    const [Y,M,D] = dstr.split('-').map(Number);
    const cand = order.map(k=>{
      const raw = (timings[k]||"").replace(/\s*\(.*?\)\s*/g,"");
      if(!raw.includes(':')) return {k, diff:Infinity};
      const [HH,MM] = raw.split(':').map(Number);
      const dt = new Date(Y, M-1, D, HH, MM, 0);
      return {k, diff: dt - nowTZ};
    });
    let next = cand.filter(x=>x.diff>=0).sort((a,b)=>a.diff-b.diff)[0];
    if(!next) next = cand.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff))[0];
    return next?.k || null;
  }

  /* Ø¶Ù…Ø§Ù† Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ */
  function ensureImsak(t){
    if(!t.Imsak && t.Fajr){
      const pure = t.Fajr.replace(/\s*\(.*?\)\s*/g,"");
      const [H,M] = pure.split(":").map(Number);
      const d = new Date(); d.setHours(H, M-10, 0, 0);
      t.Imsak = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }
    return t;
  }

  /* API (method=0) */
  async function fetchTimings(country, city){
    const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=0`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª");
    const json = await res.json();
    return json.data.timings;
  }

  /* Ø±Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª */
  function renderTimes(timings, tz){
    const t = ensureImsak({...timings});
    const rows = [
      {label:"Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ",    key:"Imsak",   icon:"ğŸŒ™"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø±", key:"Fajr",    icon:"ğŸ•Œ"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¸Ù‡Ø±", key:"Dhuhr",   icon:"â˜€ï¸"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹ØµØ±", key:"Asr",     icon:"ğŸŒ¤ï¸"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨",key:"Maghrib", icon:"ğŸŒ†"},
      {label:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø´Ø§Ø¡",key:"Isha",    icon:"ğŸŒ™"},
      {label:"Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„",key:"Midnight",icon:"ğŸŒŒ"}
    ];
    const nextK = nextPrayerKey(t, tz);
    times.innerHTML = rows.map(r=>trHTML(r.label, r.icon, t[r.key], r.key===nextK)).join("");
  }

  /* Ø§Ù„Ø¯ÙˆÙ„Ø©: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¨ÙˆØ¨ (Pills) */
  function renderCountryPills(active){
    countryPills.innerHTML = "";
    Object.keys(MAP).forEach(code=>{
      const pill = document.createElement('button');
      pill.type = "button";
      pill.className = "pill";
      pill.textContent = countryAR(code);
      pill.setAttribute('aria-selected', code===active ? 'true' : 'false');
      pill.addEventListener('click', ()=> setCountry(code));
      countryPills.appendChild(pill);
    });
  }
  function countryAR(code){
    return ({
      "Bahrain":"Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†","Lebanon":"Ù„Ø¨Ù†Ø§Ù†","Iraq":"Ø§Ù„Ø¹Ø±Ø§Ù‚","Iran":"Ø¥ÙŠØ±Ø§Ù†","Kuwait":"Ø§Ù„ÙƒÙˆÙŠØª","Saudi Arabia":"Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"
    })[code] || code;
  }

  /* Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© */
  function openCitySheet(){ citySheet.classList.add('open'); }
  function closeCitySheet(){ citySheet.classList.remove('open'); }
  function buildCityGrid(country){
    const list = MAP[country]?.cities || [];
    cityGrid.innerHTML = list.map(c=>(
      `<div class="cityCard" data-en="${c.en}" data-ar="${c.ar}">
        <span class="ccDot">ğŸ™</span><span>${c.ar}</span>
      </div>`
    )).join("");
    Array.from(cityGrid.querySelectorAll('.cityCard')).forEach(card=>{
      card.addEventListener('click', ()=>{
        const en = card.getAttribute('data-en'); const ar = card.getAttribute('data-ar');
        citySearch.value = ar;
        closeCitySheet();
        setCity(currentCountry, en, ar);
      });
    });
  }
  function filterCityGrid(q){
    q = (q||"").trim();
    Array.from(cityGrid.children).forEach(c=>{
      const ar = c.getAttribute('data-ar'); const en = c.getAttribute('data-en');
      const show = !q || ar.includes(q) || en.toLowerCase().includes(q.toLowerCase());
      c.style.display = show ? "" : "none";
    });
  }

  /* ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® + Ø§Ù„Ù…ÙƒØ§Ù† + Ø§Ù„Ø³Ø§Ø¹Ø©) */
  function updateTop(country, cityEn){
    const tz = MAP[country]?.tz || MAP[DEFAULT_COUNTRY].tz;
    const cityObj = (MAP[country]?.cities || []).find(x=>x.en===cityEn) || {ar:cityEn};
    placeLabel.textContent = `${countryAR(country)} â€“ ${cityObj.ar}`;
    hijri.textContent = fmtHijri(tz);
    greg.textContent  = fmtGreg(tz);
    clearInterval(window._clk);
    clock.textContent = fmtClock(tz);
    window._clk = setInterval(()=>{ clock.textContent = fmtClock(tz); }, 1000);
    return tz;
  }

  /* Ø­Ø§Ù„Ø§Øª ÙˆØªØ¯ÙÙ‚ */
  let currentCountry = DEFAULT_COUNTRY;
  let currentCityEn  = MAP[DEFAULT_COUNTRY].cities[0].en;

  function setCountry(code){
    currentCountry = code;
    renderCountryPills(code);
    citySearch.value = ""; openCitySheet(); buildCityGrid(code); filterCityGrid("");
    // ØªØ¹ÙŠÙŠÙ† Ø£ÙˆÙ„ Ù…Ø¯ÙŠÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    const first = MAP[code]?.cities?.[0]; if(first){ setCity(code, first.en, first.ar, {skipFetch:true}); }
    load(); // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ÙÙˆØ±Ù‹Ø§ Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  }
  function setCity(country, en, ar, opts={}){
    currentCountry = country;
    currentCityEn = en;
    citySearch.value = ar || citySearch.value;
    load(opts);
  }

  async function load(opts={}){
    const tz = updateTop(currentCountry, currentCityEn);
    times.innerHTML = `<tr><td colspan="2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØªâ€¦</td></tr>`;
    try{
      const timings = opts.skipFetch ? null : await fetchTimings(currentCountry, currentCityEn);
      if(timings) renderTimes(timings, tz);
      else { // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¯ÙˆÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ù„Ø¨
        const t = await fetchTimings(currentCountry, currentCityEn);
        renderTimes(t, tz);
      }
    }catch(e){
      console.error(e);
      times.innerHTML = `<tr><td colspan="2" style="color:#b91c1c">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.</td></tr>`;
    }
  }

  /* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ */
  function init(){
    setRandomHadith();
    renderCountryPills(currentCountry);
    buildCityGrid(currentCountry);
    // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø¨Ø­Ø±ÙŠÙ† â€“ Ø§Ù„Ù…Ù†Ø§Ù…Ø©
    setCountry(DEFAULT_COUNTRY);
    cityOpen.addEventListener('click', ()=> citySheet.classList.toggle('open'));
    citySearch.addEventListener('input', (e)=> filterCityGrid(e.target.value));
    document.addEventListener('click', (e)=>{
      if(!e.target.closest('.cityPicker')) closeCitySheet();
    });
  }
  init();
</script>
</body>
</html>
