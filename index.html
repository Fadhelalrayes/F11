<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <!-- صفحة مواقيت صلاة — تصميم مُنظَّم يشبه الصورة، والبيانات تُجلب مباشرة من واجهة "حقيبة المؤمن" -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>مواقيت الصلاة — حقيبة المؤمن</title>
  <meta name="description" content="واجهة عربية أنيقة تعرض مواقيت الصلاة مباشرة من API حقيبة المؤمن، مع عد تنازلي للأذان، ودعم الهواتف.">

  <!-- سياسة أمان تسمح بالاتصال بـ hq.alkafeel.net فقط -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'nonce-pt123';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 connect-src 'self' https://hq.alkafeel.net;
                 object-src 'none';
                 base-uri 'none';
                 frame-ancestors 'none';
                 form-action 'self';
                 upgrade-insecure-requests;
                 block-all-mixed-content">

  <style>
    :root{
      --bg:#f3f3f5;          /* خلفية فاتحة تشبه التطبيق */
      --bar:#b99f6a;         /* لون شريط العنوان */
      --card:#ffffff;        /* بطاقات القوائم */
      --text:#191c1f;
      --muted:#6c747c;
      --accent:#00b563;
      --bd:#e8e8ea;
      --radius:14px;
      --shadow:0 6px 20px rgba(0,0,0,.06);
      --maxw: 560px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e1113; --bar:#8f7a4f; --card:#161a1c; --text:#e8edf0; --muted:#9aa4ad; --bd:#283036; --shadow:0 10px 26px rgba(0,0,0,.35);
      }
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Naskh Arabic", Arial, sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      display:grid; place-items:start center; min-height:100vh;
    }

    /* شريط علوي */
    .appbar{
      position:sticky; top:0; z-index:10; width:100%;
      background: var(--bar); color:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.08);
    }
    .barin{
      max-width: var(--maxw); margin:auto; padding:10px 12px; display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .title{
      display:flex; flex-direction:column; gap:2px
    }
    .title b{font-size:1.05rem; letter-spacing:.2px}
    .title small{opacity:.9}

    .wrap{inline-size:100%; max-width: var(--maxw); padding:14px; margin:auto}

    .datecard{
      background: var(--card); border:1px solid var(--bd); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:12px; display:grid; grid-template-columns: auto 1fr auto; align-items:center; gap:10px;
    }
    .arrow{
      inline-size:38px; block-size:38px; display:grid; place-items:center;
      border-radius:10px; border:1px solid var(--bd); background:#fff0; color:#fff;
      opacity:.55; cursor:not-allowed; /* تُركت لواجهة فقط (لا تاريخ مخصّص من API) */
    }
    @media (prefers-color-scheme: light){ .arrow{ color:#000 } }
    .dates{
      display:flex; flex-direction:column; text-align:center;
    }
    .dates b{font-size:1rem}
    .dates small{color:var(--muted)}

    /* بطاقة كل صلاة */
    .list{
      margin-top:12px; display:flex; flex-direction:column; gap:10px;
    }
    .item{
      background: var(--card); border:1px solid var(--bd); border-radius:12px; box-shadow: var(--shadow);
      padding:12px 14px;
    }
    .row{
      display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px;
    }
    .label{ font-weight:700 }
    .time{ font-size:1.25rem; font-weight:800 }
    .sub{ margin:.5rem 0 0; color: var(--muted); font-size:.95rem }

    /* أزرار تحكم سفلية */
    .controls{
      margin-top:14px; display:flex; gap:8px; flex-wrap:wrap
    }
    .btn{
      border:1px solid var(--bd); border-radius:12px; padding:.7rem .9rem; background:var(--card); box-shadow: var(--shadow); cursor:pointer;
    }
    .btn.primary{ background: var(--accent); border-color: transparent; color:#fff; font-weight:800 }
    .note{ margin:10px 2px 0; color: var(--muted); font-size:.95rem }

    /* رسالة خطأ/تنبيه */
    .alert{
      margin-top:12px; background:#ffeeee; color:#8b1c1c; border:1px solid #f3c9c9; border-radius:12px; padding:.8rem .9rem; display:none;
    }
    @media (prefers-color-scheme: dark){
      .alert{ background:#311; color:#f7bcbc; border-color:#522 }
    }
  </style>
</head>
<body>
  <!-- الشريط العلوي -->
  <div class="appbar" role="banner">
    <div class="barin">
      <button class="btn" id="geoBtn" title="استخدم موقعي">📍 موقعي</button>
      <div class="title" aria-live="polite">
        <b id="city">Tubli – Bahrain</b>
        <small id="todayTitles">الأحد 26 ربيع الثاني 1447 · 19 أكتوبر 2025</small>
      </div>
      <button class="btn" id="refreshBtn" title="تحديث">↻ تحديث</button>
    </div>
  </div>

  <!-- المحتوى -->
  <main class="wrap" role="main" aria-labelledby="pageTitle">
    <h1 id="pageTitle" class="sr-only">مواقيت الصلاة — حقيبة المؤمن</h1>

    <!-- بطاقة التاريخ -->
    <section class="datecard" aria-label="العناوين والتاريخ">
      <button class="arrow" aria-label="اليوم السابق" title="اليوم السابق">‹</button>
      <div class="dates">
        <b id="hijriDate">—</b>
        <small id="gregDate">—</small>
      </div>
      <button class="arrow" aria-label="اليوم التالي" title="اليوم التالي">›</button>
    </section>

    <!-- قائمة المواقيت على شكل بطاقات مثل الصورة -->
    <section class="list" aria-live="polite" id="timesWrap" aria-busy="false">
      <article class="item">
        <div class="row">
          <div class="label">الفجر</div>
          <div class="time" id="t-fajr">—</div>
        </div>
        <div class="sub" id="fajrCountdown" aria-hidden="true">متبقي على الأذان —:—:—</div>
      </article>

      <article class="item">
        <div class="row">
          <div class="label">الشروق</div>
          <div class="time" id="t-sunrise">—</div>
        </div>
      </article>

      <article class="item">
        <div class="row">
          <div class="label">الظهر</div>
          <div class="time" id="t-dhuhr">—</div>
        </div>
      </article>

      <article class="item">
        <div class="row">
          <div class="label">الغروب</div>
          <div class="time" id="t-sunset">—</div>
        </div>
      </article>

      <article class="item">
        <div class="row">
          <div class="label">المغرب</div>
          <div class="time" id="t-maghrib">—</div>
        </div>
      </article>

      <article class="item">
        <div class="row">
          <div class="label">منتصف الليل</div>
          <div class="time" id="t-midnight">—</div>
        </div>
      </article>
    </section>

    <!-- تحكم يدوي (للضبط السريع) -->
    <section class="controls" aria-label="إعدادات سريعة">
      <button class="btn primary" id="applyBahrain" type="button">تعيين: البحرين (Tubli) +3</button>
      <button class="btn" id="customBtn" type="button">إدخال إحداثيات يدويًا</button>
      <small class="note">لا نُخزن موقعك. نُرسل الإحداثيات فقط لواجهة حقيبة المؤمن لحساب المواقيت.</small>
      <div class="alert" id="errorBox" role="alert"></div>
    </section>
  </main>

  <!-- سكربت جلب وعرض المواقيت (Nonce مطابق لـ CSP) -->
  <script nonce="pt123">
  (function(){
    'use strict';

    /* عناصر DOM */
    const el = {
      city:   document.getElementById('city'),
      hdate:  document.getElementById('hijriDate'),
      gdate:  document.getElementById('gregDate'),
      wrap:   document.getElementById('timesWrap'),
      fajr:   document.getElementById('t-fajr'),
      sunrise:document.getElementById('t-sunrise'),
      dhuhr:  document.getElementById('t-dhuhr'),
      sunset: document.getElementById('t-sunset'),
      maghrib:document.getElementById('t-maghrib'),
      midnight:document.getElementById('t-midnight'),
      fajrCd: document.getElementById('fajrCountdown'),
      error:  document.getElementById('errorBox'),
      titles: document.getElementById('todayTitles'),
      geoBtn: document.getElementById('geoBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      applyBH: document.getElementById('applyBahrain'),
      customBtn: document.getElementById('customBtn')
    };

    /* تنسيقات مساعدة */
    const fmtTime = v => (v && /^\d{1,2}:\d{2}/.test(v)) ? v : '—';
    const busy = b => el.wrap.setAttribute('aria-busy', b ? 'true' : 'false');

    /* نَسق افتراضي: Tubli – Bahrain */
    let state = {
      lat: 26.2189,
      lon: 50.5903,
      tz: '+3',
      place: 'Tubli – Bahrain'
    };

    /* جلب من واجهة حقيبة المؤمن */
    async function fetchFromKafeel(lat, lon, tz){
      const url = `https://hq.alkafeel.net/Api/init/init.php?timezone=${encodeURIComponent(tz)}&long=${encodeURIComponent(lon)}&lati=${encodeURIComponent(lat)}&v=jsonPrayerTimes`;
      const res = await fetch(url, { method:'GET', mode:'cors', cache:'no-store', referrerPolicy:'no-referrer' });
      if(!res.ok) throw new Error('تعذّر الاتصال بواجهة حقيبة المؤمن');
      return await res.json();
    }

    /* عرض القيم على الواجهة (يشبه تطبيق البطائق في الصورة) */
    function paint(data){
      // العناوين والتواريخ
      el.hdate.textContent = data.date || data.hDate || '—';
      const now = new Date();
      el.gdate.textContent = now.toLocaleDateString('ar', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      el.titles.textContent = `${el.hdate.textContent} · ${el.gdate.textContent}`;

      // المواقيت
      el.fajr.textContent    = fmtTime(data.fajir) || fmtTime(data.fajr);
      el.sunrise.textContent = fmtTime(data.sunrise);
      el.dhuhr.textContent   = fmtTime(data.dhuhr);
      el.sunset.textContent  = fmtTime(data.sunset);
      el.maghrib.textContent = fmtTime(data.maghrib);
      el.midnight.textContent= fmtTime(data.midnight) || fmtTime(data.midNight);

      // عدّ تنازلي للفجر إذا كان القادم
      setupCountdown(data);
    }

    /* تحويل "HH:MM" لوقت اليوم */
    function todayAt(hhmm){
      if(!/^\d{1,2}:\d{2}$/.test(hhmm)) return null;
      const [h,m] = hhmm.split(':').map(Number);
      const d = new Date(); d.setSeconds(0,0); d.setHours(h, m, 0, 0);
      return d;
    }

    /* تحديد الصلاة القادمة وبناء العد التنازلي (نُظهره تحت الفجر مثل الصورة) */
    let cdTimer = null;
    function setupCountdown(times){
      if(cdTimer) clearInterval(cdTimer);
      el.fajrCd.setAttribute('aria-hidden','true');
      el.fajrCd.textContent = 'متبقي على الأذان —:—:—';

      const order = [
        { id:'الفجر',    t: todayAt(times.fajir || times.fajr) },
        { id:'الظهر',    t: todayAt(times.dhuhr) },
        { id:'العصر',    t: todayAt(times.asr) },
        { id:'المغرب',   t: todayAt(times.maghrib) },
        { id:'العشاء',   t: todayAt(times.isha) }
      ].filter(x => x.t);

      const now = new Date();
      let next = order.find(x => x.t > now);

      // إن لم يوجد وقت متبقٍ اليوم، لا نعرض العد — (تبسيط)
      if(!next) return;

      // نعرض العد تحت أول بطاقة (كما في الصورة "متبقي على الأذان")
      el.fajrCd.removeAttribute('aria-hidden');

      function tick(){
        const diff = next.t - new Date();
        if(diff <= 0){ el.fajrCd.textContent = 'حان وقت الأذان'; clearInterval(cdTimer); return; }
        const hh = Math.floor(diff/3_600_000);
        const mm = Math.floor((diff%3_600_000)/60_000);
        const ss = Math.floor((diff%60_000)/1_000);
        el.fajrCd.textContent = `متبقي على الأذان ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
      }
      tick();
      cdTimer = setInterval(tick, 1000);
    }

    /* تحميل المواقيت */
    async function loadTimes(){
      try{
        busy(true);
        el.error.style.display = 'none';
        el.city.textContent = state.place;
        const data = await fetchFromKafeel(state.lat, state.lon, state.tz);
        paint(data || {});
      }catch(err){
        console.error(err);
        el.error.textContent = 'حدثت مشكلة في جلب المواقيت. تحقق من الاتصال أو جرّب لاحقًا.';
        el.error.style.display = 'block';
      }finally{
        busy(false);
      }
    }

    /* أزرار التحكم */
    el.applyBH.addEventListener('click', ()=>{ state = { lat:26.2189, lon:50.5903, tz:'+3', place:'Tubli – Bahrain' }; loadTimes(); });
    el.refreshBtn.addEventListener('click', loadTimes);
    el.geoBtn.addEventListener('click', ()=>{
      if(!('geolocation' in navigator)){ el.error.textContent = 'متصفحك لا يدعم تحديد الموقع.'; el.error.style.display='block'; return; }
      navigator.geolocation.getCurrentPosition(p=>{
        const tz = (new Date().getTimezoneOffset() / -60) || +3;
        state = { lat:+p.coords.latitude.toFixed(6), lon:+p.coords.longitude.toFixed(6), tz: (tz>0?`+${tz}`:`${tz}`), place:'موقعي الحالي' };
        loadTimes();
      }, e=>{
        el.error.textContent = 'تم رفض إذن الموقع أو حدث خطأ. يمكنك استخدام زر "تعيين: البحرين".';
        el.error.style.display = 'block';
      }, { enableHighAccuracy:false, timeout:10000, maximumAge:0 });
    });

    el.customBtn.addEventListener('click', ()=>{
      const lat = prompt('أدخل خط العرض (lat):', state.lat);
      const lon = prompt('أدخل خط الطول (lon):', state.lon);
      const tz  = prompt('أدخل المنطقة الزمنية (مثال: +3 أو -4):', state.tz);
      if(lat && lon && tz){ state = { lat:+lat, lon:+lon, tz:tz.trim(), place:'إحداثيات مخصّصة' }; loadTimes(); }
    });

    // تشغيل أولي — البحرين Tubli
    loadTimes();
  })();
  </script>
</body>
</html>
