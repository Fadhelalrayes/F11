<script>
/* =================== الإعدادات =================== */
const CONFIG = {
  // تيكر مباشر عبر WebSocket (Binance)
  CRYPTO_SYMBOLS: ["btcusdt","ethusdt","solusdt","bnbusdt","xrpusdt"], // اكتب بالحروف الصغيرة
  // أسعار الصرف: مصدر أساسي + احتياطي
  FX_PRIMARY:  "https://open.er-api.com/v6/latest/USD",
  FX_FALLBACK: "https://api.frankfurter.app/latest?from=USD",
  REFRESH_MS: 15000,         // لتحديث التنبؤات/التوصيات والتنبيهات
  NEWS_REFRESH_MS: 120000    // تحديث الأخبار (الكود عندك سابقًا كما هو)
};

/* =================== أدوات مساعدة =================== */
const $ = s => document.querySelector(s);
function fmt(n,d=2){ if(n==null||Number.isNaN(n)) return "—"; return Number(n).toLocaleString('en-US',{maximumFractionDigits:d}); }
function now(){ const d=new Date(),p=n=>String(n).padStart(2,"0"); $("#lastUpdated").textContent = `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
function arabicName(symbol){
  const map = {
    "BTCUSD":"بيتكوين/دولار","ETHUSD":"إيثريوم/دولار","SOLUSD":"سولانا/دولار","BNBUSD":"بي إن بي/دولار","XRPUSD":"ريبل/دولار",
    "EURUSD":"يورو/دولار","USDJPY":"دولار/ين","USDBHD":"دولار/دينار بحريني","USDSAR":"دولار/ريال سعودي",
    "USDAED":"دولار/درهم إماراتي","GBPUSD":"جنيه/دولار","USDTRY":"دولار/ليرة تركية"
  };
  return map[symbol] || symbol;
}

/* =================== الحالة =================== */
let WS;                  // اتصال WebSocket للعملات الرقمية
let CRYPTO = {};         // رمز → { last, change, vol }
let FX = [];             // قائمة أزواج صرف {symbol,last,change,vol}

/* =================== WebSocket: Binance =================== */
function openCryptoStream(){
  try { if(WS) WS.close(); } catch(_){}
  const streams = CONFIG.CRYPTO_SYMBOLS.map(s=>`${s}@ticker`).join('/');
  WS = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
  WS.onopen = () => { /* متصل */ };
  WS.onmessage = ev => {
    const msg = JSON.parse(ev.data);
    const t = msg.data; // بيانات التيكر
    const sym = (t.s||"").replace("USDT","USD"); // BTCUSDT → BTCUSD
    CRYPTO[sym] = {
      symbol: sym,
      last: +t.c,                     // آخر سعر
      change: +t.P,                   // % 24 ساعة
      vol: +t.v                       // حجم 24 ساعة
    };
    renderAll(); // تحديث مباشر كل وصول
  };
  WS.onerror = () => { /* تجاهل، سيظل الاتصال يحاول */ };
  WS.onclose  = () => { setTimeout(openCryptoStream, 2000); }; // إعادة محاولة تلقائية
}

/* =================== أسعار الصرف (أساسي + احتياطي) =================== */
async function fetchText(url, timeout=8000){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeout);
  try{ const r=await fetch(url,{signal:ctrl.signal,headers:{'Cache-Control':'no-cache'}}); if(!r.ok) throw new Error(r.status); return await r.text(); }
  finally{ clearTimeout(t); }
}

async function loadFXPrimary(){
  try{
    const txt = await fetchText(`${CONFIG.FX_PRIMARY}?_=${Date.now()}`);
    const d = JSON.parse(txt);
    if(d.result!=="success") throw 0;
    const r=d.rates||{}, out=[];
    const push=(k,v)=>out.push({symbol:k,last:+v,change:0,vol:0});
    if(r.EUR) push("EURUSD",1/r.EUR);
    if(r.JPY) push("USDJPY",r.JPY);
    if(r.BHD) push("USDBHD",r.BHD);
    if(r.SAR) push("USDSAR",r.SAR);
    if(r.AED) push("USDAED",r.AED);
    if(r.GBP) push("GBPUSD",1/r.GBP);
    if(r.TRY) push("USDTRY",r.TRY);
    return out;
  }catch(_){ return null; }
}
async function loadFXFallback(){
  try{
    const txt = await fetchText(`${CONFIG.FX_FALLBACK}?_=${Date.now()}`);
    const d = JSON.parse(txt); // { rates: { EUR:0.93, ... }, base:'USD' }
    const r=d.rates||{}, out=[];
    const push=(k,v)=>out.push({symbol:k,last:+v,change:0,vol:0});
    if(r.EUR) push("EURUSD",1/r.EUR);
    if(r.JPY) push("USDJPY",r.JPY);
    if(r.GBP) push("GBPUSD",1/r.GBP);
    if(r.TRY) push("USDTRY",r.TRY);
    // قد لا يوفر BHD/SAR/AED؛ نتجاوزها إن لم تتوفر
    return out;
  }catch(_){ return []; }
}
async function loadFXAll(){
  const p = await loadFXPrimary();
  FX = p ?? await loadFXFallback();
}

/* =================== بناء المشتقات =================== */
function buildForecastRows(list){
  return list.map(p=>{
    const m=(p.change||0)/100, conf=Math.min(0.9,Math.max(0.35,Math.abs(m)*3.5));
    const sig=m>0.003?"bull":m<-0.003?"bear":"neutral";
    return {symbol:p.symbol, f5:p.last*(1+m*0.2), f1h:p.last*(1+m*0.6), f1d:p.last*(1+m*1.2), conf:Math.round(conf*100), sig};
  });
}
function buildRecommendations(list){
  const buy=[],sell=[];
  for(const p of list){ if(p.change>=1.5) buy.push(p); if(p.change<=-1.5) sell.push(p); }
  return {buy,sell};
}
function buildAlerts(list){
  return list.filter(p=>Math.abs(p.change)>=3).map(p=>({symbol:p.symbol,msg:`تغيّر ${p.change.toFixed(2)}%`}));
}

/* =================== العرض =================== */
function renderPrices(listAll){
  const tb=$("#pricesTbody"); tb.innerHTML="";
  if(!listAll.length){ tb.innerHTML='<tr><td colspan="4" class="empty">لا توجد بيانات متاحة حاليًا</td></tr>'; return; }
  for(const p of listAll){
    const tr=document.createElement("tr");
    const digits = p.symbol.endsWith("USD") ? (p.symbol.startsWith("USD")?5:4) : 4;
    tr.innerHTML = `
      <td><b>${arabicName(p.symbol)}</b></td>
      <td>${fmt(p.last,digits)}</td>
      <td style="font-weight:800;color:${p.change>=0?'#0a7a2f':'#b11a1a'}">${p.change>=0?'↑':'↓'} ${fmt(Math.abs(p.change),2)}%</td>
      <td>${fmt(p.vol,0)}</td>`;
    tb.appendChild(tr);
  }
}
function renderForecast(listAll){
  const tb=$("#forecastTbody"); tb.innerHTML="";
  if(!listAll.length){ tb.innerHTML='<tr><td colspan="6" class="empty">لا توجد بيانات متاحة حاليًا</td></tr>'; return; }
  const rows=buildForecastRows(listAll);
  for(const f of rows){
    const cls=f.sig==="bull"?"bull":f.sig==="bear"?"bear":"neutral";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>${arabicName(f.symbol)}</b></td>
      <td>${fmt(f.f5,2)}</td>
      <td>${fmt(f.f1h,2)}</td>
      <td>${fmt(f.f1d,2)}</td>
      <td>${f.conf}%</td>
      <td><span class="pill ${cls}">${f.sig==="bull"?"صاعد":f.sig==="bear"?"هابط":"محايد"}</span></td>`;
    tb.appendChild(tr);
  }
}
function renderRecommendations(listAll){
  const {buy,sell}=buildRecommendations(listAll);
  const b=$("#buyList"), s=$("#sellList");
  b.innerHTML=""; s.innerHTML="";
  if(!buy.length) b.innerHTML='<div class="empty">لا توجد توصيات شراء حاليًا</div>';
  if(!sell.length) s.innerHTML='<div class="empty">لا توجد توصيات بيع حاليًا</div>';
  for(const r of buy){ const d=document.createElement("div"); d.className="alert"; d.innerHTML=`<b>${arabicName(r.symbol)}</b> — إشارة شراء (زخم إيجابي)`; b.appendChild(d); }
  for(const r of sell){ const d=document.createElement("div"); d.className="alert"; d.innerHTML=`<b>${arabicName(r.symbol)}</b> — إشارة بيع (زخم سلبي)`; s.appendChild(d); }
}
function renderAlerts(listAll){
  const arr=buildAlerts(listAll), a=$("#alertsList"); a.innerHTML="";
  if(!arr.length){ a.innerHTML='<div class="empty">لا توجد تنبيهات حاليًا</div>'; return; }
  for(const x of arr){ const d=document.createElement("div"); d.className="alert"; d.innerHTML=`<b>${arabicName(x.symbol)}</b> — ${x.msg}`; a.appendChild(d); }
}

/* حزمة واحدة للتحديث الكامل */
function renderAll(){
  // جمع العملات الرقمية من الويب سوكِت + إضافة أسعار الصرف
  const cryptoList = Object.values(CRYPTO);
  const listAll = cryptoList.concat(FX);
  renderPrices(listAll);
  renderForecast(listAll);
  renderRecommendations(listAll);
  renderAlerts(listAll);
  now();
}

/* =================== التشغيل =================== */
async function init(){
  openCryptoStream();   // يبدأ تدفق العملات الرقمية فورًا
  await loadFXAll();    // تحميل أسعار الصرف (مع احتياطي)
  renderAll();
  // إعادة حساب المشتقات دوريًا (حتى لو لم تصل رسائل WS لوهلة)
  setInterval(renderAll, CONFIG.REFRESH_MS);
}
init();
</script>
