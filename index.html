from transformers import VisionEncoderDecoderModel
import torch, os

# 1) Retrouver le meilleur checkpoint connu par le trainer
best_ckpt = getattr(trainer.state, "best_model_checkpoint", None)
if best_ckpt is None:
    # au cas où, mets le dernier step qui te semblait meilleur (ex: 500)
    best_ckpt = "trocr_rimes_ckpt/checkpoint-500"

print("Meilleur checkpoint:", best_ckpt)

# 2) Charger ce checkpoint
device = "cuda" if torch.cuda.is_available() else "cpu"
best_model = VisionEncoderDecoderModel.from_pretrained(best_ckpt).to(device)

# 3) Évaluer (val + test) et afficher
trainer.model = best_model
val_metrics  = trainer.evaluate(eval_dataset=val_ds, metric_key_prefix="val")
test_metrics = trainer.evaluate(eval_dataset=test_ds)
print("VAL:", {k: float(f"{v:.6f}") if isinstance(v,float) else v for k,v in val_metrics.items()})
print("TEST:", {k: float(f"{v:.6f}") if isinstance(v,float) else v for k,v in test_metrics.items()})

# 4) Sauvegarder proprement
save_dir = "trocr_rimes_best_now"
best_model.save_pretrained(save_dir)
processor.save_pretrained(save_dir)
print("✔️ sauvegardé dans:", save_dir)
