<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>سيرة ذاتية — مُعالج بسيط احترافي (البحرين)</title>
<style>
  :root{
    --bg:#ffffff; --fg:#0f172a; --muted:#475569;
    --accent:#C7A046;        /* ذهبي */
    --accent-weak:#EAD9A2;   /* ذهبي فاتح */
    --border:#e5e7eb; --chip:#f8fafc;
    --radius:14px; --shadow:0 8px 28px rgba(15,23,42,.06);
  }
  html,body{background:var(--bg);color:var(--fg);font-family:"Cairo","Noto Naskh Arabic",system-ui,Arial;line-height:1.5}
  *{box-sizing:border-box}
  a{color:var(--accent);text-decoration:none}

  .wrap{max-width:900px;margin:20px auto;padding:0 14px}
  /* Stepper */
  .stepper{position:sticky;top:0;z-index:5;background:#fff;border:1px solid var(--border);
    border-radius:12px;box-shadow:var(--shadow);padding:10px 12px;margin-bottom:14px}
  .steps{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .step{flex:1;display:flex;align-items:center;gap:8px;opacity:.6}
  .step.active{opacity:1}
  .dot{width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;
    background:var(--accent-weak);color:#7a5a16;font-weight:800}
  .bar{height:3px;background:var(--accent-weak);border-radius:99px;flex:1}
  .steps .between{flex:1;margin:0 6px}
  .head-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:flex-end}
  .btn{border:1px solid var(--accent);background:var(--accent);color:#fff;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.ghost{background:#fff;color:var(--accent)}
  .btn.s{padding:6px 9px;font-size:12px;border-radius:8px}
  .btn.icon{display:inline-flex;align-items:center;gap:6px}
  .hide{display:none}

  /* Sections (accordion-ish like your screenshots) */
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:12px}
  .card-h{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
  .card-h h2{margin:0;font-size:16px;color:#111}
  .toggle{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800}
  .card-b{padding:14px 16px}
  .row{display:grid;gap:10px}
  .two{grid-template-columns:1fr}
  @media(min-width:640px){.two{grid-template-columns:1fr 1fr}}

  label{font-size:13px;color:var(--muted);font-weight:700}
  input[type="text"],input[type="email"],input[type="tel"],input[type="url"],textarea,select{
    width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;outline:none
  }
  textarea{min-height:90px;resize:vertical}
  input:focus,textarea:focus,select:focus{border-color:var(--accent)}
  .hint{font-size:12px;color:var(--muted)}
  .chipline{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 10px;border:1px solid var(--border);background:var(--chip);border-radius:999px;font-size:12px}

  /* Repeat block */
  .rep{border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:8px}
  .rep .rh{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .icon-btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}

  /* Preview */
  .preview.card-b{padding:18px}
  .cv{border:1px solid var(--border);border-radius:12px;padding:22px}
  .cv h1{font-size:22px;margin:0 0 4px;font-weight:900}
  .cv .sub{color:var(--muted);margin:0 0 10px}
  .cv .barline{height:2px;background:var(--accent);margin:8px 0 14px}
  .cv .sec{margin-bottom:14px}
  .cv .sec h3{font-size:14px;margin:0 0 6px;position:relative;padding-bottom:5px}
  .cv .sec h3:after{content:"";position:absolute;inset-inline:0;bottom:0;height:2px;background:var(--accent-weak)}
  .cv .meta{font-size:12px;color:var(--muted)}
  .cv .chipline .chip{font-size:11px}
  .cv ul{margin:6px 0 0 18px} .cv li{margin:4px 0}

  /* Floating preview button (like in shots) */
  .fab{position:fixed;inset-inline-start:16px;inset-block-end:16px;z-index:10}
  .fab button{display:flex;align-items:center;gap:8px;border-radius:24px}

  /* Print */
  @page{size:A4;margin:18mm}
  @media print{
    .no-print{display:none!important}
    .cv{border:none;padding:0}
  }
  :focus-visible{outline:3px solid var(--accent-weak);outline-offset:2px}
</style>
</head>
<body>
<div class="wrap">

  <!-- Stepper -->
  <div class="stepper no-print">
    <div class="steps">
      <div class="step" id="st1"><span class="dot">1</span><strong>شخصي</strong></div>
      <div class="between bar"></div>
      <div class="step" id="st2"><span class="dot">2</span><strong>تجارب ومهارات</strong></div>
      <div class="between bar"></div>
      <div class="step" id="st3"><span class="dot">3</span><strong>معاينة وتصدير</strong></div>
    </div>
    <div class="head-actions">
      <button class="btn icon" id="btnPdf" title="طباعة PDF">🖨️ PDF</button>
      <button class="btn ghost icon" id="btnDoc" title="تنزيل Word">⬇️ Word</button>
      <button class="btn ghost icon" id="btnSave">💾 حفظ</button>
      <label class="btn ghost icon" for="jsonFile" style="cursor:pointer;">📂 استيراد</label>
      <input id="jsonFile" type="file" accept="application/json" class="hide">
      <select id="dirSel" class="btn ghost s">
        <option value="rtl" selected>RTL</option><option value="ltr">LTR</option>
      </select>
    </div>
  </div>

  <!-- القسم 1: شخصي -->
  <section class="card" data-step="1">
    <div class="card-h">
      <h2>التفاصيل الشخصية</h2>
      <button class="toggle" aria-expanded="true">+</button>
    </div>
    <div class="card-b">
      <div class="row two">
        <div><label>الاسم الكامل *</label><input id="fullName" type="text" placeholder="مثال: علي حسن محمد" required></div>
        <div><label>المسمّى الوظيفي المستهدف *</label><input id="title" type="text" placeholder="مثال: مطوّر برمجيات" required></div>
        <div><label>البريد الإلكتروني *</label><input id="email" type="email" placeholder="name@example.com" required></div>
        <div><label>الهاتف (البحرين) *</label><input id="phone" type="tel" placeholder="+973 3xxxxxxx" required></div>
        <div><label>المدينة / الدولة *</label><input id="location" type="text" value="المنامة، البحرين" required></div>
        <div><label>العنوان</label><input id="address" type="text" placeholder="اختياري"></div>
      </div>

      <div class="row">
        <div><label>ملخّص مهني (3–4 جمل)</label>
          <textarea id="summary" maxlength="450" placeholder="مختصر قوي يبرز القيمة والإنجازات بالأرقام"></textarea>
          <div class="hint"><span id="sumCount">0</span> / 450</div>
        </div>
      </div>

      <div class="chipline" style="margin-top:6px">
        <button class="btn s ghost" data-add="cpr">+ الرقم الشخصي (CPR)</button>
        <button class="btn s ghost" data-add="license">+ رخصة القيادة</button>
        <button class="btn s ghost" data-add="nationality">+ الجنسية</button>
        <button class="btn s ghost" data-add="linkedin">+ LinkedIn</button>
        <button class="btn s ghost" data-add="website">+ الموقع الإلكتروني</button>
        <button class="btn s ghost" data-add="custom">+ حقل مخصص</button>
      </div>
      <div id="extraBox"></div>
    </div>
  </section>

  <!-- القسم 2: خبرة/تعليم/مهارات/لغات -->
  <section class="card" data-step="2">
    <div class="card-h">
      <h2>الخبرة العملية</h2>
      <button class="toggle" aria-expanded="false">+</button>
    </div>
    <div class="card-b hide" id="expWrap">
      <div class="hint">أضف حتى 3 وظائف بإنجازات قصيرة قابلة للقياس.</div>
      <div id="expList"></div>
      <button class="btn s ghost" id="addExp">+ إضافة خبرة</button>
    </div>
  </section>

  <section class="card" data-step="2">
    <div class="card-h">
      <h2>المؤهلات الدراسية</h2>
      <button class="toggle" aria-expanded="false">+</button>
    </div>
    <div class="card-b hide" id="eduWrap">
      <div id="eduList"></div>
      <button class="btn s ghost" id="addEdu">+ إضافة مؤهل</button>
    </div>
  </section>

  <section class="card" data-step="2">
    <div class="card-h">
      <h2>المهارات</h2>
      <button class="toggle" aria-expanded="false">+</button>
    </div>
    <div class="card-b hide">
      <label>اكتب المهارة واضغط Enter (حتى 12)</label>
      <input id="skillInput" type="text" placeholder="مثال: React / SQL / قيادة فريق">
      <div id="skillChips" class="chipline" aria-live="polite"></div>
    </div>
  </section>

  <section class="card" data-step="2">
    <div class="card-h">
      <h2>اللغات</h2>
      <button class="toggle" aria-expanded="false">+</button>
    </div>
    <div class="card-b hide">
      <div class="row two">
        <select id="langName">
          <option>العربية</option><option>الإنجليزية</option><option>الهندية</option><option>الأوردو</option>
        </select>
        <select id="langLevel">
          <option>Native</option><option>C2</option><option>C1</option><option>B2</option><option>B1</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <button class="btn s ghost" id="addLang">+ إضافة لغة</button>
      </div>
      <div id="langList" class="chipline"></div>
    </div>
  </section>

  <!-- القسم 3: المعاينة -->
  <section class="card" data-step="3">
    <div class="card-h">
      <h2>معاينة</h2>
      <button class="toggle" aria-expanded="true">+</button>
    </div>
    <div class="card-b preview">
      <article id="cv" class="cv" aria-label="معاينة السيرة">
        <h1 id="v_name">اسم المتقدّم</h1>
        <p class="sub" id="v_title">المسمّى المستهدف</p>
        <div class="meta" id="v_contacts">email@example.com · +973 3xxxxxxx · المنامة، البحرين · linkedin.com/in/…</div>
        <div class="barline"></div>

        <section class="sec" id="sec_summary" hidden>
          <h3>الملخّص</h3><p id="v_summary"></p>
        </section>

        <section class="sec" id="sec_exp" hidden>
          <h3>الخبرة العملية</h3><div id="v_exp"></div>
        </section>

        <section class="sec" id="sec_edu" hidden>
          <h3>التعليم</h3><div id="v_edu"></div>
        </section>

        <section class="sec" id="sec_skills" hidden>
          <h3>المهارات</h3><div id="v_skills" class="chipline"></div>
        </section>

        <section class="sec" id="sec_langs" hidden>
          <h3>اللغات</h3><div id="v_langs"></div>
        </section>
      </article>
    </div>
  </section>

  <!-- زر معاينة عائم -->
  <div class="fab no-print">
    <button class="btn icon" id="scrollPreview">🔍 معاينة</button>
  </div>

</div>

<script>
(()=>{
  const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const dirSel=$('#dirSel');

  // Stepper highlight
  function setStep(n){
    [$('#st1'),$('#st2'),$('#st3')].forEach((el,i)=>el.classList.toggle('active', i+1<=n));
  }
  setStep(1);

  // Accordion toggles
  $$('.card .toggle').forEach(btn=>{
    const body=btn.parentElement.nextElementSibling;
    btn.addEventListener('click', ()=>{
      const open = !body.classList.contains('hide');
      body.classList.toggle('hide', open);
      btn.setAttribute('aria-expanded', String(!open));
      // step change hint
      const step = btn.closest('.card').getAttribute('data-step');
      setStep(parseInt(step,10));
    });
  });

  // Floating scroll to preview
  $('#scrollPreview').addEventListener('click', ()=>$('#cv').scrollIntoView({behavior:'smooth',block:'start'}));

  // Direction
  dirSel.addEventListener('change', e=>{
    const dir=e.target.value;
    document.documentElement.setAttribute('dir',dir);
    document.documentElement.setAttribute('lang', dir==='rtl'?'ar':'en');
  });

  // Basic fields + Bahrain phone
  const name=$('#fullName'), title=$('#title'), email=$('#email'), phone=$('#phone'),
        location=$('#location'), address=$('#address'), summary=$('#summary'), sumCount=$('#sumCount');
  function sanitize(s){return (s||'').toString().replace(/\s+/g,' ').trim();}
  function validBHPhone(s){return /^\+?973\d{8}$/.test((s||'').replace(/\s+/g,''));}

  function updateHeader(){
    $('#v_name').textContent = sanitize(name.value) || 'اسم المتقدّم';
    $('#v_title').textContent = sanitize(title.value) || 'المسمّى المستهدف';
    const contacts = [
      sanitize(email.value), sanitize(phone.value), sanitize(location.value||'المنامة، البحرين')
    ].filter(Boolean).join(' · ');
    const links = $('#extraBox .extra[data-type="linkedin"] input')?.value || $('#extraBox .extra[data-type="website"] input')?.value || '';
    const prettyLink = links ? links.split(/[,،]\s*/).map(t=>{
      try{const u=new URL(t.includes('http')?t:'https://'+t);return (u.hostname.replace(/^www\./,'')+u.pathname).replace(/\/$/,'')}
      catch{return t}
    }).join(' · ') : '';
    $('#v_contacts').textContent = [contacts, prettyLink].filter(Boolean).join(' · ') || 'email@example.com · +973 3xxxxxxx · المنامة، البحرين';
  }
  [name,title,email,phone,location,address].forEach(el=>el.addEventListener('input', updateHeader));
  summary.addEventListener('input', e=>{
    sumCount.textContent=e.target.value.length;
    const v=sanitize(e.target.value);
    $('#v_summary').textContent=v;
    $('#sec_summary').hidden=!v;
  });

  // Extras (chips like screenshots)
  const extraBox=$('#extraBox');
  const addMap = {
    cpr:{label:'الرقم الشخصي (CPR)', placeholder:'123456789'},
    license:{label:'رخصة القيادة', placeholder:'سارية'},
    nationality:{label:'الجنسية', placeholder:'بحرينية / أخرى'},
    linkedin:{label:'LinkedIn', placeholder:'linkedin.com/in/username'},
    website:{label:'الموقع الإلكتروني', placeholder:'your-portfolio.com'},
    custom:{label:'حقل مخصص', placeholder:'...'}
  };
  $$('.chipline [data-add]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const type = btn.getAttribute('data-add');
      const cfg = addMap[type];
      const wrap = document.createElement('div');
      wrap.className='row two extra'; wrap.dataset.type=type;
      wrap.style.marginTop='8px';
      wrap.innerHTML = `
        <div><label>${cfg.label}</label><input type="text" placeholder="${cfg.placeholder}"></div>
        <div style="display:flex;align-items:end"><button type="button" class="icon-btn del">حذف</button></div>`;
      extraBox.appendChild(wrap);
      wrap.addEventListener('input', updateHeader);
      wrap.querySelector('.del').addEventListener('click', ()=>{wrap.remove(); updateHeader();});
      updateHeader();
    });
  });

  // Experience blocks (max 3)
  const expList=$('#expList'); $('#addExp').addEventListener('click', ()=>{ if($$('#expList .rep').length<3) expList.appendChild(expItem()); syncExp(); });
  function expItem(data={}){
    const d=Object.assign({role:'',company:'',loc:'المنامة، البحرين',start:'',end:'',b1:'',b2:'',b3:''},data);
    const w=document.createElement('div'); w.className='rep';
    w.innerHTML=`
      <div class="rh"><strong>خبرة</strong>
        <div>
          <button class="icon-btn up">▲</button>
          <button class="icon-btn dn">▼</button>
          <button class="icon-btn del" style="border-color:#dc2626;color:#dc2626">حذف</button>
        </div>
      </div>
      <div class="row two">
        <div><label>المسمّى</label><input class="role" type="text" value="${d.role}" placeholder="مثال: مطوّر واجهات"></div>
        <div><label>الشركة</label><input class="company" type="text" value="${d.company}" placeholder="اسم الشركة"></div>
        <div><label>الموقع</label><input class="loc" type="text" value="${d.loc}"></div>
        <div><label>الفترة</label><div style="display:flex;gap:8px"><input class="start" type="text" placeholder="YYYY-MM" value="${d.start}" style="flex:1"><input class="end" type="text" placeholder="YYYY-MM أو حاضر" value="${d.end}" style="flex:1"></div></div>
      </div>
      <div class="row">
        <div><label>إنجاز #1</label><input class="b1" type="text" value="${d.b1}" placeholder="رفعت الدقة 20% خلال 3 أشهر"></div>
        <div><label>إنجاز #2</label><input class="b2" type="text" value="${d.b2}" placeholder="خفضت التكاليف 15%"></div>
        <div><label>إنجاز #3</label><input class="b3" type="text" value="${d.b3}" placeholder="قدت فريق 4 مهندسين…"></div>
      </div>`;
    w.addEventListener('click', e=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.classList.contains('del')) w.remove();
      if(b.classList.contains('up') && w.previousElementSibling) expList.insertBefore(w, w.previousElementSibling);
      if(b.classList.contains('dn') && w.nextElementSibling) expList.insertBefore(w.nextElementSibling, w);
      syncExp();
    });
    w.addEventListener('input', syncExp);
    return w;
  }
  function syncExp(){
    const vexp=$('#v_exp'); vexp.innerHTML='';
    $$('#expList .rep').forEach(rep=>{
      const role=sanitize($('.role',rep).value), company=sanitize($('.company',rep).value),
            loc=sanitize($('.loc',rep).value), st=sanitize($('.start',rep).value), en=sanitize($('.end',rep).value),
            b1=sanitize($('.b1',rep).value), b2=sanitize($('.b2',rep).value), b3=sanitize($('.b3',rep).value);
      if(!(role||company||b1||b2||b3)) return;
      const it=document.createElement('div'); it.className='item';
      it.innerHTML = `
        <div><strong>${role||''}</strong><span class="meta"> ${company?(' — '+company):''}</span></div>
        <div class="meta">${[loc,[st,en].filter(Boolean).join(' – ')].filter(Boolean).join(' · ')}</div>`;
      const ul=document.createElement('ul'); [b1,b2,b3].filter(Boolean).forEach(t=>{const li=document.createElement('li');li.textContent=t;ul.appendChild(li);});
      it.appendChild(ul); vexp.appendChild(it);
    });
    $('#sec_exp').hidden = vexp.children.length===0;
  }

  // Education blocks (max 2)
  const eduList=$('#eduList'); $('#addEdu').addEventListener('click', ()=>{ if($$('#eduList .rep').length<2) eduList.appendChild(eduItem()); syncEdu(); });
  function eduItem(data={}){
    const d=Object.assign({degree:'',major:'',school:'',date:'',loc:'المنامة، البحرين'},data);
    const w=document.createElement('div'); w.className='rep';
    w.innerHTML=`
      <div class="rh"><strong>تعليم</strong>
        <div>
          <button class="icon-btn up">▲</button>
          <button class="icon-btn dn">▼</button>
          <button class="icon-btn del" style="border-color:#dc2626;color:#dc2626">حذف</button>
        </div>
      </div>
      <div class="row two">
        <div><label>الدرجة</label><input class="degree" type="text" value="${d.degree}" placeholder="بكالوريوس / ماجستير"></div>
        <div><label>التخصص</label><input class="major" type="text" value="${d.major}" placeholder="علوم الحاسب"></div>
        <div><label>المؤسسة</label><input class="school" type="text" value="${d.school}" placeholder="جامعة البحرين"></div>
        <div><label>الموقع</label><input class="loc" type="text" value="${d.loc}"></div>
        <div><label>تاريخ التخرج</label><input class="date" type="text" value="${d.date}" placeholder="YYYY-MM"></div>
      </div>`;
    w.addEventListener('click', e=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.classList.contains('del')) w.remove();
      if(b.classList.contains('up') && w.previousElementSibling) eduList.insertBefore(w, w.previousElementSibling);
      if(b.classList.contains('dn') && w.nextElementSibling) eduList.insertBefore(w.nextElementSibling, w);
      syncEdu();
    });
    w.addEventListener('input', syncEdu);
    return w;
  }
  function syncEdu(){
    const vedu=$('#v_edu'); vedu.innerHTML='';
    $$('#eduList .rep').forEach(rep=>{
      const degree=sanitize($('.degree',rep).value), major=sanitize($('.major',rep).value),
            school=sanitize($('.school',rep).value), loc=sanitize($('.loc',rep).value), date=sanitize($('.date',rep).value);
      if(!(degree||school)) return;
      const it=document.createElement('div'); it.className='item';
      it.innerHTML = `
        <div><strong>${degree}${major?(' — '+major):''}</strong><span class="meta"> ${school?(' — '+school):''}</span></div>
        <div class="meta">${[loc,date].filter(Boolean).join(' · ')}</div>`;
      vedu.appendChild(it);
    });
    $('#sec_edu').hidden = vedu.children.length===0;
  }

  // Skills (chips)
  const skillInput=$('#skillInput'), skillChips=$('#skillChips'), vSkills=$('#v_skills');
  const skills=[];
  skillInput.addEventListener('keydown', e=>{
    const val=sanitize(e.target.value);
    if(e.key==='Enter' && val){
      e.preventDefault();
      if(skills.length>=12) return;
      skills.push(val); e.target.value=''; renderSkills();
    }
  });
  function renderSkills(){
    skillChips.innerHTML=''; vSkills.innerHTML='';
    skills.forEach((t,i)=>{
      const chip=document.createElement('span'); chip.className='chip'; chip.textContent=t; chip.title='إزالة';
      chip.style.cursor='pointer'; chip.addEventListener('click', ()=>{skills.splice(i,1);renderSkills();});
      skillChips.appendChild(chip);
      const v=document.createElement('span'); v.className='chip'; v.textContent=t; vSkills.appendChild(v);
    });
    $('#sec_skills').hidden = skills.length===0;
  }

  // Languages chips
  const langs=[]; $('#addLang').addEventListener('click', ()=>{
    if(langs.length>=5) return;
    langs.push($('#langName').value+': '+$('#langLevel').value); renderLangs();
  });
  function renderLangs(){
    const list=$('#langList'), v=$('#v_langs'); list.innerHTML=''; v.innerHTML='';
    langs.forEach((t,i)=>{
      const c=document.createElement('span'); c.className='chip'; c.textContent=t; c.style.cursor='pointer'; c.title='إزالة';
      c.addEventListener('click', ()=>{langs.splice(i,1);renderLangs();});
      list.appendChild(c);
      const p=document.createElement('p'); p.className='meta'; p.textContent='• '+t; v.appendChild(p);
    });
    $('#sec_langs').hidden = langs.length===0;
  }

  // Export PDF / DOC
  function validate(){
    const errs=[];
    if(!sanitize(name.value)) errs.push('الاسم الكامل');
    if(!sanitize(title.value)) errs.push('المسمّى');
    if(!sanitize(email.value)) errs.push('البريد');
    if(!validBHPhone(phone.value)) errs.push('الهاتف (صيغة البحرين: +973XXXXXXXX)');
    if(!sanitize(location.value)) errs.push('المدينة/الدولة');
    if(errs.length){ alert('أكمل/صحّح:\n• '+errs.join('\n• ')); return false; }
    return true;
  }
  $('#btnPdf').addEventListener('click', ()=>{ if(validate()) window.print(); });
  $('#btnDoc').addEventListener('click', ()=>{
    if(!validate()) return;
    const dir=document.documentElement.getAttribute('dir')||'rtl';
    const cv=$('#cv').cloneNode(true);
    const styles=`
      <style>
        body{font-family:"Cairo","Noto Naskh Arabic",Arial;direction:${dir};color:#0F172A}
        h1{margin:0 0 4px;font-size:22px} h3{margin:10px 0 6px;font-size:14px}
        .meta{color:#475569;font-size:12px} .barline{height:2px;background:#C7A046;margin:8px 0 14px}
        .chip{display:inline-block;margin:2px 4px;padding:3px 8px;border:1px solid #E5E7EB;border-radius:999px;font-size:11px;background:#F8FAFC}
        ul{margin:6px 0 0 18px} li{margin:4px 0}
      </style>`;
    const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>CV</title>${styles}</head><body>${cv.outerHTML}</body></html>`;
    const blob=new Blob([html],{type:'application/msword'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='CV-Bahrain.doc'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),200);
  });

  // Save / Import JSON
  function collect(){
    return {
      basics:{
        name:sanitize(name.value), title:sanitize(title.value), email:sanitize(email.value),
        phone:sanitize(phone.value), location:sanitize(location.value), address:sanitize(address.value),
        summary:sanitize(summary.value),
        cpr: $('#extraBox .extra[data-type="cpr"] input')?.value||'',
        license: $('#extraBox .extra[data-type="license"] input')?.value||'',
        nationality: $('#extraBox .extra[data-type="nationality"] input')?.value||'',
        linkedin: $('#extraBox .extra[data-type="linkedin"] input')?.value||'',
        website: $('#extraBox .extra[data-type="website"] input')?.value||''
      },
      exp: $$('#expList .rep').map(rep=>({
        role:sanitize($('.role',rep).value), company:sanitize($('.company',rep).value),
        loc:sanitize($('.loc',rep).value), start:sanitize($('.start',rep).value),
        end:sanitize($('.end',rep).value),
        b1:sanitize($('.b1',rep)?.value||''), b2:sanitize($('.b2',rep)?.value||''), b3:sanitize($('.b3',rep)?.value||'')
      })),
      edu: $$('#eduList .rep').map(rep=>({
        degree:sanitize($('.degree',rep).value), major:sanitize($('.major',rep).value),
        school:sanitize($('.school',rep).value), loc:sanitize($('.loc',rep).value), date:sanitize($('.date',rep).value)
      })),
      skills: [...skills], langs:[...langs]
    };
  }
  $('#btnSave').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(collect(),null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cv-bahrain.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),200);
  });
  $('#jsonFile').addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{ load(JSON.parse(await f.text())); }catch{ alert('تعذّر استيراد JSON'); }
    e.target.value='';
  });
  function load(data){
    const b=data.basics||{};
    name.value=b.name||''; title.value=b.title||''; email.value=b.email||''; phone.value=b.phone||'';
    location.value=b.location||'المنامة، البحرين'; address.value=b.address||'';
    summary.value=b.summary||''; sumCount.textContent=(b.summary||'').length;
    // extras
    extraBox.innerHTML='';
    ['cpr','license','nationality','linkedin','website'].forEach(k=>{
      if(b[k]){ const fakeBtn=document.querySelector(`[data-add="${k}"]`); fakeBtn?.click(); $('#extraBox .extra:last-child input').value=b[k]; }
    });
    // lists
    expList.innerHTML=''; (data.exp||[]).slice(0,3).forEach(x=>expList.appendChild(expItem(x)));
    eduList.innerHTML=''; (data.edu||[]).slice(0,2).forEach(x=>eduList.appendChild(eduItem(x)));
    // chips
    skills.splice(0,skills.length, ...(data.skills||[])); renderSkills();
    langs.splice(0,langs.length, ...(data.langs||[])); renderLangs();

    updateHeader(); syncExp(); syncEdu();
  }

  // Initialize one block for سهولة
  expList.appendChild(expItem());
  eduList.appendChild(eduItem());
  updateHeader();

})();
</script>
</body>
</html>
